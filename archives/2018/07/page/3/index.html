<!doctype html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8">
    <meta name="baidu-site-verification" content="dIcXMeY8Ya">
    
    <title>文章归档: 2018/7 | 网记本</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="keywords" content="freefuncode, Android, Kotlin, 网络记事本, 网记本">
    <meta name="description" content="FreeFunCode网络记事本">

    
    <link rel="alternative" href="/atom.xml" title="网记本" type="application/atom+xml">
    
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.css">
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?fd459238242776d173cdc64918fb32f2";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


</head>
</html>
<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">网记本</span>
                    <span class="description">网络记事本-huangguangzhi</span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/archives/2018/07/page/3/index.html" class="item ">
                <a href="/" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="/archives/2018/07/page/3/index.html" class="item ">
                <a href="/about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="" target="_blank">good good study ,day day up!</a>
                        |
                    
                        <a href="" target="_blank">利用碎片化时间挖掘知识深度！</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" class="juejin" target="_blank"><b>■</b> 稀土掘金</a>
                    
                        <a href="https://weibo.com/230689567" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/avatar.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章归档 -->

    <h3 class="widget-hd">
        <strong>
            
                文章归档
                <!-- 文章归档，可以根据日期分类 -->
            
        </strong>
    </h3>
    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/">
    		Android 源码分析（六） SystemServer 进程
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2018-07-07T07:14:19.000Z">2018-07-07</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>&nbsp;&nbsp;&nbsp; 一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; <strong>SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；</strong><br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.<br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. SystemService进程</h2>
<p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; ZygoteInit类的main方法调用了StartSystemService() 启动SystemService.<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SystemServer进程主要的作用是启动各种系统服务，比如ActivityManagerService，PackageManagerService，WindowManagerService等服务.</p>
<p>&nbsp;</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteInit.java</span>
     <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Prepare the arguments and fork for the system server process.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> startSystemServer(String abiList, String socketName, ZygoteServer zygoteServer)
            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller, RuntimeException {
        </span><span style="color: #0000ff;">long</span> capabilities =<span style="color: #000000;"> posixCapabilitiesAsBits(
            OsConstants.CAP_IPC_LOCK,
            OsConstants.CAP_KILL,
            OsConstants.CAP_NET_ADMIN,
            OsConstants.CAP_NET_BIND_SERVICE,
            OsConstants.CAP_NET_BROADCAST,
            OsConstants.CAP_NET_RAW,
            OsConstants.CAP_SYS_MODULE,
            OsConstants.CAP_SYS_NICE,
            OsConstants.CAP_SYS_PTRACE,
            OsConstants.CAP_SYS_TIME,
            OsConstants.CAP_SYS_TTY_CONFIG,
            OsConstants.CAP_WAKE_ALARM
        );
        </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Containers run without this capability, so avoid setting it in that case </span><span style="color: #008000;">*/</span>
        <span style="color: #0000ff;">if</span> (!SystemProperties.getBoolean(PROPERTY_RUNNING_IN_CONTAINER, <span style="color: #0000ff;">false</span><span style="color: #000000;">)) {
            capabilities </span>|=<span style="color: #000000;"> posixCapabilitiesAsBits(OsConstants.CAP_BLOCK_SUSPEND);
        }
        </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Hardcoded command line to start the system server </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        String args[] </span>=<span style="color: #000000;"> {
            </span>"--setuid=1000"<span style="color: #000000;">,
            </span>"--setgid=1000"<span style="color: #000000;">,
            </span>"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1032,3001,3002,3003,3006,3007,3009,3010"<span style="color: #000000;">,
            </span>"--capabilities=" + capabilities + "," +<span style="color: #000000;"> capabilities,
            </span>"--nice-name=system_server"<span style="color: #000000;">,
            </span>"--runtime-args"<span style="color: #000000;">,
            </span>"com.android.server.SystemServer"<span style="color: #000000;">,
        };
        ZygoteConnection.Arguments parsedArgs </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; pid;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        parsedArgs &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ZygoteConnection.Arguments(args);
        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);
        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Request to fork the system server process &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
        pid &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; Zygote.forkSystemServer(
                parsedArgs.uid, parsedArgs.gid,
                parsedArgs.gids,
                parsedArgs.debugFlags,
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
                parsedArgs.permittedCapabilities,
                parsedArgs.effectiveCapabilities);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IllegalArgumentException ex) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RuntimeException(ex);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; For child process &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (pid == 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (hasSecondZygote(abiList)) {
            waitForSecondaryZygote(socketName);
        }

        zygoteServer.closeServerSocket();
        handleSystemServerProcess(parsedArgs);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp; 接上篇文章继续看看SystemServer在源码中做了什么.</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">SystemServer.java</span>

<pre><code>&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * The main entry point from zygote.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; main(String[] args) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemServer().run();
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; run() {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        traceBeginAndSlog(&lt;/span&gt;&quot;InitBeforeStartServices&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If a device&apos;s clock is before 1970 (before 0), a lot of
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; APIs crash dealing with negative numbers, notably
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; java.io.File#setLastModified, so instead we fake it and
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; hope that time from cell towers or NTP fixes it shortly.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (System.currentTimeMillis() &amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt; EARLIEST_SUPPORTED_TIME) {
            Slog.w(TAG, &lt;/span&gt;&quot;System clock is before 1970; setting to 1970.&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
            SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;
        &lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Default the timezone property to GMT if not set.
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//</code></pre><p>            String timezoneProperty =  SystemProperties.get(“persist.sys.timezone”<span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span> (timezoneProperty == <span style="color: #0000ff;">null</span> ||<span style="color: #000000;"> timezoneProperty.isEmpty()) {<br>                Slog.w(TAG, </span>“Timezone not set; setting to GMT.”<span style="color: #000000;">);<br>                SystemProperties.set(</span>“persist.sys.timezone”, “GMT”<span style="color: #000000;">);<br>            }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If the system has &quot;persist.sys.language&quot; and friends set, replace them with
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; &quot;persist.sys.locale&quot;. Note that the default locale at this point is calculated
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; using the &quot;-Duser.locale&quot; command line flag. That flag is usually populated by
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; AndroidRuntime using the same set of system properties, but only the system_server
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; and system apps are allowed to set them.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; NOTE: Most changes made here will need an equivalent change to
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; core/jni/AndroidRuntime.cpp&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemProperties.get(&quot;persist.sys.language&quot;&lt;span style=&quot;color: #000000;&quot;&gt;).isEmpty()) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String languageTag =&lt;span style=&quot;color: #000000;&quot;&gt; Locale.getDefault().toLanguageTag();

    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.locale&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, languageTag);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.language&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.country&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.localevar&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The system server should never make non-oneway calls&lt;/span&gt;
Binder.setWarnOnBlocking(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Here we go!&lt;/span&gt;
Slog.i(TAG, &quot;Entered the Android system server!&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; uptimeMillis = (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime();
EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, uptimeMillis);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mRuntimeRestart) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_system_server_init&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, uptimeMillis);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In case the runtime switched since last boot (such as when
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the old runtime was removed in an OTA), set the system
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; property so that it is in sync. We can | xq oqi&apos;t do this in
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; libnativehelper&apos;s JniInvocation::Init code where we already
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; had to fallback to a different runtime because it is
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; running as root and we need to be the system user to set
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the property. &lt;/span&gt;&lt;span style=&quot;color: #008000; text-decoration: underline;&quot;&gt;http://b/11463182&lt;/span&gt;
SystemProperties.set(&quot;persist.sys.dalvik.vm.lib.2&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, VMRuntime.getRuntime().vmLibrary());

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Enable the sampling profiler.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (SamplingProfilerIntegration.isEnabled()) {
    SamplingProfilerIntegration.start();
    mProfilerSnapshotTimer &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Timer();
    mProfilerSnapshotTimer.schedule(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; TimerTask() {
            @Override
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; run() {
                SamplingProfilerIntegration.writeSnapshot(&lt;/span&gt;&quot;system_server&quot;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            }
        }, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Mmmmmm... more memory!&lt;/span&gt;</code></pre><p><span style="color: #000000;">            VMRuntime.getRuntime().clearGrowthLimit();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The system server has to run all of the time, so it needs to be
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; as efficient as possible with its memory usage.&lt;/span&gt;
VMRuntime.getRuntime().setTargetHeapUtilization(0.8f&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Some devices rely on runtime fingerprint generation, so make sure
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we&apos;ve defined it before booting further.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            Build.ensureFingerprintProperty();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Within the system server, it is an error to access Environment paths without
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; explicitly specifying a user.&lt;/span&gt;
Environment.setUserRequired(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Within the system server, any incoming Bundles should be defused
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to avoid throwing BadParcelableException.&lt;/span&gt;
BaseBundle.setShouldDefuse(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Ensure binder calls into the system always run at foreground priority.&lt;/span&gt;
BinderInternal.disableBackgroundScheduling(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Increase the number of binder threads in system_server&lt;/span&gt;</code></pre><p><span style="color: #000000;">            BinderInternal.setMaxThreads(sMaxBinderThreads);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Prepare the main looper thread (this thread).&lt;/span&gt;</code></pre><p><span style="color: #000000;">            android.os.Process.setThreadPriority(<br>                android.os.Process.THREAD_PRIORITY_FOREGROUND);<br>            android.os.Process.setCanSelfBackground(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);<br>            Looper.prepareMainLooper();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize native services.&lt;/span&gt;
System.loadLibrary(&quot;android_servers&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Check whether we failed to shut down last time we tried.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; This call may not return.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            performPendingShutdown();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize the system context.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            createSystemContext();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Create the system service manager.&lt;/span&gt;
mSystemServiceManager = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemServiceManager(mSystemContext);
mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);
LocalServices.addService(SystemServiceManager.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, mSystemServiceManager);
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Prepare the thread pool for init tasks that can be parallelized&lt;/span&gt;</code></pre><p><span style="color: #000000;">            SystemServerInitThreadPool.get();<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            traceEnd();  </span><span style="color: #008000;">//</span><span style="color: #008000;"> InitBeforeStartServices</span><br><span style="color: #000000;">        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start services. 启动各种需要的服务&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    traceBeginAndSlog(&lt;/span&gt;&quot;StartServices&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;启动系统Boot级服务 &lt;/span&gt;</code></pre><p><span style="color: #000000;">            startBootstrapServices();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">启动系统核心的服务 </span><br><span style="color: #000000;">            startCoreServices();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">启动非核心的服务 </span><br><span style="color: #000000;">            startOtherServices();<br>            SystemServerInitThreadPool.shutdown();<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable ex) {<br>            Slog.e(</span>“System”, “<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>“<span style="color: #000000;">);<br>            Slog.e(</span>“System”, “<strong><strong>****</strong></strong> Failure starting system services”<span style="color: #000000;">, ex);<br>            </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> ex;<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            traceEnd();<br>        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; For debug builds, log event loop stalls to dropbox for analysis.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (StrictMode.conditionallyEnableDebugLogging()) {
    Slog.i(TAG, &lt;/span&gt;&quot;Enabled StrictMode for system server main thread.&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
}
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!mRuntimeRestart &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;isFirstBootOrUpgrade()) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; uptimeMillis = (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime();
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_system_server_ready&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, uptimeMillis);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; MAX_UPTIME_MILLIS = 60 * 1000&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (uptimeMillis &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; MAX_UPTIME_MILLIS) {
        Slog.wtf(SYSTEM_SERVER_TIMING_TAG,
                &lt;/span&gt;&quot;SystemServer init took too long. uptimeMillis=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; uptimeMillis);
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Loop forever.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Looper.loop();<br>        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> RuntimeException(“Main thread loop unexpectedly exited”<span style="color: #000000;">);<br>    }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts the small tangle of critical services that are needed to get
 * the system off the ground.  These services have complex mutual dependencies
 * which is why we initialize them all in one place here.  Unless your service
 * is also entwined in these dependencies, it should be initialized in one of
 * the other functions.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startBootstrapServices() {
    Slog.i(TAG, &lt;/span&gt;&quot;Reading configuration...&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String TAG_SYSTEM_CONFIG = &quot;ReadingSystemConfig&quot;&lt;span style=&quot;color: #000000;&quot;&gt;;
    traceBeginAndSlog(TAG_SYSTEM_CONFIG);
    SystemServerInitThreadPool.get().submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Wait for installd to finish starting up so that it has a chance to
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; create critical directories such as /data/user with the appropriate
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; permissions.  We need this to complete before we initialize other services.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartInstaller&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    Installer installer &lt;/span&gt;= mSystemServiceManager.startService(Installer.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In some cases after launching an app we need to access device identifiers,
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; therefore register the device identifier policy before the activity manager.&lt;/span&gt;
    traceBeginAndSlog(&quot;DeviceIdentifiersPolicyService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(DeviceIdentifiersPolicyService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Activity manager runs the show.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartActivityManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSystemServiceManager.startService(
            ActivityManagerService.Lifecycle.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;).getService();
    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);
    mActivityManagerService.setInstaller(installer);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Power manager needs to be started early because other services need it.
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Native daemons may be watching for it to be registered so it must be ready
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to handle incoming binder calls immediately (including being able to verify
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the permissions for those calls).&lt;/span&gt;
    traceBeginAndSlog(&quot;StartPowerManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mPowerManagerService &lt;/span&gt;= mSystemServiceManager.startService(PowerManagerService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Now that the power manager has been started, let the activity manager
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; initialize power management features.&lt;/span&gt;
    traceBeginAndSlog(&quot;InitPowerManagement&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService.initPowerManagement();
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Bring up recovery system in case a rescue party needs a reboot&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemProperties.getBoolean(&quot;config.disable_noncore&quot;, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
        traceBeginAndSlog(&lt;/span&gt;&quot;StartRecoverySystemService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        mSystemServiceManager.startService(RecoverySystemService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        traceEnd();
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Now that we have the bare essentials of the OS up and running, take
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; note that we just booted, which might send out a rescue party if
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we&apos;re stuck in a runtime restart loop.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        RescueParty.noteBoot(mSystemContext);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages LEDs and display backlight so we need it to bring up the display.&lt;/span&gt;
traceBeginAndSlog(&quot;StartLightsService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startService(LightsService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Display manager is needed to provide display metrics before package manager
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; starts up.&lt;/span&gt;
traceBeginAndSlog(&quot;StartDisplayManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mDisplayManagerService &lt;/span&gt;= mSystemServiceManager.startService(DisplayManagerService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We need the default display before we can initialize the package manager.&lt;/span&gt;
traceBeginAndSlog(&quot;WaitForDisplay&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Only run &quot;core&quot; apps if we&apos;re encrypting the device.&lt;/span&gt;
String cryptState = SystemProperties.get(&quot;vold.decrypt&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ENCRYPTING_STATE.equals(cryptState)) {
    Slog.w(TAG, &lt;/span&gt;&quot;Detected encryption in progress - only parsing core apps&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mOnlyCore &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ENCRYPTED_STATE.equals(cryptState)) {
    Slog.w(TAG, &lt;/span&gt;&quot;Device encrypted - only parsing core apps&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mOnlyCore &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start the package manager.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mRuntimeRestart) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_package_manager_init_start&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            (&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime());
}
traceBeginAndSlog(&lt;/span&gt;&quot;StartPackageManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mPackageManagerService &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; PackageManagerService.main(mSystemContext, installer,
        mFactoryTestMode &lt;/span&gt;!=&lt;span style=&quot;color: #000000;&quot;&gt; FactoryTest.FACTORY_TEST_OFF, mOnlyCore);
mFirstBoot &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mPackageManagerService.isFirstBoot();
mPackageManager &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSystemContext.getPackageManager();
traceEnd();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!mRuntimeRestart &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;isFirstBootOrUpgrade()) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_package_manager_init_ready&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            (&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime());
}
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages A/B OTA dexopting. This is a bootstrap service as we need it to rename
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; A/B artifacts after boot, before anything else might touch/need them.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Note: this isn&apos;t needed during decryption (we don&apos;t have /data anyways).&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mOnlyCore) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; disableOtaDexopt = SystemProperties.getBoolean(&quot;config.disable_otadexopt&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;disableOtaDexopt) {
        traceBeginAndSlog(&lt;/span&gt;&quot;StartOtaDexOptService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            OtaDexoptService.main(mSystemContext, mPackageManagerService);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Throwable e) {
            reportWtf(&lt;/span&gt;&quot;starting OtaDexOptService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, e);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;finally&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            traceEnd();
        }
    }
}

traceBeginAndSlog(&lt;/span&gt;&quot;StartUserManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startService(UserManagerService.LifeCycle.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize attribute cache used to cache resources from packages.&lt;/span&gt;
traceBeginAndSlog(&quot;InitAttributerCache&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
AttributeCache.init(mSystemContext);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Set up the Application instance for the system process and get started.&lt;/span&gt;
traceBeginAndSlog(&quot;SetSystemProcess&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mActivityManagerService.setSystemProcess();
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; DisplayManagerService needs to setup android.display scheduling related policies
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; since setSystemProcess() would have overridden policies due to setProcessGroup&lt;/span&gt;</code></pre><p><span style="color: #000000;">        mDisplayManagerService.setupSchedulerPolicies();</span></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages Overlay packages&lt;/span&gt;
    traceBeginAndSlog(&quot;StartOverlayManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; OverlayManagerService(mSystemContext, installer));
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The sensor service needs access to package manager service, app ops
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; service, and permissions service, therefore we start it after them.
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start sensor service in a separate thread. Completion should be checked
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; before using it.&lt;/span&gt;
    mSensorServiceStart = SystemServerInitThreadPool.get().submit(() -&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        BootTimingsTraceLog traceLog &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; BootTimingsTraceLog(
                SYSTEM_SERVER_TIMING_ASYNC_TAG, Trace.TRACE_TAG_SYSTEM_SERVER);
        traceLog.traceBegin(START_SENSOR_SERVICE);
        startSensorService();
        traceLog.traceEnd();
    }, START_SENSOR_SERVICE);
}


&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts some essential services that are not tangled up in the bootstrap process.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startCoreServices() {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Records errors and logs, for example wtf()&lt;/span&gt;
    traceBeginAndSlog(&quot;StartDropBoxManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(DropBoxManagerService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    traceBeginAndSlog(&lt;/span&gt;&quot;StartBatteryService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks the battery level.  Requires LightService.&lt;/span&gt;
    mSystemServiceManager.startService(BatteryService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks application usage stats.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartUsageService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(UsageStatsService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService.setUsageStatsManager(
            LocalServices.getService(UsageStatsManagerInternal.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks whether the updatable WebView is in a ready state and watches for update installs.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartWebViewUpdateService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mWebViewUpdateService &lt;/span&gt;= mSystemServiceManager.startService(WebViewUpdateService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();
}
&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;"> mSystemServiceManager是系统服务管理对象.在run()方法已经创建 mSystemServiceManager = new SystemServiceManager(mSystemContext);
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 进入mSystemServiceManager.startService() 分析下. 进入具体实现的方法

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;SystemServiceManager.java&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Creates and starts a system service. The class must be a subclass of
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; com.android.server.SystemService}.
 *
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; serviceClass A Java class that implements the SystemService interface.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The service instance, never null.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@throws&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; RuntimeException if the service fails to start.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
@SuppressWarnings(&lt;/span&gt;&quot;unchecked&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &amp;lt;T &lt;span style=&quot;color: #0000ff;&quot;&gt;extends&lt;/span&gt; SystemService&amp;gt; T startService(Class&amp;lt;T&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String name =&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass.getName();
        Slog.i(TAG, &lt;/span&gt;&quot;Starting &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name);
        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, &lt;/span&gt;&quot;StartService &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name);

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Create the service.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.isAssignableFrom(serviceClass)) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must extend &quot; + SystemService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.getName());
        }
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; T service;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            Constructor&lt;/span&gt;&amp;lt;T&amp;gt; constructor = serviceClass.getConstructor(Context.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            service &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; constructor.newInstance(mContext);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (InstantiationException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service could not be instantiated&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IllegalAccessException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must have a public constructor with a Context argument&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (NoSuchMethodException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must have a public constructor with a Context argument&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (InvocationTargetException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service constructor threw an exception&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        }

        startService(service);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; service;
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;finally&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);
    }
}

  &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts a service by class name.
 *
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The service instance.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
@SuppressWarnings(&lt;/span&gt;&quot;unchecked&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemService startService(String className) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; Class&amp;lt;SystemService&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        serviceClass &lt;/span&gt;= (Class&amp;lt;SystemService&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;)Class.forName(className);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ClassNotFoundException ex) {
        Slog.i(TAG, &lt;/span&gt;&quot;Starting &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; className);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; className
                &lt;/span&gt;+ &quot;: service class not found, usually indicates that the caller should &quot;
                + &quot;have called PackageManager.hasSystemFeature() to check whether the &quot;
                + &quot;feature is available on this device before trying to start the &quot;
                + &quot;services that implement it&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startService(serviceClass);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;通过反射器构造方法创建出服务类,然后返回SystemService.启动对应的服务.&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/" title="Android 源码分析（六） SystemServer 进程">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/img/thumbnail/7.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/07/Android源码分析五Zygote进程/">
    		Android 源码分析（五） Zygote 进程
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2018-07-07T06:14:54.000Z">2018-07-07</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/zygote.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.前言:&nbsp;&nbsp;</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；</p>
<h3>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；</h3>
<p>&nbsp;&nbsp;&nbsp; SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;</p>
<h2>二. Zygote进程&nbsp;</h2>
<p>&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; Android系统是基于Linux内核的，而在Linux系统中，所有的进程都是init进程的子孙进程，也就是说，所有的进程都是直接或者间接地由init进程fork出来的。Zygote进程也不例外，它是在系统启动的过程，由init进程创建的.<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; init进程在启动Zygote进程时一般都会调用ZygoteInit类的main方法.</p>
<p>　　如果SystemServer崩溃了，Zygote也会kill自己，重新创建进程服务。</p>
<p>&nbsp;　　</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteInit.java</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String argv[]) {
        ZygoteServer zygoteServer </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> ZygoteServer();

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Mark zygote start. This ensures that thread creation will throw
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; an error.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        ZygoteHooks.startZygoteNoThreadCreation();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Zygote goes into its own process group.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    Os.setpgid(&lt;/span&gt;0, 0&lt;span style=&quot;color: #000000;&quot;&gt;);
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ErrnoException ex) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to setpgid(0,0)&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Report Zygote start time to tron unless it is a runtime restart&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&quot;1&quot;.equals(SystemProperties.get(&quot;sys.boot_completed&quot;&lt;span style=&quot;color: #000000;&quot;&gt;))) {
        MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_zygote_init&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
                (&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime());
    }

    String bootTimeTag &lt;/span&gt;= Process.is64Bit() ? &quot;Zygote64Timing&quot; : &quot;Zygote32Timing&quot;&lt;span style=&quot;color: #000000;&quot;&gt;;
    BootTimingsTraceLog bootTimingsTraceLog &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; BootTimingsTraceLog(bootTimeTag,
            Trace.TRACE_TAG_DALVIK);
    bootTimingsTraceLog.traceBegin(&lt;/span&gt;&quot;ZygoteInit&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    RuntimeInit.enableDdms();
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start profiling the zygote initialization.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            SamplingProfilerIntegration.start();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; startSystemServer = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
String socketName &lt;/span&gt;= &quot;zygote&quot;&lt;span style=&quot;color: #000000;&quot;&gt;;
String abiList &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; enableLazyPreload = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt; argv.length; i++&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (&quot;start-system-server&quot;&lt;span style=&quot;color: #000000;&quot;&gt;.equals(argv[i])) {
        startSystemServer &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (&quot;--enable-lazy-preload&quot;&lt;span style=&quot;color: #000000;&quot;&gt;.equals(argv[i])) {
        enableLazyPreload &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (argv[i].startsWith(ABI_LIST_ARG)) {
        abiList &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; argv[i].substring(ABI_LIST_ARG.length());
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (argv[i].startsWith(SOCKET_NAME_ARG)) {
        socketName &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; argv[i].substring(SOCKET_NAME_ARG.length());
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Unknown command line argument: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; argv[i]);
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (abiList == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;No ABI list supplied.&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

zygoteServer.registerServerSocket(socketName);
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In some configurations, we avoid preloading resources and classes eagerly.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In such cases, we will preload things prior to our first fork.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;enableLazyPreload) {
    bootTimingsTraceLog.traceBegin(&lt;/span&gt;&quot;ZygotePreload&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,
        SystemClock.uptimeMillis());
    preload(bootTimingsTraceLog);
    EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,
        SystemClock.uptimeMillis());
    bootTimingsTraceLog.traceEnd(); &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; ZygotePreload&lt;/span&gt;
} &lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    Zygote.resetNicePriority();
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Finish profiling the zygote initialization.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            SamplingProfilerIntegration.writeZygoteSnapshot();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Do an initial gc to clean up after startup&lt;/span&gt;
bootTimingsTraceLog.traceBegin(&quot;PostZygoteInitGC&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
gcAndFinalize();
bootTimingsTraceLog.traceEnd(); &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; PostZygoteInitGC&lt;/span&gt;</code></pre><span style="color: #000000;">
            bootTimingsTraceLog.traceEnd(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> ZygoteInit
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Disable tracing so that forked processes do not inherit stale tracing tags from
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Zygote.</span>
            Trace.setTracingEnabled(<span style="color: #0000ff;">false</span><span style="color: #000000;">);

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Zygote process unmounts root storage spaces.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            Zygote.nativeUnmountStorageOnInit();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Set seccomp policy&lt;/span&gt;</code></pre><p><span style="color: #000000;">            Seccomp.setPolicy();</span></p>
<pre><code>        ZygoteHooks.stopZygoteNoThreadCreation();

        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (startSystemServer) {
            startSystemServer(abiList, socketName, zygoteServer);
        }

        Log.i(TAG, &lt;/span&gt;&quot;Accepting command socket connections&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        zygoteServer.runSelectLoop(abiList);

        zygoteServer.closeServerSocket();
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Zygote.MethodAndArgsCaller caller) {
        caller.run();
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Throwable ex) {
        Log.e(TAG, &lt;/span&gt;&quot;System zygote died with exception&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        zygoteServer.closeServerSocket();
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ex;
    }
}
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;1.registerServerSocket
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;2.调用preload加载资源，
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;3.利用gcAndFinalize初始化gc，
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;4.启动SystemServer，startSystemServer() 这里启动SystemServer服务.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;5.调用runSelectLoop运行Zygote进程选择的looper，
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;6.关闭和清理zygote sockets &lt;/span&gt;
&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></span></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteServer.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Registers a server socket for zygote command connections
     *
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> RuntimeException when open fails
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">void</span><span style="color: #000000;"> registerServerSocket(String socketName) {
        </span><span style="color: #0000ff;">if</span> (mServerSocket == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> fileDesc;
            </span><span style="color: #0000ff;">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX +<span style="color: #000000;"> socketName;
            </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                String env </span>=<span style="color: #000000;"> System.getenv(fullSocketName);
                fileDesc </span>=<span style="color: #000000;"> Integer.parseInt(env);
            } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (RuntimeException ex) {
                </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> RuntimeException(fullSocketName + " unset or invalid"<span style="color: #000000;">, ex);
            }

<pre><code>        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            FileDescriptor fd &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; FileDescriptor();
            fd.setInt$(fileDesc);
            mServerSocket &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; LocalServerSocket(fd);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IOException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RuntimeException(
                    &lt;/span&gt;&quot;Error binding to local socket &apos;&quot; + fileDesc + &quot;&apos;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        }
    }
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteInit.java</span>
    <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> preload(BootTimingsTraceLog bootTimingsTraceLog) {
        Log.d(TAG, </span>"begin preload"<span style="color: #000000;">);
        bootTimingsTraceLog.traceBegin(</span>"BeginIcuCachePinning"<span style="color: #000000;">);
        beginIcuCachePinning();
        bootTimingsTraceLog.traceEnd(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> BeginIcuCachePinning</span>
        bootTimingsTraceLog.traceBegin("PreloadClasses"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;">初始化Zygote中需要的class类        </span>
<span style="color: #000000;">        preloadClasses();
        bootTimingsTraceLog.traceEnd(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> PreloadClasses</span>
        bootTimingsTraceLog.traceBegin("PreloadResources"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;">初始化系统资源</span>
<span style="color: #000000;">        preloadResources();
        bootTimingsTraceLog.traceEnd(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> PreloadResources</span>
        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, "PreloadOpenGL"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;">初始化OpenGL</span>
<span style="color: #000000;">        preloadOpenGL();
        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);
        </span><span style="color: #008000;">//</span><span style="color: #008000;">初始化系统libraries</span>
<span style="color: #000000;">        preloadSharedLibraries();
        </span><span style="color: #008000;">//</span><span style="color: #008000;">初始化文字资源</span>
<span style="color: #000000;">        preloadTextResources();
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Ask the WebViewFactory to do any initialization that must run in the zygote process,
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> for memory sharing purposes.
        </span><span style="color: #008000;">//</span><span style="color: #008000;">初始化webview</span>
<span style="color: #000000;">        WebViewFactory.prepareWebViewInZygote();
        endIcuCachePinning();
        warmUpJcaProviders();
        Log.d(TAG, </span>"end preload"<span style="color: #000000;">);

<pre><code>    sPreloadComplete &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">进去看看初始化webview方法
    </span><span style="color: #008000;">//</span><span style="color: #008000;">WebViewFactory.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Perform any WebView loading preparations that must happen in the zygote.
     * Currently, this means allocating address space to load the real JNI library later.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> prepareWebViewInZygote() {
        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            System.loadLibrary(</span>"webviewchromium_loader"<span style="color: #000000;">);
            </span><span style="color: #0000ff;">long</span> addressSpaceToReserve =<span style="color: #000000;">
                    SystemProperties.getLong(CHROMIUM_WEBVIEW_VMSIZE_SIZE_PROPERTY,
                    CHROMIUM_WEBVIEW_DEFAULT_VMSIZE_BYTES);
            sAddressSpaceReserved </span>=<span style="color: #000000;"> nativeReserveAddressSpace(addressSpaceToReserve);

<pre><code>        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (sAddressSpaceReserved) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG) {
                Log.v(LOGTAG, &lt;/span&gt;&quot;address space reserved: &quot; + addressSpaceToReserve + &quot; bytes&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
            }
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            Log.e(LOGTAG, &lt;/span&gt;&quot;reserving &quot; + addressSpaceToReserve +
                    &quot; bytes of address space failed&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        }
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Throwable t) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Log and discard errors at this stage as we must not crash the zygote.&lt;/span&gt;
        Log.e(LOGTAG, &quot;error preparing native loader&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, t);
    }
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/07/Android源码分析五Zygote进程/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/07/Android源码分析五Zygote进程/" title="Android 源码分析（五） Zygote 进程">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/img/thumbnail/7.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/07/Android源码分析四Handler异步消息机制/">
    		Android 源码分析（四） Handler 异步消息机制
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2018-07-07T04:40:19.000Z">2018-07-07</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/handler.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.Handler 使用方法:</h2>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre> Handler handler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Handler() {
        @Override
        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleMessage(Message msg) {
            </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.handleMessage(msg);
            </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (msg.what) {
                </span><span style="color: #0000ff;">case</span> 1<span style="color: #000000;">:
                    Log.i(TAG,</span>"UI thread sendEmptyMessage...1"<span style="color: #000000;">);
                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
                </span><span style="color: #0000ff;">case</span> 2<span style="color: #000000;">:
                    Log.i(TAG,</span>"thread sendEmptyMessage...2"<span style="color: #000000;">);
                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
                </span><span style="color: #0000ff;">case</span> 3<span style="color: #000000;">:
                    Log.i(TAG,</span>"thread sendMessage...3"<span style="color: #000000;">);
                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
                </span><span style="color: #0000ff;">case</span> 4<span style="color: #000000;">:
                    Log.i(TAG,</span>"UI thread sendMessage...4"<span style="color: #000000;">);
                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
            }
        }
    };


<pre><code>handler.sendEmptyMessage(&lt;/span&gt;1&lt;span style=&quot;color: #000000;&quot;&gt;);

handler.postDelayed(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Runnable() {
        @Override
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; run() {
            handler.sendEmptyMessage(&lt;/span&gt;2&lt;span style=&quot;color: #000000;&quot;&gt;);

            Message msg &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Message();
            msg.what &lt;/span&gt;= 3&lt;span style=&quot;color: #000000;&quot;&gt;;
            handler.sendMessage(msg);
        }
    }, &lt;/span&gt;1000&lt;span style=&quot;color: #000000;&quot;&gt;);&lt;br&gt;
Message msg2 &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Message();
msg2.what &lt;/span&gt;= 4&lt;span style=&quot;color: #000000;&quot;&gt;;
handler.sendMessage(msg2);&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>输出结果:</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180707123135364-1224869612.png" alt></p>
<h2>二.源码分析</h2>
<pre><span style="color: #000000;">从handler.sendMessage(msg)进去看看源码怎么调用的.<br></span></pre>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>//<span style="color: #000000;">Handler.java

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;Looper.prepare()方法初始化了一个Looper对象并关联在一个MessageQueue对象，并且一个线程中只有一个Looper对象，只有一个MessageQueue对象。
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;Handler的构造方法则在Handler内部维护了当前线程的Looper对象&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; Handler(Callback callback, &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; async) {
    ......
    mLooper &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; Looper.myLooper();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (mLooper == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RuntimeException(
            &lt;/span&gt;&quot;Can&apos;t create handler inside thread that has not called Looper.prepare()&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    }
    ......
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; if we can get rid of this method, the handler need not remember its loop
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we could instead export a getMessageQueue() method... &lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Looper getLooper() {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mLooper;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Pushes a message onto the end of the message queue after all pending messages
 * before the current time. It will be received in {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #handleMessage},
 * in the thread attached to this handler.
 *  
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Returns true if the message was successfully placed in to the 
 *         message queue.  Returns false on failure, usually because the
 *         looper processing the message queue is exiting.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; sendMessage(Message msg)
{
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;参数 0 代表,无延迟.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; sendMessageDelayed(msg, 0&lt;span style=&quot;color: #000000;&quot;&gt;);
}

 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Enqueue a message into the message queue after all pending messages
 * before (current time + delayMillis). You will receive it in
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #handleMessage}, in the thread attached to this handler.
 *  
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Returns true if the message was successfully placed in to the 
 *         message queue.  Returns false on failure, usually because the
 *         looper processing the message queue is exiting.  Note that a
 *         result of true does not mean the message will be processed -- if
 *         the looper is quit before the delivery time of the message
 *         occurs then the message will be dropped.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; sendMessageDelayed(Message msg, &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; delayMillis)
{
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (delayMillis &amp;lt; 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
        delayMillis &lt;/span&gt;= 0&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; sendMessageAtTime(msg, SystemClock.uptimeMillis() +&lt;span style=&quot;color: #000000;&quot;&gt; delayMillis);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Enqueue a message into the message queue after all pending messages
 * before the absolute time (in milliseconds) &amp;lt;var&amp;gt;uptimeMillis&amp;lt;/var&amp;gt;.
 * &amp;lt;b&amp;gt;The time-base is {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; android.os.SystemClock#uptimeMillis}.&amp;lt;/b&amp;gt;
 * Time spent in deep sleep will add an additional delay to execution.
 * You will receive it in {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #handleMessage}, in the thread attached
 * to this handler.
 * 
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; uptimeMillis The absolute time at which the message should be
 *         delivered, using the
 *         {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; android.os.SystemClock#uptimeMillis} time-base.
 *         
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Returns true if the message was successfully placed in to the 
 *         message queue.  Returns false on failure, usually because the
 *         looper processing the message queue is exiting.  Note that a
 *         result of true does not mean the message will be processed -- if
 *         the looper is quit before the delivery time of the message
 *         occurs then the message will be dropped.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; sendMessageAtTime(Message msg, &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; uptimeMillis) {
    MessageQueue queue &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mQueue;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (queue == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        RuntimeException e &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RuntimeException(
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt; + &quot; sendMessageAtTime() called with no mQueue&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        Log.w(&lt;/span&gt;&quot;Looper&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, e.getMessage(), e);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; enqueueMessage(queue, msg, uptimeMillis);
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; enqueueMessage(MessageQueue queue, Message msg, &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; uptimeMillis) {
    msg.target &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (mAsynchronous) {
        msg.setAsynchronous(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; queue.enqueueMessage(msg, uptimeMillis);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;msg.target就是Handler对象本身；而这里的queue对象就是我们的Handler内部维护的Looper对象关联的MessageQueue对象.&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<pre></pre>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">MessageQueue.java</span>
    <span style="color: #0000ff;">boolean</span> enqueueMessage(Message msg, <span style="color: #0000ff;">long</span><span style="color: #000000;"> when) {
        </span><span style="color: #0000ff;">if</span> (msg.target == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalArgumentException("Message must have a target."<span style="color: #000000;">);
        }
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (msg.isInUse()) {
            </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalStateException(msg + " This message is already in use."<span style="color: #000000;">);
        }

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;synchronized&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (mQuitting) {
            IllegalStateException e &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; IllegalStateException(
                    msg.target &lt;/span&gt;+ &quot; sending message to a Handler on a dead thread&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
            Log.w(TAG, e.getMessage(), e);
            msg.recycle();
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        }

        msg.markInUse();
        msg.when &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; when;
        Message p &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mMessages;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; needWake;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (p == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; || when == 0 || when &amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt; p.when) {
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; New head, wake up the event queue if blocked.&lt;/span&gt;
            msg.next =&lt;span style=&quot;color: #000000;&quot;&gt; p;
            mMessages &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; msg;
            needWake &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mBlocked;
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Inserted within the middle of the queue.  Usually we don&apos;t have to wake
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; up the event queue unless there is a barrier at the head of the queue
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; and the message is the earliest asynchronous message in the queue.&lt;/span&gt;
            needWake = mBlocked &amp;amp;&amp;amp; p.target == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; msg.isAsynchronous();
            Message prev;
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (;;) {
                prev &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; p;
                p &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; p.next;
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (p == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; || when &amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt; p.when) {
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                }
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (needWake &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; p.isAsynchronous()) {
                    needWake &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                }
            }
            msg.next &lt;/span&gt;= p; &lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; invariant: p == prev.next&lt;/span&gt;
            prev.next =&lt;span style=&quot;color: #000000;&quot;&gt; msg;
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We can assume mPtr != 0 because mQuitting is false.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (needWake) {
            nativeWake(mPtr);
        }
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">Looper.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Run the message queue in this thread. Be sure to call
     * {</span><span style="color: #808080;">@link</span><span style="color: #008000;"> #quit()} to end the loop.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> loop() {
        </span><span style="color: #0000ff;">final</span> Looper me =<span style="color: #000000;"> myLooper();
        </span><span style="color: #0000ff;">if</span> (me == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> RuntimeException("No Looper; Looper.prepare() wasn't called on this thread."<span style="color: #000000;">);
        }
        </span><span style="color: #0000ff;">final</span> MessageQueue queue =<span style="color: #000000;"> me.mQueue;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Make sure the identity of this thread is that of the local process,
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; and keep track of what that identity token actually is.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Binder.clearCallingIdentity();<br>        </span><span style="color: #0000ff;">final</span> <span style="color: #0000ff;">long</span> ident =<span style="color: #000000;"> Binder.clearCallingIdentity();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;Looper.loop()方法里起了一个死循环，不断的判断MessageQueue中的消息是否为空，如果为空则直接return掉，然后执行queue.next()方法：&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (;;) {
    Message msg &lt;/span&gt;= queue.next(); &lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; might block&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (msg == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; No message indicates that the message queue is quitting.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; This must be in a local variable, in case a UI event sets the logger&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; Printer logging =&lt;span style=&quot;color: #000000;&quot;&gt; me.mLogging;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (logging != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        logging.println(&lt;/span&gt;&quot;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; Dispatching to &quot; + msg.target + &quot; &quot; +&lt;span style=&quot;color: #000000;&quot;&gt;
                msg.callback &lt;/span&gt;+ &quot;: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; msg.what);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt; slowDispatchThresholdMs =&lt;span style=&quot;color: #000000;&quot;&gt; me.mSlowDispatchThresholdMs;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt; traceTag =&lt;span style=&quot;color: #000000;&quot;&gt; me.mTraceTag;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (traceTag != 0 &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; Trace.isTagEnabled(traceTag)) {
        Trace.traceBegin(traceTag, msg.target.getTraceName(msg));
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt; start = (slowDispatchThresholdMs == 0) ? 0&lt;span style=&quot;color: #000000;&quot;&gt; : SystemClock.uptimeMillis();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; end;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;msg.target就是Handler对象本身&lt;/span&gt;</code></pre><p><span style="color: #000000;">                msg.target.dispatchMessage(msg);<br>                end </span>= (slowDispatchThresholdMs == 0) ? 0<span style="color: #000000;"> : SystemClock.uptimeMillis();<br>            } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>                </span><span style="color: #0000ff;">if</span> (traceTag != 0<span style="color: #000000;">) {<br>                    Trace.traceEnd(traceTag);<br>                }<br>            }<br>            </span><span style="color: #0000ff;">if</span> (slowDispatchThresholdMs &gt; 0<span style="color: #000000;">) {<br>                </span><span style="color: #0000ff;">final</span> <span style="color: #0000ff;">long</span> time = end -<span style="color: #000000;"> start;<br>                </span><span style="color: #0000ff;">if</span> (time &gt;<span style="color: #000000;"> slowDispatchThresholdMs) {<br>                    Slog.w(TAG, </span>“Dispatch took “ + time + “ms on “<br>                            + Thread.currentThread().getName() + “, h=” +<span style="color: #000000;"><br>                            msg.target </span>+ “ cb=” + msg.callback + “ msg=” +<span style="color: #000000;"> msg.what);<br>                }<br>            }</span></p>
<pre><code>        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (logging != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            logging.println(&lt;/span&gt;&quot;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; Finished to &quot; + msg.target + &quot; &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; msg.callback);
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Make sure that during the course of dispatching the
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; identity of the thread wasn&apos;t corrupted.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt; newIdent =&lt;span style=&quot;color: #000000;&quot;&gt; Binder.clearCallingIdentity();
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (ident !=&lt;span style=&quot;color: #000000;&quot;&gt; newIdent) {
            Log.wtf(TAG, &lt;/span&gt;&quot;Thread identity changed from 0x&quot;
                    + Long.toHexString(ident) + &quot; to 0x&quot;
                    + Long.toHexString(newIdent) + &quot; while dispatching to &quot;
                    + msg.target.getClass().getName() + &quot; &quot;
                    + msg.callback + &quot; what=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; msg.what);
        }

        msg.recycleUnchecked();
    }
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>又回到Handler.java</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">Handle.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Handle system messages here.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> dispatchMessage(Message msg) {
        </span><span style="color: #0000ff;">if</span> (msg.callback != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            handleCallback(msg);
        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
            </span><span style="color: #0000ff;">if</span> (mCallback != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (mCallback.handleMessage(msg)) {
                    </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
                }
            }
            handleMessage(msg);
        }
    }

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; handleCallback(Message message) {
    message.callback.run();
}
&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h3>补充: UI线程 调用 Loop.</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>    <span style="color: #008000;">//</span><span style="color: #008000;">ActivityThread.java</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {
        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, </span>"ActivityThreadMain"<span style="color: #000000;">);
        SamplingProfilerIntegration.start();

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; CloseGuard defaults to true and can be quite spammy.  We
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; disable it here, but selectively enable it later (via
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; StrictMode) on debug builds, but using DropBox, not logs.&lt;/span&gt;
CloseGuard.setEnabled(&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

Environment.initForCurrentUser();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Set the reporter for event logging in libcore&lt;/span&gt;
EventLogger.setReporter(&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; EventLoggingReporter());

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Make sure TrustedCertificateStore looks in the right place for CA certificates&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; File configDir =&lt;span style=&quot;color: #000000;&quot;&gt; Environment.getUserConfigDirectory(UserHandle.myUserId());
TrustedCertificateStore.setDefaultUserDirectory(configDir);

Process.setArgV0(&lt;/span&gt;&quot;&amp;lt;pre-initialized&amp;gt;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);

Looper.prepareMainLooper();

ActivityThread thread &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ActivityThread();
thread.attach(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (sMainThreadHandler == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    sMainThreadHandler &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; thread.getHandler();
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    Looper.myLooper().setMessageLogging(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
            LogPrinter(Log.DEBUG, &lt;/span&gt;&quot;ActivityThread&quot;&lt;span style=&quot;color: #000000;&quot;&gt;));
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; End of event ActivityThreadMain.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">主线程启动就调用了loop().</span><br><span style="color: #000000;">        Looper.loop();</span></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Main thread loop unexpectedly exited&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h2><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180707123851869-829464379.png" alt></h2>
<h2>三.总结:</h2>
<p>一.Handler,Looper,MessageQue三者关系&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;</p>
<p>　　1.Looper：相当于消息的载体<br><br>&nbsp;&nbsp;&nbsp;&nbsp; 　　1) 它的内部有一个消息队列，也就是MessageQueue，Handler发送的所有消息都会走向这个消息队里。<br><br>&nbsp;&nbsp;&nbsp;&nbsp; 　　2) 它的Looper.loop方法是一个死循环，不断的从消息队列MessageQueue中取出消息。如果有消息存在就处理该消息，否则就阻塞。<br><br>&nbsp;&nbsp; &nbsp;2.MessageQue：就是一个消息队列，可以向其中添加消息并处理消息。<br><br>&nbsp;&nbsp; &nbsp;3.Handler其实就是发送消息处理消息的封装。它与Looper相关联，也就是说在Handler的内部可以找到Looper，找到了Looper就找到了相应的消息队列。因此Handler发送的消息都会走向MessageQueue。<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; </p>
<p>&nbsp;二.为什么不能在子线程中更新UI&nbsp;&nbsp; &nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 如果在子线程更新UI，那么就会出现这样子的一种况：其中一个子线程更新界面还没有完成，另外一个子线程就又去更新UI了，这样子会造成子UI界面错乱。那么你可能会说，我们可以实行加锁机制啊，让更新UI的代码不能并发执行。如果每一个子线程都加锁，那么 毫无疑问程序的性能将会大大下降。因此主要的原因总结起来就是两点：<br><br>&nbsp;&nbsp; &nbsp;（1）为了防止界面错乱<br><br>&nbsp;&nbsp; &nbsp;（2）为了防止程序性能下降<br><br>&nbsp;&nbsp;&nbsp;&nbsp; 因此android不允许在子线程中更新UI。为了解决这个这个问题，android就设计出这样子的一套消息处理机制，让我们尽管在子线程中发送更新UI的消息，而不用去关心多线程问题。在主线程的消息队里中采取轮询更新处理。</p>
<pre><span style="color: #000000;">&nbsp;</span></pre>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/07/Android源码分析四Handler异步消息机制/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/07/Android源码分析四Handler异步消息机制/" title="Android 源码分析（四） Handler 异步消息机制">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/img/thumbnail/7.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/设计模式/">设计模式</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/06/23种设计模式在Android中的应用/">
    		23种设计模式在Android中的应用
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2018-07-06T15:37:49.000Z">2018-07-06</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/设计模式/" title="设计模式">设计模式</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/java_design.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p>所有江湖偶遇,都是宿命相逢 ----《逆水寒》，只是觉得文案不错，就用了。哈哈！</p>
<h2><strong>一.设计原则：</strong></h2>
<p>单一职责原则（SRP）：任何一个对象都应给只有一个单独的职责(“低耦合，高内聚”)<br>里氏替换原则（LSP）：在任何父类出现的地方都可以用子类替换<br>依赖注入原则（DIP）：要依赖于抽象而不是依赖于具体实现（此原则是开闭原则的基础）<br>接口分离原则（ISP）：不应该强迫他们的客户程序依赖他们不需要的方法<br>迪米特原则（LOD）：一个对象应该对其他对象尽可能少的了解，意思就是降低各个对象之间的耦合。<br>开闭原则（OCP）：一个对对象对扩展是开放的，对修改是关闭的。</p>
<h2>二.23中设计模式</h2>
<p>1.<strong>工厂模式(Factory Pattern)：</strong>在工厂模式中，客户类与工厂来是分开的，消费者任何时候需要产品只需要向工厂请求就好，消费者无需修改就可以接纳新产品。缺点是：当前产品修改是工厂也需要修改。</p>
<p>2.<strong>建造模式(Builder Pattern)：</strong>将产品的内部表象和产品的生成过程分割开来，从而使一个建造过程生成具有不同表象的产品，建造模式使得产品内部表象可以独立的变化，客户不必知道产品的内部细节。建造模式可以强制实行一种分步骤的建造过程。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('0227c0ad-92ec-4e6d-bd4d-2cbd65fe0531')"><img id="code_img_closed_0227c0ad-92ec-4e6d-bd4d-2cbd65fe0531" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_0227c0ad-92ec-4e6d-bd4d-2cbd65fe0531" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('0227c0ad-92ec-4e6d-bd4d-2cbd65fe0531',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_0227c0ad-92ec-4e6d-bd4d-2cbd65fe0531" class="cnblogs_code_hide">
<pre>AlertDialog.Builder builder  = <span style="color: #0000ff;">new</span> AlertDialog.Builder(<span style="color: #0000ff;">this</span><span style="color: #000000;">);
        builder.setTitle(</span>""<span style="color: #000000;">)
                .setIcon(R.drawable.ic_launcher_foreground)
                .setView(R.layout.activity_main)
                .setOnKeyListener(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> DialogInterface.OnKeyListener() {
                    @Override
                    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> onKey(DialogInterface dialogInterface, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i, KeyEvent keyEvent) {
                        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
                    }
                })
                .setOnCancelListener(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> DialogInterface.OnCancelListener() {
                    @Override
                    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCancel(DialogInterface dialogInterface) {

<pre><code>    }
})
.create().show();&lt;/span&gt;&lt;/pre&gt;</code></pre></span></pre></div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>3.<strong>工厂方法模式(Abstract Factory Pattern)：</strong>在工厂方法模式中，核心工厂类不再负责所有的产品的创建，而是将具体创建工作交给子类处理，成为一个抽象角色，仅负责给出具体工厂必须实现的接口，而不接触某款产品的实例化细节。</p>
<p>4.<strong>原型模型模式(Prototype Pattern)：</strong>原型模型是通过给定一个原型对象来指明要创建的的对象类型，可以用复制这个对象的方法创建更多的对象，原型模型允许动态的增加或减少产品类。缺点是：每一个类必须配备一个克隆方法。</p>
<p>5.<strong>单例模式（Singleton Pattern）：</strong>确保某一个类只有一个实例，而且自行实例化并向整个系统提供这个实例单例模式。</p>
<p>- 饿汉式单例</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<div class="cnblogs_code_toolbar">public class Singleton {<br>&nbsp;&nbsp;&nbsp;&nbsp;private Singleton(){}<br>&nbsp;&nbsp;&nbsp;&nbsp;private static Singleton instance = new Singleton();<br>&nbsp;&nbsp;&nbsp;&nbsp;public static Singleton getInstance(){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return instance;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}</div>





<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>-懒汉式单例</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<div class="cnblogs_code_toolbar">
<p>/**<br>&nbsp;* Singleton helper class for lazily initialization.<br>&nbsp;*<br>&nbsp;* Modeled after frameworks/base/include/utils/Singleton.h<br>&nbsp;*<br>&nbsp;* @hide<br>&nbsp;*/<br>public abstract class Singleton&lt;T&gt; {<br>&nbsp;&nbsp;&nbsp; private T mInstance;</p>
<p>&nbsp;&nbsp;&nbsp; protected abstract T create();</p>
<p>&nbsp;&nbsp;&nbsp; public final T get() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; synchronized (this) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (mInstance == null) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mInstance = create();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return mInstance;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}</p>





</div>





<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>　　饿汉模式是在系统运行起来,在装在类的时候就进行初始化的操作,外部对象使用的时候不需要做任何判断可以直接使用,从效率上来说是优于懒汉模式的.但是对比懒汉模式的延迟加载技术,不管系统用不用该实例,内存都会在最开始的时候创建出来.跟懒汉的时间换空间正好相反,饿汉是空间换时间。</p>
<p>6.<strong>适配器模式(Adapter Pattern)：</strong>把我一个类的接口变化成客户端期望的另一个接口。</p>
<p>Adapter.java Android8.0源码</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('bb2ee639-be31-4b15-845a-77ea4c283247')"><img id="code_img_closed_bb2ee639-be31-4b15-845a-77ea4c283247" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_bb2ee639-be31-4b15-845a-77ea4c283247" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('bb2ee639-be31-4b15-845a-77ea4c283247',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_bb2ee639-be31-4b15-845a-77ea4c283247" class="cnblogs_code_hide">
<pre><span style="color: #008000;">/**</span><span style="color: #008000;">
 * adapter 对象充当 AdapterView 和该View展现数据的桥梁。提供对数据的访问。
 * 还负责每一个 android.view.View 控件的数据集控制。
 * </span><span style="color: #808080;">@see</span><span style="color: #008000;"> android.widget.ArrayAdapter
 * </span><span style="color: #808080;">@see</span><span style="color: #008000;"> android.widget.CursorAdapter
 * </span><span style="color: #808080;">@see</span><span style="color: #008000;"> android.widget.SimpleCursorAdapter
 </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Adapter {
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * Register an observer that is called when changes happen to the data used by this adapter.
     * 当这个适配器使用的数据放生变化时候，注册一个观察者
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> observer the object that gets notified when the data set changes.
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> observer 当数据集发生变化，得到通知的对象
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">void</span><span style="color: #000000;"> registerDataSetObserver(DataSetObserver observer);

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Unregister an observer that has previously been registered with this
 * adapter via {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #registerDataSetObserver}.
 * 该方法是注销观察者作用，
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; observer the object to unregister.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; observer 需要注销的观察者
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; unregisterDataSetObserver(DataSetObserver observer);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * How many items are in the data set represented by this Adapter.
 * adapter数据集大小
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Count of items.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; 返回数据集大小
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; getCount();   

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Get the data item associated with the specified position in the data set.
 * 返回数据集对应索引（position）的数据项对象
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; position Position of the item whose data we want within the adapter&apos;s 
 * data set.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The data at the specified position.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
Object getItem(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; position);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Get the row id associated with the specified position in the list.
 * 返回数据集对应索引（position）的数据项Id
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; position The position of the item within the adapter&apos;s data set whose row id we want.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The id of the item at the specified position.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt; getItemId(&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; position);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Indicates whether the item ids are stable across changes to the
 * underlying data.
 * 如果相同的ID总是引用相同的对象，则为true。
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; True if the same id always refers to the same object.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; hasStableIds();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Get a View that displays the data at the specified position in the data set. You can either
 * create a View manually or inflate it from an XML layout file. When the View is inflated, the
 * parent View (GridView, ListView...) will apply default layout parameters unless you use
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; android.view.LayoutInflater#inflate(int, android.view.ViewGroup, boolean)}
 * to specify a root view and to prevent attachment to the root.
 * 返回数据集中对应索引（position）指定的View。同样也可以创建一个视图或者通过xml布局inflate。
 * 如果是通过inflate获取视图时候，&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; parent 可以是GridView 或者ListView等控件。
 * 除非你用{&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; android.view.LayoutInflater#inflate(int, android.view.ViewGroup, boolean)}指定根视图并防止附着，否则使用默认的布局参数。
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; position The position of the item within the adapter&apos;s data set of the item whose view
 *        we want.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; position 我们想要返回的视图,对应数据集索引（position）
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; convertView The old view to reuse, if possible. Note: You should check that this view
 *        is non-null and of an appropriate type before using. If it is not possible to convert
 *        this view to display the correct data, this method can create a new view.
 *        Heterogeneous lists can specify their number of view types, so that this View is
 *        always of the right type (see {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getViewTypeCount()} and
 *        {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getItemViewType(int)}).
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; convertView 如果可以，重用旧视图。注意：需要检查视图不是null并且是适当的类型。如果不能重用，可以创建一个视图。
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; parent The parent that this view will eventually be attached to
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; parent 根视图
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; A View corresponding to the data at the specified position.
 * 返回呈现数据集索引对应数据项的视图。
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
View getView(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; position, View convertView, ViewGroup parent);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * An item view type that causes the {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; AdapterView} to ignore the item
 * view. For example, this can be used if the client does not want a
 * particular view to be given for conversion in
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getView(int, View, ViewGroup)}.
 * 
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@see&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getItemViewType(int)
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@see&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getViewTypeCount()
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; IGNORE_ITEM_VIEW_TYPE =&lt;span style=&quot;color: #000000;&quot;&gt; AdapterView.ITEM_VIEW_TYPE_IGNORE;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Get the type of View that will be created by {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getView} for the specified item.
 * 
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; position The position of the item within the adapter&apos;s data set whose view type we
 *        want.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; An integer representing the type of View. Two views should share the same type if one
 *         can be converted to the other in {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getView}. Note: Integers must be in the
 *         range 0 to {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getViewTypeCount} - 1. {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #IGNORE_ITEM_VIEW_TYPE} can
 *         also be returned.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@see&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #IGNORE_ITEM_VIEW_TYPE
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; getItemViewType(&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; position);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * &amp;lt;p&amp;gt;
 * Returns the number of types of Views that will be created by
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getView}. Each type represents a set of views that can be
 * converted in {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; #getView}. If the adapter always returns the same
 * type of View for all items, this method should return 1.
 * &amp;lt;/p&amp;gt;
 * &amp;lt;p&amp;gt;
 * This method will only be called when the adapter is set on the {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; AdapterView}.
 * &amp;lt;/p&amp;gt;
 * 
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The number of types of Views that will be created by this adapter
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; getViewTypeCount();

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; NO_SELECTION =&lt;span style=&quot;color: #000000;&quot;&gt; Integer.MIN_VALUE;

 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
  * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; true if this adapter doesn&apos;t contain any data.  This is used to determine
  * whether the empty view should be displayed.  A typical implementation will return
  * getCount() == 0 but since getCount() includes the headers and footers, specialized
  * adapters might want a different behavior.
  &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
 &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; isEmpty();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Gets a string representation of the adapter data that can help
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; android.service.autofill.AutofillService} autofill the view backed by the adapter.
 *
 * &amp;lt;p&amp;gt;
 * It should only be set (i.e., non-{&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@code&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; null} if the values do not represent PII
 * (Personally Identifiable Information - sensitive data such as email addresses,
 * credit card numbers, passwords, etc...). For
 * example, it&apos;s ok to return a list of month names, but not a list of usernames. A good rule of
 * thumb is that if the adapter data comes from static resources, such data is not PII - see
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; android.view.ViewStructure#setDataIsSensitive(boolean)} for more info.
 *
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@code&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; null} by default, unless implementations override it.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;default&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; @Nullable CharSequence[] getAutofillOptions() {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>7.<strong>桥接模式(Bridge Pattern)：</strong>将抽象化和实现化脱耦，使得二者可以独立变化，也就是说，将他们的强关联变成弱关联，即软件系统使用的是组合/聚合关系而不是继承关系，从而使两者可以独立变化。</p>
<p>8.<strong>合成模式(Composite Pattern)：</strong>将对象组合成树形结构以表示“部分-整体”的层次结构，使得用户对单个对象和组合对象的使用具有一致性</p>
<p>9.<strong>装饰者模式(Decorator Pattern)：</strong>装饰者模式以客户端透明的方式扩展对象的功能，是继承方案的一个替代方案，提供了比继承更多的灵活性，动态的的给一个对象添加功能，这些功能又可以动态的撤销。可增加又一些基本功能排列组合产生非常强大的功能。</p>
<p>10.<strong>门面模式(Facade Pattern)：</strong>外部与一个子系统通信必须通过一个门面对象进行，门面模式提供一个高层次的接口，使得子系统更容易使用。每一个子系统只有一个门面类，而且此门面类只有一个实例，单整个系统可以有多个门面类。</p>
<p>11.<strong>享元模式(Flyweight Pattern)：</strong>使用共享对象可有效地支持大量的细粒度对象。</p>
<p>12.<strong>代理模式(Proxy pattern)：</strong>给某一个对象创建一个代理对象，并由代理对象控制源对象的应用。</p>
<p>13.<strong>责任链模式(chain of responsinbleity Pattern)：</strong>使多个对象有机会处理请求，从而避免了请求的发送者和接收者之间的耦合关系 。将这些对象连成一个链，并沿着这条链传递请求，知道有对象处理它为止</p>
<p>14.<strong>命令模式(cmd Pattern)：</strong>将一个请求封装成一个对象，从而让你使用不同的请求把客户端参数化，对请求排队或者记录请求日志，可以提供命令的撤销和恢复功能。</p>
<p>15<strong>.解释器模式(Interpreter Pattern)：</strong>给定一门语言，定义它的文法的一种表示，并定义一个解释器，该解释器使用该表示来解释语言中的句子。</p>
<p>16.<strong>迭代子模式(Iterator Pattern)：</strong>它提供一种方法访问一个容器对象中各个元素，而又不需要暴露该对象的内部细节。</p>
<p>17.<strong>调停者模式(mediator Pattern )：</strong>调停者模式包装了一系列对象相互作用的方式，使得这些对象不必相互明显作用。从而使他们可以松散偶合。当某些对象之间的作用发生改变时，不会立即影响其他的一些对象之间的作用。保证这些作用可以彼此独立的变化。调停者模式将多对多的相互作用转化为一对多的相互作用。调停者模式将对象的行为和协作抽象化，把对象在小尺度的行为上与其他对象的相互作用分开处理。</p>
<p>18.<strong>备忘录模式(Memento Pattern)：</strong>在不破坏封装的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态，这样以后就可将该对象恢复到原来保存的状态。</p>
<p>19.<strong>观察者模式(Observer Pattern)：</strong>定义对象间一种一对多的依赖关系，使得每当一个对象改变状态，则所有依赖于它的对象都会得到通知并被自动更新</p>
<p>20.<strong>状态模式(state Pattern )：</strong>当一个对象在状态改变时允许其改变行为，这个对象看起来像改变了其类。</p>
<p>21.<strong>策略模式(Strategy Pattern)：</strong>定义一组算法，将每个算法都封装起来，并且使他们之间可以互换</p>
<p>22.<strong>模板方法模式(Template Method Pattern)：</strong></p>
<p>23.<strong>访问者模式(Visitor Pattern)：</strong>封装一些作用于某种数据结构中的各种元素，它可以在不改变数据结构的前提下定义作用于这些元素的新的操作</p>
<p><br>参考：<br>https://blog.csdn.net/forwujinwei/article/details/79050044</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/06/23种设计模式在Android中的应用/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/06/23种设计模式在Android中的应用/" title="23种设计模式在Android中的应用">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/img/thumbnail/6.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/后端/">后端</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/01/Java基础面试题汇总/">
    		Java基础面试题汇总
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2018-06-30T20:16:31.000Z">2018-07-01</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/面试/" title="面试">面试</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/java_interview.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p><strong>1. java 中 wait()与sleep() 区别</strong>：<br>答：两者都是暂停当前运行的线程。sleep()是Thread类的方法；wait()是Object类的方法 。调用sleep()，线程不会释放对象锁，其他线程依然无法访问这个对象；调用wait(),线程会释放对象锁，其他线程能访问这个对象。</p>
<p><strong>2. java中代表价格的数据类型用哪个BigDecimal还是double？</strong><br>答：如果需要精确计算的结果，使用BigDecimal类，但是比较消耗内存和性能；否则可以直接使用float或double。</p>
<p><strong>3. a = a + b 与 a += b 的区别？</strong><br>答：内存上分析：如果加法操作的结果比 a 的最大值要大，则 a+b 会出现编译错误；但是 a += b 没问题，+= 隐式的将加操作的结果类型强制转换为持有结果的类型。</p>
<p><strong>4. 我们能在 Switch 中使用 String 吗？</strong><br>答：从 Java 7 开始，我们可以在 switch case 中使用字符串，但这仅仅是一个语法糖。内部实现在 switch 中使用字符串的 hash code。从Java 5开始，Java中引入了枚举类型enum。</p>
<p><strong>5. Java 中 WeakReference（弱引用） 与 SoftReference（软引用）的区别？</strong><br>答： WeakReference 与 SoftReference 都有利于提高 GC 和 内存的效率。 WeakReference ，一旦失去最后一个强引用，就会被 GC 回收；软引用可以延迟到 JVM 内存不足的时候被 GC 回收。</p>
<p><strong>6. Java 中堆和栈有什么区别？</strong><br>答：JVM中堆和栈是不同的内存区域。栈用于保存方法的一些基本类型的变量和对象的引用变量，当超过变量的作用域后，java会自动释放掉为该变量分配的内存空间；堆内存用于存放由new创建的对象，由JVM的GC来管理。</p>
<p><strong>7. “a==b”和”a.equals(b)”有什么区别？</strong><br>答：如果 a 和 b 都是对象，则 a==b 是比较两个对象的引用，只有当 a 和 b 指向的是堆中的同一个对象才会返回 true，而 a.equals(b)是比较逻辑一致，两个对象必须具有相同的 hashCode才返回true，所以通常需要重写equals()方法来提供逻辑一致性的比较。</p>
<p><strong>8. ArrayList 与 LinkedList 的区别？</strong><br>答：都实现了List接口。<br>1.ArrayList是实现了基于动态数组的数据结构，LinkedList基于链表的数据结构。&nbsp;<br>2.对于随机访问get和set，ArrayList觉得优于LinkedList，因为LinkedList要移动指针。&nbsp;<br>3.对于新增和删除操作add和remove，LinedList比较占优势，因为ArrayList要移动数据。</p>
<p><strong>9. String和StringBuilder、StringBuffer的区别？</strong><br>答：String是只读字符串，也就意味着String引用的字符串内容是不能被改变的。<br>而StringBuffer/StringBuilder类表示的字符串对象可以直接进行修改。StringBuilder是Java 5中引入的，它和StringBuffer的方法完全相同，区别在于它是在单线程环境下使用的，因为它的所有方面都没有被synchronized修饰，因此它的效率也比StringBuffer要高。<br>在线程安全上，StringBuilder是线程不安全的，而StringBuffer是线程安全的。</p>
<p><br><strong>10. 抽象类（abstract class）和接口（interface）有什么异同？</strong><br>答：抽象类和接口都不能够实例化，但可以定义抽象类和接口类型的引用。一个类如果继承了某个抽象类或者实现了某个接口都需要对其中的抽象方法全部进行实现，否则该类仍然需要被声明为抽象类。接口比抽象类更加抽象，因为抽象类中可以定义构造器，可以有抽象方法和具体方法，而接口中不能定义构造器而且其中的方法全部都是抽象方法。抽象类中的成员可以是private、默认、protected、public的，而接口中的成员全都是public的。抽象类中可以定义成员变量，而接口中定义的成员变量实际上都是常量。有抽象方法的类必须被声明为抽象类，而抽象类未必要有抽象方法。</p>
<p><strong>11. 用Java写一个单例类。</strong><br>答：<br>- 饿汉式单例</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Singleton {
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Singleton(){}
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Singleton instance = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Singleton();
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Singleton getInstance(){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">return</span><span style="color: #000000;"> instance;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>-懒汉式单例</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Singleton {
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Singleton instance = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Singleton() {}
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> Singleton getInstance(){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">if</span> (instance == <span style="color: #0000ff;">null</span>) instance ＝ <span style="color: #0000ff;">new</span><span style="color: #000000;"> Singleton();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">return</span><span style="color: #000000;"> instance;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/01/Java基础面试题汇总/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/01/Java基础面试题汇总/" title="Java基础面试题汇总">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/img/thumbnail/1.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    

    
    <nav class="page-navigator">
        <a class="extend prev" rel="prev" href="/archives/2018/07/page/2/">前一页</a><a class="page-number" href="/archives/2018/07/">1</a><a class="page-number" href="/archives/2018/07/page/2/">2</a><span class="page-number current">3</span>
    </nav>
    


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/后端/">后端</a>
        <span class="badge">(21)</span>
    </li>
    
    <li>
        <a href="/categories/Android/">Android</a>
        <span class="badge">(52)</span>
    </li>
    
    <li>
        <a href="/categories/后端/CSharp/">CSharp</a>
        <span class="badge">(14)</span>
    </li>
    
    <li>
        <a href="/categories/Android/开源框架/">开源框架</a>
        <span class="badge">(17)</span>
    </li>
    
    <li>
        <a href="/categories/Android/kotlin/">kotlin</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="/categories/Android/安卓源码/">安卓源码</a>
        <span class="badge">(15)</span>
    </li>
    
    <li>
        <a href="/categories/Android/知识点/">知识点</a>
        <span class="badge">(18)</span>
    </li>
    
    <li>
        <a href="/categories/GitHub/">GitHub</a>
        <span class="badge">(5)</span>
    </li>
    
    <li>
        <a href="/categories/后端/JAVA/">JAVA</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/心情/">心情</a>
        <span class="badge">(10)</span>
    </li>
    
    <li>
        <a href="/categories/前端/">前端</a>
        <span class="badge">(5)</span>
    </li>
    
    <li>
        <a href="/categories/后端/PHP/">PHP</a>
        <span class="badge">(6)</span>
    </li>
    
    <li>
        <a href="/categories/设计模式/">设计模式</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/日期格式化/" title="日期格式化">日期格式化 (1)</a>
  
    <a class="tag-item" href="/tags/Linq/" title="Linq">Linq (1)</a>
  
    <a class="tag-item" href="/tags/visualStudio/" title="visualStudio">visualStudio (2)</a>
  
    <a class="tag-item" href="/tags/coroutine协程/" title="coroutine协程">coroutine协程 (1)</a>
  
    <a class="tag-item" href="/tags/view绘制/" title="view绘制">view绘制 (1)</a>
  
    <a class="tag-item" href="/tags/线程切换/" title="线程切换">线程切换 (1)</a>
  
    <a class="tag-item" href="/tags/屏幕适配/" title="屏幕适配">屏幕适配 (1)</a>
  
    <a class="tag-item" href="/tags/开源框架/" title="开源框架">开源框架 (17)</a>
  
    <a class="tag-item" href="/tags/安卓源码/" title="安卓源码">安卓源码 (15)</a>
  
    <a class="tag-item" href="/tags/面试/" title="面试">面试 (2)</a>
  
    <a class="tag-item" href="/tags/地图/" title="地图">地图 (2)</a>
  
    <a class="tag-item" href="/tags/hexo/" title="hexo">hexo (4)</a>
  
    <a class="tag-item" href="/tags/IIS/" title="IIS">IIS (2)</a>
  
    <a class="tag-item" href="/tags/SqlServer/" title="SqlServer">SqlServer (1)</a>
  
    <a class="tag-item" href="/tags/ViewPager/" title="ViewPager">ViewPager (1)</a>
  
    <a class="tag-item" href="/tags/XMLHttpRequest/" title="XMLHttpRequest">XMLHttpRequest (1)</a>
  
    <a class="tag-item" href="/tags/增量更新/" title="增量更新">增量更新 (1)</a>
  
    <a class="tag-item" href="/tags/电影/" title="电影">电影 (4)</a>
  
    <a class="tag-item" href="/tags/fiddler/" title="fiddler">fiddler (1)</a>
  
    <a class="tag-item" href="/tags/副业/" title="副业">副业 (1)</a>
  
    <a class="tag-item" href="/tags/职业生涯/" title="职业生涯">职业生涯 (1)</a>
  
    <a class="tag-item" href="/tags/Activity/" title="Activity">Activity (1)</a>
  
    <a class="tag-item" href="/tags/BroadcastReceiver/" title="BroadcastReceiver">BroadcastReceiver (1)</a>
  
    <a class="tag-item" href="/tags/职业发展/" title="职业发展">职业发展 (1)</a>
  
    <a class="tag-item" href="/tags/跳槽/" title="跳槽">跳槽 (2)</a>
  
    <a class="tag-item" href="/tags/图片保存/" title="图片保存">图片保存 (1)</a>
  
    <a class="tag-item" href="/tags/习惯/" title="习惯">习惯 (1)</a>
  
    <a class="tag-item" href="/tags/c/" title="c#">c# (1)</a>
  
    <a class="tag-item" href="/tags/easyui/" title="easyui">easyui (2)</a>
  
    <a class="tag-item" href="/tags/php/" title="php">php (1)</a>
  
    <a class="tag-item" href="/tags/Android/" title="Android">Android (2)</a>
  
    <a class="tag-item" href="/tags/kotlin/" title="kotlin">kotlin (1)</a>
  
    <a class="tag-item" href="/tags/序列化/" title="序列化">序列化 (1)</a>
  
    <a class="tag-item" href="/tags/mongodb/" title="mongodb">mongodb (1)</a>
  
    <a class="tag-item" href="/tags/评论插件/" title="评论插件">评论插件 (1)</a>
  
    <a class="tag-item" href="/tags/正则表达式/" title="正则表达式">正则表达式 (1)</a>
  
    <a class="tag-item" href="/tags/AIDL/" title="AIDL">AIDL (1)</a>
  
    <a class="tag-item" href="/tags/公众号/" title="公众号">公众号 (1)</a>
  
    <a class="tag-item" href="/tags/设计模式/" title="设计模式">设计模式 (1)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" target="_blank" title="稀土掘金">稀土掘金</a>
        </li>
    
        <li>
            <a href="https://www.cnblogs.com/bugzone" target="_blank" title="博客园">博客园</a>
        </li>
    
        <li>
            <a href="https://weibo.com/230689567" target="_blank" title="新浪微博">新浪微博</a>
        </li>
    
        <li>
            <a href="https://www.jianshu.com/u/ba21180e6aab" target="_blank" title="简书">简书</a>
        </li>
    
        <li>
            <a href="https://github.com/freefuncode/" target="_blank" title="GitHub">GitHub</a>
        </li>
    
        <li>
            <a href="https://freefuncode.github.io/GitBook" target="_blank" title="GitBook">GitBook</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2019
    

    <a href="/">Jelon Loves You</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->
<script src="/js/main.js"></script>
</body>
</html>