<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8">
    <meta name="baidu-site-verification" content="dIcXMeY8Ya">
    
    <title>`安卓源码`标签下的文章 | 网记本</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="keywords" content="freefuncode, Android, Kotlin, 网络记事本, 网记本">
    <meta name="description" content="FreeFunCode网络记事本">

    
    <link rel="alternative" href="/atom.xml" title="网记本" type="application/atom+xml">
    
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?3771b2566860fea0de20c35742671f53";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');</script></head>
<body class="home">

    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">网记本</span>
                    <span class="description">网络记事本-huangguangzhi</span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/tags/安卓源码/index.html" class="item ">
                <a href="/" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="/tags/安卓源码/index.html" class="item ">
                <a href="/lab/" title="时间线" class="icon-lab">&nbsp;时间线</a>
            </li>
            
            <li rel="/tags/安卓源码/index.html" class="item ">
                <a href="/about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="/tags/安卓源码/index.html" class="item ">
                <a href="/comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="" target="_blank">good good study ,day day up!</a>
                        |
                    
                        <a href="" target="_blank">利用碎片化时间挖掘知识深度！</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" class="juejin" target="_blank"><b>■</b> 稀土掘金</a>
                    
                        <a href="https://weibo.com/230689567" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/user.png" alt="avatar" title="FreeFunCode">
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 按标签分类 -->

    <h3 class="widget-hd">
        <strong>
            
                `安卓源码`标签下的文章
            
        </strong>
    </h3>
    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/22/Android进阶学习笔记整理/">
    		Android进阶学习笔记整理
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-22T08:27:43.000Z">2018-07-22</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/9350418.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <div>
<h2>一．android系统架构图及各层介绍</h2>
<p style="text-align: center;"><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722160006222-1427704878.jpg" alt=""></p>
<strong>1. 应用层</strong>：应用是用java语言编写的运行在虚拟机上的程序，比如通讯录，日历,电话，短信，浏览器等。</div>
<div><br><strong>2. 应用框架层</strong>：这一层是编写Google发布的核心应用时所使用的API框架，开发人员同样可以使用这些框架来开发自己的应用，这样便简化了程序开发的结构设计，但是必须要遵守其框架的开发原则。应用程序框架层包括活动管理器、窗口管理器、内容提供者、视图系统、包管理器、电话管理器、资源管理器、位置管理器、通知管理器和XMPP服务十个部分。</div>
<div><br><strong>3. 统运行库（C/C++库以及Android运行库）层</strong>：当使用Android应用框架时，Android系统会通过一些C/C++库来支持我们使用的各个组件，使其更好的为我们服务，比如其中的SQLite（关系数据库），Webkit，chromium（Web浏览器引擎），Dalivk,ART(Android Runtime)。</div>
<div><br><strong>4.Linux内核层</strong>：Android的核心系统服务基于Linux内核，如安全性、内存管理、进程管理、用户权限管理、网络协议栈和驱动模型等都依赖于该内核，比如Binder IPC(Internet Process Connection进程间通信)驱动，android的一个特殊驱动程序，具有单独的设备节点，提供进程间通信的功能。</div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; </div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; 若是从事Android应用开发，那应该研究Android的应用框架层和应用程序层；若是从事Android系统开发，那应该研究Android的系统库和Android运行时；若是从事Android驱动开发，那应该研究Android的Linux内核。找准定位，事倍功半。</div>
<div>
<h2>二. 随笔整理（导读）</h2>
<h3>Android 应用层：</h3>







</div>
<div><ol>
<li><a id="homepage1_HomePageDays_DaysList_ctl05_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/activity_lifecycle.html" target="_blank">Android 四大组件 (一) Activity 生命周期</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl02_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/android_service.html" target="_blank">Android 四大组件 (二) Service 使用</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/BroadcastReceiver.html" target="_blank">Android 四大组件 (三) BroadcastReceiver 介绍</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ContentProvider.html" target="_blank">Android 四大组件 (四) ContentProvider介绍</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl02_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/fragment.html" target="_blank">Android 四大组件 (五) 第五大组件 - Fragment 使用</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl04_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/android8_new_features.html" target="_blank">Android 8.0新特性介绍以及注意事项</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/aidl.html" target="_blank">AIDL介绍以及简单使用</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/viewpager.html" target="_blank">ViewPager 相关使用</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_3" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/Serializable_Parcelable.html" target="_blank">Serializable和Parcelable之序列化</a></li>





</ol></div>
<h3><br>Android 框架层：</h3>
<div><ol>
<li>&nbsp;<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/readTheFuckingSourceCode.html" target="_blank">Android 源码分析（一） 开篇介绍</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl04_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/startActivity.html" target="_blank">Android 源码分析（二） Activity 启动分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl04_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/startService.html" target="_blank">Android 源码分析（三） Service 启动分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_4" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/handler.html" target="_blank">Android 源码分析（四） Handler 异步消息机制</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_3" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/zygote.html" target="_blank">Android 源码分析（五） Zygote 进程</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_2" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank">Android 源码分析（六） SystemServer 进程</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/Launcher.html" target="_blank">Android 源码分析（七） Launcher 桌面程序启动分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/Launcher_app.html" target="_blank">Android 源码分析（八） Launcher 桌面启动App过程</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/init.html" target="_blank">Android 源码分析（九） Init 启动分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl05_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/dalvik.html" target="_blank">Android 源码分析（十） Dalvik 虚拟机创建过程</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl03_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/touchEvent.html" target="_blank">Android 源码分析（十一） 事件传递机制</a><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_2" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ServiceManager.html" target="_blank" rel="noopener">Android源码分析（十二）ServiceManager服务分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_2" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ServiceManager.html" target="_blank">Android源码分析（十二）ServiceManager服务分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ActivityManagerService.html" target="_blank">Android源码分析（十三）ActivityManagerService服务分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/PackageManagerService.html" target="_blank">Android源码分析（十四）PackageManagerService服务分析</a></li>





</ol></div>
<h2>三.学习资料</h2>
<p>　　<strong>1.Android源码</strong>&nbsp;<a href="https://pan.baidu.com/s/15PNt1W4jjxZXM9o-qCC94A" target="_blank">https://pan.baidu.com/s/15PNt1W4jjxZXM9o-qCC94A</a> 密码：p3td</p>
<p>　　<strong>2.Android 6.0 离线API</strong> <a href="https://pan.baidu.com/s/17E01X32lHOrz0FN_QlXmwQ%20" target="_blank">https://pan.baidu.com/s/17E01X32lHOrz0FN_QlXmwQ </a>密码: styi</p>
<p>　　<strong>3.探索Android FrameWork底层开发视频</strong> <a href="https://pan.baidu.com/s/14BiZNm2C362afq3K-c3AJA" target="_blank">https://pan.baidu.com/s/14BiZNm2C362afq3K-c3AJA</a> 密码: i7yd</p>
<div>&nbsp; &nbsp; &nbsp; &nbsp;</div>
<div>&nbsp; &nbsp; &nbsp;&nbsp; 在学习过程中借鉴也翻阅了很多网上大牛的一些文章，加深自己的理解，如果文中未注明出处原文，还请原作者谅解，因为实在是找不到原文了。这里我推荐两个对Android 框架层研究比较透彻的两位大牛的bolg，他们帮助我加深了很多概念的理解。感谢他们。<br>　　《深入理解Android系列》丛书的作者： <a href="http://www.cnblogs.com/innost" target="_blank">http://www.cnblogs.com/innost</a><br>　　《Android系统源代码情景分析》作者：<a href="https://blog.csdn.net/Luoshengyang/" target="_blank">https://blog.csdn.net/Luoshengyang/</a></div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; 我的系列随笔只是作为一个自己的学习笔记，理解程度无法与两位大牛著作对比，但是可以作为读者或者自己初步探索Android源码和理解其实现原理的第一步。</div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; </div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; 在工作中，会发现，其实很多东西，我们都会，但是就是讲不出来。学计算机出生，保持严谨性是必须的，有时候正因为时刻的严谨性，让我们不敢轻易对一些概念东西给出自己观点，怕说错，归根到底是对其实现原理理解不够透彻，让我们畏手畏脚的进行总结。“大胆假设，小心验证” 我想这句话可以作为我们学习技术的一个参考。</div>
<div>&nbsp;</div>
<div>&nbsp;</div>
<div><span style="text-decoration: underline;">附上android知识体系图</span>：</div>
<div style="text-align: center;">　　<img src="https://images2018.cnblogs.com/blog/612293/201808/612293-20180805222343312-808261016.jpg" alt=""></div>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/22/Android进阶学习笔记整理/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/22/Android进阶学习笔记整理/" title="Android进阶学习笔记整理">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/2.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/22/Android源码分析十四PackageManagerService服务分析/">
    		Android源码分析（十四）PackageManagerService服务分析
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-22T06:59:30.000Z">2018-07-22</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/PackageManagerService.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <div>
<h3>一. PackageManagerService启动过程分析</h3>
&nbsp;PackageManagerService(PMS)主要是管理应用的安装，卸载，更新，解析以及权限。</div>
<div>　　<br>如果想了解SystemService启动过程请看这篇文章：<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_2" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank">Android 源码分析（六） SystemServer 进程</a><br>如果想了解AMS服务分析请看这篇文章：<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ActivityManagerService.html" target="_blank">Android源码分析（十三）ActivityManagerService服务分析</a></div>
<div>&nbsp;</div>
<div>同AMS一样，PMS也是由SystemServer启动的.</div>
<div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> final <span style="color: #0000ff;">class</span><span style="color: #000000;"> SystemServer {
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> PackageManagerService mPackageManagerService;
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> PackageManager mPackageManager;
    ...
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Start the package manager.
    </span><span style="color: #008000;">//</span><span style="color: #008000;">启动PMS服务</span>
    <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">mRuntimeRestart) {
        MetricsLogger.histogram(</span><span style="color: #0000ff;">null</span>, <span style="color: #800000;">"</span><span style="color: #800000;">boot_package_manager_init_start</span><span style="color: #800000;">"</span><span style="color: #000000;">,
                (</span><span style="color: #0000ff;">int</span><span style="color: #000000;">) SystemClock.elapsedRealtime());
    }
    traceBeginAndSlog(</span><span style="color: #800000;">"</span><span style="color: #800000;">StartPackageManagerService</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    mPackageManagerService </span>=<span style="color: #000000;"> PackageManagerService.main(mSystemContext, installer,
            mFactoryTestMode </span>!=<span style="color: #000000;"> FactoryTest.FACTORY_TEST_OFF, mOnlyCore);
    mFirstBoot </span>=<span style="color: #000000;"> mPackageManagerService.isFirstBoot();
    mPackageManager </span>=<span style="color: #000000;"> mSystemContext.getPackageManager();
    traceEnd();
    </span><span style="color: #0000ff;">if</span> (!mRuntimeRestart &amp;&amp; !<span style="color: #000000;">isFirstBootOrUpgrade()) {
        MetricsLogger.histogram(</span><span style="color: #0000ff;">null</span>, <span style="color: #800000;">"</span><span style="color: #800000;">boot_package_manager_init_ready</span><span style="color: #800000;">"</span><span style="color: #000000;">,
                (</span><span style="color: #0000ff;">int</span><span style="color: #000000;">) SystemClock.elapsedRealtime());
    }
    ...
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">PackageManagerService 初始化工作</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> PackageManagerService extends IPackageManager.Stub
        implements PackageSender {

<pre><code>&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;static&lt;/span&gt;&lt;span style="color: #000000;"&gt; PackageManagerService main(Context context, Installer installer,
        boolean factoryTest, boolean onlyCore) {
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Self-check for initial settings.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        PackageManagerServiceCompilerMapping.checkProperties();<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">构造一个PackageManagerService</span><br>        PackageManagerService m = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PackageManagerService(context, installer,<br>                factoryTest, onlyCore);<br>        m.enableSystemUserPackages();<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">添加到ServiceManager</span><br>        ServiceManager.addService(<span style="color: #800000;">“</span><span style="color: #800000;">package</span><span style="color: #800000;">“</span><span style="color: #000000;">, m);<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> m;<br>    }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt;&lt;span style="color: #000000;"&gt; PackageManagerService(Context context, Installer installer,
        boolean factoryTest, boolean onlyCore) {

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;installer apk的安装和卸载最终都是调用installd来实现的。&lt;/span&gt;
    mInstaller =&lt;span style="color: #000000;"&gt; installer;
    mPackageDexOptimizer &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; PackageDexOptimizer(installer, mInstallLock, context,
            &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;*dexopt*&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    mDexManager &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; DexManager(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;, mPackageDexOptimizer, installer, mInstallLock);
    mMoveCallbacks &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; MoveCallbacks(FgThread.&lt;span style="color: #0000ff;"&gt;get&lt;/span&gt;&lt;span style="color: #000000;"&gt;().getLooper());

    synchronized (mInstallLock) {
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; writer 
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;环境变量初始化&lt;/span&gt;</code></pre><p><span style="color: #000000;">        synchronized (mPackages) {<br>            File dataDir </span>=<span style="color: #000000;"> Environment.getDataDirectory();<br>            mAppInstallDir </span>= <span style="color: #0000ff;">new</span> File(dataDir, <span style="color: #800000;">“</span><span style="color: #800000;">app</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br>            mAppLib32InstallDir </span>= <span style="color: #0000ff;">new</span> File(dataDir, <span style="color: #800000;">“</span><span style="color: #800000;">app-lib</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br>            mAsecInternalPath </span>= <span style="color: #0000ff;">new</span> File(dataDir, <span style="color: #800000;">“</span><span style="color: #800000;">app-asec</span><span style="color: #800000;">“</span><span style="color: #000000;">).getPath();<br>            mDrmAppPrivateInstallDir </span>= <span style="color: #0000ff;">new</span> File(dataDir, <span style="color: #800000;">“</span><span style="color: #800000;">app-private</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br>            sUserManager </span>= <span style="color: #0000ff;">new</span> UserManagerService(context, <span style="color: #0000ff;">this</span><span style="color: #000000;">,<br>                    </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> UserDataPreparer(mInstaller, mInstallLock, mContext, mOnlyCore), mPackages);</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;权限注册到 package manager，一个权限与几个组ID对应，当一个APK授予这个权限时，它同属于这几个组。
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;权限是一个复杂的过程
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Propagate permission configuration in to package manager.&lt;/span&gt;
ArrayMap&amp;lt;String, SystemConfig.PermissionEntry&amp;gt;&lt;span style="color: #000000;"&gt; permConfig
        &lt;/span&gt;=&lt;span style="color: #000000;"&gt; systemConfig.getPermissions();
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;遍历权限配置文件&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; i=&lt;span style="color: #800080;"&gt;0&lt;/span&gt;; i&amp;lt;permConfig.size(); i++&lt;span style="color: #000000;"&gt;) {
    SystemConfig.PermissionEntry perm &lt;/span&gt;=&lt;span style="color: #000000;"&gt; permConfig.valueAt(i);
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;拿到权限&lt;/span&gt;
    BasePermission bp = mSettings.mPermissions.&lt;span style="color: #0000ff;"&gt;get&lt;/span&gt;&lt;span style="color: #000000;"&gt;(perm.name);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (bp == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        bp &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; BasePermission(perm.name, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;android&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, BasePermission.TYPE_BUILTIN);
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;写入权限&lt;/span&gt;</code></pre><p><span style="color: #000000;">                    mSettings.mPermissions.put(perm.name, bp);<br>                }<br>                </span><span style="color: #0000ff;">if</span> (perm.gids != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>                    bp.setGids(perm.gids, perm.perUser);<br>                }<br>            }<br>        }</span></p>
<pre><code>final PackageHandler mHandler;
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt; PackageHandler extends Handler {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; doHandleMessage(Message msg) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;switch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (msg.what) {

        }
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt; scanDirLI(File dir, &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; parseFlags, &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; scanFlags, &lt;span style="color: #0000ff;"&gt;long&lt;/span&gt;&lt;span style="color: #000000;"&gt; currentTime) {
    final File[] files &lt;/span&gt;=&lt;span style="color: #000000;"&gt; dir.listFiles();
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ArrayUtils.isEmpty(files)) {
        Log.d(TAG, &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;No files in app dir &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt; +&lt;span style="color: #000000;"&gt; dir);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
    ParallelPackageParser parallelPackageParser &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; ParallelPackageParser(
            mSeparateProcesses, mOnlyCore, mMetrics, mCacheDir,
            mParallelPackageParserCallback);

    parallelPackageParser.close();

}

File frameworkDir &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; File(Environment.getRootDirectory(), &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;framework&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Find base frameworks (resource packages without code).&lt;/span&gt;</code></pre><p><span style="color: #000000;">    scanDirTracedLI(frameworkDir, mDefParseFlags<br>            </span>|<span style="color: #000000;"> PackageParser.PARSE_IS_SYSTEM<br>            </span>|<span style="color: #000000;"> PackageParser.PARSE_IS_SYSTEM_DIR<br>            </span>|<span style="color: #000000;"> PackageParser.PARSE_IS_PRIVILEGED,<br>            scanFlags </span>| SCAN_NO_DEX, <span style="color: #800080;">0</span><span style="color: #000000;">);</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Collected privileged system packages. 系统安装包&lt;/span&gt;
final File privilegedAppDir = &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; File(Environment.getRootDirectory(), &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;priv-app&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
scanDirTracedLI(privilegedAppDir, mDefParseFlags
        &lt;/span&gt;|&lt;span style="color: #000000;"&gt; PackageParser.PARSE_IS_SYSTEM
        &lt;/span&gt;|&lt;span style="color: #000000;"&gt; PackageParser.PARSE_IS_SYSTEM_DIR
        &lt;/span&gt;| PackageParser.PARSE_IS_PRIVILEGED, scanFlags, &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Collect ordinary system packages. 系统app安装包&lt;/span&gt;
final File systemAppDir = &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; File(Environment.getRootDirectory(), &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;app&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
scanDirTracedLI(systemAppDir, mDefParseFlags
        &lt;/span&gt;|&lt;span style="color: #000000;"&gt; PackageParser.PARSE_IS_SYSTEM
        &lt;/span&gt;| PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;);</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>　　PMS里面主要完成以下几件事。<br>&nbsp;　　1、通过installer与installd进行连接，进行安装卸载应用操作<br>&nbsp;　　2、创建PacakageHandler线程，处理外部应用的安装卸载请求<br>&nbsp;　　3、处理系统权限相关配置<br>&nbsp;　　4、扫描安装应用，并解析APK安装包信息</p>
<div>
<h3>二.总结</h3>

<p>&nbsp;一张图总结下PMS主要完成的工作，以及对上与PackageManager交互，向下与Installd的控制。<br>&nbsp;　　　　　　　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722145529724-1218830986.png" alt=""></p></div><p></p>
<div><br>如果想了解桌面Launcher应用启动app过程，请看这篇文章。<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/Launcher_app.html" target="_blank">Android 源码分析（八） Launcher 桌面启动App过程</a></div>
<div>最后补充一点，如果想要了解APK的编译过程，可以进一步去了解Android4.4之后使用的ART,可以与Dalivk对比了解。<br>给个Dalivk的启动过程介绍的文章：<a id="homepage1_HomePageDays_DaysList_ctl05_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/dalvik.html" target="_blank">Android 源码分析（十） Dalvik 虚拟机创建过程</a></div>

</div>
<div>&nbsp;</div>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/22/Android源码分析十四PackageManagerService服务分析/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/22/Android源码分析十四PackageManagerService服务分析/" title="Android源码分析（十四）PackageManagerService服务分析">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/2.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/22/Android源码分析十三ActivityManagerService服务分析/">
    		Android源码分析（十三）ActivityManagerService服务分析
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-22T05:33:13.000Z">2018-07-22</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/ActivityManagerService.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h3>一.ActivityManagerService(AMS) 启动过程分析</h3>
<p>在SystemServer启动ActivityManagerService</p>
<p>如果想了解SystemServer启动过程可以看这篇文章：<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank">Android 源码分析（六） SystemServer 进程</a></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>frameworks\<span style="color: #0000ff;">base</span><span style="color: #000000;">\services\java\com\android\server\SystemServer.java
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Activity manager runs the show.</span>
        traceBeginAndSlog(<span style="color: #800000;">"</span><span style="color: #800000;">StartActivityManager</span><span style="color: #800000;">"</span><span style="color: #000000;">);
        mActivityManagerService </span>=<span style="color: #000000;"> mSystemServiceManager.startService(
                ActivityManagerService.Lifecycle.</span><span style="color: #0000ff;">class</span><span style="color: #000000;">).getService();
        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);
        mActivityManagerService.setInstaller(installer);
        </span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ActivityManagerService extends IActivityManager.Stub
        implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback {

<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt;* All system services &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;
SystemServiceManager mSystemServiceManager;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt;* Run all ActivityStacks through this &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;管理Activity&lt;/span&gt;</code></pre><p><span style="color: #000000;">    final ActivityStackSupervisor mStackSupervisor;</span></p>
<pre><code>final ActivityStarter mActivityStarter;

final TaskChangeNotificationController mTaskChangeNotificationController;

final InstrumentationReporter mInstrumentationReporter &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; InstrumentationReporter();

final ArrayList&lt;/span&gt;&amp;lt;ActiveInstrumentation&amp;gt; mActiveInstrumentation = &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;&lt;span style="color: #000000;"&gt;();

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Whether we should use SCHED_FIFO for UI and RenderThreads.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt; boolean mUseFifoUiScheduling = &lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;Broadcast 广播 ，前台广播队列和后台广播队列&lt;/span&gt;</code></pre><p><span style="color: #000000;">    BroadcastQueue mFgBroadcastQueue;<br>    BroadcastQueue mBgBroadcastQueue;</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Convenient for easy iteration over the queues. Foreground is first
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; so that dispatch of foreground broadcasts gets precedence.&lt;/span&gt;
final BroadcastQueue[] mBroadcastQueues = &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; BroadcastQueue[&lt;span style="color: #800080;"&gt;2&lt;/span&gt;&lt;span style="color: #000000;"&gt;];

BroadcastStats mLastBroadcastStats;
BroadcastStats mCurBroadcastStats;

BroadcastQueue broadcastQueueForIntent(Intent intent) {
    final boolean isFg &lt;/span&gt;= (intent.getFlags() &amp;amp; Intent.FLAG_RECEIVER_FOREGROUND) != &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (DEBUG_BROADCAST_BACKGROUND) Slog.i(TAG_BROADCAST,
            &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;Broadcast intent &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt; + intent + &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt; on &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;
            + (isFg ? &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;foreground&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt; : &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;background&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;) + &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt; queue&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; (isFg) ?&lt;span style="color: #000000;"&gt; mFgBroadcastQueue : mBgBroadcastQueue;
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;Activity 堆栈&lt;/span&gt;
&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt;*
 * The last resumed activity. This is identical to the current resumed activity most
 * of the time but could be different when we're pausing one activity before we resume
 * another activity.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt;&lt;span style="color: #000000;"&gt; ActivityRecord mLastResumedActivity;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt;*
 * If non-null, we are tracking the time the user spends in the currently focused app.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt;&lt;span style="color: #000000;"&gt; AppTimeTracker mCurAppTimeTracker;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;ANR ？ 最后个ANR状态，难道可以记录app发生ANR的？&lt;/span&gt;
&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt;*
 * Dump of the activity state at the time of the last ANR. Cleared after
 * {@link WindowManagerService#LAST_ANR_LIFETIME_DURATION_MSECS}
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;
String mLastANRState;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;Service 和 Provider 管理&lt;/span&gt;</code></pre><p><span style="color: #000000;">    final ActiveServices mServices;<br>    final ProviderMap mProviderMap;</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;存放系统数据目录
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; TODO: Move creation of battery stats service outside of activity manager service.&lt;/span&gt;
File dataDir =&lt;span style="color: #000000;"&gt; Environment.getDataDirectory();
File systemDir &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; File(dataDir, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;system&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
systemDir.mkdirs();
mBatteryStatsService &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; BatteryStatsService(systemDir, mHandler);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;应用权限管理&lt;/span&gt;
mAppOpsService = mInjector.getAppOpsService(&lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; File(systemDir, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;appops.xml&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;), mHandler);

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;AcitivityManager 添加进来&lt;/span&gt;
    ServiceManager.addService(Context.ACTIVITY_SERVICE, &lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
            ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);
            ServiceManager.addService(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;meminfo&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; MemBinder(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
            ServiceManager.addService(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;gfxinfo&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; GraphicsBinder(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
            ServiceManager.addService(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;dbinfo&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; DbBinder(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (MONITOR_CPU_USAGE) {
                ServiceManager.addService(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;cpuinfo&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; CpuBinder(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
            }
            ServiceManager.addService(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;permission&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; PermissionController(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
            ServiceManager.addService(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;processinfo&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; ProcessInfoService(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;));

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;最后 使用Watchdog监控&lt;/span&gt;
Watchdog.getInstance().addMonitor(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
Watchdog.getInstance().addThread(mHandler);</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;&nbsp; 从上面截取的一些代码片段，我们能了解到， AMS创建过程 涉及到Android 四大组件管理的初始化工作。并且ActivityManagerService extends IActivityManager.Stub，所以可知AcitivityManagerService与AcitivityManager之间通信也是使用binder机制。</p>
<p>&nbsp; &nbsp; 进ActivityManager 里面看看</p>
<div class="cnblogs_code">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">与ActivityManagerService里的ServiceManager.addService(Context.ACTIVITY_SERVICE, this, true);对应。</span>
<span style="color: #000000;">@SystemService(Context.ACTIVITY_SERVICE)
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ActivityManager {
    ...
}</span></pre>
</div>
<p>&nbsp;</p>
<h3>二.ActivityManager和ActivityManagerService关系</h3>
<p>如果想了解Activity是如果通过ActivityManager调用ActivityManagerService的过程可以看下这篇文章.</p>
<p><a id="homepage1_HomePageDays_DaysList_ctl03_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/startActivity.html" target="_blank">Android 源码分析（二） Activity 启动分析</a></p>
<p>ActivityManager（frameworks/base/core/java/android/app/ActivityManager.java）</p>
<p>ActivityManager 是客户端用来管理系统中正在运行的所有Activity.</p>
<p>上层APP通过ActivityManager使用binder机制传递信息给AMS，由AMS去完成交互和调度工作后通过binder机制返回给ActivityManager，把结果在返回给上层app。</p>
<p>一张图了解ActivityManager和ActivityManagerService在整个Android系统通信过程中位置。</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722132754102-1009841250.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>参考：<br>[1]https://www.cnblogs.com/bastard/p/5770573.html</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/22/Android源码分析十三ActivityManagerService服务分析/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/22/Android源码分析十三ActivityManagerService服务分析/" title="Android源码分析（十三）ActivityManagerService服务分析">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/2.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/22/Android源码分析十二ServiceManager服务分析/">
    		Android源码分析（十二）ServiceManager服务分析
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-22T03:44:46.000Z">2018-07-22</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/ServiceManager.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.启动过程分析</h2>
<div>基于 binder 机制实现通信，添加服务，查询服务，获取服务。查询，获取服务时候需要检查权限，android是基于Linux底层，所以也很好的实现了linux多用户管理。</div>
<div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">frameworks\native\cmds\servicemanager\servicemanager.rc
service servicemanager </span>/system/bin/<span style="color: #000000;">servicemanager
    </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> core animation
    user system
    group system readproc
    critical
    onrestart restart healthd
    onrestart restart zygote
    onrestart restart audioserver
    onrestart restart media
    onrestart restart surfaceflinger
    onrestart restart inputflinger
    onrestart restart drm
    onrestart restart cameraserver
    writepid </span>/dev/cpuset/system-background/tasks</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>从上面可知，如果ServiceManager服务异常退出的话，系统会重启。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">frameworks\native\cmds\servicemanager\service_manager.c
</span><span style="color: #0000ff;">int</span> main(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span>**<span style="color: #000000;"> argv)
{
    </span><span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs;
    union selinux_callback cb;
    </span><span style="color: #0000ff;">char</span> *<span style="color: #000000;">driver;

<pre><code>&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (argc &amp;gt; &lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    driver &lt;/span&gt;= argv[&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;];
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    driver &lt;/span&gt;= &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev/binder&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

bs &lt;/span&gt;= binder_open(driver, &lt;span style="color: #800080;"&gt;128&lt;/span&gt;*&lt;span style="color: #800080;"&gt;1024&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;bs) {
#ifdef VENDORSERVICEMANAGER
    ALOGW(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;failed to open binder driver %s\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, driver);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;while&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        sleep(UINT_MAX);
    }
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;#else&lt;/span&gt;&lt;span style="color: #000000;"&gt;
    ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;failed to open binder driver %s\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, driver);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;#endif&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (binder_become_context_manager(bs)) {
    ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;cannot become context manager (%s)\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, strerror(errno));
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

cb.func_audit &lt;/span&gt;=&lt;span style="color: #000000;"&gt; audit_callback;
selinux_set_callback(SELINUX_CB_AUDIT, cb);
cb.func_log &lt;/span&gt;=&lt;span style="color: #000000;"&gt; selinux_log_callback;
selinux_set_callback(SELINUX_CB_LOG, cb);

#ifdef VENDORSERVICEMANAGER
sehandle &lt;/span&gt;=&lt;span style="color: #000000;"&gt; selinux_android_vendor_service_context_handle();
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;#else&lt;/span&gt;&lt;span style="color: #000000;"&gt;
sehandle &lt;/span&gt;=&lt;span style="color: #000000;"&gt; selinux_android_service_context_handle();
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;#endif&lt;/span&gt;&lt;span style="color: #000000;"&gt;
selinux_status_open(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (sehandle ==&lt;span style="color: #000000;"&gt; NULL) {
    ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;SELinux: Failed to acquire sehandle. Aborting.\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    abort();
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (getcon(&amp;amp;service_manager_context) != &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;SELinux: Failed to acquire service_manager context. Aborting.\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    abort();
}


&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;loop 接受消息。并将binder解析完的消息返回给svcmgr_handler处理。&lt;/span&gt;</code></pre><p><span style="color: #000000;">    binder_loop(bs, svcmgr_handler);</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>从这我们知道，ServiceManager是基于binder机制实现的。进入binder.c中了解下binder_open,binder_loop，然后binder将解析完的消息，返回给svcmag_handler处理</p>
<p>frameworks\native\cmds\servicemanager\binder.c</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c271bc75-156b-40e2-ae92-90551ddf233c')"><img id="code_img_closed_c271bc75-156b-40e2-ae92-90551ddf233c" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_c271bc75-156b-40e2-ae92-90551ddf233c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('c271bc75-156b-40e2-ae92-90551ddf233c',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_c271bc75-156b-40e2-ae92-90551ddf233c" class="cnblogs_code_hide">
<pre>    <span style="color: #0000ff;">struct</span> binder_state *binder_open(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> driver, size_t mapsize)
{
    </span><span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs;
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_version vers;

<pre><code>bs &lt;/span&gt;= malloc(&lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;(*&lt;span style="color: #000000;"&gt;bs));
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;bs) {
    errno &lt;/span&gt;=&lt;span style="color: #000000;"&gt; ENOMEM;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; NULL;
}

bs&lt;/span&gt;-&amp;gt;fd = open(driver, O_RDWR |&lt;span style="color: #000000;"&gt; O_CLOEXEC);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (bs-&amp;gt;fd &amp;lt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    fprintf(stderr,&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;binder: cannot open %s (%s)\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
            driver, strerror(errno));
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;goto&lt;/span&gt;&lt;span style="color: #000000;"&gt; fail_open;
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; ((ioctl(bs-&amp;gt;fd, BINDER_VERSION, &amp;amp;vers) == -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;) ||&lt;span style="color: #000000;"&gt;
    (vers.protocol_version &lt;/span&gt;!=&lt;span style="color: #000000;"&gt; BINDER_CURRENT_PROTOCOL_VERSION)) {
    fprintf(stderr,
            &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;binder: kernel driver version (%d) differs from user space version (%d)\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
            vers.protocol_version, BINDER_CURRENT_PROTOCOL_VERSION);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;goto&lt;/span&gt;&lt;span style="color: #000000;"&gt; fail_open;
}

bs&lt;/span&gt;-&amp;gt;mapsize =&lt;span style="color: #000000;"&gt; mapsize;
bs&lt;/span&gt;-&amp;gt;mapped = mmap(NULL, mapsize, PROT_READ, MAP_PRIVATE, bs-&amp;gt;fd, &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (bs-&amp;gt;mapped ==&lt;span style="color: #000000;"&gt; MAP_FAILED) {
    fprintf(stderr,&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;binder: cannot map device (%s)\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
            strerror(errno));
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;goto&lt;/span&gt;&lt;span style="color: #000000;"&gt; fail_map;
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; bs;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('5c06b747-4566-4459-8bff-9b4c249774c5')"><img id="code_img_closed_5c06b747-4566-4459-8bff-9b4c249774c5" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_5c06b747-4566-4459-8bff-9b4c249774c5" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('5c06b747-4566-4459-8bff-9b4c249774c5',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_5c06b747-4566-4459-8bff-9b4c249774c5" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">void</span> binder_loop(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs, binder_handler func)
{
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> res;
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_write_read bwr;
    uint32_t readbuf[</span><span style="color: #800080;">32</span><span style="color: #000000;">];

<pre><code>bwr.write_size &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
bwr.write_consumed &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
bwr.write_buffer &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

readbuf[&lt;/span&gt;&lt;span style="color: #800080;"&gt;0&lt;/span&gt;] =&lt;span style="color: #000000;"&gt; BC_ENTER_LOOPER;
binder_write(bs, readbuf, &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;&lt;span style="color: #000000;"&gt;(uint32_t));

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt;&lt;span style="color: #000000;"&gt; (;;) {
    bwr.read_size &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;&lt;span style="color: #000000;"&gt;(readbuf);
    bwr.read_consumed &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    bwr.read_buffer &lt;/span&gt;=&lt;span style="color: #000000;"&gt; (uintptr_t) readbuf;

    res &lt;/span&gt;= ioctl(bs-&amp;gt;fd, BINDER_WRITE_READ, &amp;amp;&lt;span style="color: #000000;"&gt;bwr);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (res &amp;lt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;binder_loop: ioctl failed (%s)\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, strerror(errno));
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;break&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;解析消息&lt;/span&gt;
    res = binder_parse(bs, &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;, (uintptr_t) readbuf, bwr.read_consumed, func);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (res == &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;binder_loop: unexpected reply?!\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;break&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (res &amp;lt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;binder_loop: io error %d %s\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, res, strerror(errno));
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;break&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
}</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div>binder_parse 解析接受到的消息&nbsp;</div>
<div>binder_send_reply 接收到消息，并解析完消息后，binder将解析后的消息返回给ServiceManager</div>
<div>
<div class="cnblogs_code" onclick="cnblogs_code_show('4aebc7de-d31e-48f8-9dbc-8ae2582c5d95')"><img id="code_img_closed_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('4aebc7de-d31e-48f8-9dbc-8ae2582c5d95',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">void</span> binder_send_reply(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                       </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">reply,
                       binder_uintptr_t buffer_to_free,
                       </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> status)
{
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> {
        uint32_t cmd_free;
        binder_uintptr_t buffer;
        uint32_t cmd_reply;
        </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_transaction_data txn;
    } __attribute__((packed)) data;

<pre><code>data.cmd_free &lt;/span&gt;=&lt;span style="color: #000000;"&gt; BC_FREE_BUFFER;
data.buffer &lt;/span&gt;=&lt;span style="color: #000000;"&gt; buffer_to_free;
data.cmd_reply &lt;/span&gt;=&lt;span style="color: #000000;"&gt; BC_REPLY;
data.txn.target.ptr &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
data.txn.cookie &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
data.txn.code &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (status) {
    data.txn.flags &lt;/span&gt;=&lt;span style="color: #000000;"&gt; TF_STATUS_CODE;
    data.txn.data_size &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;(&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    data.txn.offsets_size &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    data.txn.data.ptr.buffer &lt;/span&gt;= (uintptr_t)&amp;amp;&lt;span style="color: #000000;"&gt;status;
    data.txn.data.ptr.offsets &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    data.txn.flags &lt;/span&gt;= &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    data.txn.data_size &lt;/span&gt;= reply-&amp;gt;data - reply-&amp;gt;&lt;span style="color: #000000;"&gt;data0;
    data.txn.offsets_size &lt;/span&gt;= ((&lt;span style="color: #0000ff;"&gt;char&lt;/span&gt;*) reply-&amp;gt;offs) - ((&lt;span style="color: #0000ff;"&gt;char&lt;/span&gt;*) reply-&amp;gt;&lt;span style="color: #000000;"&gt;offs0);
    data.txn.data.ptr.buffer &lt;/span&gt;= (uintptr_t)reply-&amp;gt;&lt;span style="color: #000000;"&gt;data0;
    data.txn.data.ptr.offsets &lt;/span&gt;= (uintptr_t)reply-&amp;gt;&lt;span style="color: #000000;"&gt;offs0;
}
binder_write(bs, &lt;/span&gt;&amp;amp;data, &lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;&lt;span style="color: #000000;"&gt;(data));</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>继续回到serviceManager里分析binder解析返回回来的服务消息</p>
<p>frameworks\native\cmds\servicemanager\servicemanager.rc</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">int</span> svcmgr_handler(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                   </span><span style="color: #0000ff;">struct</span> binder_transaction_data *<span style="color: #000000;">txn,
                   </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">msg,
                   </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">reply)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *<span style="color: #000000;">si;
    uint16_t </span>*<span style="color: #000000;">s;
    size_t len;
    uint32_t handle;
    uint32_t strict_policy;
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> allow_isolated;

<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;ALOGI("target=%p code=%d pid=%d uid=%d\n",
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;      (void*) txn-&amp;gt;target.ptr, txn-&amp;gt;code, txn-&amp;gt;sender_pid, txn-&amp;gt;sender_euid);&lt;/span&gt;

&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (txn-&amp;gt;target.ptr !=&lt;span style="color: #000000;"&gt; BINDER_SERVICE_MANAGER)
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (txn-&amp;gt;code ==&lt;span style="color: #000000;"&gt; PING_TRANSACTION)
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Equivalent to Parcel::enforceInterface(), reading the RPC
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; header with the strict mode policy mask and the interface name.
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Note that we ignore the strict_policy and don't propagate it
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; further (since we do no outbound RPCs anyway).&lt;/span&gt;
strict_policy =&lt;span style="color: #000000;"&gt; bio_get_uint32(msg);
s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style="color: #000000;"&gt;len);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (s ==&lt;span style="color: #000000;"&gt; NULL) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;检查是否是servicemanager服务&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; ((len != (&lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;(svcmgr_id) / &lt;span style="color: #800080;"&gt;2&lt;/span&gt;)) ||&lt;span style="color: #000000;"&gt;
    memcmp(svcmgr_id, s, &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;&lt;span style="color: #000000;"&gt;(svcmgr_id))) {
    fprintf(stderr,&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;invalid id %s\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, str8(s, len));
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (sehandle &amp;amp;&amp;amp; selinux_status_updated() &amp;gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;struct&lt;/span&gt; selabel_handle *tmp_sehandle =&lt;span style="color: #000000;"&gt; selinux_android_service_context_handle();
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (tmp_sehandle) {
        selabel_close(sehandle);
        sehandle &lt;/span&gt;=&lt;span style="color: #000000;"&gt; tmp_sehandle;
    }
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;switch&lt;/span&gt;(txn-&amp;gt;&lt;span style="color: #000000;"&gt;code) {
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;case&lt;/span&gt;&lt;span style="color: #000000;"&gt; SVC_MGR_GET_SERVICE:
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;检查服务，do_find_service 查找服务。&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;case&lt;/span&gt;&lt;span style="color: #000000;"&gt; SVC_MGR_CHECK_SERVICE:
    s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style="color: #000000;"&gt;len);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (s ==&lt;span style="color: #000000;"&gt; NULL) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
    handle &lt;/span&gt;= do_find_service(s, len, txn-&amp;gt;sender_euid, txn-&amp;gt;&lt;span style="color: #000000;"&gt;sender_pid);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;handle)
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;break&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    bio_put_ref(reply, handle);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;添加服务 do_add_service 获取服务 在do_add_service会检查是否具有权限&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;case&lt;/span&gt;&lt;span style="color: #000000;"&gt; SVC_MGR_ADD_SERVICE:
    s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style="color: #000000;"&gt;len);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (s ==&lt;span style="color: #000000;"&gt; NULL) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
    handle &lt;/span&gt;=&lt;span style="color: #000000;"&gt; bio_get_ref(msg);
    allow_isolated &lt;/span&gt;= bio_get_uint32(msg) ? &lt;span style="color: #800080;"&gt;1&lt;/span&gt; : &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (do_add_service(bs, s, len, handle, txn-&amp;gt;&lt;span style="color: #000000;"&gt;sender_euid,
        allow_isolated, txn&lt;/span&gt;-&amp;gt;&lt;span style="color: #000000;"&gt;sender_pid))
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;break&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;查询服务&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;case&lt;/span&gt;&lt;span style="color: #000000;"&gt; SVC_MGR_LIST_SERVICES: {
    uint32_t n &lt;/span&gt;=&lt;span style="color: #000000;"&gt; bio_get_uint32(msg);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!svc_can_list(txn-&amp;gt;sender_pid, txn-&amp;gt;&lt;span style="color: #000000;"&gt;sender_euid)) {
        ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;list_service() uid=%d - PERMISSION DENIED\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
                txn&lt;/span&gt;-&amp;gt;&lt;span style="color: #000000;"&gt;sender_euid);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
    si &lt;/span&gt;=&lt;span style="color: #000000;"&gt; svclist;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;while&lt;/span&gt; ((n-- &amp;gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;) &amp;amp;&amp;amp;&lt;span style="color: #000000;"&gt; si)
        si &lt;/span&gt;= si-&amp;gt;&lt;span style="color: #000000;"&gt;next;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (si) {
        bio_put_string16(reply, si&lt;/span&gt;-&amp;gt;&lt;span style="color: #000000;"&gt;name);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;default&lt;/span&gt;&lt;span style="color: #000000;"&gt;:
    ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;unknown code %d\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, txn-&amp;gt;&lt;span style="color: #000000;"&gt;code);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

bio_put_uint32(reply, &lt;/span&gt;&lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>进入 do_find_service&nbsp; do_add_service了解下做了什么事。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('259cf340-561d-4ea7-9910-93cac3ea1148')"><img id="code_img_closed_259cf340-561d-4ea7-9910-93cac3ea1148" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_259cf340-561d-4ea7-9910-93cac3ea1148" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('259cf340-561d-4ea7-9910-93cac3ea1148',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_259cf340-561d-4ea7-9910-93cac3ea1148" class="cnblogs_code_hide">
<pre>uint32_t do_find_service(<span style="color: #0000ff;">const</span> uint16_t *<span style="color: #000000;">s, size_t len, uid_t uid, pid_t spid)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *si =<span style="color: #000000;"> find_svc(s, len);

<pre><code>&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!si || !si-&amp;gt;&lt;span style="color: #000000;"&gt;handle) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!si-&amp;gt;&lt;span style="color: #000000;"&gt;allow_isolated) {
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If this service doesn't allow access from isolated processes,
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; then check the uid to see if it is isolated.&lt;/span&gt;
    uid_t appid = uid %&lt;span style="color: #000000;"&gt; AID_USER;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (appid &amp;gt;= AID_ISOLATED_START &amp;amp;&amp;amp; appid &amp;lt;=&lt;span style="color: #000000;"&gt; AID_ISOLATED_END) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;svc_can_find(s, len, spid, uid)) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; si-&amp;gt;&lt;span style="color: #000000;"&gt;handle;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('786c6178-2ad5-466d-b516-d8e38fe7b404')"><img id="code_img_closed_786c6178-2ad5-466d-b516-d8e38fe7b404" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_786c6178-2ad5-466d-b516-d8e38fe7b404" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('786c6178-2ad5-466d-b516-d8e38fe7b404',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_786c6178-2ad5-466d-b516-d8e38fe7b404" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">int</span> do_add_service(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                   </span><span style="color: #0000ff;">const</span> uint16_t *<span style="color: #000000;">s, size_t len,
                   uint32_t handle, uid_t uid, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> allow_isolated,
                   pid_t spid)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *<span style="color: #000000;">si;

<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;ALOGI("add_service('%s',%x,%s) uid=%d\n", str8(s, len), handle,
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;        allow_isolated ? "allow_isolated" : "!allow_isolated", uid);&lt;/span&gt;

&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!handle || (len == &lt;span style="color: #800080;"&gt;0&lt;/span&gt;) || (len &amp;gt; &lt;span style="color: #800080;"&gt;127&lt;/span&gt;&lt;span style="color: #000000;"&gt;))
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;检查是否有权限&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;svc_can_register(s, len, spid, uid)) {
    ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;add_service('%s',%x) uid=%d - PERMISSION DENIED\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
         str8(s, len), handle, uid);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

si &lt;/span&gt;=&lt;span style="color: #000000;"&gt; find_svc(s, len);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (si) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (si-&amp;gt;&lt;span style="color: #000000;"&gt;handle) {
        ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;add_service('%s',%x) uid=%d - ALREADY REGISTERED, OVERRIDE\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
             str8(s, len), handle, uid);
        svcinfo_death(bs, si);
    }
    si&lt;/span&gt;-&amp;gt;handle =&lt;span style="color: #000000;"&gt; handle;
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    si &lt;/span&gt;= malloc(&lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;(*si) + (len + &lt;span style="color: #800080;"&gt;1&lt;/span&gt;) * &lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;&lt;span style="color: #000000;"&gt;(uint16_t));
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;si) {
        ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;add_service('%s',%x) uid=%d - OUT OF MEMORY\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
             str8(s, len), handle, uid);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
    si&lt;/span&gt;-&amp;gt;handle =&lt;span style="color: #000000;"&gt; handle;
    si&lt;/span&gt;-&amp;gt;len =&lt;span style="color: #000000;"&gt; len;
    memcpy(si&lt;/span&gt;-&amp;gt;name, s, (len + &lt;span style="color: #800080;"&gt;1&lt;/span&gt;) * &lt;span style="color: #0000ff;"&gt;sizeof&lt;/span&gt;&lt;span style="color: #000000;"&gt;(uint16_t));
    si&lt;/span&gt;-&amp;gt;name[len] = &lt;span style="color: #800000;"&gt;'&lt;/span&gt;&lt;span style="color: #800000;"&gt;\0&lt;/span&gt;&lt;span style="color: #800000;"&gt;'&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    si&lt;/span&gt;-&amp;gt;death.func = (&lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;*&lt;span style="color: #000000;"&gt;) svcinfo_death;
    si&lt;/span&gt;-&amp;gt;death.ptr =&lt;span style="color: #000000;"&gt; si;
    si&lt;/span&gt;-&amp;gt;allow_isolated =&lt;span style="color: #000000;"&gt; allow_isolated;
    si&lt;/span&gt;-&amp;gt;next =&lt;span style="color: #000000;"&gt; svclist;
    svclist &lt;/span&gt;=&lt;span style="color: #000000;"&gt; si;
}

binder_acquire(bs, handle);
binder_link_to_death(bs, handle, &lt;/span&gt;&amp;amp;si-&amp;gt;&lt;span style="color: #000000;"&gt;death);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<h2>二. ServiceManager如何管理服务</h2>
<p>&nbsp;从上面源码分析我们知道了ServiceManager利用binder通信机制来管理一系列服务。<br>&nbsp;上面源码的执行路径可以用下图所示：（注意，图中do_find_service7 应该是do_find_service.操作手误。）</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722114236180-75099312.png" alt=""></p>
<p>&nbsp;</p>
<p>　　代码分析抽象成逻辑分析，如下图所示：</p>
<p>　　　　　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722114323395-1692794298.png" alt=""></p>

</div>

</div>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/22/Android源码分析十二ServiceManager服务分析/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/22/Android源码分析十二ServiceManager服务分析/" title="Android源码分析（十二）ServiceManager服务分析">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/2.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/15/Android源码分析十一事件传递机制/">
    		Android 源码分析（十一） 事件传递机制
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-15T05:18:25.000Z">2018-07-15</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/touchEvent.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.介绍</h2>
<p>　　Android三种事件类型：ACTION_DOWN,ACTOIN_MOVE,ACTION_UP。<br>　　事件传递的三个阶段：<br>　　　　分发(Dispatch)<br>　　　　　　方法：public boolean <strong>dispatchTouchEvent</strong>(MotionEvent ev)<br>　　　　拦截(Intercept)<br>　　　　　　方法：public boolean <strong>onInterceptTouchEvent</strong>(MotionEvent ev)<br>　　　　消费(Consume)<br>　　　　　　方法：public boolean <strong>onTouchEvent</strong>(MotionEvent event)</p>
<h2>二.源码分析</h2>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">Activity.java   </span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Called to process touch screen events.  You can override this to
     * intercept all touch screen events before they are dispatched to the
     * window.  Be sure to call this implementation for touch screen events
     * that should be handled normally.
     *
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> ev The touch screen event.
     *
     * </span><span style="color: #808080;">@return</span><span style="color: #008000;"> boolean Return true if this event was consumed.
     </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> dispatchTouchEvent(MotionEvent ev) {
        </span><span style="color: #0000ff;">if</span> (ev.getAction() ==<span style="color: #000000;"> MotionEvent.ACTION_DOWN) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;">当此activity在栈顶时，用户对手机：触屏点击，按home，back，menu键都会触发此方法。
            </span><span style="color: #008000;">//</span><span style="color: #008000;">注：下拉statubar,旋转屏幕,锁屏，不会触发此方法.</span>
<span style="color: #000000;">            onUserInteraction();
        }
        </span><span style="color: #008000;">//</span><span style="color: #008000;">查看getWindow().对event做了什么分发？</span>
        <span style="color: #0000ff;">if</span><span style="color: #000000;"> (getWindow().superDispatchTouchEvent(ev)) {
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
        }
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> onTouchEvent(ev);
}

<p>Window.java 是一个抽象类。在Activity里attach()查看Window创建过程<br></p></span><span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> attach(…){<p></p>
<pre><code>attachBaseContext(context);

    mFragments.attachHost(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt; &lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt;parent&lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;PhoneWindow 是 getWindow()的具体实现类。进去查看它的superDispatchTouchEvent()&lt;/span&gt;
    mWindow = &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; PhoneWindow(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;, window, activityConfigCallback);
    mWindow.setWindowControllerCallback(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    mWindow.setCallback(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    mWindow.setOnWindowDismissedCallback(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    mWindow.getLayoutInflater().setPrivateFactory(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (info.softInputMode !=&lt;span style="color: #000000;"&gt; WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) {
        mWindow.setSoftInputMode(info.softInputMode);
    }
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (info.uiOptions != 0&lt;span style="color: #000000;"&gt;) {
        mWindow.setUiOptions(info.uiOptions);
    }
    mUiThread &lt;/span&gt;=&lt;span style="color: #000000;"&gt; Thread.currentThread();

    mMainThread &lt;/span&gt;=&lt;span style="color: #000000;"&gt; aThread;
...</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">PhoneWindow.java extends Window</span>
<span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> superDispatchTouchEvent(MotionEvent event) {
        </span><span style="color: #008000;">//</span><span style="color: #008000;">PhoneWindow Event 分发操作有在DecorView实现了，继续进去看看DecorView类。</span>
        <span style="color: #0000ff;">return</span><span style="color: #000000;"> mDecor.superDispatchTouchEvent(event);
    }

<p></p></span><span style="color: #008000;">//</span><span style="color: #008000;"> This is the top-level view of the window, containing the window decor.</span><br>    <span style="color: #0000ff;">private</span> DecorView mDecor;</pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">DecorView.java </span>
     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> superDispatchTouchEvent(MotionEvent event) {
         </span><span style="color: #008000;">//</span><span style="color: #008000;">DecorView就是activity的顶级view，
         </span><span style="color: #008000;">//</span><span style="color: #008000;">点击事件已经从activity传到View当中了，接下来要分析的就是顶级View把事件如何分发到各个子view中
         </span><span style="color: #008000;">//</span><span style="color: #008000;">DecorView extends FrameLayout</span>
        <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.dispatchTouchEvent(event);
    }

<pre><code> @Override
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt;&lt;span style="color: #000000;"&gt; dispatchTouchEvent(MotionEvent ev) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; Window.Callback cb =&lt;span style="color: #000000;"&gt; mWindow.getCallback();
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; cb != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !mWindow.isDestroyed() &amp;amp;&amp;amp; mFeatureId &amp;lt; 0
            ? cb.dispatchTouchEvent(ev) : &lt;span style="color: #0000ff;"&gt;super&lt;/span&gt;&lt;span style="color: #000000;"&gt;.dispatchTouchEvent(ev);
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">FrameLayout.java
    </span><span style="color: #008000;">//</span><span style="color: #008000;">FrameLayout extends ViewGroup 到 ViewGroup里看看</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FrameLayout <span style="color: #0000ff;">extends</span> ViewGroup {}</pre>
</div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ViewGroup.java</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> dispatchTouchEvent(MotionEvent ev) {
        </span><span style="color: #0000ff;">if</span> (mInputEventConsistencyVerifier != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            mInputEventConsistencyVerifier.onTouchEvent(ev, </span>1<span style="color: #000000;">);
        }

<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If the event targets the accessibility focused view and this is it, start
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; normal event dispatch. Maybe a descendant is what will handle the click.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (ev.isTargetAccessibilityFocus() &amp;amp;&amp;amp;&lt;span style="color: #000000;"&gt; isAccessibilityFocusedViewOrHost()) {
    ev.setTargetAccessibilityFocus(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; handled = &lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (onFilterTouchEventForSecurity(ev)) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; action =&lt;span style="color: #000000;"&gt; ev.getAction();
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; actionMasked = action &amp;amp;&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_MASK;

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Handle an initial down.
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;当点击事件是MotionEvent.ACTION_DOWN时，及手指刚刚触碰屏幕第一个触发的事件&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_DOWN) {
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Throw away all previous state when starting a new touch gesture.
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; The framework may have dropped the up or cancel event for the previous gesture
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; due to an app switch, ANR, or some other state change.&lt;/span&gt;</code></pre><p><span style="color: #000000;">                cancelAndClearTouchTargets(ev);<br>                resetTouchState();<br>            }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Check for interception.
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;检查是否拦截&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt;&lt;span style="color: #000000;"&gt; intercepted;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;判断是否父类是否拦截点击事件&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_DOWN
        &lt;/span&gt;|| mFirstTouchTarget != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; disallowIntercept = (mGroupFlags &amp;amp; FLAG_DISALLOW_INTERCEPT) != 0&lt;span style="color: #000000;"&gt;;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;disallowIntercept) {
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;调用拦截方法&lt;/span&gt;
        intercepted =&lt;span style="color: #000000;"&gt; onInterceptTouchEvent(ev);
        ev.setAction(action); &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; restore action in case it was changed&lt;/span&gt;
    } &lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        intercepted &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; There are no touch targets and this action is not an initial down
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; so this view group continues to intercept touches.&lt;/span&gt;
    intercepted = &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If intercepted, start normal event dispatch. Also if there is already
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; a view that is handling the gesture, do normal event dispatch.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (intercepted || mFirstTouchTarget != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    ev.setTargetAccessibilityFocus(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Check for cancelation.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; canceled = resetCancelNextUpFlag(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;)
        &lt;/span&gt;|| actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_CANCEL;

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Update list of touch targets for pointer down, if needed.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; split = (mGroupFlags &amp;amp; FLAG_SPLIT_MOTION_EVENTS) != 0&lt;span style="color: #000000;"&gt;;
TouchTarget newTouchTarget &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; alreadyDispatchedToNewTouchTarget = &lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;没有被取消并且没有被拦截,事件传递到子View &lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!canceled &amp;amp;&amp;amp; !&lt;span style="color: #000000;"&gt;intercepted) {

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If the event is targeting accessiiblity focus we give it to the
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; view that has accessibility focus and if it does not handle it
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; we clear the flag and dispatch the event to all children as usual.
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; We are looking up the accessibility focused host to avoid keeping
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; state since these events are very rare.&lt;/span&gt;
    View childWithAccessibilityFocus =&lt;span style="color: #000000;"&gt; ev.isTargetAccessibilityFocus()
            &lt;/span&gt;? findChildWithAccessibilityFocus() : &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_DOWN
            &lt;/span&gt;|| (split &amp;amp;&amp;amp; actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_POINTER_DOWN)
            &lt;/span&gt;|| actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_HOVER_MOVE) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; actionIndex = ev.getActionIndex(); &lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; always 0 for down&lt;/span&gt;
        &lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; idBitsToAssign = split ? 1 &amp;lt;&amp;lt;&lt;span style="color: #000000;"&gt; ev.getPointerId(actionIndex)
                : TouchTarget.ALL_POINTER_IDS;

        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Clean up earlier touch targets for this pointer id in case they
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; have become out of sync.&lt;/span&gt;</code></pre><p><span style="color: #000000;">                    removePointersFromTouchTargets(idBitsToAssign);</span></p>
<pre><code>                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; childrenCount =&lt;span style="color: #000000;"&gt; mChildrenCount;
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (newTouchTarget == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt; &amp;amp;&amp;amp; childrenCount != 0&lt;span style="color: #000000;"&gt;) {
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;float&lt;/span&gt; x =&lt;span style="color: #000000;"&gt; ev.getX(actionIndex);
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;float&lt;/span&gt; y =&lt;span style="color: #000000;"&gt; ev.getY(actionIndex);
                    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Find a child that can receive the event.
                    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Scan children from front to back.&lt;/span&gt;
                    &lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; ArrayList&amp;lt;View&amp;gt; preorderedList =&lt;span style="color: #000000;"&gt; buildTouchDispatchChildList();
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; customOrder = preorderedList == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;
                            &amp;amp;&amp;amp;&lt;span style="color: #000000;"&gt; isChildrenDrawingOrderEnabled();
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; View[] children =&lt;span style="color: #000000;"&gt; mChildren;
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; i = childrenCount - 1; i &amp;gt;= 0; i--&lt;span style="color: #000000;"&gt;) {
                        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; childIndex =&lt;span style="color: #000000;"&gt; getAndVerifyPreorderedIndex(
                                childrenCount, i, customOrder);
                        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; View child =&lt;span style="color: #000000;"&gt; getAndVerifyPreorderedView(
                                preorderedList, children, childIndex);

                        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If there is a view that has accessibility focus we want it
                        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; to get the event first and if not handled we will perform a
                        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; normal dispatch. We may do a double iteration but this is
                        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; safer given the timeframe.&lt;/span&gt;
                        &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (childWithAccessibilityFocus != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
                            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (childWithAccessibilityFocus !=&lt;span style="color: #000000;"&gt; child) {
                                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;continue&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                            }
                            childWithAccessibilityFocus &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                            i &lt;/span&gt;= childrenCount - 1&lt;span style="color: #000000;"&gt;;
                        }

                        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;canViewReceivePointerEvents(child)
                                &lt;/span&gt;|| !isTransformedTouchPointInView(x, y, child, &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;)) {
                            ev.setTargetAccessibilityFocus(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
                            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;continue&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                        }

                        newTouchTarget &lt;/span&gt;=&lt;span style="color: #000000;"&gt; getTouchTarget(child);
                        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (newTouchTarget != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
                            &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Child is already receiving touch within its bounds.
                            &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Give it the new pointer in addition to the ones it is handling.&lt;/span&gt;
                            newTouchTarget.pointerIdBits |=&lt;span style="color: #000000;"&gt; idBitsToAssign;
                            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;break&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                        }

                        resetCancelNextUpFlag(child);
                        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (dispatchTransformedTouchEvent(ev, &lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;, child, idBitsToAssign)) {
                            &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Child wants to receive touch within its bounds.&lt;/span&gt;
                            mLastTouchDownTime =&lt;span style="color: #000000;"&gt; ev.getDownTime();
                            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (preorderedList != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
                                &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; childIndex points into presorted list, find original index&lt;/span&gt;
                                &lt;span style="color: #0000ff;"&gt;for&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; j = 0; j &amp;lt; childrenCount; j++&lt;span style="color: #000000;"&gt;) {
                                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (children[childIndex] ==&lt;span style="color: #000000;"&gt; mChildren[j]) {
                                        mLastTouchDownIndex &lt;/span&gt;=&lt;span style="color: #000000;"&gt; j;
                                        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;break&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                                    }
                                }
                            } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
                                mLastTouchDownIndex &lt;/span&gt;=&lt;span style="color: #000000;"&gt; childIndex;
                            }
                            mLastTouchDownX &lt;/span&gt;=&lt;span style="color: #000000;"&gt; ev.getX();
                            mLastTouchDownY &lt;/span&gt;=&lt;span style="color: #000000;"&gt; ev.getY();
                            newTouchTarget &lt;/span&gt;=&lt;span style="color: #000000;"&gt; addTouchTarget(child, idBitsToAssign);
                            alreadyDispatchedToNewTouchTarget &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;break&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                        }

                        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; The accessibility focus didn't handle the event, so clear
                        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; the flag and do a normal dispatch to all children.&lt;/span&gt;
                        ev.setTargetAccessibilityFocus(&lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
                    }
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (preorderedList != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) preorderedList.clear();
                }

                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (newTouchTarget == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt; &amp;amp;&amp;amp; mFirstTouchTarget != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
                    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Did not find a child to receive the event.
                    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Assign the pointer to the least recently added target.&lt;/span&gt;
                    newTouchTarget =&lt;span style="color: #000000;"&gt; mFirstTouchTarget;
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;while&lt;/span&gt; (newTouchTarget.next != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
                        newTouchTarget &lt;/span&gt;=&lt;span style="color: #000000;"&gt; newTouchTarget.next;
                    }
                    newTouchTarget.pointerIdBits &lt;/span&gt;|=&lt;span style="color: #000000;"&gt; idBitsToAssign;
                }
            }
        }

        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Dispatch to touch targets.&lt;/span&gt;
        &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (mFirstTouchTarget == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
            &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; No touch targets so treat this as an ordinary view.&lt;/span&gt;
            handled = dispatchTransformedTouchEvent(ev, canceled, &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
                    TouchTarget.ALL_POINTER_IDS);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
            &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Dispatch to touch targets, excluding the new touch target if we already
            &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; dispatched to it.  Cancel touch targets if necessary.&lt;/span&gt;
            TouchTarget predecessor = &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
            TouchTarget target &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mFirstTouchTarget;
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;while&lt;/span&gt; (target != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; TouchTarget next =&lt;span style="color: #000000;"&gt; target.next;
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (alreadyDispatchedToNewTouchTarget &amp;amp;&amp;amp; target ==&lt;span style="color: #000000;"&gt; newTouchTarget) {
                    handled &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; cancelChild =&lt;span style="color: #000000;"&gt; resetCancelNextUpFlag(target.child)
                            &lt;/span&gt;||&lt;span style="color: #000000;"&gt; intercepted;
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (dispatchTransformedTouchEvent(ev, cancelChild,
                            target.child, target.pointerIdBits)) {
                        handled &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                    }
                    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (cancelChild) {
                        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (predecessor == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
                            mFirstTouchTarget &lt;/span&gt;=&lt;span style="color: #000000;"&gt; next;
                        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
                            predecessor.next &lt;/span&gt;=&lt;span style="color: #000000;"&gt; next;
                        }
                        target.recycle();
                        target &lt;/span&gt;=&lt;span style="color: #000000;"&gt; next;
                        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;continue&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
                    }
                }
                predecessor &lt;/span&gt;=&lt;span style="color: #000000;"&gt; target;
                target &lt;/span&gt;=&lt;span style="color: #000000;"&gt; next;
            }
        }

        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Update list of touch targets for pointer up or cancel, if needed.&lt;/span&gt;
        &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (canceled
                &lt;/span&gt;|| actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_UP
                &lt;/span&gt;|| actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_HOVER_MOVE) {
            resetTouchState();
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (split &amp;amp;&amp;amp; actionMasked ==&lt;span style="color: #000000;"&gt; MotionEvent.ACTION_POINTER_UP) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; actionIndex =&lt;span style="color: #000000;"&gt; ev.getActionIndex();
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; idBitsToRemove = 1 &amp;lt;&amp;lt;&lt;span style="color: #000000;"&gt; ev.getPointerId(actionIndex);
            removePointersFromTouchTargets(idBitsToRemove);
        }
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!handled &amp;amp;&amp;amp; mInputEventConsistencyVerifier != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        mInputEventConsistencyVerifier.onUnhandledEvent(ev, &lt;/span&gt;1&lt;span style="color: #000000;"&gt;);
    }
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; handled;
}&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>ViewGroup 分发事件总结：&nbsp;</p>
<p>&nbsp;<strong>1.</strong> android的事件传递是先传递到父类，再到子类的。 <br><strong>&nbsp;2.</strong> ViewGroup中可以通过onInterceptTouchEvent方法对事件传递进行拦截，但是子View可以通过requestDisallowInterceptTouchEvent(boolean disallowIntercept)控制父类的拦截事件是否调用。 <br>&nbsp;<strong>3</strong>. 子View消耗掉点击事件后，父类onTouchEvent方法不会调用，子View不消耗点击事件，会传到父类onTouchEvent方法，父类onTouchEvent方法返回false，则最终传递到activity的onTouchEvent方法。 <br>&nbsp;<strong>4.</strong> ViewGroup一旦调用onInterceptTouchEvent方法拦截点击事件后，本次点击序列事件则都交于该ViewGroup处理，并且onInterceptTouchEvent将不再执行。<br>&nbsp;<strong>5.</strong> 当dispatchTouchEvent在进行事件分发的时候，只有前一个action返回true，才会触发下一个action.也就是说，子view 未消耗点击事件，dispatchTouchEvent返回false，这样mFirstTouchTarget =null，则后续action直接由ViewGroup执行，不传递给子View。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onInterceptTouchEvent(MotionEvent ev) {
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (ev.isFromSource(InputDevice.SOURCE_MOUSE)
                </span>&amp;&amp; ev.getAction() ==<span style="color: #000000;"> MotionEvent.ACTION_DOWN
                </span>&amp;&amp;<span style="color: #000000;"> ev.isButtonPressed(MotionEvent.BUTTON_PRIMARY)
                </span>&amp;&amp;<span style="color: #000000;"> isOnScrollbarThumb(ev.getX(), ev.getY())) {
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
        }
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;"> @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> requestDisallowInterceptTouchEvent(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> disallowIntercept) {

<pre><code>    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (disallowIntercept == ((mGroupFlags &amp;amp; FLAG_DISALLOW_INTERCEPT) != 0&lt;span style="color: #000000;"&gt;)) {
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; We're already in this state, assume our ancestors are too&lt;/span&gt;
        &lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (disallowIntercept) {
        mGroupFlags &lt;/span&gt;|=&lt;span style="color: #000000;"&gt; FLAG_DISALLOW_INTERCEPT;
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        mGroupFlags &lt;/span&gt;&amp;amp;= ~&lt;span style="color: #000000;"&gt;FLAG_DISALLOW_INTERCEPT;
    }

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Pass it up to our parent&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (mParent != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        mParent.requestDisallowInterceptTouchEvent(disallowIntercept);
    }
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h2>三.总结</h2>
<p>一张图介绍PhoneWindow,DecorView，Activity,ViewGroup,View 关系</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180715131417207-666045289.png" alt=""></p>
<p>在来一张图介绍下ViewGroup里的事件分发过程：（该图片来自https://www.jianshu.com/p/cf22ea3b09a5）</p>
<p>注：此图横着分析看，由上到下，由左到右。几个概念注意下 ：UserActivity(=Activiyt),ViewParent(=ViewGoup),ChildView(=View)。</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180715131456221-957174283.png" alt=""></p>
<p>&nbsp;</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/15/Android源码分析十一事件传递机制/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/15/Android源码分析十一事件传递机制/" title="Android 源码分析（十一） 事件传递机制">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/5.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/09/Android源码分析十Dalvik虚拟机创建过程/">
    		Android 源码分析（十） Dalvik 虚拟机创建过程
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-09T13:04:17.000Z">2018-07-09</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/dalvik.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一. 介绍Dalvik</h2>
<p>　　1.java的运行需要JVM,同样android中使用了java语言，也需要一个VM。针对手机处理器和内存等硬件资源不足而推出来的一款VM，为android运行提供环境，叫DVM。</p>
<p>　　2.Dalvik虚拟机允许多个instance的存在。实际上android中的每一个app都是运行在自己VM实例之中(沙盒)。每一个VM实例在linux中又是一个单独的进程，所以可以认为是同一个概念。运行在自己的DVM进程之中，不同的app不会相互干扰，且不会因为一个DVM的崩溃导致所有的app进程都崩溃。这点来说，<strong>Android dvm的进程和Linux的进程, 应用程序的进程 概念类似。</strong></p>
<p><strong>　　3.与<span style="color: #333300;"><strong><span style="font-family: Microsoft YaHei;">JVM的区别：</span></strong></span></strong></p>
<p><strong><span style="color: #333300;"><strong><span style="font-family: Microsoft YaHei;">　　　　</span></strong></span></strong><span style="color: #333300;"><span style="font-family: Microsoft YaHei;">1.基于架构的不同。JVM是基于栈的架构，而DVM是基于寄存器架构。</span></span></p>
<p><span style="color: #333300;"><span style="font-family: Microsoft YaHei;">　　　　2.jvm运行的是字节码文件，而dvm运行自己定义的dex文件格式。</span></span></p>
<p><span style="color: #333300;"><span style="font-family: Microsoft YaHei;">　　　　　　<span style="font-size: small;">JVM编译过程 java-&gt;class-&gt;jar</span><br><span style="font-size: small;">　　　　　　 DVM编译过程java-&gt;class-&gt;dex</span></span></span></p>
<p><span style="color: #333300;"><span style="font-family: Microsoft YaHei;"><span style="font-size: small;">　　　　总结dvm与jvm区别：</span></span></span><span style="color: #333300;"><span style="font-family: Microsoft YaHei;"><span style="font-size: small;">　　　　　</span></span></span></p>
<p>　　　　区别一：dvm执行的是.dex格式文件&nbsp; jvm执行的是.class文件&nbsp;&nbsp; android程序编译完之后生产.class文件，然后，dex工具会把.class文件处理成.dex文件，然后把资源文件和.dex文件等打包成.apk文件。apk就是android package的意思。 jvm执行的是.class文件。</p>
<p>&nbsp;</p>
<p>　　　　区别二:dvm是基于寄存器的虚拟机&nbsp; 而jvm执行是基于虚拟栈的虚拟机。寄存器存取速度比栈快的多，dvm可以根据硬件实现最大的优化，比较适合移动设备。</p>
<p>&nbsp;</p>
<p>　　　　区别三：.class文件存在很多的冗余信息，dex工具会去除冗余信息，并把所有的.class文件整合到.dex文件中。减少了I/O操作，提高了类的查找速度</p>
<p>　　　　</p>
<p>　　　　一张图了解dvm主要做的事：</p>
<p>　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180709210031356-2049035324.png" alt=""></p>
<p>　　　　参考：&nbsp;https://blog.csdn.net/u010355144/article/details/47682797</p>
<h2>二.Dalvik启动过程</h2>
<p>　　</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">AndroidRuntime.cpp</span>
<span style="color: #0000ff;">int</span> AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, <span style="color: #0000ff;">bool</span><span style="color: #000000;"> zygote)
{
    JavaVMInitArgs initArgs;
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> propBuf[PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> stackTraceFileBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xstacktracefile:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jniOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjniopts:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapstartsizeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xms</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapsizeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xmx</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapgrowthlimitOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:HeapGrowthLimit=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapminfreeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:HeapMinFree=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapmaxfreeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:HeapMaxFree=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> usejitOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xusejit:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jitmaxsizeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitmaxsize:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jitinitialsizeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitinitialsize:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jitthresholdOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitthreshold:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> useJitProfilesOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitsaveprofilinginfo:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jitprithreadweightOptBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitprithreadweight:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jittransitionweightOptBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjittransitionweight:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> gctypeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xgc:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> backgroundgcOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:BackgroundGC=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heaptargetutilizationOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:HeapTargetUtilization=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> cachePruneBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xzygote-max-boot-retry=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatXmsImageFlagsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xms</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatXmxImageFlagsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xmx</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatXmsFlagsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xms</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatXmxFlagsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xmx</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatCompilerFilterBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">--compiler-filter=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatImageCompilerFilterBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">--compiler-filter=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatThreadsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-j</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatThreadsImageBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-j</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> dex2oat_isa_variant_key[PROPERTY_KEY_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oat_isa_variant[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">--instruction-set-variant=</span><span style="color: #800000;">"</span>) -<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> dex2oat_isa_features_key[PROPERTY_KEY_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oat_isa_features[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">--instruction-set-features=</span><span style="color: #800000;">"</span>) -<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> dex2oatFlagsBuf[PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> dex2oatImageFlagsBuf[PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> extraOptsBuf[PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> voldDecryptBuf[PROPERTY_VALUE_MAX];
    ...

<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Initialize the VM.
 *
 * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread.
 * If this call succeeds, the VM is ready, and we can start issuing
 * JNI calls.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;amp;initArgs) &amp;lt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;JNI_CreateJavaVM failed\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;</code></pre><p>}</p>
<p></p></span><span style="color: #0000ff;">void</span> AndroidRuntime::start(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>* className, <span style="color: #0000ff;">const</span> Vector&lt;String8&gt;&amp; options, <span style="color: #0000ff;">bool</span><span style="color: #000000;"> zygote)<br>{<p></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt; start the virtual machine &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;
JniInvocation jni_invocation;
jni_invocation.Init(NULL);
JNIEnv&lt;/span&gt;*&lt;span style="color: #000000;"&gt; env;
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (startVm(&amp;amp;mJavaVM, &amp;amp;env, zygote) != &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}
onVmCreated(env);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Register android functions.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (startReg(env) &amp;lt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    ALOGE(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;Unable to register all android natives\n&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}</code></pre><p>}<br><br><span style="color: #339966;">　　　　　//Dalvik虚拟机在Zygote进程中的启动过程，这个启动过程主要就是完成了以下四个事情：</span><br><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; //1. 创建了一个Dalvik虚拟机实例；</span><br><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; //2. 加载了Java核心类及其JNI方法；</span><br><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; //3. 为主线程的设置了一个JNI环境；</span><br><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; //4. 注册了Android核心类的JNI方法。</span><br></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p><strong>Zygote 启动Dalvik作用：</strong></p>
<p>　　1. Zygote进程为Android系统准备好了一个Dalvik虚拟机实例，以后Zygote进程在创建Android应用程序进程的时候，就可以将它自身的Dalvik虚拟机实例复制到新创建Android应用程序进程中去，从而加快了Android应用程序进程的启动过程。</p>
<p><br>　　2.Java核心类和Android核心类（位于dex文件中），以及它们的JNI方法（位于so文件中），都是以内存映射的方式来读取的，因此，Zygote进程在创建Android应用程序进程的时候，除了可以将自身的Dalvik虚拟机实例复制到新创建的Android应用程序进程之外，还可以与新创建的Android应用程序进程共享Java核心类和Android核心类，以及它们的JNI方法，这样就可以节省内存消耗。</p>
<p><br>　　3.Zygote进程为了加快Android应用程序进程的启动过程，牺牲了自己的启动速度，因为它需要加载大量的Java核心类，以及注册大量的Android核心类JNI方法。Dalvik虚拟机在加载Java核心类的时候，还需要对它们进行验证以及优化，这些通常都是比较耗时的。又由于Zygote进程是由init进程启动的，也就是说Zygote进程在是开机的时候进行启动的，因此，Zygote进程的牺牲是比较大的。不过毕竟我们在玩手机的时候，很少会关机，也就是很少开机，因此，牺牲Zygote进程的启动速度是值得的，换来的是Android应用程序的快速启动。</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/09/Android源码分析十Dalvik虚拟机创建过程/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/09/Android源码分析十Dalvik虚拟机创建过程/" title="Android 源码分析（十） Dalvik 虚拟机创建过程">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/9.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/08/Android源码分析九Init启动分析/">
    		Android 源码分析（九） Init 启动分析
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-08T15:05:42.000Z">2018-07-08</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/init.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.前言:&nbsp;&nbsp;&nbsp;</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用</p>
<h3>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；</h3>
<p>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；</p>
<p>&nbsp;&nbsp;&nbsp; SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.</p>
<h2><br>二. init 进程分析</h2>
<p>&nbsp;linux的根进程,同样也是守护进程，usb连接电脑后，cmd窗口，输入：adb shell ps 命令，能看到手机系统中当前跑的所有进程，有一个init进程。<br>&nbsp;init进程主要任务：</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180708230407266-1488130940.png" alt=""></p>
<p>&nbsp;</p>
<p>源码：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">system/core/init/init.cpp

<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;1.创建目录
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;2.将log重定向
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;3.初始化环境变量
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;4.得到硬件信息和版本
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;5.解析内核启动参数
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;6.导入默认环境变量
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;7.得到系统分区&lt;/span&gt;</code></pre><p><span style="color: #0000ff;">int</span> main(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span>**<span style="color: #000000;"> argv) {<br>    </span><span style="color: #0000ff;">if</span> (!strcmp(basename(argv[<span style="color: #800080;">0</span>]), <span style="color: #800000;">“</span><span style="color: #800000;">ueventd</span><span style="color: #800000;">“</span><span style="color: #000000;">)) {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> ueventd_main(argc, argv);<br>    }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!strcmp(basename(argv[&lt;span style="color: #800080;"&gt;0&lt;/span&gt;]), &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;watchdogd&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;)) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; watchdogd_main(argc, argv);
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (REBOOT_BOOTLOADER_ON_PANIC) {
    install_reboot_signal_handlers();
}

add_environment(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;PATH&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, _PATH_DEFPATH);

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;bool&lt;/span&gt; is_first_stage = (getenv(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_SECOND_STAGE&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;) ==&lt;span style="color: #000000;"&gt; nullptr);

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (is_first_stage) {
    boot_clock::time_point start_time &lt;/span&gt;=&lt;span style="color: #000000;"&gt; boot_clock::now();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Clear the umask.&lt;/span&gt;
    umask(&lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Get the basic filesystem setup we need put together in the initramdisk
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; on / and then we'll let the rc file figure out the rest.&lt;/span&gt;
    mount(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;tmpfs&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;tmpfs&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, MS_NOSUID, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;mode=0755&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    mkdir(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev/pts&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800080;"&gt;0755&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    mkdir(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev/socket&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800080;"&gt;0755&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    mount(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;devpts&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev/pts&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;devpts&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;, NULL);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;#define&lt;/span&gt; MAKE_STR(x) __STRING(x)&lt;span style="color: #000000;"&gt;
    mount(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;proc&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/proc&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;proc&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800080;"&gt;0&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;hidepid=2,gid=&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt; MAKE_STR(AID_READPROC));
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Don't expose the raw commandline to unprivileged processes.&lt;/span&gt;
    chmod(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/proc/cmdline&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800080;"&gt;0440&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    gid_t groups[] &lt;/span&gt;=&lt;span style="color: #000000;"&gt; { AID_READPROC };
    setgroups(arraysize(groups), groups);
    mount(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;sysfs&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/sys&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;sysfs&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;, NULL);
    mount(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;selinuxfs&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/sys/fs/selinux&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;selinuxfs&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;, NULL);
    mknod(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev/kmsg&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, S_IFCHR | &lt;span style="color: #800080;"&gt;0600&lt;/span&gt;, makedev(&lt;span style="color: #800080;"&gt;1&lt;/span&gt;, &lt;span style="color: #800080;"&gt;11&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
    mknod(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev/random&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, S_IFCHR | &lt;span style="color: #800080;"&gt;0666&lt;/span&gt;, makedev(&lt;span style="color: #800080;"&gt;1&lt;/span&gt;, &lt;span style="color: #800080;"&gt;8&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
    mknod(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev/urandom&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, S_IFCHR | &lt;span style="color: #800080;"&gt;0666&lt;/span&gt;, makedev(&lt;span style="color: #800080;"&gt;1&lt;/span&gt;, &lt;span style="color: #800080;"&gt;9&lt;/span&gt;&lt;span style="color: #000000;"&gt;));

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; talk to the outside world...&lt;/span&gt;</code></pre><p><span style="color: #000000;">        InitKernelLogging(argv);</span></p>
<pre><code>    LOG(INFO) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;init first stage started!&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;DoFirstStageMount()) {
        LOG(ERROR) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;Failed to mount required partitions early ...&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
        panic();
    }

    SetInitAvbVersionInRecovery();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Set up SELinux, loading the SELinux policy.&lt;/span&gt;
    selinux_initialize(&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; We're in the kernel domain, so re-exec init to transition to the init domain now
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; that the SELinux policy has been loaded.&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (restorecon(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;) == -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        PLOG(ERROR) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;restorecon failed&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
        security_failure();
    }

    setenv(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_SECOND_STAGE&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;true&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;static&lt;/span&gt; constexpr uint32_t kNanosecondsPerMillisecond =&lt;span style="color: #000000;"&gt; 1e6;
    uint64_t start_ms &lt;/span&gt;= start_time.time_since_epoch().count() /&lt;span style="color: #000000;"&gt; kNanosecondsPerMillisecond;
    setenv(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_STARTED_AT&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, StringPrintf(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;%&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt; PRIu64, start_ms).c_str(), &lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;char&lt;/span&gt;* path = argv[&lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;];
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;char&lt;/span&gt;* args[] =&lt;span style="color: #000000;"&gt; { path, nullptr };
    execv(path, args);

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; execv() only returns if an error happened, in which case we
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; panic and never fall through this conditional.&lt;/span&gt;
    PLOG(ERROR) &amp;lt;&amp;lt; &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;execv(\"&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt; &amp;lt;&amp;lt; path &amp;lt;&amp;lt; &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;\") failed&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    security_failure();
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; At this point we're in the second stage of init.&lt;/span&gt;</code></pre><p><span style="color: #000000;">    InitKernelLogging(argv);<br>    LOG(INFO) </span>&lt;&lt; <span style="color: #800000;">“</span><span style="color: #800000;">init second stage started!</span><span style="color: #800000;">“</span><span style="color: #000000;">;</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Set up a session keyring that all processes will have access to. It
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; will hold things like FBE encryption keys. No process should override
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; its session keyring.&lt;/span&gt;
keyctl(KEYCTL_GET_KEYRING_ID, KEY_SPEC_SESSION_KEYRING, &lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Indicate that booting is in progress to background fw loaders, etc.&lt;/span&gt;
close(open(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/dev/.booting&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, O_WRONLY | O_CREAT | O_CLOEXEC, &lt;span style="color: #800080;"&gt;0000&lt;/span&gt;&lt;span style="color: #000000;"&gt;));

property_init();

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If arguments are passed both on the command line and in DT,
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; properties set in DT always have priority over the command-line ones.&lt;/span&gt;</code></pre><p><span style="color: #000000;">    process_kernel_dt();<br>    process_kernel_cmdline();</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Propagate the kernel variables to internal variables
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; used by init as well as the current required properties.&lt;/span&gt;</code></pre><p><span style="color: #000000;">    export_kernel_boot_props();</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Make the time that init started available for bootstat to log.&lt;/span&gt;
property_set(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;ro.boottime.init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, getenv(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_STARTED_AT&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
property_set(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;ro.boottime.init.selinux&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, getenv(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_SELINUX_TOOK&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;));

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Set libavb version for Framework-only OTA match in Treble build.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;const&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;char&lt;/span&gt;* avb_version = getenv(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_AVB_VERSION&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (avb_version) property_set(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;ro.boot.avb_version&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;, avb_version);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Clean up our environment.&lt;/span&gt;
unsetenv(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_SECOND_STAGE&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
unsetenv(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_STARTED_AT&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
unsetenv(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_SELINUX_TOOK&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
unsetenv(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;INIT_AVB_VERSION&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Now set up SELinux for second stage.&lt;/span&gt;
selinux_initialize(&lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
selinux_restore_context();

epoll_fd &lt;/span&gt;=&lt;span style="color: #000000;"&gt; epoll_create1(EPOLL_CLOEXEC);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (epoll_fd == -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    PLOG(ERROR) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;epoll_create1 failed&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    exit(&lt;/span&gt;&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
}

signal_handler_init();

property_load_boot_defaults();
export_oem_lock_status();
start_property_service();
set_usb_controller();

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;const&lt;/span&gt;&lt;span style="color: #000000;"&gt; BuiltinFunctionMap function_map;
Action::set_function_map(&lt;/span&gt;&amp;amp;&lt;span style="color: #000000;"&gt;function_map);

Parser&lt;/span&gt;&amp;amp; parser =&lt;span style="color: #000000;"&gt; Parser::GetInstance();
parser.AddSectionParser(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;service&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;,std::make_unique&amp;lt;ServiceParser&amp;gt;&lt;span style="color: #000000;"&gt;());
parser.AddSectionParser(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;on&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, std::make_unique&amp;lt;ActionParser&amp;gt;&lt;span style="color: #000000;"&gt;());
parser.AddSectionParser(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;import&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, std::make_unique&amp;lt;ImportParser&amp;gt;&lt;span style="color: #000000;"&gt;());
std::&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;string&lt;/span&gt; bootscript = GetProperty(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;ro.boot.init_rc&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;""&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (bootscript.empty()) {
    parser.ParseConfig(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/init.rc&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    parser.set_is_system_etc_init_loaded(
            parser.ParseConfig(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/system/etc/init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
    parser.set_is_vendor_etc_init_loaded(
            parser.ParseConfig(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/vendor/etc/init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
    parser.set_is_odm_etc_init_loaded(parser.ParseConfig(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;/odm/etc/init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    parser.ParseConfig(bootscript);
    parser.set_is_system_etc_init_loaded(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    parser.set_is_vendor_etc_init_loaded(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    parser.set_is_odm_etc_init_loaded(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Turning this on and letting the INFO logging be discarded adds 0.2s to
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Nexus 9 boot time, so it's disabled by default.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;) parser.DumpState();

ActionManager&lt;/span&gt;&amp;amp; am =&lt;span style="color: #000000;"&gt; ActionManager::GetInstance();

am.QueueEventTrigger(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;early-init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...&lt;/span&gt;
am.QueueBuiltinAction(wait_for_coldboot_done_action, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;wait_for_coldboot_done&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; ... so that we can start queuing up actions that require stuff from /dev.&lt;/span&gt;
am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;mix_hwrng_into_linux_rng&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
am.QueueBuiltinAction(set_mmap_rnd_bits_action, &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;set_mmap_rnd_bits&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
am.QueueBuiltinAction(set_kptr_restrict_action, &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;set_kptr_restrict&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
am.QueueBuiltinAction(keychord_init_action, &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;keychord_init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
am.QueueBuiltinAction(console_init_action, &lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;console_init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Trigger all the boot actions to get us started.&lt;/span&gt;
am.QueueEventTrigger(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; wasn't ready immediately after wait_for_coldboot_done&lt;/span&gt;
am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;mix_hwrng_into_linux_rng&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Don't mount filesystems or start core system services in charger mode.&lt;/span&gt;
std::&lt;span style="color: #0000ff;"&gt;string&lt;/span&gt; bootmode = GetProperty(&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;ro.bootmode&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;, &lt;span style="color: #800000;"&gt;""&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (bootmode == &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;charger&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    am.QueueEventTrigger(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;charger&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    am.QueueEventTrigger(&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;late-init&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Run all property triggers based on current state of the properties.&lt;/span&gt;
am.QueueBuiltinAction(queue_property_triggers_action, &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;queue_property_triggers&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;while&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; By default, sleep until something happens.&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; epoll_timeout_ms = -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!(waiting_for_prop ||&lt;span style="color: #000000;"&gt; ServiceManager::GetInstance().IsWaitingForExec())) {
        am.ExecuteOneCommand();
    }
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!(waiting_for_prop ||&lt;span style="color: #000000;"&gt; ServiceManager::GetInstance().IsWaitingForExec())) {
        restart_processes();

        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If there's a process that needs restarting, wake up in time for that.&lt;/span&gt;
        &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (process_needs_restart_at != &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
            epoll_timeout_ms &lt;/span&gt;= (process_needs_restart_at - time(nullptr)) * &lt;span style="color: #800080;"&gt;1000&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (epoll_timeout_ms &amp;lt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;) epoll_timeout_ms = &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
        }

        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If there's more work to do, wake up again immediately.&lt;/span&gt;
        &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (am.HasMoreCommands()) epoll_timeout_ms = &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }

    epoll_event ev;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;amp;ev, &lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;, epoll_timeout_ms));
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (nr == -&lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        PLOG(ERROR) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #800000;"&gt;epoll_wait failed&lt;/span&gt;&lt;span style="color: #800000;"&gt;"&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (nr == &lt;span style="color: #800080;"&gt;1&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        ((&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;void&lt;/span&gt; (*&lt;span style="color: #000000;"&gt;)()) ev.data.ptr)();
    }
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #800080;"&gt;0&lt;/span&gt;&lt;span style="color: #000000;"&gt;;</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/08/Android源码分析九Init启动分析/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/08/Android源码分析九Init启动分析/" title="Android 源码分析（九） Init 启动分析">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/8.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/07/Android源码分析八Launcher桌面启动App过程/">
    		Android 源码分析（八） Launcher 桌面启动App过程
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-07T12:13:12.000Z">2018-07-07</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/Launcher_app.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.<br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. Launcher 桌面启动App过程分析</h2>
<p>Launcher应用程序在启动过程中会通过PackageManagerService服务请求查询系统所有的已安装应用的包名，图标和应用名称等信息，然后填充到Launcher中的Adapter中.<br>这样点击某一项应用图标的时候就可以根据该图标的包名和启动Activity的类名初始化Intent对象，然后调用startActivity(Intent)启动相关的应用程序了。<br>其实android中应用进程可以通过许多方式启动，比如启动一个Activity，启动一个Service，启动一个ContentProvider或者是一个BroadcastReceiver，也就是说我们可以通过启动四大组件的方式启动应用进程，在应用进程没有启动的时候，如果我们通过启动这些组件，这时候系统会判断当前这些组件所需要的应用进程是否已经启动，若没有的话，则会启动应用进程。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">LauncherActivity.java</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> LauncherActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ListActivity {
    ......
    @Override
    </span><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onListItemClick(ListView l, View v, <span style="color: #0000ff;">int</span> position, <span style="color: #0000ff;">long</span><span style="color: #000000;"> id) {
        Intent intent </span>=<span style="color: #000000;"> intentForPosition(position);
        startActivity(intent);
    }
    ......

<pre><code>@Override
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; startActivity(Intent intent) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;.startActivity(intent, &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
}
......
 @Override
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; startActivity(Intent intent, @Nullable Bundle options) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (options != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        startActivityForResult(intent, &lt;/span&gt;-1&lt;span style="color: #000000;"&gt;, options);
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Note we want to go through this call for compatibility with
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; applications that may have overridden the method.&lt;/span&gt;
        startActivityForResult(intent, -1&lt;span style="color: #000000;"&gt;);
    }
}
......
&lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Adapter which shows the set of activities that can be performed for a given intent.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;class&lt;/span&gt; ActivityAdapter &lt;span style="color: #0000ff;"&gt;extends&lt;/span&gt; BaseAdapter &lt;span style="color: #0000ff;"&gt;implements&lt;/span&gt;&lt;span style="color: #000000;"&gt; Filterable {
    ......
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt; View getView(&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt; position, View convertView, ViewGroup parent) {
        View view;
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (convertView == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
            view &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mInflater.inflate(
                    com.android.internal.R.layout.activity_list_item_2, parent, &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
            view &lt;/span&gt;=&lt;span style="color: #000000;"&gt; convertView;
        }
        bindView(view, mActivitiesList.get(position));
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; view;
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; bindView(View view, ListItem item) {
        TextView text &lt;/span&gt;=&lt;span style="color: #000000;"&gt; (TextView) view;
        text.setText(item.label);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (mShowIcons) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (item.icon == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
                item.icon &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mIconResizer.createIconThumbnail(item.resolveInfo.loadIcon(getPackageManager()));
            }
            text.setCompoundDrawablesWithIntrinsicBounds(item.icon, &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;, &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
        }
    }
    ......
}</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">activity_list.xml Launcher 桌面就是一个列表控件，来存放所有应用的图标和名称</span>
&lt;FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"<span style="color: #000000;">
    android:layout_width</span>="match_parent"<span style="color: #000000;">
    android:layout_height</span>="match_parent"
    &gt;

<pre><code>&amp;lt;&lt;span style="color: #000000;"&gt;ListView
    android:id&lt;/span&gt;="@android:id/list"&lt;span style="color: #000000;"&gt;
    android:layout_width&lt;/span&gt;="match_parent"&lt;span style="color: #000000;"&gt;
    android:layout_height&lt;/span&gt;="match_parent"
    /&amp;gt;

&amp;lt;&lt;span style="color: #000000;"&gt;TextView
    android:id&lt;/span&gt;="@android:id/empty"&lt;span style="color: #000000;"&gt;
    android:layout_width&lt;/span&gt;="match_parent"&lt;span style="color: #000000;"&gt;
    android:layout_height&lt;/span&gt;="match_parent"&lt;span style="color: #000000;"&gt;
    android:gravity&lt;/span&gt;="center"&lt;span style="color: #000000;"&gt;
    android:text&lt;/span&gt;="@string/activity_list_empty"&lt;span style="color: #000000;"&gt;
    android:visibility&lt;/span&gt;="gone"&lt;span style="color: #000000;"&gt;
    android:textAppearance&lt;/span&gt;="?android:attr/textAppearanceMedium"
    /&amp;gt;</code></pre><p>&lt;/FrameLayout&gt;</p></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">activity_list_item_2.xml 列表控件的子项，存放应用名称和应用logo。drawablePadding="14dip".</span>
&lt;TextView xmlns:android="http://schemas.android.com/apk/res/android"<span style="color: #000000;">
    android:layout_width</span>="match_parent"<span style="color: #000000;">
    android:layout_height</span>="wrap_content"<span style="color: #000000;">
    android:minHeight</span>="?attr/listPreferredItemHeight"<span style="color: #000000;">
    android:textAppearance</span>="?attr/textAppearanceListItemSmall"<span style="color: #000000;">
    android:gravity</span>="center_vertical"<span style="color: #000000;">
    android:drawablePadding</span>="14dip"<span style="color: #000000;">
    android:paddingStart</span>="?attr/listPreferredItemPaddingStart"<span style="color: #000000;">
    android:paddingEnd</span>="?attr/listPreferredItemPaddingEnd" /&gt;</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>后面就进入了Activity的启动流程了。</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/07/Android源码分析八Launcher桌面启动App过程/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/07/Android源码分析八Launcher桌面启动App过程/" title="Android 源码分析（八） Launcher 桌面启动App过程">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/7.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/07/Android源码分析七Launcher桌面程序启动分析/">
    		Android 源码分析（七） Launcher 桌面程序启动分析
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-07T11:51:44.000Z">2018-07-07</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/Launcher.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;<strong>Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序</strong>.<strong>在Zygote进程里等待SystemService进程启动后，创建.</strong><br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. Launcher 桌面程序启动</h2>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Launcher程序就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序。</p>
<p>　　首先了解下，Zygote进程是如何启动一个应用的。</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180708235023116-19887742.png" alt=""></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteServer.java</span>
 <span style="color: #0000ff;">void</span> runSelectLoop(String abiList) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller {
        ArrayList</span>&lt;FileDescriptor&gt; fds = <span style="color: #0000ff;">new</span> ArrayList&lt;FileDescriptor&gt;<span style="color: #000000;">();
        ArrayList</span>&lt;ZygoteConnection&gt; peers = <span style="color: #0000ff;">new</span> ArrayList&lt;ZygoteConnection&gt;<span style="color: #000000;">();

<pre><code>    fds.add(mServerSocket.getFileDescriptor());
    peers.add(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;while&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        StructPollfd[] pollFds &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; StructPollfd[fds.size()];
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; i = 0; i &amp;lt; pollFds.length; ++&lt;span style="color: #000000;"&gt;i) {
            pollFds[i] &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; StructPollfd();
            pollFds[i].fd &lt;/span&gt;=&lt;span style="color: #000000;"&gt; fds.get(i);
            pollFds[i].events &lt;/span&gt;= (&lt;span style="color: #0000ff;"&gt;short&lt;/span&gt;&lt;span style="color: #000000;"&gt;) POLLIN;
        }
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
            Os.poll(pollFds, &lt;/span&gt;-1&lt;span style="color: #000000;"&gt;);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ErrnoException ex) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; RuntimeException("poll failed"&lt;span style="color: #000000;"&gt;, ex);
        }
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; i = pollFds.length - 1; i &amp;gt;= 0; --&lt;span style="color: #000000;"&gt;i) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; ((pollFds[i].revents &amp;amp; POLLIN) == 0&lt;span style="color: #000000;"&gt;) {
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;continue&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
            }
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (i == 0&lt;span style="color: #000000;"&gt;) {
                ZygoteConnection newPeer &lt;/span&gt;=&lt;span style="color: #000000;"&gt; acceptCommandPeer(abiList);
                peers.add(newPeer);
                fds.add(newPeer.getFileDesciptor());
            } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; done = peers.get(i).runOnce(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (done) {
                    peers.remove(i);
                    fds.remove(i);
                }
            }
        }
    }
}</code></pre><p>}<br><br>　　/**<br>&nbsp;&nbsp;&nbsp;&nbsp; * Waits for and accepts a single command connection. Throws<br>&nbsp;&nbsp;&nbsp;&nbsp; * RuntimeException on failure.<br>&nbsp;&nbsp;&nbsp;&nbsp; */<br>&nbsp;&nbsp;&nbsp; private ZygoteConnection acceptCommandPeer(String abiList) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return createNewConnection(mServerSocket.accept(), abiList);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (IOException ex) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new RuntimeException(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; “IOException during accept()”, ex);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;<br>&nbsp;protected ZygoteConnection createNewConnection(LocalSocket socket, String abiList)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throws IOException {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new ZygoteConnection(socket, abiList);<br>&nbsp;&nbsp;&nbsp; }<br></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('b4582d4a-5eee-42a1-a93e-5858a6f4d479')"><img id="code_img_closed_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('b4582d4a-5eee-42a1-a93e-5858a6f4d479',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteConnection.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Constructs instance from connected socket.
     *
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> socket non-null; connected socket
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> abiList non-null; a list of ABIs this zygote supports.
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IOException
     </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    ZygoteConnection(LocalSocket socket, String abiList) </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
        mSocket </span>=<span style="color: #000000;"> socket;
        </span><span style="color: #0000ff;">this</span>.abiList =<span style="color: #000000;"> abiList;

<pre><code>    mSocketOutStream
            &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; DataOutputStream(socket.getOutputStream());

    mSocketReader &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; BufferedReader(
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; InputStreamReader(socket.getInputStream()), 256&lt;span style="color: #000000;"&gt;);

    mSocket.setSoTimeout(CONNECTION_TIMEOUT_MILLIS);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        peer &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mSocket.getPeerCredentials();
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (IOException ex) {
        Log.e(TAG, &lt;/span&gt;"Cannot read peer credentials"&lt;span style="color: #000000;"&gt;, ex);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt;&lt;span style="color: #000000;"&gt; ex;
    }
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Reads one start command from the command socket. If successful,
 * a child is forked and a {&lt;/span&gt;&lt;span style="color: #808080;"&gt;@link&lt;/span&gt;&lt;span style="color: #008000;"&gt; Zygote.MethodAndArgsCaller}
 * exception is thrown in that child while in the parent process,
 * the method returns normally. On failure, the child is not
 * spawned and messages are printed to the log and stderr. Returns
 * a boolean status value indicating whether an end-of-file on the command
 * socket has been encountered.
 *
 * &lt;/span&gt;&lt;span style="color: #808080;"&gt;@return&lt;/span&gt;&lt;span style="color: #008000;"&gt; false if command socket should continue to be read from, or
 * true if an end-of-file has been encountered.
 * &lt;/span&gt;&lt;span style="color: #808080;"&gt;@throws&lt;/span&gt;&lt;span style="color: #008000;"&gt; Zygote.MethodAndArgsCaller trampoline to invoke main()
 * method in child process
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; runOnce(ZygoteServer zygoteServer) &lt;span style="color: #0000ff;"&gt;throws&lt;/span&gt;&lt;span style="color: #000000;"&gt; Zygote.MethodAndArgsCaller {

    String args[];
    Arguments parsedArgs &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    FileDescriptor[] descriptors;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        args &lt;/span&gt;=&lt;span style="color: #000000;"&gt; readArgumentList();
        descriptors &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mSocket.getAncillaryFileDescriptors();
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (IOException ex) {
        Log.w(TAG, &lt;/span&gt;"IOException on command socket " +&lt;span style="color: #000000;"&gt; ex.getMessage());
        closeSocket();
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (args == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; EOF reached.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            closeSocket();<br>            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt; the stderr of the most recent request, if avail &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;
PrintStream newStderr &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (descriptors != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt; &amp;amp;&amp;amp; descriptors.length &amp;gt;= 3&lt;span style="color: #000000;"&gt;) {
    newStderr &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; PrintStream(
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; FileOutputStream(descriptors[2&lt;span style="color: #000000;"&gt;]));
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; pid = -1&lt;span style="color: #000000;"&gt;;
FileDescriptor childPipeFd &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
FileDescriptor serverPipeFd &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    parsedArgs &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; Arguments(args);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (parsedArgs.abiListQuery) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; handleAbiListQuery();
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (parsedArgs.preloadDefault) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; handlePreload();
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.preloadPackage != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; handlePreloadPackage(parsedArgs.preloadPackage,
                parsedArgs.preloadPackageLibs, parsedArgs.preloadPackageCacheKey);
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.permittedCapabilities != 0 || parsedArgs.effectiveCapabilities != 0&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; ZygoteSecurityException("Client may not specify capabilities: " +
                "permitted=0x" + Long.toHexString(parsedArgs.permittedCapabilities) +
                ", effective=0x" +&lt;span style="color: #000000;"&gt; Long.toHexString(parsedArgs.effectiveCapabilities));
    }

    applyUidSecurityPolicy(parsedArgs, peer);
    applyInvokeWithSecurityPolicy(parsedArgs, peer);

    applyDebuggerSystemProperty(parsedArgs);
    applyInvokeWithSystemProperty(parsedArgs);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;[][] rlimits = &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.rlimits != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        rlimits &lt;/span&gt;=&lt;span style="color: #000000;"&gt; parsedArgs.rlimits.toArray(intArray2d);
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;[] fdsToIgnore = &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.invokeWith != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        FileDescriptor[] pipeFds &lt;/span&gt;=&lt;span style="color: #000000;"&gt; Os.pipe2(O_CLOEXEC);
        childPipeFd &lt;/span&gt;= pipeFds[1&lt;span style="color: #000000;"&gt;];
        serverPipeFd &lt;/span&gt;= pipeFds[0&lt;span style="color: #000000;"&gt;];
        Os.fcntlInt(childPipeFd, F_SETFD, &lt;/span&gt;0&lt;span style="color: #000000;"&gt;);
        fdsToIgnore &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt;[] { childPipeFd.getInt$(), serverPipeFd.getInt$() };
    }

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
     * In order to avoid leaking descriptors to the Zygote child,
     * the native code must close the two Zygote socket descriptors
     * in the child process before it switches from Zygote-root to
     * the UID and privileges of the application being launched.
     *
     * In order to avoid "bad file descriptor" errors when the
     * two LocalSocket objects are closed, the Posix file
     * descriptors are released via a dup2() call which closes
     * the socket and substitutes an open descriptor to /dev/null.
     &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;

    &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; [] fdsToClose = { -1, -1&lt;span style="color: #000000;"&gt; };

    FileDescriptor fd &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mSocket.getFileDescriptor();

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (fd != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        fdsToClose[&lt;/span&gt;0] =&lt;span style="color: #000000;"&gt; fd.getInt$();
    }

    fd &lt;/span&gt;=&lt;span style="color: #000000;"&gt; zygoteServer.getServerSocketFileDescriptor();

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (fd != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        fdsToClose[&lt;/span&gt;1] =&lt;span style="color: #000000;"&gt; fd.getInt$();
    }

    fd &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    pid &lt;/span&gt;=&lt;span style="color: #000000;"&gt; Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,
            parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,
            parsedArgs.niceName, fdsToClose, fdsToIgnore, parsedArgs.instructionSet,
            parsedArgs.appDataDir);
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ErrnoException ex) {
    logAndPrintError(newStderr, &lt;/span&gt;"Exception creating pipe"&lt;span style="color: #000000;"&gt;, ex);
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (IllegalArgumentException ex) {
    logAndPrintError(newStderr, &lt;/span&gt;"Invalid zygote arguments"&lt;span style="color: #000000;"&gt;, ex);
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ZygoteSecurityException ex) {
    logAndPrintError(newStderr,
            &lt;/span&gt;"Zygote security policy prevents request: "&lt;span style="color: #000000;"&gt;, ex);
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (pid == 0&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; in child&lt;/span&gt;</code></pre><p><span style="color: #000000;">                zygoteServer.closeServerSocket();<br>                IoUtils.closeQuietly(serverPipeFd);<br>                serverPipeFd </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span></p>
<pre><code>    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; should never get here, the child is expected to either
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; throw Zygote.MethodAndArgsCaller or exec().&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; in parent...pid of &amp;lt; 0 means failure&lt;/span&gt;</code></pre><p><span style="color: #000000;">                IoUtils.closeQuietly(childPipeFd);<br>                childPipeFd </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);<br>            }<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            IoUtils.closeQuietly(childPipeFd);<br>            IoUtils.closeQuietly(serverPipeFd);<br>        }<br>    }<br>    </span></p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('24047af0-fb9d-4495-955a-61ae30e0b7ac')"><img id="code_img_closed_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('24047af0-fb9d-4495-955a-61ae30e0b7ac',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">Zygote.java</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> forkAndSpecialize(<span style="color: #0000ff;">int</span> uid, <span style="color: #0000ff;">int</span> gid, <span style="color: #0000ff;">int</span>[] gids, <span style="color: #0000ff;">int</span><span style="color: #000000;"> debugFlags,
          </span><span style="color: #0000ff;">int</span>[][] rlimits, <span style="color: #0000ff;">int</span> mountExternal, String seInfo, String niceName, <span style="color: #0000ff;">int</span><span style="color: #000000;">[] fdsToClose,
          </span><span style="color: #0000ff;">int</span><span style="color: #000000;">[] fdsToIgnore, String instructionSet, String appDataDir) {
        VM_HOOKS.preFork();
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Resets nice priority for zygote process.</span>
<span style="color: #000000;">        resetNicePriority();
        </span><span style="color: #0000ff;">int</span> pid =<span style="color: #000000;"> nativeForkAndSpecialize(
                  uid, gid, gids, debugFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,
                  fdsToIgnore, instructionSet, appDataDir);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Enable tracing as soon as possible for the child process.</span>
        <span style="color: #0000ff;">if</span> (pid == 0<span style="color: #000000;">) {
            Trace.setTracingEnabled(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);

<pre><code>        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Note that this event ends at the end of handleChildProc,&lt;/span&gt;
        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, "PostFork"&lt;span style="color: #000000;"&gt;);
    }
    VM_HOOKS.postForkCommon();
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; pid;
}&lt;/span&gt;&lt;/pre&gt;</code></pre></span></pre></div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('585017ee-5c61-4dd0-b78d-a900abceb71c')"><img id="code_img_closed_585017ee-5c61-4dd0-b78d-a900abceb71c" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_585017ee-5c61-4dd0-b78d-a900abceb71c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('585017ee-5c61-4dd0-b78d-a900abceb71c',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_585017ee-5c61-4dd0-b78d-a900abceb71c" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteConnection.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Handles post-fork setup of child proc, closing sockets as appropriate,
     * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller
     * if successful or returning if failed.
     *
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> parsedArgs non-null; zygote args
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> descriptors null-ok; new file descriptors for stdio if available.
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> pipeFd null-ok; pipe for communication back to Zygote.
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> newStderr null-ok; stream to use for stderr until stdio
     * is reopened.
     *
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Zygote.MethodAndArgsCaller on success to
     * trampoline to code that invokes static main.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleChildProc(Arguments parsedArgs,
            FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)
            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller {
        </span><span style="color: #008000;">/**</span><span style="color: #008000;">
         * By the time we get here, the native code has closed the two actual Zygote
         * socket connections, and substituted /dev/null in their place.  The LocalSocket
         * objects still need to be closed properly.
         </span><span style="color: #008000;">*/</span><span style="color: #000000;">

<pre><code>closeSocket();
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (descriptors != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        Os.dup2(descriptors[&lt;/span&gt;0&lt;span style="color: #000000;"&gt;], STDIN_FILENO);
        Os.dup2(descriptors[&lt;/span&gt;1&lt;span style="color: #000000;"&gt;], STDOUT_FILENO);
        Os.dup2(descriptors[&lt;/span&gt;2&lt;span style="color: #000000;"&gt;], STDERR_FILENO);

        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt;&lt;span style="color: #000000;"&gt; (FileDescriptor fd: descriptors) {
            IoUtils.closeQuietly(fd);
        }
        newStderr &lt;/span&gt;=&lt;span style="color: #000000;"&gt; System.err;
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ErrnoException ex) {
        Log.e(TAG, &lt;/span&gt;"Error reopening stdio"&lt;span style="color: #000000;"&gt;, ex);
    }
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.niceName != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    Process.setArgV0(parsedArgs.niceName);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; End of the postFork event.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>        </span><span style="color: #0000ff;">if</span> (parsedArgs.invokeWith != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            WrapperInit.execApplication(parsedArgs.invokeWith,<br>                    parsedArgs.niceName, parsedArgs.targetSdkVersion,<br>                    VMRuntime.getCurrentInstructionSet(),<br>                    pipeFd, parsedArgs.remainingArgs);<br>        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br>            ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion,<br>                    parsedArgs.remainingArgs, </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> classLoader </span><span style="color: #008000;">*/</span><span style="color: #000000;">);<br>        }<br>    }</span></p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p>
<p>　　前一篇文章我们知道在SystemServer进程的启动过程中会调用其main静态方法，开始执行整个SystemServer的启动流程。在调用startOtherService方法中就会通过调用mActivityManagerService.systemReady()方法。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">SystemServer.java</span>
<span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> startOtherServices() {
    ......
         </span><span style="color: #008000;">//</span><span style="color: #008000;"> We now tell the activity manager it is okay to run third party
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> code.  It will call back into us once it has gotten to the state
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> where third party code can really run (but before it has actually
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> started launching the initial applications), for us to complete our
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> initialization.</span>
<span style="color: #000000;">        mActivityManagerService.systemReady()
    ......
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ActivityManagerService.java</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> systemReady(<span style="color: #0000ff;">final</span><span style="color: #000000;"> Runnable goingCallback, BootTimingsTraceLog traceLog) {
        ......
    startHomeActivityLocked(currentUserId, </span>"systemReady"<span style="color: #000000;">);
        ......

<p>}</p>
<p></p></span><span style="color: #0000ff;">boolean</span> startHomeActivityLocked(<span style="color: #0000ff;">int</span><span style="color: #000000;"> userId, String reason) {<br>        </span><span style="color: #0000ff;">if</span> (mFactoryTest ==<span style="color: #000000;"> FactoryTest.FACTORY_TEST_LOW_LEVEL<br>                </span>&amp;&amp; mTopAction == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> We are running in factory test mode, but unable to find<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> the factory test app, so just sit around displaying the<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> error message and don’t try to start anything.</span><br>            <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        }<br>        Intent intent </span>=<span style="color: #000000;"> getHomeIntent();<br>        ActivityInfo aInfo </span>=<span style="color: #000000;"> resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);<br>        </span><span style="color: #0000ff;">if</span> (aInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            intent.setComponent(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Don’t do this if the home app is currently being<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> instrumented.</span><br>            aInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ActivityInfo(aInfo);<br>            aInfo.applicationInfo </span>=<span style="color: #000000;"> getAppInfoForUser(aInfo.applicationInfo, userId);<br>            ProcessRecord app </span>=<span style="color: #000000;"> getProcessRecordLocked(aInfo.processName,<br>                    aInfo.applicationInfo.uid, </span><span style="color: #0000ff;">true</span><span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span> (app == <span style="color: #0000ff;">null</span> || app.instr == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>                intent.setFlags(intent.getFlags() </span>|<span style="color: #000000;"> Intent.FLAG_ACTIVITY_NEW_TASK);<br>                </span><span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> resolvedUserId =<span style="color: #000000;"> UserHandle.getUserId(aInfo.applicationInfo.uid);<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;"> For ANR debugging to verify if the user activity is the one that actually<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;"> launched.</span><br>                <span style="color: #0000ff;">final</span> String myReason = reason + “:” + userId + “:” +<span style="color: #000000;"> resolvedUserId;<br>                mActivityStarter.startHomeActivityLocked(intent, aInfo, myReason);<br>            }<br>        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br>            Slog.wtf(TAG, </span>“No home screen found for “ + intent, <span style="color: #0000ff;">new</span><span style="color: #000000;"> Throwable());<br>        }<p></p>
<pre><code>    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

 Intent getHomeIntent() {
    Intent intent &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; Intent(mTopAction, mTopData != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt; ? Uri.parse(mTopData) : &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    intent.setComponent(mTopComponent);
    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (mFactoryTest !=&lt;span style="color: #000000;"&gt; FactoryTest.FACTORY_TEST_LOW_LEVEL) {
        intent.addCategory(Intent.CATEGORY_HOME);
    }
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; intent;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ActivityStarter.java</span>
    <span style="color: #0000ff;">void</span><span style="color: #000000;"> startHomeActivityLocked(Intent intent, ActivityInfo aInfo, String reason) {
        mSupervisor.moveHomeStackTaskToTop(reason);
        mLastHomeActivityStartResult </span>= startActivityLocked(<span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">caller</span><span style="color: #008000;">*/</span><span style="color: #000000;">, intent,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">ephemeralIntent</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resolvedType</span><span style="color: #008000;">*/</span>, aInfo, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">rInfo</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">voiceSession</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">voiceInteractor</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resultTo</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resultWho</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">requestCode</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">callingPid</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">callingUid</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">callingPackage</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">realCallingPid</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">realCallingUid</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span>0 <span style="color: #008000;">/*</span><span style="color: #008000;">startFlags</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">options</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">false</span> <span style="color: #008000;">/*</span><span style="color: #008000;">ignoreTargetSecurity</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">false</span> <span style="color: #008000;">/*</span><span style="color: #008000;">componentSpecified</span><span style="color: #008000;">*/</span>, mLastHomeActivityStartRecord <span style="color: #008000;">/*</span><span style="color: #008000;">outActivity</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">container</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">inTask</span><span style="color: #008000;">*/</span>, "startHomeActivity: " +<span style="color: #000000;"> reason);
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (mSupervisor.inResumeTopActivity) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> If we are in resume section already, home activity will be initialized, but not
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> resumed (to avoid recursive resume) and will stay that way until something pokes it
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> again. We need to schedule another resume.</span>
<span style="color: #000000;">            mSupervisor.scheduleResumeTopActivities();
        }
    }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp; 后面就进入了Activity的启动流程了。</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/07/Android源码分析七Launcher桌面程序启动分析/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/07/Android源码分析七Launcher桌面程序启动分析/" title="Android 源码分析（七） Launcher 桌面程序启动分析">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/7.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Android/">Android</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/">
    		Android 源码分析（六） SystemServer 进程
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        huangguangzhi 发表于
        <time datetime="2018-07-07T07:14:19.000Z">2018-07-07</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p><a href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>&nbsp;&nbsp;&nbsp; 一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; <strong>SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；</strong><br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.<br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. SystemService进程</h2>
<p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; ZygoteInit类的main方法调用了StartSystemService() 启动SystemService.<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SystemServer进程主要的作用是启动各种系统服务，比如ActivityManagerService，PackageManagerService，WindowManagerService等服务.</p>
<p>&nbsp;</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteInit.java</span>
     <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Prepare the arguments and fork for the system server process.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> startSystemServer(String abiList, String socketName, ZygoteServer zygoteServer)
            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller, RuntimeException {
        </span><span style="color: #0000ff;">long</span> capabilities =<span style="color: #000000;"> posixCapabilitiesAsBits(
            OsConstants.CAP_IPC_LOCK,
            OsConstants.CAP_KILL,
            OsConstants.CAP_NET_ADMIN,
            OsConstants.CAP_NET_BIND_SERVICE,
            OsConstants.CAP_NET_BROADCAST,
            OsConstants.CAP_NET_RAW,
            OsConstants.CAP_SYS_MODULE,
            OsConstants.CAP_SYS_NICE,
            OsConstants.CAP_SYS_PTRACE,
            OsConstants.CAP_SYS_TIME,
            OsConstants.CAP_SYS_TTY_CONFIG,
            OsConstants.CAP_WAKE_ALARM
        );
        </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Containers run without this capability, so avoid setting it in that case </span><span style="color: #008000;">*/</span>
        <span style="color: #0000ff;">if</span> (!SystemProperties.getBoolean(PROPERTY_RUNNING_IN_CONTAINER, <span style="color: #0000ff;">false</span><span style="color: #000000;">)) {
            capabilities </span>|=<span style="color: #000000;"> posixCapabilitiesAsBits(OsConstants.CAP_BLOCK_SUSPEND);
        }
        </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Hardcoded command line to start the system server </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        String args[] </span>=<span style="color: #000000;"> {
            </span>"--setuid=1000"<span style="color: #000000;">,
            </span>"--setgid=1000"<span style="color: #000000;">,
            </span>"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1032,3001,3002,3003,3006,3007,3009,3010"<span style="color: #000000;">,
            </span>"--capabilities=" + capabilities + "," +<span style="color: #000000;"> capabilities,
            </span>"--nice-name=system_server"<span style="color: #000000;">,
            </span>"--runtime-args"<span style="color: #000000;">,
            </span>"com.android.server.SystemServer"<span style="color: #000000;">,
        };
        ZygoteConnection.Arguments parsedArgs </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;

<pre><code>    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt; pid;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        parsedArgs &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; ZygoteConnection.Arguments(args);
        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);
        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);

        &lt;/span&gt;&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt; Request to fork the system server process &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;
        pid &lt;/span&gt;=&lt;span style="color: #000000;"&gt; Zygote.forkSystemServer(
                parsedArgs.uid, parsedArgs.gid,
                parsedArgs.gids,
                parsedArgs.debugFlags,
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;,
                parsedArgs.permittedCapabilities,
                parsedArgs.effectiveCapabilities);
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (IllegalArgumentException ex) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; RuntimeException(ex);
    }

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;/*&lt;/span&gt;&lt;span style="color: #008000;"&gt; For child process &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (pid == 0&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (hasSecondZygote(abiList)) {
            waitForSecondaryZygote(socketName);
        }

        zygoteServer.closeServerSocket();
        handleSystemServerProcess(parsedArgs);
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp; 接上篇文章继续看看SystemServer在源码中做了什么.</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">SystemServer.java</span>

<pre><code>&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * The main entry point from zygote.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;static&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; main(String[] args) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; SystemServer().run();
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; run() {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        traceBeginAndSlog(&lt;/span&gt;"InitBeforeStartServices"&lt;span style="color: #000000;"&gt;);
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If a device's clock is before 1970 (before 0), a lot of
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; APIs crash dealing with negative numbers, notably
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; java.io.File#setLastModified, so instead we fake it and
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; hope that time from cell towers or NTP fixes it shortly.&lt;/span&gt;
        &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (System.currentTimeMillis() &amp;lt;&lt;span style="color: #000000;"&gt; EARLIEST_SUPPORTED_TIME) {
            Slog.w(TAG, &lt;/span&gt;"System clock is before 1970; setting to 1970."&lt;span style="color: #000000;"&gt;);
            SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);
        }

        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;
        &lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Default the timezone property to GMT if not set.
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//</code></pre><p>            String timezoneProperty =  SystemProperties.get(“persist.sys.timezone”<span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span> (timezoneProperty == <span style="color: #0000ff;">null</span> ||<span style="color: #000000;"> timezoneProperty.isEmpty()) {<br>                Slog.w(TAG, </span>“Timezone not set; setting to GMT.”<span style="color: #000000;">);<br>                SystemProperties.set(</span>“persist.sys.timezone”, “GMT”<span style="color: #000000;">);<br>            }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; If the system has "persist.sys.language" and friends set, replace them with
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; "persist.sys.locale". Note that the default locale at this point is calculated
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; using the "-Duser.locale" command line flag. That flag is usually populated by
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; AndroidRuntime using the same set of system properties, but only the system_server
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; and system apps are allowed to set them.
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;
&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; NOTE: Most changes made here will need an equivalent change to
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; core/jni/AndroidRuntime.cpp&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!SystemProperties.get("persist.sys.language"&lt;span style="color: #000000;"&gt;).isEmpty()) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; String languageTag =&lt;span style="color: #000000;"&gt; Locale.getDefault().toLanguageTag();

    SystemProperties.set(&lt;/span&gt;"persist.sys.locale"&lt;span style="color: #000000;"&gt;, languageTag);
    SystemProperties.set(&lt;/span&gt;"persist.sys.language", ""&lt;span style="color: #000000;"&gt;);
    SystemProperties.set(&lt;/span&gt;"persist.sys.country", ""&lt;span style="color: #000000;"&gt;);
    SystemProperties.set(&lt;/span&gt;"persist.sys.localevar", ""&lt;span style="color: #000000;"&gt;);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; The system server should never make non-oneway calls&lt;/span&gt;
Binder.setWarnOnBlocking(&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Here we go!&lt;/span&gt;
Slog.i(TAG, "Entered the Android system server!"&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; uptimeMillis = (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt;) SystemClock.elapsedRealtime();
EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, uptimeMillis);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;mRuntimeRestart) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;, "boot_system_server_init"&lt;span style="color: #000000;"&gt;, uptimeMillis);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; In case the runtime switched since last boot (such as when
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; the old runtime was removed in an OTA), set the system
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; property so that it is in sync. We can | xq oqi't do this in
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; libnativehelper's JniInvocation::Init code where we already
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; had to fallback to a different runtime because it is
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; running as root and we need to be the system user to set
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; the property. &lt;/span&gt;&lt;span style="color: #008000; text-decoration: underline;"&gt;http://b/11463182&lt;/span&gt;
SystemProperties.set("persist.sys.dalvik.vm.lib.2"&lt;span style="color: #000000;"&gt;, VMRuntime.getRuntime().vmLibrary());

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Enable the sampling profiler.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (SamplingProfilerIntegration.isEnabled()) {
    SamplingProfilerIntegration.start();
    mProfilerSnapshotTimer &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; Timer();
    mProfilerSnapshotTimer.schedule(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; TimerTask() {
            @Override
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; run() {
                SamplingProfilerIntegration.writeSnapshot(&lt;/span&gt;"system_server", &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
            }
        }, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Mmmmmm... more memory!&lt;/span&gt;</code></pre><p><span style="color: #000000;">            VMRuntime.getRuntime().clearGrowthLimit();</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; The system server has to run all of the time, so it needs to be
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; as efficient as possible with its memory usage.&lt;/span&gt;
VMRuntime.getRuntime().setTargetHeapUtilization(0.8f&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Some devices rely on runtime fingerprint generation, so make sure
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; we've defined it before booting further.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            Build.ensureFingerprintProperty();</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Within the system server, it is an error to access Environment paths without
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; explicitly specifying a user.&lt;/span&gt;
Environment.setUserRequired(&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Within the system server, any incoming Bundles should be defused
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; to avoid throwing BadParcelableException.&lt;/span&gt;
BaseBundle.setShouldDefuse(&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Ensure binder calls into the system always run at foreground priority.&lt;/span&gt;
BinderInternal.disableBackgroundScheduling(&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Increase the number of binder threads in system_server&lt;/span&gt;</code></pre><p><span style="color: #000000;">            BinderInternal.setMaxThreads(sMaxBinderThreads);</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Prepare the main looper thread (this thread).&lt;/span&gt;</code></pre><p><span style="color: #000000;">            android.os.Process.setThreadPriority(<br>                android.os.Process.THREAD_PRIORITY_FOREGROUND);<br>            android.os.Process.setCanSelfBackground(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);<br>            Looper.prepareMainLooper();</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Initialize native services.&lt;/span&gt;
System.loadLibrary("android_servers"&lt;span style="color: #000000;"&gt;);

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Check whether we failed to shut down last time we tried.
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; This call may not return.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            performPendingShutdown();</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Initialize the system context.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            createSystemContext();</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Create the system service manager.&lt;/span&gt;
mSystemServiceManager = &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; SystemServiceManager(mSystemContext);
mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);
LocalServices.addService(SystemServiceManager.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;, mSystemServiceManager);
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Prepare the thread pool for init tasks that can be parallelized&lt;/span&gt;</code></pre><p><span style="color: #000000;">            SystemServerInitThreadPool.get();<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            traceEnd();  </span><span style="color: #008000;">//</span><span style="color: #008000;"> InitBeforeStartServices</span><br><span style="color: #000000;">        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Start services. 启动各种需要的服务&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    traceBeginAndSlog(&lt;/span&gt;"StartServices"&lt;span style="color: #000000;"&gt;);
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;启动系统Boot级服务 &lt;/span&gt;</code></pre><p><span style="color: #000000;">            startBootstrapServices();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">启动系统核心的服务 </span><br><span style="color: #000000;">            startCoreServices();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">启动非核心的服务 </span><br><span style="color: #000000;">            startOtherServices();<br>            SystemServerInitThreadPool.shutdown();<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable ex) {<br>            Slog.e(</span>“System”, “<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>“<span style="color: #000000;">);<br>            Slog.e(</span>“System”, “<strong><strong>****</strong></strong> Failure starting system services”<span style="color: #000000;">, ex);<br>            </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> ex;<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            traceEnd();<br>        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; For debug builds, log event loop stalls to dropbox for analysis.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (StrictMode.conditionallyEnableDebugLogging()) {
    Slog.i(TAG, &lt;/span&gt;"Enabled StrictMode for system server main thread."&lt;span style="color: #000000;"&gt;);
}
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!mRuntimeRestart &amp;amp;&amp;amp; !&lt;span style="color: #000000;"&gt;isFirstBootOrUpgrade()) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; uptimeMillis = (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt;) SystemClock.elapsedRealtime();
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;, "boot_system_server_ready"&lt;span style="color: #000000;"&gt;, uptimeMillis);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; MAX_UPTIME_MILLIS = 60 * 1000&lt;span style="color: #000000;"&gt;;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (uptimeMillis &amp;gt;&lt;span style="color: #000000;"&gt; MAX_UPTIME_MILLIS) {
        Slog.wtf(SYSTEM_SERVER_TIMING_TAG,
                &lt;/span&gt;"SystemServer init took too long. uptimeMillis=" +&lt;span style="color: #000000;"&gt; uptimeMillis);
    }
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Loop forever.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Looper.loop();<br>        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> RuntimeException(“Main thread loop unexpectedly exited”<span style="color: #000000;">);<br>    }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Starts the small tangle of critical services that are needed to get
 * the system off the ground.  These services have complex mutual dependencies
 * which is why we initialize them all in one place here.  Unless your service
 * is also entwined in these dependencies, it should be initialized in one of
 * the other functions.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; startBootstrapServices() {
    Slog.i(TAG, &lt;/span&gt;"Reading configuration..."&lt;span style="color: #000000;"&gt;);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; String TAG_SYSTEM_CONFIG = "ReadingSystemConfig"&lt;span style="color: #000000;"&gt;;
    traceBeginAndSlog(TAG_SYSTEM_CONFIG);
    SystemServerInitThreadPool.get().submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Wait for installd to finish starting up so that it has a chance to
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; create critical directories such as /data/user with the appropriate
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; permissions.  We need this to complete before we initialize other services.&lt;/span&gt;
    traceBeginAndSlog("StartInstaller"&lt;span style="color: #000000;"&gt;);
    Installer installer &lt;/span&gt;= mSystemServiceManager.startService(Installer.&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; In some cases after launching an app we need to access device identifiers,
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; therefore register the device identifier policy before the activity manager.&lt;/span&gt;
    traceBeginAndSlog("DeviceIdentifiersPolicyService"&lt;span style="color: #000000;"&gt;);
    mSystemServiceManager.startService(DeviceIdentifiersPolicyService.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Activity manager runs the show.&lt;/span&gt;
    traceBeginAndSlog("StartActivityManager"&lt;span style="color: #000000;"&gt;);
    mActivityManagerService &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mSystemServiceManager.startService(
            ActivityManagerService.Lifecycle.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;).getService();
    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);
    mActivityManagerService.setInstaller(installer);
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Power manager needs to be started early because other services need it.
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Native daemons may be watching for it to be registered so it must be ready
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; to handle incoming binder calls immediately (including being able to verify
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; the permissions for those calls).&lt;/span&gt;
    traceBeginAndSlog("StartPowerManager"&lt;span style="color: #000000;"&gt;);
    mPowerManagerService &lt;/span&gt;= mSystemServiceManager.startService(PowerManagerService.&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Now that the power manager has been started, let the activity manager
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; initialize power management features.&lt;/span&gt;
    traceBeginAndSlog("InitPowerManagement"&lt;span style="color: #000000;"&gt;);
    mActivityManagerService.initPowerManagement();
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Bring up recovery system in case a rescue party needs a reboot&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!SystemProperties.getBoolean("config.disable_noncore", &lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;)) {
        traceBeginAndSlog(&lt;/span&gt;"StartRecoverySystemService"&lt;span style="color: #000000;"&gt;);
        mSystemServiceManager.startService(RecoverySystemService.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
        traceEnd();
    }

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Now that we have the bare essentials of the OS up and running, take
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; note that we just booted, which might send out a rescue party if
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; we're stuck in a runtime restart loop.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        RescueParty.noteBoot(mSystemContext);</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Manages LEDs and display backlight so we need it to bring up the display.&lt;/span&gt;
traceBeginAndSlog("StartLightsService"&lt;span style="color: #000000;"&gt;);
mSystemServiceManager.startService(LightsService.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
traceEnd();

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Display manager is needed to provide display metrics before package manager
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; starts up.&lt;/span&gt;
traceBeginAndSlog("StartDisplayManager"&lt;span style="color: #000000;"&gt;);
mDisplayManagerService &lt;/span&gt;= mSystemServiceManager.startService(DisplayManagerService.&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
traceEnd();

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; We need the default display before we can initialize the package manager.&lt;/span&gt;
traceBeginAndSlog("WaitForDisplay"&lt;span style="color: #000000;"&gt;);
mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);
traceEnd();

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Only run "core" apps if we're encrypting the device.&lt;/span&gt;
String cryptState = SystemProperties.get("vold.decrypt"&lt;span style="color: #000000;"&gt;);
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ENCRYPTING_STATE.equals(cryptState)) {
    Slog.w(TAG, &lt;/span&gt;"Detected encryption in progress - only parsing core apps"&lt;span style="color: #000000;"&gt;);
    mOnlyCore &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ENCRYPTED_STATE.equals(cryptState)) {
    Slog.w(TAG, &lt;/span&gt;"Device encrypted - only parsing core apps"&lt;span style="color: #000000;"&gt;);
    mOnlyCore &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Start the package manager.&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;mRuntimeRestart) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;, "boot_package_manager_init_start"&lt;span style="color: #000000;"&gt;,
            (&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt;) SystemClock.elapsedRealtime());
}
traceBeginAndSlog(&lt;/span&gt;"StartPackageManagerService"&lt;span style="color: #000000;"&gt;);
mPackageManagerService &lt;/span&gt;=&lt;span style="color: #000000;"&gt; PackageManagerService.main(mSystemContext, installer,
        mFactoryTestMode &lt;/span&gt;!=&lt;span style="color: #000000;"&gt; FactoryTest.FACTORY_TEST_OFF, mOnlyCore);
mFirstBoot &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mPackageManagerService.isFirstBoot();
mPackageManager &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mSystemContext.getPackageManager();
traceEnd();
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!mRuntimeRestart &amp;amp;&amp;amp; !&lt;span style="color: #000000;"&gt;isFirstBootOrUpgrade()) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;, "boot_package_manager_init_ready"&lt;span style="color: #000000;"&gt;,
            (&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt;) SystemClock.elapsedRealtime());
}
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Manages A/B OTA dexopting. This is a bootstrap service as we need it to rename
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; A/B artifacts after boot, before anything else might touch/need them.
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Note: this isn't needed during decryption (we don't have /data anyways).&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;mOnlyCore) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; disableOtaDexopt = SystemProperties.getBoolean("config.disable_otadexopt"&lt;span style="color: #000000;"&gt;,
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;false&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!&lt;span style="color: #000000;"&gt;disableOtaDexopt) {
        traceBeginAndSlog(&lt;/span&gt;"StartOtaDexOptService"&lt;span style="color: #000000;"&gt;);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
            OtaDexoptService.main(mSystemContext, mPackageManagerService);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (Throwable e) {
            reportWtf(&lt;/span&gt;"starting OtaDexOptService"&lt;span style="color: #000000;"&gt;, e);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;finally&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
            traceEnd();
        }
    }
}

traceBeginAndSlog(&lt;/span&gt;"StartUserManagerService"&lt;span style="color: #000000;"&gt;);
mSystemServiceManager.startService(UserManagerService.LifeCycle.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
traceEnd();

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Initialize attribute cache used to cache resources from packages.&lt;/span&gt;
traceBeginAndSlog("InitAttributerCache"&lt;span style="color: #000000;"&gt;);
AttributeCache.init(mSystemContext);
traceEnd();

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Set up the Application instance for the system process and get started.&lt;/span&gt;
traceBeginAndSlog("SetSystemProcess"&lt;span style="color: #000000;"&gt;);
mActivityManagerService.setSystemProcess();
traceEnd();

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; DisplayManagerService needs to setup android.display scheduling related policies
&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; since setSystemProcess() would have overridden policies due to setProcessGroup&lt;/span&gt;</code></pre><p><span style="color: #000000;">        mDisplayManagerService.setupSchedulerPolicies();</span></p>
<pre><code>    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Manages Overlay packages&lt;/span&gt;
    traceBeginAndSlog("StartOverlayManagerService"&lt;span style="color: #000000;"&gt;);
    mSystemServiceManager.startService(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; OverlayManagerService(mSystemContext, installer));
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; The sensor service needs access to package manager service, app ops
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; service, and permissions service, therefore we start it after them.
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Start sensor service in a separate thread. Completion should be checked
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; before using it.&lt;/span&gt;
    mSensorServiceStart = SystemServerInitThreadPool.get().submit(() -&amp;gt;&lt;span style="color: #000000;"&gt; {
        BootTimingsTraceLog traceLog &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; BootTimingsTraceLog(
                SYSTEM_SERVER_TIMING_ASYNC_TAG, Trace.TRACE_TAG_SYSTEM_SERVER);
        traceLog.traceBegin(START_SENSOR_SERVICE);
        startSensorService();
        traceLog.traceEnd();
    }, START_SENSOR_SERVICE);
}


&lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Starts some essential services that are not tangled up in the bootstrap process.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;private&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;void&lt;/span&gt;&lt;span style="color: #000000;"&gt; startCoreServices() {
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Records errors and logs, for example wtf()&lt;/span&gt;
    traceBeginAndSlog("StartDropBoxManager"&lt;span style="color: #000000;"&gt;);
    mSystemServiceManager.startService(DropBoxManagerService.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    traceEnd();

    traceBeginAndSlog(&lt;/span&gt;"StartBatteryService"&lt;span style="color: #000000;"&gt;);
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Tracks the battery level.  Requires LightService.&lt;/span&gt;
    mSystemServiceManager.startService(BatteryService.&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Tracks application usage stats.&lt;/span&gt;
    traceBeginAndSlog("StartUsageService"&lt;span style="color: #000000;"&gt;);
    mSystemServiceManager.startService(UsageStatsService.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    mActivityManagerService.setUsageStatsManager(
            LocalServices.getService(UsageStatsManagerInternal.&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;));
    traceEnd();

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Tracks whether the updatable WebView is in a ready state and watches for update installs.&lt;/span&gt;
    traceBeginAndSlog("StartWebViewUpdateService"&lt;span style="color: #000000;"&gt;);
    mWebViewUpdateService &lt;/span&gt;= mSystemServiceManager.startService(WebViewUpdateService.&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    traceEnd();
}
&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;"> mSystemServiceManager是系统服务管理对象.在run()方法已经创建 mSystemServiceManager = new SystemServiceManager(mSystemContext);
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 进入mSystemServiceManager.startService() 分析下. 进入具体实现的方法

<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;SystemServiceManager.java&lt;/span&gt;
&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Creates and starts a system service. The class must be a subclass of
 * {&lt;/span&gt;&lt;span style="color: #808080;"&gt;@link&lt;/span&gt;&lt;span style="color: #008000;"&gt; com.android.server.SystemService}.
 *
 * &lt;/span&gt;&lt;span style="color: #808080;"&gt;@param&lt;/span&gt;&lt;span style="color: #008000;"&gt; serviceClass A Java class that implements the SystemService interface.
 * &lt;/span&gt;&lt;span style="color: #808080;"&gt;@return&lt;/span&gt;&lt;span style="color: #008000;"&gt; The service instance, never null.
 * &lt;/span&gt;&lt;span style="color: #808080;"&gt;@throws&lt;/span&gt;&lt;span style="color: #008000;"&gt; RuntimeException if the service fails to start.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;
@SuppressWarnings(&lt;/span&gt;"unchecked"&lt;span style="color: #000000;"&gt;)
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt; &amp;lt;T &lt;span style="color: #0000ff;"&gt;extends&lt;/span&gt; SystemService&amp;gt; T startService(Class&amp;lt;T&amp;gt;&lt;span style="color: #000000;"&gt; serviceClass) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; String name =&lt;span style="color: #000000;"&gt; serviceClass.getName();
        Slog.i(TAG, &lt;/span&gt;"Starting " +&lt;span style="color: #000000;"&gt; name);
        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, &lt;/span&gt;"StartService " +&lt;span style="color: #000000;"&gt; name);

        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Create the service.&lt;/span&gt;
        &lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (!SystemService.&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;.isAssignableFrom(serviceClass)) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; RuntimeException("Failed to create " +&lt;span style="color: #000000;"&gt; name
                    &lt;/span&gt;+ ": service must extend " + SystemService.&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;.getName());
        }
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt;&lt;span style="color: #000000;"&gt; T service;
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
            Constructor&lt;/span&gt;&amp;lt;T&amp;gt; constructor = serviceClass.getConstructor(Context.&lt;span style="color: #0000ff;"&gt;class&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
            service &lt;/span&gt;=&lt;span style="color: #000000;"&gt; constructor.newInstance(mContext);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (InstantiationException ex) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; RuntimeException("Failed to create service " +&lt;span style="color: #000000;"&gt; name
                    &lt;/span&gt;+ ": service could not be instantiated"&lt;span style="color: #000000;"&gt;, ex);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (IllegalAccessException ex) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; RuntimeException("Failed to create service " +&lt;span style="color: #000000;"&gt; name
                    &lt;/span&gt;+ ": service must have a public constructor with a Context argument"&lt;span style="color: #000000;"&gt;, ex);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (NoSuchMethodException ex) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; RuntimeException("Failed to create service " +&lt;span style="color: #000000;"&gt; name
                    &lt;/span&gt;+ ": service must have a public constructor with a Context argument"&lt;span style="color: #000000;"&gt;, ex);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (InvocationTargetException ex) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; RuntimeException("Failed to create service " +&lt;span style="color: #000000;"&gt; name
                    &lt;/span&gt;+ ": service constructor threw an exception"&lt;span style="color: #000000;"&gt;, ex);
        }

        startService(service);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; service;
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;finally&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);
    }
}

  &lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Starts a service by class name.
 *
 * &lt;/span&gt;&lt;span style="color: #808080;"&gt;@return&lt;/span&gt;&lt;span style="color: #008000;"&gt; The service instance.
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;
@SuppressWarnings(&lt;/span&gt;"unchecked"&lt;span style="color: #000000;"&gt;)
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;public&lt;/span&gt;&lt;span style="color: #000000;"&gt; SystemService startService(String className) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;final&lt;/span&gt; Class&amp;lt;SystemService&amp;gt;&lt;span style="color: #000000;"&gt; serviceClass;
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        serviceClass &lt;/span&gt;= (Class&amp;lt;SystemService&amp;gt;&lt;span style="color: #000000;"&gt;)Class.forName(className);
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ClassNotFoundException ex) {
        Slog.i(TAG, &lt;/span&gt;"Starting " +&lt;span style="color: #000000;"&gt; className);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; RuntimeException("Failed to create service " +&lt;span style="color: #000000;"&gt; className
                &lt;/span&gt;+ ": service class not found, usually indicates that the caller should "
                + "have called PackageManager.hasSystemFeature() to check whether the "
                + "feature is available on this device before trying to start the "
                + "services that implement it"&lt;span style="color: #000000;"&gt;, ex);
    }
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; startService(serviceClass);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt;通过反射器构造方法创建出服务类,然后返回SystemService.启动对应的服务.&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
            
            <p class="more">
                <a href="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/" title="Android 源码分析（六） SystemServer 进程">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/[object Object]thumbnail/7.jpg" alt="默认配图">
                
            </a>
        </div>
    </div>
</article>

    

    
    <nav class="page-navigator">
        <span class="page-number current">1</span><a class="page-number" href="/tags/安卓源码/page/2/">2</a><a class="extend next" rel="next" href="/tags/安卓源码/page/2/">后一页</a>
    </nav>
    


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/后端/">后端</a>
        <span class="badge">(21)</span>
    </li>
    
    <li>
        <a href="/categories/Android/">Android</a>
        <span class="badge">(52)</span>
    </li>
    
    <li>
        <a href="/categories/后端/CSharp/">CSharp</a>
        <span class="badge">(14)</span>
    </li>
    
    <li>
        <a href="/categories/Android/开源框架/">开源框架</a>
        <span class="badge">(17)</span>
    </li>
    
    <li>
        <a href="/categories/Android/kotlin/">kotlin</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="/categories/Android/安卓源码/">安卓源码</a>
        <span class="badge">(15)</span>
    </li>
    
    <li>
        <a href="/categories/Android/知识点/">知识点</a>
        <span class="badge">(18)</span>
    </li>
    
    <li>
        <a href="/categories/GitHub/">GitHub</a>
        <span class="badge">(5)</span>
    </li>
    
    <li>
        <a href="/categories/后端/JAVA/">JAVA</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/心情/">心情</a>
        <span class="badge">(12)</span>
    </li>
    
    <li>
        <a href="/categories/前端/">前端</a>
        <span class="badge">(5)</span>
    </li>
    
    <li>
        <a href="/categories/后端/PHP/">PHP</a>
        <span class="badge">(6)</span>
    </li>
    
    <li>
        <a href="/categories/设计模式/">设计模式</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/日期格式化/" title="日期格式化">日期格式化 (1)</a>
  
    <a class="tag-item" href="/tags/Linq/" title="Linq">Linq (1)</a>
  
    <a class="tag-item" href="/tags/visualStudio/" title="visualStudio">visualStudio (2)</a>
  
    <a class="tag-item" href="/tags/coroutine协程/" title="coroutine协程">coroutine协程 (1)</a>
  
    <a class="tag-item" href="/tags/view绘制/" title="view绘制">view绘制 (1)</a>
  
    <a class="tag-item" href="/tags/线程切换/" title="线程切换">线程切换 (1)</a>
  
    <a class="tag-item" href="/tags/屏幕适配/" title="屏幕适配">屏幕适配 (1)</a>
  
    <a class="tag-item" href="/tags/开源框架/" title="开源框架">开源框架 (17)</a>
  
    <a class="tag-item" href="/tags/安卓源码/" title="安卓源码">安卓源码 (15)</a>
  
    <a class="tag-item" href="/tags/面试/" title="面试">面试 (2)</a>
  
    <a class="tag-item" href="/tags/地图/" title="地图">地图 (2)</a>
  
    <a class="tag-item" href="/tags/hexo/" title="hexo">hexo (4)</a>
  
    <a class="tag-item" href="/tags/IIS/" title="IIS">IIS (2)</a>
  
    <a class="tag-item" href="/tags/SqlServer/" title="SqlServer">SqlServer (1)</a>
  
    <a class="tag-item" href="/tags/ViewPager/" title="ViewPager">ViewPager (1)</a>
  
    <a class="tag-item" href="/tags/XMLHttpRequest/" title="XMLHttpRequest">XMLHttpRequest (1)</a>
  
    <a class="tag-item" href="/tags/增量更新/" title="增量更新">增量更新 (1)</a>
  
    <a class="tag-item" href="/tags/电影/" title="电影">电影 (4)</a>
  
    <a class="tag-item" href="/tags/心情/" title="心情">心情 (1)</a>
  
    <a class="tag-item" href="/tags/fiddler/" title="fiddler">fiddler (1)</a>
  
    <a class="tag-item" href="/tags/副业/" title="副业">副业 (1)</a>
  
    <a class="tag-item" href="/tags/职业生涯/" title="职业生涯">职业生涯 (1)</a>
  
    <a class="tag-item" href="/tags/Activity/" title="Activity">Activity (1)</a>
  
    <a class="tag-item" href="/tags/BroadcastReceiver/" title="BroadcastReceiver">BroadcastReceiver (1)</a>
  
    <a class="tag-item" href="/tags/职业发展/" title="职业发展">职业发展 (1)</a>
  
    <a class="tag-item" href="/tags/购房/" title="购房">购房 (1)</a>
  
    <a class="tag-item" href="/tags/跳槽/" title="跳槽">跳槽 (2)</a>
  
    <a class="tag-item" href="/tags/图片保存/" title="图片保存">图片保存 (1)</a>
  
    <a class="tag-item" href="/tags/习惯/" title="习惯">习惯 (1)</a>
  
    <a class="tag-item" href="/tags/c/" title="c#">c# (1)</a>
  
    <a class="tag-item" href="/tags/easyui/" title="easyui">easyui (2)</a>
  
    <a class="tag-item" href="/tags/php/" title="php">php (1)</a>
  
    <a class="tag-item" href="/tags/Android/" title="Android">Android (2)</a>
  
    <a class="tag-item" href="/tags/kotlin/" title="kotlin">kotlin (1)</a>
  
    <a class="tag-item" href="/tags/序列化/" title="序列化">序列化 (1)</a>
  
    <a class="tag-item" href="/tags/mongodb/" title="mongodb">mongodb (1)</a>
  
    <a class="tag-item" href="/tags/评论插件/" title="评论插件">评论插件 (1)</a>
  
    <a class="tag-item" href="/tags/正则表达式/" title="正则表达式">正则表达式 (1)</a>
  
    <a class="tag-item" href="/tags/AIDL/" title="AIDL">AIDL (1)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" target="_blank" title="稀土掘金">稀土掘金</a>
        </li>
    
        <li>
            <a href="https://www.cnblogs.com/bugzone" target="_blank" title="博客园">博客园</a>
        </li>
    
        <li>
            <a href="https://weibo.com/230689567" target="_blank" title="新浪微博">新浪微博</a>
        </li>
    
        <li>
            <a href="https://www.jianshu.com/u/ba21180e6aab" target="_blank" title="简书">简书</a>
        </li>
    
        <li>
            <a href="https://github.com/freefuncode/" target="_blank" title="GitHub">GitHub</a>
        </li>
    
        <li>
            <a href="https://freefuncode.github.io/GitBook" target="_blank" title="GitBook">GitBook</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    ©
    
        2016-2019
    

    <a href="/">FreeFunCode</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->


<script type="text/javascript" src="/bundle.js"></script><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>