<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  
  <title>Android 源码分析（三） Service 启动分析 - 网记本</title>
  <meta charset="UTF-8">
  <meta name="description" content>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/img/favicon.png" type="image/png">
  <meta name="description" content="点击查看原文        //android-8.0.0_r1\frameworks\base\core\java\android\content\Context.java  /**  startService是Context的抽象方法。 调用startService时，会先调用到ContextWrapper的startService方法*/  @Nullable  public abstrac">
<meta name="keywords" content="安卓源码">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 源码分析（三） Service 启动分析">
<meta property="og:url" content="https://freefuncode.github.io/2018/06/24/Android源码分析三Service启动分析/index.html">
<meta property="og:site_name" content="网记本">
<meta property="og:description" content="点击查看原文        //android-8.0.0_r1\frameworks\base\core\java\android\content\Context.java  /**  startService是Context的抽象方法。 调用startService时，会先调用到ContextWrapper的startService方法*/  @Nullable  public abstrac">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/612293/201806/612293-20180624141726420-1470284606.png">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/612293/201806/612293-20180624170737100-200403851.png">
<meta property="og:updated_time" content="2019-09-06T13:20:05.795Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 源码分析（三） Service 启动分析">
<meta name="twitter:description" content="点击查看原文        //android-8.0.0_r1\frameworks\base\core\java\android\content\Context.java  /**  startService是Context的抽象方法。 调用startService时，会先调用到ContextWrapper的startService方法*/  @Nullable  public abstrac">
<meta name="twitter:image" content="https://images2018.cnblogs.com/blog/612293/201806/612293-20180624141726420-1470284606.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css">
   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="/css/style.css?v=1571545564720">
</head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(https://i.loli.net/2019/01/13/5c3aec85a4343.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="网记本" class="mdui-btn mdui-btn-icon"><img src="/img/avatar.jpg"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="网记本">
            <img src="/img/avatar.jpg" alt="网记本">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>94</div>
        <div><span>标签</span>51</div>
        <div><span>分类</span>13</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的收藏">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的收藏
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">社交按钮</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://weibo.com/230689567" target="_blank" mdui-tooltip="{content: '微博'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-weibo"></i>
        </a><a class="mdui-ripple" href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" target="_blank" mdui-tooltip="{content: '掘金'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-appstore-fill"></i>
        </a><a class="mdui-ripple" href="https://www.cnblogs.com/bugzone/" target="_blank" mdui-tooltip="{content: '博客园'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-dribbble"></i>
        </a><a class="mdui-ripple" href="https://www.jianshu.com/u/ba21180e6aab" target="_blank" mdui-tooltip="{content: '简书'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-container"></i>
        </a><a class="mdui-ripple" href="https://github.com/freefuncode/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://www.zhihu.com/people/yimei-cheng-xu-yuan-28/activities" target="_blank" mdui-tooltip="{content: '知乎'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-zhihu"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/">Android</a>
          <span class="category-list-count">52</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/CSharp/">CSharp</a>
          <span class="category-list-count">14</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/GitHub/">GitHub</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/JAVA/">JAVA</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/PHP/">PHP</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/kotlin/">kotlin</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/前端/">前端</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/">后端</a>
          <span class="category-list-count">21</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/安卓源码/">安卓源码</a>
          <span class="category-list-count">15</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/开源框架/">开源框架</a>
          <span class="category-list-count">17</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/心情/">心情</a>
          <span class="category-list-count">10</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/知识点/">知识点</a>
          <span class="category-list-count">18</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/设计模式/">设计模式</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">标签云</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Activity/" style="font-size: 10px;">Activity</a> <a href="/tags/Android/" style="font-size: 12.5px;">Android</a> <a href="/tags/Android7-0/" style="font-size: 10px;">Android7.0</a> <a href="/tags/BroadcastReceiver/" style="font-size: 10px;">BroadcastReceiver</a> <a href="/tags/C-文件上传/" style="font-size: 10px;">C#文件上传</a> <a href="/tags/ContentProvider/" style="font-size: 10px;">ContentProvider</a> <a href="/tags/Excel操作/" style="font-size: 10px;">Excel操作</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/IIS/" style="font-size: 12.5px;">IIS</a> <a href="/tags/LNMP/" style="font-size: 10px;">LNMP</a> <a href="/tags/Linq/" style="font-size: 10px;">Linq</a> <a href="/tags/MAMP/" style="font-size: 10px;">MAMP</a> <a href="/tags/Service/" style="font-size: 10px;">Service</a> <a href="/tags/SqlServer/" style="font-size: 10px;">SqlServer</a> <a href="/tags/ViewPager/" style="font-size: 10px;">ViewPager</a> <a href="/tags/XMLHttpRequest/" style="font-size: 10px;">XMLHttpRequest</a> <a href="/tags/c/" style="font-size: 10px;">c#</a> <a href="/tags/coroutine协程/" style="font-size: 10px;">coroutine协程</a> <a href="/tags/easyui/" style="font-size: 12.5px;">easyui</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/kotlin/" style="font-size: 10px;">kotlin</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mono-for-Android/" style="font-size: 10px;">mono_for_Android</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/view绘制/" style="font-size: 10px;">view绘制</a> <a href="/tags/visualStudio/" style="font-size: 12.5px;">visualStudio</a> <a href="/tags/习惯/" style="font-size: 10px;">习惯</a> <a href="/tags/京东云擎/" style="font-size: 10px;">京东云擎</a> <a href="/tags/公众号/" style="font-size: 10px;">公众号</a> <a href="/tags/副业/" style="font-size: 10px;">副业</a> <a href="/tags/图片保存/" style="font-size: 10px;">图片保存</a> <a href="/tags/地图/" style="font-size: 12.5px;">地图</a> <a href="/tags/增量更新/" style="font-size: 10px;">增量更新</a> <a href="/tags/安卓源码/" style="font-size: 17.5px;">安卓源码</a> <a href="/tags/屏幕适配/" style="font-size: 10px;">屏幕适配</a> <a href="/tags/序列化/" style="font-size: 10px;">序列化</a> <a href="/tags/开源框架/" style="font-size: 20px;">开源框架</a> <a href="/tags/新浪SAE/" style="font-size: 10px;">新浪SAE</a> <a href="/tags/日期格式化/" style="font-size: 10px;">日期格式化</a> <a href="/tags/正则表达式/" style="font-size: 10px;">正则表达式</a> <a href="/tags/电影/" style="font-size: 15px;">电影</a> <a href="/tags/线程切换/" style="font-size: 10px;">线程切换</a> <a href="/tags/职业发展/" style="font-size: 10px;">职业发展</a> <a href="/tags/职业生涯/" style="font-size: 10px;">职业生涯</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/评论插件/" style="font-size: 10px;">评论插件</a> <a href="/tags/跳槽/" style="font-size: 12.5px;">跳槽</a> <a href="/tags/面试/" style="font-size: 12.5px;">面试</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2019 网记本
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    <div class="nexmoe-post-cover"> 
        
            <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg">
        
        <h1>Android 源码分析（三） Service 启动分析</h1>
    </div>
  <div class="nexmoe-post-meta">
    <a><i class="nexmoefont icon-calendar-fill"></i>2018年06月24日</a>
    <a><i class="nexmoefont icon-areachart"></i>9.8k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 60 分钟</a>
    
      <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
    
    
      <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
    
  </div>
  <article>
    <p><a href="https://www.cnblogs.com/bugzone/p/startService.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p><img src="https://images2018.cnblogs.com/blog/612293/201806/612293-20180624141726420-1470284606.png" alt></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">android-8.0.0_r1\frameworks\base\core\java\android\content\Context.java</span>

<p><span style="color: #008000;">/**</span><span style="color: #008000;"></span></p>
<ul>
<li>startService是Context的抽象方法。</li>
<li>调用startService时，会先调用到ContextWrapper的startService方法<br><span style="color: #008000;">*/</span><span style="color: #000000;"><br>  @Nullable<br>  </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> ComponentName startService(Intent service);</li></ul></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">android-8.0.0_r1\frameworks\base\core\java\android\content\ContextWrapper.java</span>



<p><span style="color: #008000;">/**</span><span style="color: #008000;"></span></p>
<ul>
<li><p>mBase是ContextImpl的实例，</p>
</li>
<li><p>ContextWrapper类的startService方法最终通过ContextImpl类的startService方法来实现<br><span style="color: #008000;">*/</span><span style="color: #000000;"><br>  @Override<br>  </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> ComponentName startService(Intent service) {</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mBase.startService(service);</code></pre><p>  }</p></li></ul></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">android-8.0.0_r1\frameworks\base\core\java\android\app\ContextImpl.java</span>
<span style="color: #000000;">
  @Override
  </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> ComponentName startService(Intent service) {
      warnIfCallingFromSystemProcess();
      </span><span style="color: #0000ff;">return</span> startServiceCommon(service, <span style="color: #0000ff;">false</span><span style="color: #000000;">, mUser);
  }

<p>  </p></span><span style="color: #0000ff;">private</span> ComponentName startServiceCommon(Intent service, <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> requireForeground,<p></p>
<pre><code>    UserHandle user) {
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;验证intent的有效性&amp;nbsp;&amp;nbsp;&lt;/span&gt;</code></pre><p><span style="color: #000000;">            validateServiceIntent(service);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;准备离开应用程序进程，进入ActivityManagerService进程（意味着bundle的数据要在进程间传递）&lt;/span&gt;
service.prepareToLeaveProcess(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;调用ActivityManagerProxy类的startService来实现启动服务的操作&amp;nbsp;&amp;nbsp;</code></pre><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    </p></span><span style="color: #008000;">//</span><span style="color: #008000;">&nbsp;ActivityManagerProxy是一个Binder对象的远程接口，而这个Binder对象就是ActivityManagerService。</span><p></p>
<pre><code>    ComponentName cn =&lt;span style=&quot;color: #000000;&quot;&gt; ActivityManager.getService().startService(
        mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(
                    getContentResolver()), requireForeground,
                    getOpPackageName(), user.getIdentifier());
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (cn != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (cn.getPackageName().equals(&quot;!&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SecurityException(
                    &lt;/span&gt;&quot;Not allowed to start service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; service
                    &lt;/span&gt;+ &quot; without permission &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; cn.getClassName());
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (cn.getPackageName().equals(&quot;!!&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SecurityException(
                    &lt;/span&gt;&quot;Unable to start service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; service
                    &lt;/span&gt;+ &quot;: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; cn.getClassName());
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (cn.getPackageName().equals(&quot;?&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; IllegalStateException(
                    &lt;/span&gt;&quot;Not allowed to start service &quot; + service + &quot;: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; cn.getClassName());
        }
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; cn;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (RemoteException e) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; e.rethrowFromSystemServer();
}</code></pre><p>  }</p>
<p>  <span style="color: #008000;">/**</span><span style="color: #008000;"></span></p>
<ul>
<li><p>验证intent的有效性&nbsp;</p>
</li>
<li><p><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> validateServiceIntent(Intent service) {<br>  </span><span style="color: #0000ff;">if</span> (service.getComponent() == <span style="color: #0000ff;">null</span> &amp;&amp; service.getPackage() == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;隐式启动判断，5.1之后不允许隐式启动服务&amp;nbsp;&amp;nbsp;&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (getApplicationInfo().targetSdkVersion &amp;gt;=&lt;span style=&quot;color: #000000;&quot;&gt; Build.VERSION_CODES.LOLLIPOP) {
    IllegalArgumentException ex &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; IllegalArgumentException(
            &lt;/span&gt;&quot;Service Intent must be explicit: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; service);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ex;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    Log.w(TAG, &lt;/span&gt;&quot;Implicit intents with startService are not safe: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; service
            &lt;/span&gt;+ &quot; &quot; + Debug.getCallers(2, 3&lt;span style=&quot;color: #000000;&quot;&gt;));
}</code></pre><p>  }<br>}</p></li></ul></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">android-8.0.0_r1\frameworks\base\core\java\android\app\ActivityManager.java</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> IActivityManager getService() {
  </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> IActivityManagerSingleton.get();
}
</span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =
      <span style="color: #0000ff;">new</span> Singleton&lt;IActivityManager&gt;<span style="color: #000000;">() {
          @Override
          </span><span style="color: #0000ff;">protected</span><span style="color: #000000;"> IActivityManager create() {
              </span><span style="color: #0000ff;">final</span> IBinder b =<span style="color: #000000;"> ServiceManager.getService(Context.ACTIVITY_SERVICE);
              </span><span style="color: #0000ff;">final</span> IActivityManager am =<span style="color: #000000;"> IActivityManager.Stub.asInterface(b);
              </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> am;
          }
      };</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">android-8.0.0_r1\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ActivityManagerService <span style="color: #0000ff;">extends</span><span style="color: #000000;"> IActivityManager.Stub
  </span><span style="color: #0000ff;">implements</span> Watchdog.Monitor, BatteryStatsImpl.BatteryCallback {}</pre>
</div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">android-8.0.0_r1\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span>
<span style="color: #000000;">    @Override
</span><span style="color: #0000ff;">public</span><span style="color: #000000;"> ComponentName startService(IApplicationThread caller, Intent service,
      String resolvedType, </span><span style="color: #0000ff;">boolean</span> requireForeground, String callingPackage, <span style="color: #0000ff;">int</span><span style="color: #000000;"> userId)
      </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> TransactionTooLargeException {
  enforceNotIsolatedCaller(</span>"startService"<span style="color: #000000;">);
  </span><span style="color: #008000;">//</span><span style="color: #008000;"> Refuse possible leaked file descriptors</span>
  <span style="color: #0000ff;">if</span> (service != <span style="color: #0000ff;">null</span> &amp;&amp; service.hasFileDescriptors() == <span style="color: #0000ff;">true</span><span style="color: #000000;">) {
      </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalArgumentException("File descriptors passed in Intent"<span style="color: #000000;">);
  }

<p>  </p></span><span style="color: #0000ff;">if</span> (callingPackage == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<p></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&quot;callingPackage cannot be null&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);</code></pre><p>  }</p>
<p>  </p></span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,<p></p>
<pre><code>&lt;/span&gt;&quot;*** startService: &quot; + service + &quot; type=&quot; + resolvedType + &quot; fg=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; requireForeground);</code></pre><p>  </p></span><span style="color: #0000ff;">synchronized</span>(<span style="color: #0000ff;">this</span><span style="color: #000000;">) {<p></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; callingPid =&lt;span style=&quot;color: #000000;&quot;&gt; Binder.getCallingPid();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; callingUid =&lt;span style=&quot;color: #000000;&quot;&gt; Binder.getCallingUid();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt; origId =&lt;span style=&quot;color: #000000;&quot;&gt; Binder.clearCallingIdentity();
ComponentName res;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    res &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mServices.startServiceLocked(caller, service,
            resolvedType, callingPid, callingUid,
            requireForeground, callingPackage, userId);
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;finally&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    Binder.restoreCallingIdentity(origId);
}
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; res;</code></pre><p>  }<br>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">android-8.0.0_r1\frameworks\base\services\core\java\com\android\server\am\ActiveServices.java</span>
<span style="color: #000000;">
ComponentName startServiceLocked(IApplicationThread caller, Intent service, String resolvedType,
      </span><span style="color: #0000ff;">int</span> callingPid, <span style="color: #0000ff;">int</span> callingUid, <span style="color: #0000ff;">boolean</span> fgRequired, String callingPackage, <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> userId)
      </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> TransactionTooLargeException {
  </span><span style="color: #0000ff;">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, "startService: " +<span style="color: #000000;"> service
          </span>+ " type=" + resolvedType + " args=" +<span style="color: #000000;"> service.getExtras());

<p>  </p></span><span style="color: #0000ff;">final</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> callerFg;<br>  </span><span style="color: #0000ff;">if</span> (caller != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<p></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; ProcessRecord callerApp =&lt;span style=&quot;color: #000000;&quot;&gt; mAm.getRecordForAppLocked(caller);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (callerApp == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SecurityException(
            &lt;/span&gt;&quot;Unable to find app for caller &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; caller
            &lt;/span&gt;+ &quot; (pid=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; callingPid
            &lt;/span&gt;+ &quot;) when starting service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; service);
}
callerFg &lt;/span&gt;= callerApp.setSchedGroup !=&lt;span style=&quot;color: #000000;&quot;&gt; ProcessList.SCHED_GROUP_BACKGROUND;</code></pre><p>  } </p></span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<p></p>
<pre><code>callerFg &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>  }</p>




<pre><code>&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;调用retrieveServiceLocked方法解析service这个Intent，然后将解析结果放在res.record中。&amp;nbsp;&amp;nbsp;
&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;调用该方法后，为被调用者构造了对应的ServiceRecord对象，并保存到ActivityManagerService的成员变量mServiceMap中。&amp;nbsp;&lt;/span&gt;
    ServiceLookupResult res =&lt;span style=&quot;color: #000000;&quot;&gt;
        retrieveServiceLocked(service, resolvedType, callingPackage,
                callingPid, callingUid, userId, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;, callerFg, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (res == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (res.record == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; ComponentName(&quot;!&quot;, res.permission != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;
                ? res.permission : &quot;private to package&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    }

    ServiceRecord r &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; res.record;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mAm.mUserController.exists(r.userId)) {
        Slog.w(TAG, &lt;/span&gt;&quot;Trying to start service with non-existent user! &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r.userId);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If this isn&apos;t a direct-to-foreground start, check our ability to kick off an
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; arbitrary service&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!r.startRequested &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;fgRequired) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Before going further -- if this app is not allowed to start services in the
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; background, then at this point we aren&apos;t going to let it period.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; allowed =&lt;span style=&quot;color: #000000;&quot;&gt; mAm.getAppStartModeLocked(r.appInfo.uid, r.packageName,
                r.appInfo.targetSdkVersion, callingPid, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (allowed !=&lt;span style=&quot;color: #000000;&quot;&gt; ActivityManager.APP_START_MODE_NORMAL) {
            Slog.w(TAG, &lt;/span&gt;&quot;Background start not allowed: service &quot;
                    + service + &quot; to &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r.name.flattenToShortString()
                    &lt;/span&gt;+ &quot; from pid=&quot; + callingPid + &quot; uid=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; callingUid
                    &lt;/span&gt;+ &quot; pkg=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; callingPackage);
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (allowed ==&lt;span style=&quot;color: #000000;&quot;&gt; ActivityManager.APP_START_MODE_DELAYED) {
                &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In this case we are silently disabling the app, to disrupt as
                &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; little as possible existing apps.&lt;/span&gt;
                &lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
            }
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; This app knows it is in the new model where this operation is not
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; allowed, so tell it what has happened.&lt;/span&gt;
            UidRecord uidRec =&lt;span style=&quot;color: #000000;&quot;&gt; mAm.mActiveUids.get(r.appInfo.uid);
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; ComponentName(&quot;?&quot;, &quot;app is in background uid &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; uidRec);
        }
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;权限检查&amp;nbsp;&lt;/span&gt;
    NeededUriGrants neededGrants =&lt;span style=&quot;color: #000000;&quot;&gt; mAm.checkGrantUriPermissionFromIntentLocked(
            callingUid, r.packageName, service, service.getFlags(), &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, r.userId);

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If permissions need a review before any of the app components can run,
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we do not start the service and launch a review activity if the calling app
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; is in the foreground passing it a pending intent to start the service when
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; review is completed.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (mAm.mPermissionReviewRequired) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;requestStartTargetPermissionsReviewIfNeededLocked(r, callingPackage,
                callingUid, service, callerFg, userId)) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        }
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (unscheduleServiceRestartLocked(r, callingUid, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (DEBUG_SERVICE) Slog.v(TAG_SERVICE, &quot;START SERVICE WHILE RESTART PENDING: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
    }
    r.lastActivity &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; SystemClock.uptimeMillis();
    r.startRequested &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    r.delayedStop &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    r.fgRequired &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; fgRequired;
    r.pendingStarts.add(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; ServiceRecord.StartItem(r, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, r.makeNextStartId(),
            service, neededGrants, callingUid));

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; ServiceMap smap =&lt;span style=&quot;color: #000000;&quot;&gt; getServiceMapLocked(r.userId);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; addToStarting = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!callerFg &amp;amp;&amp;amp; !fgRequired &amp;amp;&amp;amp; r.app == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;
            &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; mAm.mUserController.hasStartedUserState(r.userId)) {
        ProcessRecord proc &lt;/span&gt;= mAm.getProcessRecordLocked(r.processName, r.appInfo.uid, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (proc == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; || proc.curProcState &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; ActivityManager.PROCESS_STATE_RECEIVER) {
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If this is not coming from a foreground caller, then we may want
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to delay the start if there are already other background services
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; that are starting.  This is to avoid process start spam when lots
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; of applications are all handling things like connectivity broadcasts.
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We only do this for cached processes, because otherwise an application
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; can have assumptions about calling startService() for a service to run
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; in its own process, and for that process to not be killed before the
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; service is started.  This is especially the case for receivers, which
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; may start a service in onReceive() to do some additional work and have
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; initialized some global state as part of that.&lt;/span&gt;
            &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (DEBUG_DELAYED_SERVICE) Slog.v(TAG_SERVICE, &quot;Potential start delay of &quot;
                    + r + &quot; in &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; proc);
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.delayed) {
                &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; This service is already scheduled for a delayed start; just leave
                &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; it still waiting.&lt;/span&gt;
                &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, &quot;Continuing to delay: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; r.name;
            }
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (smap.mStartingBackground.size() &amp;gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mMaxStartingBackground) {
                &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Something else is starting, delay!&lt;/span&gt;
                Slog.i(TAG_SERVICE, &quot;Delaying start of: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
                smap.mDelayedStartList.add(r);
                r.delayed &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; r.name;
            }
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, &quot;Not delaying: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
            addToStarting &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (proc.curProcState &amp;gt;=&lt;span style=&quot;color: #000000;&quot;&gt; ActivityManager.PROCESS_STATE_SERVICE) {
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We slightly loosen when we will enqueue this new service as a background
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; starting service we are waiting for, to also include processes that are
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; currently running other services or receivers.&lt;/span&gt;
            addToStarting = &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,
                    &lt;/span&gt;&quot;Not delaying, but counting as bg: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_DELAYED_STARTS) {
            StringBuilder sb &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; StringBuilder(128&lt;span style=&quot;color: #000000;&quot;&gt;);
            sb.append(&lt;/span&gt;&quot;Not potential delay (state=&quot;&lt;span style=&quot;color: #000000;&quot;&gt;).append(proc.curProcState)
                    .append(&lt;/span&gt;&apos; &apos;&lt;span style=&quot;color: #000000;&quot;&gt;).append(proc.adjType);
            String reason &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; proc.makeAdjReason();
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (reason != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                sb.append(&lt;/span&gt;&apos; &apos;&lt;span style=&quot;color: #000000;&quot;&gt;);
                sb.append(reason);
            }
            sb.append(&lt;/span&gt;&quot;): &quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
            sb.append(r.toString());
            Slog.v(TAG_SERVICE, sb.toString());
        }
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_DELAYED_STARTS) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (callerFg ||&lt;span style=&quot;color: #000000;&quot;&gt; fgRequired) {
            Slog.v(TAG_SERVICE, &lt;/span&gt;&quot;Not potential delay (callerFg=&quot; + callerFg + &quot; uid=&quot;
                    + callingUid + &quot; pid=&quot; + callingPid + &quot; fgRequired=&quot; + fgRequired + &quot;): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (r.app != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            Slog.v(TAG_SERVICE, &lt;/span&gt;&quot;Not potential delay (cur app=&quot; + r.app + &quot;): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            Slog.v(TAG_SERVICE,
                    &lt;/span&gt;&quot;Not potential delay (user &quot; + r.userId + &quot; not started): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
        }
    }

    ComponentName cmp &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; startServiceInnerLocked(smap, service, r, callerFg, addToStarting);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; cmp;
}

ComponentName startServiceInnerLocked(ServiceMap smap, Intent service, ServiceRecord r,
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; callerFg, &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; addToStarting) &lt;span style=&quot;color: #0000ff;&quot;&gt;throws&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; TransactionTooLargeException {
    ServiceState stracker &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; r.getTracker();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (stracker != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        stracker.setStarted(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);
    }
    r.callStart &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;synchronized&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.stats.getBatteryStats()) {
        r.stats.startRunningLocked();
    }
    String error &lt;/span&gt;= bringUpServiceLocked(r, service.getFlags(), callerFg, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (error != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; ComponentName(&quot;!!&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, error);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (r.startRequested &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; addToStarting) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; first = smap.mStartingBackground.size() == 0&lt;span style=&quot;color: #000000;&quot;&gt;;
        smap.mStartingBackground.add(r);
        r.startingBgTimeout &lt;/span&gt;= SystemClock.uptimeMillis() +&lt;span style=&quot;color: #000000;&quot;&gt; mAm.mConstants.BG_START_TIMEOUT;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_DELAYED_SERVICE) {
            RuntimeException here &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;here&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
            here.fillInStackTrace();
            Slog.v(TAG_SERVICE, &lt;/span&gt;&quot;Starting background (first=&quot; + first + &quot;): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r, here);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_DELAYED_STARTS) {
            Slog.v(TAG_SERVICE, &lt;/span&gt;&quot;Starting background (first=&quot; + first + &quot;): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
        }
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (first) {
            smap.rescheduleDelayedStartsLocked();
        }
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (callerFg ||&lt;span style=&quot;color: #000000;&quot;&gt; r.fgRequired) {
        smap.ensureNotStartingBackgroundLocked(r);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; r.name;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
*1.创建进程：startProcessLocked
*2.第一次启动Service：realStartServiceLocked
*3.启动已有的Service：sendServiceArgsLocked
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; String bringUpServiceLocked(ServiceRecord r, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; intentFlags, &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; execInFg,
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; whileRestarting, &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; permissionsReviewRequired)
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throws&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; TransactionTooLargeException {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;Slog.i(TAG, &quot;Bring up service:&quot;);
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;r.dump(&quot;  &quot;);&lt;/span&gt;

    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (r.app != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; r.app.thread != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;启动Service&amp;nbsp;&amp;nbsp;&lt;/span&gt;
        sendServiceArgsLocked(r, execInFg, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!whileRestarting &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; mRestartingServices.contains(r)) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If waiting for a restart, then do nothing.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_SERVICE) {
        Slog.v(TAG_SERVICE, &lt;/span&gt;&quot;Bringing up &quot; + r + &quot; &quot; + r.intent + &quot; fg=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r.fgRequired);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We are now bringing the service up, so no longer in the
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; restarting state.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (mRestartingServices.remove(r)) {
        clearRestartingIfNeededLocked(r);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Make sure this service is no longer considered delayed, we are starting it now.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.delayed) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, &quot;REM FR DELAY LIST (bring up): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
        getServiceMapLocked(r.userId).mDelayedStartList.remove(r);
        r.delayed &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Make sure that the user who owns this service is started.  If not,
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we don&apos;t want to allow it to run.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mAm.mUserController.hasStartedUserState(r.userId)) {
        String msg &lt;/span&gt;= &quot;Unable to launch app &quot;
                + r.appInfo.packageName + &quot;/&quot;
                + r.appInfo.uid + &quot; for service &quot;
                + r.intent.getIntent() + &quot;: user &quot; + r.userId + &quot; is stopped&quot;&lt;span style=&quot;color: #000000;&quot;&gt;;
        Slog.w(TAG, msg);
        bringDownServiceLocked(r);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; msg;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Service is now being launched, its package can&apos;t be stopped.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        AppGlobals.getPackageManager().setPackageStoppedState(
                r.packageName, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, r.userId);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (RemoteException e) {
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IllegalArgumentException e) {
        Slog.w(TAG, &lt;/span&gt;&quot;Failed trying to unstop package &quot;
                + r.packageName + &quot;: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; e);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; isolated = (r.serviceInfo.flags&amp;amp;ServiceInfo.FLAG_ISOLATED_PROCESS) != 0&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String procName =&lt;span style=&quot;color: #000000;&quot;&gt; r.processName;
    String hostingType &lt;/span&gt;= &quot;service&quot;&lt;span style=&quot;color: #000000;&quot;&gt;;
    ProcessRecord app;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;isolated) {
        app &lt;/span&gt;= mAm.getProcessRecordLocked(procName, r.appInfo.uid, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (DEBUG_MU) Slog.v(TAG_MU, &quot;bringUpServiceLocked: appInfo.uid=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r.appInfo.uid
                    &lt;/span&gt;+ &quot; app=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; app);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (app != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; app.thread != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
                app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);
                realStartServiceLocked(r, app, execInFg);
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
            } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (TransactionTooLargeException e) {
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; e;
            } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (RemoteException e) {
                Slog.w(TAG, &lt;/span&gt;&quot;Exception when starting service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r.shortName, e);
            }

            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If a dead object exception was thrown -- fall through to
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; restart the application.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            }<br>        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> If this service runs in an isolated process, then each time<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> we call startProcessLocked() we will get a new isolated<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> process, starting another process if we are currently waiting<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> for a previous process to come up.  To deal with this, we store<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> in the service any current isolated process it is running in or<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> waiting to have come up.</span><br>            app =<span style="color: #000000;"> r.isolatedProc;<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (WebViewZygote.isMultiprocessEnabled()<br>                    </span>&amp;&amp;<span style="color: #000000;"> r.serviceInfo.packageName.equals(WebViewZygote.getPackageName())) {<br>                hostingType </span>= “webview_service”<span style="color: #000000;">;<br>            }<br>        }</span></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Not running -- get it started, and enqueue this service record
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to be executed when the app comes up.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (app == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;permissionsReviewRequired) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; ((app=mAm.startProcessLocked(procName, r.appInfo, &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, intentFlags,
                hostingType, r.name, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;, isolated, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;)) == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            String msg &lt;/span&gt;= &quot;Unable to launch app &quot;
                    + r.appInfo.packageName + &quot;/&quot;
                    + r.appInfo.uid + &quot; for service &quot;
                    + r.intent.getIntent() + &quot;: process is bad&quot;&lt;span style=&quot;color: #000000;&quot;&gt;;
            Slog.w(TAG, msg);
            bringDownServiceLocked(r);
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; msg;
        }
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (isolated) {
            r.isolatedProc &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; app;
        }
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mPendingServices.contains(r)) {
        mPendingServices.add(r);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.delayedStop) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Oh and hey we&apos;ve already been asked to stop!&lt;/span&gt;
        r.delayedStop = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.startRequested) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,
                    &lt;/span&gt;&quot;Applying delayed stop (in bring up): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
            stopServiceLocked(r);
        }
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
* 完成了Service的创建、绑定、启动的调用
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; realStartServiceLocked(ServiceRecord r,
        ProcessRecord app, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; execInFg) &lt;span style=&quot;color: #0000ff;&quot;&gt;throws&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RemoteException {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (app.thread == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RemoteException();
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_MU)
        Slog.v(TAG_MU, &lt;/span&gt;&quot;realStartServiceLocked, ServiceRecord.uid = &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r.appInfo.uid
                &lt;/span&gt;+ &quot;, ProcessRecord.uid = &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; app.uid);
    r.app &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; app;
    r.restartTime &lt;/span&gt;= r.lastActivity =&lt;span style=&quot;color: #000000;&quot;&gt; SystemClock.uptimeMillis();

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; newService =&lt;span style=&quot;color: #000000;&quot;&gt; app.services.add(r);
    bumpServiceExecutingLocked(r, execInFg, &lt;/span&gt;&quot;create&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mAm.updateLruProcessLocked(app, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    updateServiceForegroundLocked(r.app, &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; oomAdj= &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mAm.updateOomAdjLocked();

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; created = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (LOG_SERVICE_START_STOP) {
            String nameTerm;
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; lastPeriod = r.shortName.lastIndexOf(&apos;.&apos;&lt;span style=&quot;color: #000000;&quot;&gt;);
            nameTerm &lt;/span&gt;= lastPeriod &amp;gt;= 0 ?&lt;span style=&quot;color: #000000;&quot;&gt; r.shortName.substring(lastPeriod) : r.shortName;
            EventLogTags.writeAmCreateService(
                    r.userId, System.identityHashCode(r), nameTerm, r.app.uid, r.app.pid);
        }
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;synchronized&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.stats.getBatteryStats()) {
            r.stats.startLaunchedLocked();
        }
        mAm.notifyPackageUse(r.serviceInfo.packageName,
                             PackageManager.NOTIFY_PACKAGE_USE_SERVICE);
        app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;RPC调用ActivityThread类中的方法创建Service&amp;nbsp;&lt;/span&gt;</code></pre><p><span style="color: #000000;">            app.thread.scheduleCreateService(r, r.serviceInfo,<br>                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),<br>                    app.repProcState);<br>            r.postNotification();<br>            created </span>= <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (DeadObjectException e) {<br>            Slog.w(TAG, </span>“Application dead when creating service “ +<span style="color: #000000;"> r);<br>            mAm.appDiedLocked(app);<br>            </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> e;<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">created) {<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;"> Keep the executeNesting count accurate.</span><br>                <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">boolean</span> inDestroying =<span style="color: #000000;"> mDestroyingServices.contains(r);<br>                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span></p>
<pre><code>        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Cleanup.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (newService) {
            app.services.remove(r);
            r.app &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Retry.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;inDestroying) {
            scheduleServiceRestartLocked(r, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        }
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.whitelistManager) {
    app.whitelistManager &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;绑定该Service&amp;nbsp;&amp;nbsp;&lt;/span&gt;</code></pre><p><span style="color: #000000;">        requestServiceBindingsLocked(r, execInFg);</span></p>
<pre><code>    updateServiceClientActivitiesLocked(app, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If the service is in the started state, and there are no
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; pending arguments, then fake up one so its onStartCommand() will
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; be called.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (r.startRequested &amp;amp;&amp;amp; r.callStart &amp;amp;&amp;amp; r.pendingStarts.size() == 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
        r.pendingStarts.add(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; ServiceRecord.StartItem(r, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, r.makeNextStartId(),
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, 0&lt;span style=&quot;color: #000000;&quot;&gt;));
    }

    &amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;启动该Service&amp;nbsp;&amp;nbsp;&lt;/span&gt;
    sendServiceArgsLocked(r, execInFg, &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.delayed) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, &quot;REM FR DELAY LIST (new proc): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
        getServiceMapLocked(r.userId).mDelayedStartList.remove(r);
        r.delayed &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.delayedStop) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Oh and hey we&apos;ve already been asked to stop!&lt;/span&gt;
        r.delayedStop = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (r.startRequested) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,
                    &lt;/span&gt;&quot;Applying delayed stop (from start): &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; r);
            stopServiceLocked(r);
        }
    }
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">android-8.0.0_r1\frameworks\base\core\java\android\app\ActivityThread.java</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> scheduleCreateService(IBinder token,
                ServiceInfo info, CompatibilityInfo compatInfo, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> processState) {
            updateProcessState(processState, </span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
            CreateServiceData s </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> CreateServiceData();
            s.token </span>=<span style="color: #000000;"> token;
            s.info </span>=<span style="color: #000000;"> info;
            s.compatInfo </span>=<span style="color: #000000;"> compatInfo;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;通过sendMessage方法向应用程序主线程MessageQueue中发送一个CREATE_SERVICE消息&lt;/span&gt;</code></pre><p><span style="color: #000000;">            sendMessage(H.CREATE_SERVICE, s);<br>        }</span></p>
<p> </p></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleMessage(Message msg) {<br>            </span><span style="color: #0000ff;">if</span> (DEBUG_MESSAGES) Slog.v(TAG, “&gt;&gt;&gt; handling: “ +<span style="color: #000000;"> codeToString(msg.what));<br>            </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (msg.what) {<br>                ……..<p></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; CREATE_SERVICE:
        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (&lt;/span&gt;&quot;serviceCreate: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; String.valueOf(msg.obj)));</code></pre><p></p></span><span style="color: #008000;">//</span><span style="color: #008000;">    将Service的创建工作交给ActivityThread类的handleCreateService方法来完成</span><br><span style="color: #000000;">                    handleCreateService((CreateServiceData)msg.obj);<br>                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<p></p>
<pre><code>               ........
           }
}</code></pre><p></p></span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleCreateService(CreateServiceData data) {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> If we are getting ready to gc after going to the background, well<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> we are back active so skip it.</span><br><span style="color: #000000;">        unscheduleGcIdler();<p></p>
<pre><code>LoadedApk packageInfo &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; getPackageInfoNoCheck(
        data.info.applicationInfo, data.compatInfo);
Service service &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    java.lang.ClassLoader cl &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; packageInfo.getClassLoader();
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;data.info.name就是Service是类名，通过类加载器根据类名创建一个实例后强转为Service类的实例&amp;nbsp;&amp;nbsp;&lt;/span&gt;
    service =&lt;span style=&quot;color: #000000;&quot;&gt; (Service) cl.loadClass(data.info.name).newInstance();
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Exception e) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mInstrumentation.onException(service, e)) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RuntimeException(
            &lt;/span&gt;&quot;Unable to instantiate service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; data.info.name
            &lt;/span&gt;+ &quot;: &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; e.toString(), e);
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (localLOGV) Slog.v(TAG, &quot;Creating service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; data.info.name);

    ContextImpl context &lt;/span&gt;= ContextImpl.createAppContext(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, packageInfo);
    context.setOuterContext(service);

    Application app &lt;/span&gt;= packageInfo.makeApplication(&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, mInstrumentation);
    service.attach(context, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, data.info.name, data.token, app,
            ActivityManager.getService());
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&amp;nbsp;回调Service的onCreate()方法&amp;nbsp;&amp;nbsp;&lt;/span&gt;</code></pre><p><span style="color: #000000;">            service.onCreate();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">&nbsp;mServices保存了应用程序进程中所有的Service，把Service添加到该变量中&nbsp;&nbsp;</span><br><span style="color: #000000;">            mServices.put(data.token, service);<br>            </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">&nbsp;通知ActivityManagerService，当前Service创建完成&nbsp;&nbsp;</span><br><span style="color: #000000;">                ActivityManager.getService().serviceDoneExecuting(<br>                        data.token, SERVICE_DONE_EXECUTING_ANON, </span>0, 0<span style="color: #000000;">);<br>            } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (RemoteException e) {<br>                </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> e.rethrowFromSystemServer();<br>            }<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br>            </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">mInstrumentation.onException(service, e)) {<br>                </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> RuntimeException(<br>                    </span>“Unable to create service “ +<span style="color: #000000;"> data.info.name<br>                    </span>+ “: “ +<span style="color: #000000;"> e.toString(), e);<br>            }<br>        }<br>    }</span></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201806/612293-20180624170737100-200403851.png" alt></p>
</div>
  </article>
  
    
<div class="nexmoe-post-copyright">
<i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
<strong>本文作者：</strong>网记本<br>
<strong>本文链接：</strong><a href="https://freefuncode.github.io/2018/06/24/Android源码分析三Service启动分析/" title="https://freefuncode.github.io/2018/06/24/Android源码分析三Service启动分析/" target="_blank" rel="noopener">https://freefuncode.github.io/2018/06/24/Android源码分析三Service启动分析/</a><br>

  <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

</div>


  
  <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'f59edbb15c434fe50f63',
        clientSecret: '5ad8f05641605b384357bd325058c4cddd58b93b',
        id: window.location.pathname,
        repo: 'FreeFunCode.github.io',
        owner: 'FreeFunCode',
        admin: 'FreeFunCode'
    })
    gitalk.render('gitalk')
</script>
</section>
</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
 
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


 
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/app.js?v=1571545564737"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>


    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>



  





    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?3771b2566860fea0de20c35742671f53#&lt;ID&gt;';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

</body>

</html>
