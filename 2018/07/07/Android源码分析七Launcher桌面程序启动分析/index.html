<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8">
    <meta name="baidu-site-verification" content="dIcXMeY8Ya">
    
    <title>Android 源码分析（七） Launcher 桌面程序启动分析 | 网记本</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="keywords" content="freefuncode, huangguangzhi, Android, Kotlin, 网络记事本, 网记本, inote.fun">
    <meta name="description" content="FreeFunCode网络记事本">

    
    <link rel="alternative" href="/atom.xml" title="网记本" type="application/atom+xml">
    
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?3771b2566860fea0de20c35742671f53";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');</script></head>
<body class="home">

    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">网记本</span>
                    <span class="description">网络记事本-huangguangzhi</span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/2018/07/07/Android源码分析七Launcher桌面程序启动分析/index.html" class="item ">
                <a href="/" title="日志" class="icon-home">&nbsp;日志</a>
            </li>
            
            <li rel="/2018/07/07/Android源码分析七Launcher桌面程序启动分析/index.html" class="item ">
                <a href="/photos/" title="相册" class="icon-files-empty">&nbsp;相册</a>
            </li>
            
            <li rel="/2018/07/07/Android源码分析七Launcher桌面程序启动分析/index.html" class="item ">
                <a href="/lab/" title="建站" class="icon-office">&nbsp;建站</a>
            </li>
            
            <li rel="/2018/07/07/Android源码分析七Launcher桌面程序启动分析/index.html" class="item ">
                <a href="/about/" title="关于" class="icon-profile">&nbsp;关于</a>
            </li>
            
            <li rel="/2018/07/07/Android源码分析七Launcher桌面程序启动分析/index.html" class="item ">
                <a href="/comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="" target="_blank">good good study ,day day up!</a>
                        |
                    
                        <a href="" target="_blank">利用碎片化时间挖掘知识深度！</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" class="juejin" target="_blank"><b>■</b> 稀土掘金</a>
                    
                        <a href="https://weibo.com/230689567" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/user.png" alt="avatar" title="FreeFunCode">
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章页 -->
<!-- 文章 -->
<article class="post article">
    <header class="text-center">
        <h3 class="post-title"><span>Android 源码分析（七） Launcher 桌面程序启动分析</span></h3>
    </header>
    <p class="post-meta text-center">
        huangguangzhi 发表于
        <time datetime="2018-07-07T11:51:44.000Z">2018-07-07</time>
    </p>
    <div class="post-content">
        <p><a href="https://www.cnblogs.com/bugzone/p/Launcher.html" target="_blank" rel="noopener">点击查看原文</a></p>
<a id="more"></a>

<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;<strong>Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序</strong>.<strong>在Zygote进程里等待SystemService进程启动后，创建.</strong><br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. Launcher 桌面程序启动</h2>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Launcher程序就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序。</p>
<p>　　首先了解下，Zygote进程是如何启动一个应用的。</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180708235023116-19887742.png" alt=""></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteServer.java</span>
 <span style="color: #0000ff;">void</span> runSelectLoop(String abiList) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller {
        ArrayList</span>&lt;FileDescriptor&gt; fds = <span style="color: #0000ff;">new</span> ArrayList&lt;FileDescriptor&gt;<span style="color: #000000;">();
        ArrayList</span>&lt;ZygoteConnection&gt; peers = <span style="color: #0000ff;">new</span> ArrayList&lt;ZygoteConnection&gt;<span style="color: #000000;">();

<pre><code>    fds.add(mServerSocket.getFileDescriptor());
    peers.add(&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;while&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        StructPollfd[] pollFds &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; StructPollfd[fds.size()];
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; i = 0; i &amp;lt; pollFds.length; ++&lt;span style="color: #000000;"&gt;i) {
            pollFds[i] &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; StructPollfd();
            pollFds[i].fd &lt;/span&gt;=&lt;span style="color: #000000;"&gt; fds.get(i);
            pollFds[i].events &lt;/span&gt;= (&lt;span style="color: #0000ff;"&gt;short&lt;/span&gt;&lt;span style="color: #000000;"&gt;) POLLIN;
        }
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
            Os.poll(pollFds, &lt;/span&gt;-1&lt;span style="color: #000000;"&gt;);
        } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ErrnoException ex) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; RuntimeException("poll failed"&lt;span style="color: #000000;"&gt;, ex);
        }
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt; (&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; i = pollFds.length - 1; i &amp;gt;= 0; --&lt;span style="color: #000000;"&gt;i) {
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; ((pollFds[i].revents &amp;amp; POLLIN) == 0&lt;span style="color: #000000;"&gt;) {
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;continue&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
            }
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (i == 0&lt;span style="color: #000000;"&gt;) {
                ZygoteConnection newPeer &lt;/span&gt;=&lt;span style="color: #000000;"&gt; acceptCommandPeer(abiList);
                peers.add(newPeer);
                fds.add(newPeer.getFileDesciptor());
            } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; done = peers.get(i).runOnce(&lt;span style="color: #0000ff;"&gt;this&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
                &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (done) {
                    peers.remove(i);
                    fds.remove(i);
                }
            }
        }
    }
}</code></pre><p>}<br><br>　　/**<br>&nbsp;&nbsp;&nbsp;&nbsp; * Waits for and accepts a single command connection. Throws<br>&nbsp;&nbsp;&nbsp;&nbsp; * RuntimeException on failure.<br>&nbsp;&nbsp;&nbsp;&nbsp; */<br>&nbsp;&nbsp;&nbsp; private ZygoteConnection acceptCommandPeer(String abiList) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return createNewConnection(mServerSocket.accept(), abiList);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (IOException ex) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new RuntimeException(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; “IOException during accept()”, ex);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;<br>&nbsp;protected ZygoteConnection createNewConnection(LocalSocket socket, String abiList)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throws IOException {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new ZygoteConnection(socket, abiList);<br>&nbsp;&nbsp;&nbsp; }<br></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('b4582d4a-5eee-42a1-a93e-5858a6f4d479')"><img id="code_img_closed_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('b4582d4a-5eee-42a1-a93e-5858a6f4d479',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteConnection.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Constructs instance from connected socket.
     *
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> socket non-null; connected socket
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> abiList non-null; a list of ABIs this zygote supports.
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IOException
     </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    ZygoteConnection(LocalSocket socket, String abiList) </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
        mSocket </span>=<span style="color: #000000;"> socket;
        </span><span style="color: #0000ff;">this</span>.abiList =<span style="color: #000000;"> abiList;

<pre><code>    mSocketOutStream
            &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; DataOutputStream(socket.getOutputStream());

    mSocketReader &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; BufferedReader(
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; InputStreamReader(socket.getInputStream()), 256&lt;span style="color: #000000;"&gt;);

    mSocket.setSoTimeout(CONNECTION_TIMEOUT_MILLIS);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        peer &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mSocket.getPeerCredentials();
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (IOException ex) {
        Log.e(TAG, &lt;/span&gt;"Cannot read peer credentials"&lt;span style="color: #000000;"&gt;, ex);
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt;&lt;span style="color: #000000;"&gt; ex;
    }
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
 * Reads one start command from the command socket. If successful,
 * a child is forked and a {&lt;/span&gt;&lt;span style="color: #808080;"&gt;@link&lt;/span&gt;&lt;span style="color: #008000;"&gt; Zygote.MethodAndArgsCaller}
 * exception is thrown in that child while in the parent process,
 * the method returns normally. On failure, the child is not
 * spawned and messages are printed to the log and stderr. Returns
 * a boolean status value indicating whether an end-of-file on the command
 * socket has been encountered.
 *
 * &lt;/span&gt;&lt;span style="color: #808080;"&gt;@return&lt;/span&gt;&lt;span style="color: #008000;"&gt; false if command socket should continue to be read from, or
 * true if an end-of-file has been encountered.
 * &lt;/span&gt;&lt;span style="color: #808080;"&gt;@throws&lt;/span&gt;&lt;span style="color: #008000;"&gt; Zygote.MethodAndArgsCaller trampoline to invoke main()
 * method in child process
 &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;
&lt;span style="color: #0000ff;"&gt;boolean&lt;/span&gt; runOnce(ZygoteServer zygoteServer) &lt;span style="color: #0000ff;"&gt;throws&lt;/span&gt;&lt;span style="color: #000000;"&gt; Zygote.MethodAndArgsCaller {

    String args[];
    Arguments parsedArgs &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    FileDescriptor[] descriptors;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        args &lt;/span&gt;=&lt;span style="color: #000000;"&gt; readArgumentList();
        descriptors &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mSocket.getAncillaryFileDescriptors();
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (IOException ex) {
        Log.w(TAG, &lt;/span&gt;"IOException on command socket " +&lt;span style="color: #000000;"&gt; ex.getMessage());
        closeSocket();
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (args == &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; EOF reached.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            closeSocket();<br>            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt; the stderr of the most recent request, if avail &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;&lt;span style="color: #000000;"&gt;
PrintStream newStderr &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (descriptors != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt; &amp;amp;&amp;amp; descriptors.length &amp;gt;= 3&lt;span style="color: #000000;"&gt;) {
    newStderr &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; PrintStream(
            &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; FileOutputStream(descriptors[2&lt;span style="color: #000000;"&gt;]));
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; pid = -1&lt;span style="color: #000000;"&gt;;
FileDescriptor childPipeFd &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
FileDescriptor serverPipeFd &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    parsedArgs &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt;&lt;span style="color: #000000;"&gt; Arguments(args);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (parsedArgs.abiListQuery) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; handleAbiListQuery();
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt;&lt;span style="color: #000000;"&gt; (parsedArgs.preloadDefault) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; handlePreload();
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.preloadPackage != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; handlePreloadPackage(parsedArgs.preloadPackage,
                parsedArgs.preloadPackageLibs, parsedArgs.preloadPackageCacheKey);
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.permittedCapabilities != 0 || parsedArgs.effectiveCapabilities != 0&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;throw&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; ZygoteSecurityException("Client may not specify capabilities: " +
                "permitted=0x" + Long.toHexString(parsedArgs.permittedCapabilities) +
                ", effective=0x" +&lt;span style="color: #000000;"&gt; Long.toHexString(parsedArgs.effectiveCapabilities));
    }

    applyUidSecurityPolicy(parsedArgs, peer);
    applyInvokeWithSecurityPolicy(parsedArgs, peer);

    applyDebuggerSystemProperty(parsedArgs);
    applyInvokeWithSystemProperty(parsedArgs);

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;[][] rlimits = &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.rlimits != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        rlimits &lt;/span&gt;=&lt;span style="color: #000000;"&gt; parsedArgs.rlimits.toArray(intArray2d);
    }

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;[] fdsToIgnore = &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.invokeWith != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        FileDescriptor[] pipeFds &lt;/span&gt;=&lt;span style="color: #000000;"&gt; Os.pipe2(O_CLOEXEC);
        childPipeFd &lt;/span&gt;= pipeFds[1&lt;span style="color: #000000;"&gt;];
        serverPipeFd &lt;/span&gt;= pipeFds[0&lt;span style="color: #000000;"&gt;];
        Os.fcntlInt(childPipeFd, F_SETFD, &lt;/span&gt;0&lt;span style="color: #000000;"&gt;);
        fdsToIgnore &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt;&lt;span style="color: #000000;"&gt;[] { childPipeFd.getInt$(), serverPipeFd.getInt$() };
    }

    &lt;/span&gt;&lt;span style="color: #008000;"&gt;/**&lt;/span&gt;&lt;span style="color: #008000;"&gt;
     * In order to avoid leaking descriptors to the Zygote child,
     * the native code must close the two Zygote socket descriptors
     * in the child process before it switches from Zygote-root to
     * the UID and privileges of the application being launched.
     *
     * In order to avoid "bad file descriptor" errors when the
     * two LocalSocket objects are closed, the Posix file
     * descriptors are released via a dup2() call which closes
     * the socket and substitutes an open descriptor to /dev/null.
     &lt;/span&gt;&lt;span style="color: #008000;"&gt;*/&lt;/span&gt;

    &lt;span style="color: #0000ff;"&gt;int&lt;/span&gt; [] fdsToClose = { -1, -1&lt;span style="color: #000000;"&gt; };

    FileDescriptor fd &lt;/span&gt;=&lt;span style="color: #000000;"&gt; mSocket.getFileDescriptor();

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (fd != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        fdsToClose[&lt;/span&gt;0] =&lt;span style="color: #000000;"&gt; fd.getInt$();
    }

    fd &lt;/span&gt;=&lt;span style="color: #000000;"&gt; zygoteServer.getServerSocketFileDescriptor();

    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (fd != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
        fdsToClose[&lt;/span&gt;1] =&lt;span style="color: #000000;"&gt; fd.getInt$();
    }

    fd &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;;

    pid &lt;/span&gt;=&lt;span style="color: #000000;"&gt; Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,
            parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,
            parsedArgs.niceName, fdsToClose, fdsToIgnore, parsedArgs.instructionSet,
            parsedArgs.appDataDir);
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ErrnoException ex) {
    logAndPrintError(newStderr, &lt;/span&gt;"Exception creating pipe"&lt;span style="color: #000000;"&gt;, ex);
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (IllegalArgumentException ex) {
    logAndPrintError(newStderr, &lt;/span&gt;"Invalid zygote arguments"&lt;span style="color: #000000;"&gt;, ex);
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ZygoteSecurityException ex) {
    logAndPrintError(newStderr,
            &lt;/span&gt;"Zygote security policy prevents request: "&lt;span style="color: #000000;"&gt;, ex);
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (pid == 0&lt;span style="color: #000000;"&gt;) {
        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; in child&lt;/span&gt;</code></pre><p><span style="color: #000000;">                zygoteServer.closeServerSocket();<br>                IoUtils.closeQuietly(serverPipeFd);<br>                serverPipeFd </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span></p>
<pre><code>    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; should never get here, the child is expected to either
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; throw Zygote.MethodAndArgsCaller or exec().&lt;/span&gt;
    &lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
} &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;else&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
    &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; in parent...pid of &amp;lt; 0 means failure&lt;/span&gt;</code></pre><p><span style="color: #000000;">                IoUtils.closeQuietly(childPipeFd);<br>                childPipeFd </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);<br>            }<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            IoUtils.closeQuietly(childPipeFd);<br>            IoUtils.closeQuietly(serverPipeFd);<br>        }<br>    }<br>    </span></p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('24047af0-fb9d-4495-955a-61ae30e0b7ac')"><img id="code_img_closed_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('24047af0-fb9d-4495-955a-61ae30e0b7ac',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">Zygote.java</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> forkAndSpecialize(<span style="color: #0000ff;">int</span> uid, <span style="color: #0000ff;">int</span> gid, <span style="color: #0000ff;">int</span>[] gids, <span style="color: #0000ff;">int</span><span style="color: #000000;"> debugFlags,
          </span><span style="color: #0000ff;">int</span>[][] rlimits, <span style="color: #0000ff;">int</span> mountExternal, String seInfo, String niceName, <span style="color: #0000ff;">int</span><span style="color: #000000;">[] fdsToClose,
          </span><span style="color: #0000ff;">int</span><span style="color: #000000;">[] fdsToIgnore, String instructionSet, String appDataDir) {
        VM_HOOKS.preFork();
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Resets nice priority for zygote process.</span>
<span style="color: #000000;">        resetNicePriority();
        </span><span style="color: #0000ff;">int</span> pid =<span style="color: #000000;"> nativeForkAndSpecialize(
                  uid, gid, gids, debugFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,
                  fdsToIgnore, instructionSet, appDataDir);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Enable tracing as soon as possible for the child process.</span>
        <span style="color: #0000ff;">if</span> (pid == 0<span style="color: #000000;">) {
            Trace.setTracingEnabled(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);

<pre><code>        &lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; Note that this event ends at the end of handleChildProc,&lt;/span&gt;
        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, "PostFork"&lt;span style="color: #000000;"&gt;);
    }
    VM_HOOKS.postForkCommon();
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; pid;
}&lt;/span&gt;&lt;/pre&gt;</code></pre></span></pre></div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('585017ee-5c61-4dd0-b78d-a900abceb71c')"><img id="code_img_closed_585017ee-5c61-4dd0-b78d-a900abceb71c" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img id="code_img_opened_585017ee-5c61-4dd0-b78d-a900abceb71c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('585017ee-5c61-4dd0-b78d-a900abceb71c',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="">
<div id="cnblogs_code_open_585017ee-5c61-4dd0-b78d-a900abceb71c" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteConnection.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Handles post-fork setup of child proc, closing sockets as appropriate,
     * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller
     * if successful or returning if failed.
     *
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> parsedArgs non-null; zygote args
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> descriptors null-ok; new file descriptors for stdio if available.
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> pipeFd null-ok; pipe for communication back to Zygote.
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> newStderr null-ok; stream to use for stderr until stdio
     * is reopened.
     *
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Zygote.MethodAndArgsCaller on success to
     * trampoline to code that invokes static main.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleChildProc(Arguments parsedArgs,
            FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)
            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller {
        </span><span style="color: #008000;">/**</span><span style="color: #008000;">
         * By the time we get here, the native code has closed the two actual Zygote
         * socket connections, and substituted /dev/null in their place.  The LocalSocket
         * objects still need to be closed properly.
         </span><span style="color: #008000;">*/</span><span style="color: #000000;">

<pre><code>closeSocket();
&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (descriptors != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;try&lt;/span&gt;&lt;span style="color: #000000;"&gt; {
        Os.dup2(descriptors[&lt;/span&gt;0&lt;span style="color: #000000;"&gt;], STDIN_FILENO);
        Os.dup2(descriptors[&lt;/span&gt;1&lt;span style="color: #000000;"&gt;], STDOUT_FILENO);
        Os.dup2(descriptors[&lt;/span&gt;2&lt;span style="color: #000000;"&gt;], STDERR_FILENO);

        &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;for&lt;/span&gt;&lt;span style="color: #000000;"&gt; (FileDescriptor fd: descriptors) {
            IoUtils.closeQuietly(fd);
        }
        newStderr &lt;/span&gt;=&lt;span style="color: #000000;"&gt; System.err;
    } &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;catch&lt;/span&gt;&lt;span style="color: #000000;"&gt; (ErrnoException ex) {
        Log.e(TAG, &lt;/span&gt;"Error reopening stdio"&lt;span style="color: #000000;"&gt;, ex);
    }
}

&lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (parsedArgs.niceName != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;) {
    Process.setArgV0(parsedArgs.niceName);
}

&lt;/span&gt;&lt;span style="color: #008000;"&gt;//&lt;/span&gt;&lt;span style="color: #008000;"&gt; End of the postFork event.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>        </span><span style="color: #0000ff;">if</span> (parsedArgs.invokeWith != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            WrapperInit.execApplication(parsedArgs.invokeWith,<br>                    parsedArgs.niceName, parsedArgs.targetSdkVersion,<br>                    VMRuntime.getCurrentInstructionSet(),<br>                    pipeFd, parsedArgs.remainingArgs);<br>        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br>            ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion,<br>                    parsedArgs.remainingArgs, </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> classLoader </span><span style="color: #008000;">*/</span><span style="color: #000000;">);<br>        }<br>    }</span></p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p>
<p>　　前一篇文章我们知道在SystemServer进程的启动过程中会调用其main静态方法，开始执行整个SystemServer的启动流程。在调用startOtherService方法中就会通过调用mActivityManagerService.systemReady()方法。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">SystemServer.java</span>
<span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> startOtherServices() {
    ......
         </span><span style="color: #008000;">//</span><span style="color: #008000;"> We now tell the activity manager it is okay to run third party
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> code.  It will call back into us once it has gotten to the state
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> where third party code can really run (but before it has actually
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> started launching the initial applications), for us to complete our
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> initialization.</span>
<span style="color: #000000;">        mActivityManagerService.systemReady()
    ......
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ActivityManagerService.java</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> systemReady(<span style="color: #0000ff;">final</span><span style="color: #000000;"> Runnable goingCallback, BootTimingsTraceLog traceLog) {
        ......
    startHomeActivityLocked(currentUserId, </span>"systemReady"<span style="color: #000000;">);
        ......

<p>}</p>
<p></p></span><span style="color: #0000ff;">boolean</span> startHomeActivityLocked(<span style="color: #0000ff;">int</span><span style="color: #000000;"> userId, String reason) {<br>        </span><span style="color: #0000ff;">if</span> (mFactoryTest ==<span style="color: #000000;"> FactoryTest.FACTORY_TEST_LOW_LEVEL<br>                </span>&amp;&amp; mTopAction == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> We are running in factory test mode, but unable to find<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> the factory test app, so just sit around displaying the<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> error message and don’t try to start anything.</span><br>            <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        }<br>        Intent intent </span>=<span style="color: #000000;"> getHomeIntent();<br>        ActivityInfo aInfo </span>=<span style="color: #000000;"> resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);<br>        </span><span style="color: #0000ff;">if</span> (aInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            intent.setComponent(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Don’t do this if the home app is currently being<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> instrumented.</span><br>            aInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ActivityInfo(aInfo);<br>            aInfo.applicationInfo </span>=<span style="color: #000000;"> getAppInfoForUser(aInfo.applicationInfo, userId);<br>            ProcessRecord app </span>=<span style="color: #000000;"> getProcessRecordLocked(aInfo.processName,<br>                    aInfo.applicationInfo.uid, </span><span style="color: #0000ff;">true</span><span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span> (app == <span style="color: #0000ff;">null</span> || app.instr == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>                intent.setFlags(intent.getFlags() </span>|<span style="color: #000000;"> Intent.FLAG_ACTIVITY_NEW_TASK);<br>                </span><span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> resolvedUserId =<span style="color: #000000;"> UserHandle.getUserId(aInfo.applicationInfo.uid);<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;"> For ANR debugging to verify if the user activity is the one that actually<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;"> launched.</span><br>                <span style="color: #0000ff;">final</span> String myReason = reason + “:” + userId + “:” +<span style="color: #000000;"> resolvedUserId;<br>                mActivityStarter.startHomeActivityLocked(intent, aInfo, myReason);<br>            }<br>        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br>            Slog.wtf(TAG, </span>“No home screen found for “ + intent, <span style="color: #0000ff;">new</span><span style="color: #000000;"> Throwable());<br>        }<p></p>
<pre><code>    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt; &lt;span style="color: #0000ff;"&gt;true&lt;/span&gt;&lt;span style="color: #000000;"&gt;;
}

 Intent getHomeIntent() {
    Intent intent &lt;/span&gt;= &lt;span style="color: #0000ff;"&gt;new&lt;/span&gt; Intent(mTopAction, mTopData != &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt; ? Uri.parse(mTopData) : &lt;span style="color: #0000ff;"&gt;null&lt;/span&gt;&lt;span style="color: #000000;"&gt;);
    intent.setComponent(mTopComponent);
    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;if&lt;/span&gt; (mFactoryTest !=&lt;span style="color: #000000;"&gt; FactoryTest.FACTORY_TEST_LOW_LEVEL) {
        intent.addCategory(Intent.CATEGORY_HOME);
    }
    &lt;/span&gt;&lt;span style="color: #0000ff;"&gt;return&lt;/span&gt;&lt;span style="color: #000000;"&gt; intent;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ActivityStarter.java</span>
    <span style="color: #0000ff;">void</span><span style="color: #000000;"> startHomeActivityLocked(Intent intent, ActivityInfo aInfo, String reason) {
        mSupervisor.moveHomeStackTaskToTop(reason);
        mLastHomeActivityStartResult </span>= startActivityLocked(<span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">caller</span><span style="color: #008000;">*/</span><span style="color: #000000;">, intent,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">ephemeralIntent</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resolvedType</span><span style="color: #008000;">*/</span>, aInfo, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">rInfo</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">voiceSession</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">voiceInteractor</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resultTo</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resultWho</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">requestCode</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">callingPid</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">callingUid</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">callingPackage</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">realCallingPid</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">realCallingUid</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span>0 <span style="color: #008000;">/*</span><span style="color: #008000;">startFlags</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">options</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">false</span> <span style="color: #008000;">/*</span><span style="color: #008000;">ignoreTargetSecurity</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">false</span> <span style="color: #008000;">/*</span><span style="color: #008000;">componentSpecified</span><span style="color: #008000;">*/</span>, mLastHomeActivityStartRecord <span style="color: #008000;">/*</span><span style="color: #008000;">outActivity</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">container</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">inTask</span><span style="color: #008000;">*/</span>, "startHomeActivity: " +<span style="color: #000000;"> reason);
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (mSupervisor.inResumeTopActivity) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> If we are in resume section already, home activity will be initialized, but not
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> resumed (to avoid recursive resume) and will stay that way until something pokes it
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> again. We need to schedule another resume.</span>
<span style="color: #000000;">            mSupervisor.scheduleResumeTopActivities();
        }
    }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp; 后面就进入了Activity的启动流程了。</p>
</div>
    </div>
    <p class="post-meta">
        <span class="post-cat">分类：
            <a class="cat-link" href="/categories/Android/">Android</a>|<a class="cat-link" href="/categories/Android/安卓源码/">安卓源码</a>
        </span>
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/安卓源码/" title="安卓源码">安卓源码</a>
    

        </span>
    </p>
</article>
<!-- 分享按钮 -->

  <div class="article-share clearfix text-center">
    <div class="share-area">
      <span class="share-txt">分享到：</span>
      <a href="javascript: window.open('http://service.weibo.com/share/share.php?url=' + encodeURIComponent(location.href) + '&amp;title=' + document.title + '&amp;language=zh_cn');" class="share-icon weibo"></a>
      <a href="javascript: alert('请复制链接到微信并发送');" class="share-icon wechat"></a>
      <a href="javascript: window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=' + encodeURIComponent(location.href) + '&amp;title=' + document.title);" class="share-icon qqzone"></a>
      <a href="javascript: window.open('http://connect.qq.com/widget/shareqq/index.html?url=' + encodeURIComponent(location.href) + '&amp;desc=Jelon个人博客&amp;title=' + document.title + '&amp;callback=' + encodeURIComponent(location.href));" class="share-icon qq"></a>
      <a href="javascript: window.open('http://shuo.douban.com/!service/share?href=' + encodeURIComponent(location.href) + '&amp;name=' + document.title + '&amp;text=' + document.title);" class="share-icon douban"></a>
    </div>
  </div>


<!-- 上一篇/下一篇 -->

<div class="article-nav clearfix">
    
    <span class="prev fl">
        上一篇<br>
        <a href="/2018/07/07/Android源码分析八Launcher桌面启动App过程/">
            
                Android 源码分析（八） Launcher 桌面启动App过程
            
        </a>
    </span>
    

    
    <span class="next fr">
        下一篇<br>
        <a href="/2018/07/07/Android源码分析六SystemServer进程/">
            
                Android 源码分析（六） SystemServer 进程
            
        </a>
    </span>
    
</div>

<!-- 文章评论 -->

  
  <div id="comments" class="comment">
    <!--
    <div class="sign-bar">
      GitHub 已登录!
      <span class="sign-link">登出</span>
    </div>
    <section class="box">
      <div class="com-avatar"><img src="/img/jelon.jpg" alt="avatar"></div>
      <div class="com-text">
        <div class="main">
          <textarea class="text-area-edited show" placeholder="暂时不支持评论，因为本站在国内，不在github。如果需要联系我，请关注我公众号吧，留言能看到！"></textarea>
          <div class="text-area-preview"></div>
        </div>
        <div class="switch">
          <div class="switch-item on">编辑</div>
          <div class="switch-item">预览</div>
        </div>
        <div class="button">提交</div>
      </div>
    </section>
    <section class="tips">注：评论支持 markdown 语法！</section>
    <section class="list-wrap">
      <ul class="list">
        <li>
          <div class="user-avatar">
            <a href="/">
              <img src="/img/jelon.jpg" alt="user-avatar">
            </a>
          </div>
          <div class="user-comment">
            <div class="user-comment-header">
              <span class="post-name">张德龙</span>
              <span class="post-time">2017年12月12日</span>
              <span class="like liked">已赞</span>
              <span class="like-num">2</span>
            </div>
            <div class="user-comment-body">333333</div>
          </div>
        </li>
        <li>
          <div class="user-avatar">
            <a href="/">
              <img src="/img/jelon.jpg" alt="user-avatar">
            </a>
          </div>
          <div class="user-comment">
            <div class="user-comment-header">
              <span class="post-name">刘德华</span>
              <span class="post-time">2017年12月12日</span>
              <span class="like">点赞</span>
              <span class="like-num">2</span>
            </div>
            <div class="user-comment-body">vvvvv</div>
          </div>
        </li>
      </ul>
      <div class="page-nav">
        <a href="javascript: void(0);" class="item">1</a>
        <a href="javascript: void(0);" class="item">2</a>
        <a href="javascript: void(0);" class="item current">3</a>
      </div>
    </section>
    -->
  </div>
  


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/后端/">后端</a>
        <span class="badge">(21)</span>
    </li>
    
    <li>
        <a href="/categories/后端/CSharp/">CSharp</a>
        <span class="badge">(14)</span>
    </li>
    
    <li>
        <a href="/categories/Android/">Android</a>
        <span class="badge">(53)</span>
    </li>
    
    <li>
        <a href="/categories/Jetpack/">Jetpack</a>
        <span class="badge">(7)</span>
    </li>
    
    <li>
        <a href="/categories/Android/知识点/">知识点</a>
        <span class="badge">(18)</span>
    </li>
    
    <li>
        <a href="/categories/Android/开源框架/">开源框架</a>
        <span class="badge">(17)</span>
    </li>
    
    <li>
        <a href="/categories/Android/安卓源码/">安卓源码</a>
        <span class="badge">(15)</span>
    </li>
    
    <li>
        <a href="/categories/Android/kotlin/">kotlin</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="/categories/Jetpack/Androidx/">Androidx</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/后端/JAVA/">JAVA</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/Jetpack/Lifecycles/">Lifecycles</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/Jetpack/LiveData/">LiveData</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/Jetpack/Paging/">Paging</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/Jetpack/Room/">Room</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/Jetpack/ViewModel/">ViewModel</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/GitHub/">GitHub</a>
        <span class="badge">(5)</span>
    </li>
    
    <li>
        <a href="/categories/心情/">心情</a>
        <span class="badge">(12)</span>
    </li>
    
    <li>
        <a href="/categories/知识点/">知识点</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="/categories/前端/">前端</a>
        <span class="badge">(5)</span>
    </li>
    
    <li>
        <a href="/categories/后端/PHP/">PHP</a>
        <span class="badge">(6)</span>
    </li>
    
    <li>
        <a href="/categories/设计模式/">设计模式</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/日期格式化/" title="日期格式化">日期格式化 (1)</a>
  
    <a class="tag-item" href="/tags/Linq/" title="Linq">Linq (1)</a>
  
    <a class="tag-item" href="/tags/visualStudio/" title="visualStudio">visualStudio (2)</a>
  
    <a class="tag-item" href="/tags/view绘制/" title="view绘制">view绘制 (1)</a>
  
    <a class="tag-item" href="/tags/屏幕适配/" title="屏幕适配">屏幕适配 (1)</a>
  
    <a class="tag-item" href="/tags/Jetpack/" title="Jetpack">Jetpack (1)</a>
  
    <a class="tag-item" href="/tags/线程切换/" title="线程切换">线程切换 (1)</a>
  
    <a class="tag-item" href="/tags/开源框架/" title="开源框架">开源框架 (17)</a>
  
    <a class="tag-item" href="/tags/安卓源码/" title="安卓源码">安卓源码 (15)</a>
  
    <a class="tag-item" href="/tags/coroutine协程/" title="coroutine协程">coroutine协程 (1)</a>
  
    <a class="tag-item" href="/tags/地图/" title="地图">地图 (2)</a>
  
    <a class="tag-item" href="/tags/面试/" title="面试">面试 (2)</a>
  
    <a class="tag-item" href="/tags/IIS/" title="IIS">IIS (2)</a>
  
    <a class="tag-item" href="/tags/Androidx/" title="Androidx">Androidx (1)</a>
  
    <a class="tag-item" href="/tags/Lifecycles/" title="Lifecycles">Lifecycles (1)</a>
  
    <a class="tag-item" href="/tags/LiveData/" title="LiveData">LiveData (1)</a>
  
    <a class="tag-item" href="/tags/Paging/" title="Paging">Paging (1)</a>
  
    <a class="tag-item" href="/tags/Room/" title="Room">Room (1)</a>
  
    <a class="tag-item" href="/tags/ViewModel/" title="ViewModel">ViewModel (1)</a>
  
    <a class="tag-item" href="/tags/hexo/" title="hexo">hexo (4)</a>
  
    <a class="tag-item" href="/tags/ViewPager/" title="ViewPager">ViewPager (1)</a>
  
    <a class="tag-item" href="/tags/XMLHttpRequest/" title="XMLHttpRequest">XMLHttpRequest (1)</a>
  
    <a class="tag-item" href="/tags/SqlServer/" title="SqlServer">SqlServer (1)</a>
  
    <a class="tag-item" href="/tags/kotlin/" title="kotlin">kotlin (2)</a>
  
    <a class="tag-item" href="/tags/增量更新/" title="增量更新">增量更新 (1)</a>
  
    <a class="tag-item" href="/tags/fiddler/" title="fiddler">fiddler (1)</a>
  
    <a class="tag-item" href="/tags/副业/" title="副业">副业 (1)</a>
  
    <a class="tag-item" href="/tags/Activity/" title="Activity">Activity (1)</a>
  
    <a class="tag-item" href="/tags/BroadcastReceiver/" title="BroadcastReceiver">BroadcastReceiver (1)</a>
  
    <a class="tag-item" href="/tags/心情/" title="心情">心情 (1)</a>
  
    <a class="tag-item" href="/tags/电影/" title="电影">电影 (4)</a>
  
    <a class="tag-item" href="/tags/职业生涯/" title="职业生涯">职业生涯 (1)</a>
  
    <a class="tag-item" href="/tags/网盘资源/" title="网盘资源">网盘资源 (1)</a>
  
    <a class="tag-item" href="/tags/职业发展/" title="职业发展">职业发展 (1)</a>
  
    <a class="tag-item" href="/tags/跳槽/" title="跳槽">跳槽 (2)</a>
  
    <a class="tag-item" href="/tags/购房/" title="购房">购房 (1)</a>
  
    <a class="tag-item" href="/tags/习惯/" title="习惯">习惯 (1)</a>
  
    <a class="tag-item" href="/tags/图片保存/" title="图片保存">图片保存 (1)</a>
  
    <a class="tag-item" href="/tags/c/" title="c#">c# (1)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" target="_blank" title="稀土掘金">稀土掘金</a>
        </li>
    
        <li>
            <a href="https://www.cnblogs.com/bugzone" target="_blank" title="博客园">博客园</a>
        </li>
    
        <li>
            <a href="https://weibo.com/230689567" target="_blank" title="新浪微博">新浪微博</a>
        </li>
    
        <li>
            <a href="https://www.jianshu.com/u/ba21180e6aab" target="_blank" title="简书">简书</a>
        </li>
    
        <li>
            <a href="https://github.com/freefuncode/" target="_blank" title="GitHub">GitHub</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    ©
    
        2012-2019
    

    <a href="/">FreeFunCode</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->


<script type="text/javascript" src="/bundle.js"></script><script type="text/javascript">JELON.Comment({
    container: 'comments',
    label: 'Android源码分析七Launcher桌面程序启动分析' || '2018/07/07/Android源码分析七Launcher桌面程序启动分析/',
    owner: 'FreeFunCode',
    repo: 'FreeFunCode.github.io',
    clientId: 'f59edbb15c434fe50f63',
    clientSecret: '5ad8f05641605b384357bd325058c4cddd58b93b'
  });</script><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>