<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  
  <title>Android 源码分析（六） SystemServer 进程 - 网记本</title>
  <meta charset="UTF-8">
  <meta name="description" content>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/img/favicon.png" type="image/png">
  <meta name="description" content="点击查看原文      &amp;nbsp;&amp;nbsp;&amp;nbsp; 一.前言: &amp;nbsp;&amp;nbsp;&amp;nbsp; init进程 –&amp;gt; Zygote进程 –&amp;gt; SystemServer进程 –&amp;gt; Launcher桌面程序 -&amp;gt; 我们的App应用&amp;nbsp;&amp;nbsp;&amp;nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个an">
<meta name="keywords" content="安卓源码">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 源码分析（六） SystemServer 进程">
<meta property="og:url" content="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/index.html">
<meta property="og:site_name" content="网记本">
<meta property="og:description" content="点击查看原文      &amp;nbsp;&amp;nbsp;&amp;nbsp; 一.前言: &amp;nbsp;&amp;nbsp;&amp;nbsp; init进程 –&amp;gt; Zygote进程 –&amp;gt; SystemServer进程 –&amp;gt; Launcher桌面程序 -&amp;gt; 我们的App应用&amp;nbsp;&amp;nbsp;&amp;nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个an">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:updated_time" content="2019-09-06T13:20:05.811Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 源码分析（六） SystemServer 进程">
<meta name="twitter:description" content="点击查看原文      &amp;nbsp;&amp;nbsp;&amp;nbsp; 一.前言: &amp;nbsp;&amp;nbsp;&amp;nbsp; init进程 –&amp;gt; Zygote进程 –&amp;gt; SystemServer进程 –&amp;gt; Launcher桌面程序 -&amp;gt; 我们的App应用&amp;nbsp;&amp;nbsp;&amp;nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个an">
<meta name="twitter:image" content="https://common.cnblogs.com/images/copycode.gif">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css">
   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="/css/style.css?v=1571545564589">
</head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(https://i.loli.net/2019/01/13/5c3aec85a4343.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="网记本" class="mdui-btn mdui-btn-icon"><img src="/img/avatar.jpg"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="网记本">
            <img src="/img/avatar.jpg" alt="网记本">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>94</div>
        <div><span>标签</span>51</div>
        <div><span>分类</span>13</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的收藏">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的收藏
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">社交按钮</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://weibo.com/230689567" target="_blank" mdui-tooltip="{content: '微博'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-weibo"></i>
        </a><a class="mdui-ripple" href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" target="_blank" mdui-tooltip="{content: '掘金'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-appstore-fill"></i>
        </a><a class="mdui-ripple" href="https://www.cnblogs.com/bugzone/" target="_blank" mdui-tooltip="{content: '博客园'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-dribbble"></i>
        </a><a class="mdui-ripple" href="https://www.jianshu.com/u/ba21180e6aab" target="_blank" mdui-tooltip="{content: '简书'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-container"></i>
        </a><a class="mdui-ripple" href="https://github.com/freefuncode/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://www.zhihu.com/people/yimei-cheng-xu-yuan-28/activities" target="_blank" mdui-tooltip="{content: '知乎'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-zhihu"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/">Android</a>
          <span class="category-list-count">52</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/CSharp/">CSharp</a>
          <span class="category-list-count">14</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/GitHub/">GitHub</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/JAVA/">JAVA</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/PHP/">PHP</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/kotlin/">kotlin</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/前端/">前端</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/">后端</a>
          <span class="category-list-count">21</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/安卓源码/">安卓源码</a>
          <span class="category-list-count">15</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/开源框架/">开源框架</a>
          <span class="category-list-count">17</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/心情/">心情</a>
          <span class="category-list-count">10</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/知识点/">知识点</a>
          <span class="category-list-count">18</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/设计模式/">设计模式</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">标签云</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Activity/" style="font-size: 10px;">Activity</a> <a href="/tags/Android/" style="font-size: 12.5px;">Android</a> <a href="/tags/Android7-0/" style="font-size: 10px;">Android7.0</a> <a href="/tags/BroadcastReceiver/" style="font-size: 10px;">BroadcastReceiver</a> <a href="/tags/C-文件上传/" style="font-size: 10px;">C#文件上传</a> <a href="/tags/ContentProvider/" style="font-size: 10px;">ContentProvider</a> <a href="/tags/Excel操作/" style="font-size: 10px;">Excel操作</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/IIS/" style="font-size: 12.5px;">IIS</a> <a href="/tags/LNMP/" style="font-size: 10px;">LNMP</a> <a href="/tags/Linq/" style="font-size: 10px;">Linq</a> <a href="/tags/MAMP/" style="font-size: 10px;">MAMP</a> <a href="/tags/Service/" style="font-size: 10px;">Service</a> <a href="/tags/SqlServer/" style="font-size: 10px;">SqlServer</a> <a href="/tags/ViewPager/" style="font-size: 10px;">ViewPager</a> <a href="/tags/XMLHttpRequest/" style="font-size: 10px;">XMLHttpRequest</a> <a href="/tags/c/" style="font-size: 10px;">c#</a> <a href="/tags/coroutine协程/" style="font-size: 10px;">coroutine协程</a> <a href="/tags/easyui/" style="font-size: 12.5px;">easyui</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/kotlin/" style="font-size: 10px;">kotlin</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mono-for-Android/" style="font-size: 10px;">mono_for_Android</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/view绘制/" style="font-size: 10px;">view绘制</a> <a href="/tags/visualStudio/" style="font-size: 12.5px;">visualStudio</a> <a href="/tags/习惯/" style="font-size: 10px;">习惯</a> <a href="/tags/京东云擎/" style="font-size: 10px;">京东云擎</a> <a href="/tags/公众号/" style="font-size: 10px;">公众号</a> <a href="/tags/副业/" style="font-size: 10px;">副业</a> <a href="/tags/图片保存/" style="font-size: 10px;">图片保存</a> <a href="/tags/地图/" style="font-size: 12.5px;">地图</a> <a href="/tags/增量更新/" style="font-size: 10px;">增量更新</a> <a href="/tags/安卓源码/" style="font-size: 17.5px;">安卓源码</a> <a href="/tags/屏幕适配/" style="font-size: 10px;">屏幕适配</a> <a href="/tags/序列化/" style="font-size: 10px;">序列化</a> <a href="/tags/开源框架/" style="font-size: 20px;">开源框架</a> <a href="/tags/新浪SAE/" style="font-size: 10px;">新浪SAE</a> <a href="/tags/日期格式化/" style="font-size: 10px;">日期格式化</a> <a href="/tags/正则表达式/" style="font-size: 10px;">正则表达式</a> <a href="/tags/电影/" style="font-size: 15px;">电影</a> <a href="/tags/线程切换/" style="font-size: 10px;">线程切换</a> <a href="/tags/职业发展/" style="font-size: 10px;">职业发展</a> <a href="/tags/职业生涯/" style="font-size: 10px;">职业生涯</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/评论插件/" style="font-size: 10px;">评论插件</a> <a href="/tags/跳槽/" style="font-size: 12.5px;">跳槽</a> <a href="/tags/面试/" style="font-size: 12.5px;">面试</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2019 网记本
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    <div class="nexmoe-post-cover"> 
        
            <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg">
        
        <h1>Android 源码分析（六） SystemServer 进程</h1>
    </div>
  <div class="nexmoe-post-meta">
    <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月07日</a>
    <a><i class="nexmoefont icon-areachart"></i>7.8k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 47 分钟</a>
    
      <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
    
    
      <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
    
  </div>
  <article>
    <p><a href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>&nbsp;&nbsp;&nbsp; 一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; <strong>SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；</strong><br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.<br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. SystemService进程</h2>
<p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; ZygoteInit类的main方法调用了StartSystemService() 启动SystemService.<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SystemServer进程主要的作用是启动各种系统服务，比如ActivityManagerService，PackageManagerService，WindowManagerService等服务.</p>
<p>&nbsp;</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteInit.java</span>
     <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Prepare the arguments and fork for the system server process.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> startSystemServer(String abiList, String socketName, ZygoteServer zygoteServer)
            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller, RuntimeException {
        </span><span style="color: #0000ff;">long</span> capabilities =<span style="color: #000000;"> posixCapabilitiesAsBits(
            OsConstants.CAP_IPC_LOCK,
            OsConstants.CAP_KILL,
            OsConstants.CAP_NET_ADMIN,
            OsConstants.CAP_NET_BIND_SERVICE,
            OsConstants.CAP_NET_BROADCAST,
            OsConstants.CAP_NET_RAW,
            OsConstants.CAP_SYS_MODULE,
            OsConstants.CAP_SYS_NICE,
            OsConstants.CAP_SYS_PTRACE,
            OsConstants.CAP_SYS_TIME,
            OsConstants.CAP_SYS_TTY_CONFIG,
            OsConstants.CAP_WAKE_ALARM
        );
        </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Containers run without this capability, so avoid setting it in that case </span><span style="color: #008000;">*/</span>
        <span style="color: #0000ff;">if</span> (!SystemProperties.getBoolean(PROPERTY_RUNNING_IN_CONTAINER, <span style="color: #0000ff;">false</span><span style="color: #000000;">)) {
            capabilities </span>|=<span style="color: #000000;"> posixCapabilitiesAsBits(OsConstants.CAP_BLOCK_SUSPEND);
        }
        </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Hardcoded command line to start the system server </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        String args[] </span>=<span style="color: #000000;"> {
            </span>"--setuid=1000"<span style="color: #000000;">,
            </span>"--setgid=1000"<span style="color: #000000;">,
            </span>"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1032,3001,3002,3003,3006,3007,3009,3010"<span style="color: #000000;">,
            </span>"--capabilities=" + capabilities + "," +<span style="color: #000000;"> capabilities,
            </span>"--nice-name=system_server"<span style="color: #000000;">,
            </span>"--runtime-args"<span style="color: #000000;">,
            </span>"com.android.server.SystemServer"<span style="color: #000000;">,
        };
        ZygoteConnection.Arguments parsedArgs </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; pid;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        parsedArgs &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ZygoteConnection.Arguments(args);
        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);
        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Request to fork the system server process &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
        pid &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; Zygote.forkSystemServer(
                parsedArgs.uid, parsedArgs.gid,
                parsedArgs.gids,
                parsedArgs.debugFlags,
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
                parsedArgs.permittedCapabilities,
                parsedArgs.effectiveCapabilities);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IllegalArgumentException ex) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RuntimeException(ex);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; For child process &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (pid == 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (hasSecondZygote(abiList)) {
            waitForSecondaryZygote(socketName);
        }

        zygoteServer.closeServerSocket();
        handleSystemServerProcess(parsedArgs);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp; 接上篇文章继续看看SystemServer在源码中做了什么.</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">SystemServer.java</span>

<pre><code>&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * The main entry point from zygote.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; main(String[] args) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemServer().run();
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; run() {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        traceBeginAndSlog(&lt;/span&gt;&quot;InitBeforeStartServices&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If a device&apos;s clock is before 1970 (before 0), a lot of
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; APIs crash dealing with negative numbers, notably
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; java.io.File#setLastModified, so instead we fake it and
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; hope that time from cell towers or NTP fixes it shortly.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (System.currentTimeMillis() &amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt; EARLIEST_SUPPORTED_TIME) {
            Slog.w(TAG, &lt;/span&gt;&quot;System clock is before 1970; setting to 1970.&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
            SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;
        &lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Default the timezone property to GMT if not set.
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//</code></pre><p>            String timezoneProperty =  SystemProperties.get(“persist.sys.timezone”<span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span> (timezoneProperty == <span style="color: #0000ff;">null</span> ||<span style="color: #000000;"> timezoneProperty.isEmpty()) {<br>                Slog.w(TAG, </span>“Timezone not set; setting to GMT.”<span style="color: #000000;">);<br>                SystemProperties.set(</span>“persist.sys.timezone”, “GMT”<span style="color: #000000;">);<br>            }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If the system has &quot;persist.sys.language&quot; and friends set, replace them with
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; &quot;persist.sys.locale&quot;. Note that the default locale at this point is calculated
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; using the &quot;-Duser.locale&quot; command line flag. That flag is usually populated by
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; AndroidRuntime using the same set of system properties, but only the system_server
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; and system apps are allowed to set them.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; NOTE: Most changes made here will need an equivalent change to
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; core/jni/AndroidRuntime.cpp&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemProperties.get(&quot;persist.sys.language&quot;&lt;span style=&quot;color: #000000;&quot;&gt;).isEmpty()) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String languageTag =&lt;span style=&quot;color: #000000;&quot;&gt; Locale.getDefault().toLanguageTag();

    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.locale&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, languageTag);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.language&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.country&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.localevar&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The system server should never make non-oneway calls&lt;/span&gt;
Binder.setWarnOnBlocking(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Here we go!&lt;/span&gt;
Slog.i(TAG, &quot;Entered the Android system server!&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; uptimeMillis = (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime();
EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, uptimeMillis);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mRuntimeRestart) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_system_server_init&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, uptimeMillis);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In case the runtime switched since last boot (such as when
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the old runtime was removed in an OTA), set the system
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; property so that it is in sync. We can | xq oqi&apos;t do this in
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; libnativehelper&apos;s JniInvocation::Init code where we already
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; had to fallback to a different runtime because it is
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; running as root and we need to be the system user to set
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the property. &lt;/span&gt;&lt;span style=&quot;color: #008000; text-decoration: underline;&quot;&gt;http://b/11463182&lt;/span&gt;
SystemProperties.set(&quot;persist.sys.dalvik.vm.lib.2&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, VMRuntime.getRuntime().vmLibrary());

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Enable the sampling profiler.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (SamplingProfilerIntegration.isEnabled()) {
    SamplingProfilerIntegration.start();
    mProfilerSnapshotTimer &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Timer();
    mProfilerSnapshotTimer.schedule(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; TimerTask() {
            @Override
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; run() {
                SamplingProfilerIntegration.writeSnapshot(&lt;/span&gt;&quot;system_server&quot;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            }
        }, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Mmmmmm... more memory!&lt;/span&gt;</code></pre><p><span style="color: #000000;">            VMRuntime.getRuntime().clearGrowthLimit();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The system server has to run all of the time, so it needs to be
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; as efficient as possible with its memory usage.&lt;/span&gt;
VMRuntime.getRuntime().setTargetHeapUtilization(0.8f&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Some devices rely on runtime fingerprint generation, so make sure
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we&apos;ve defined it before booting further.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            Build.ensureFingerprintProperty();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Within the system server, it is an error to access Environment paths without
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; explicitly specifying a user.&lt;/span&gt;
Environment.setUserRequired(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Within the system server, any incoming Bundles should be defused
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to avoid throwing BadParcelableException.&lt;/span&gt;
BaseBundle.setShouldDefuse(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Ensure binder calls into the system always run at foreground priority.&lt;/span&gt;
BinderInternal.disableBackgroundScheduling(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Increase the number of binder threads in system_server&lt;/span&gt;</code></pre><p><span style="color: #000000;">            BinderInternal.setMaxThreads(sMaxBinderThreads);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Prepare the main looper thread (this thread).&lt;/span&gt;</code></pre><p><span style="color: #000000;">            android.os.Process.setThreadPriority(<br>                android.os.Process.THREAD_PRIORITY_FOREGROUND);<br>            android.os.Process.setCanSelfBackground(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);<br>            Looper.prepareMainLooper();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize native services.&lt;/span&gt;
System.loadLibrary(&quot;android_servers&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Check whether we failed to shut down last time we tried.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; This call may not return.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            performPendingShutdown();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize the system context.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            createSystemContext();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Create the system service manager.&lt;/span&gt;
mSystemServiceManager = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemServiceManager(mSystemContext);
mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);
LocalServices.addService(SystemServiceManager.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, mSystemServiceManager);
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Prepare the thread pool for init tasks that can be parallelized&lt;/span&gt;</code></pre><p><span style="color: #000000;">            SystemServerInitThreadPool.get();<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            traceEnd();  </span><span style="color: #008000;">//</span><span style="color: #008000;"> InitBeforeStartServices</span><br><span style="color: #000000;">        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start services. 启动各种需要的服务&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    traceBeginAndSlog(&lt;/span&gt;&quot;StartServices&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;启动系统Boot级服务 &lt;/span&gt;</code></pre><p><span style="color: #000000;">            startBootstrapServices();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">启动系统核心的服务 </span><br><span style="color: #000000;">            startCoreServices();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">启动非核心的服务 </span><br><span style="color: #000000;">            startOtherServices();<br>            SystemServerInitThreadPool.shutdown();<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable ex) {<br>            Slog.e(</span>“System”, “<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>“<span style="color: #000000;">);<br>            Slog.e(</span>“System”, “<strong><strong>****</strong></strong> Failure starting system services”<span style="color: #000000;">, ex);<br>            </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> ex;<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            traceEnd();<br>        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; For debug builds, log event loop stalls to dropbox for analysis.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (StrictMode.conditionallyEnableDebugLogging()) {
    Slog.i(TAG, &lt;/span&gt;&quot;Enabled StrictMode for system server main thread.&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
}
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!mRuntimeRestart &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;isFirstBootOrUpgrade()) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; uptimeMillis = (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime();
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_system_server_ready&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, uptimeMillis);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; MAX_UPTIME_MILLIS = 60 * 1000&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (uptimeMillis &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; MAX_UPTIME_MILLIS) {
        Slog.wtf(SYSTEM_SERVER_TIMING_TAG,
                &lt;/span&gt;&quot;SystemServer init took too long. uptimeMillis=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; uptimeMillis);
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Loop forever.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Looper.loop();<br>        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> RuntimeException(“Main thread loop unexpectedly exited”<span style="color: #000000;">);<br>    }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts the small tangle of critical services that are needed to get
 * the system off the ground.  These services have complex mutual dependencies
 * which is why we initialize them all in one place here.  Unless your service
 * is also entwined in these dependencies, it should be initialized in one of
 * the other functions.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startBootstrapServices() {
    Slog.i(TAG, &lt;/span&gt;&quot;Reading configuration...&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String TAG_SYSTEM_CONFIG = &quot;ReadingSystemConfig&quot;&lt;span style=&quot;color: #000000;&quot;&gt;;
    traceBeginAndSlog(TAG_SYSTEM_CONFIG);
    SystemServerInitThreadPool.get().submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Wait for installd to finish starting up so that it has a chance to
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; create critical directories such as /data/user with the appropriate
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; permissions.  We need this to complete before we initialize other services.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartInstaller&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    Installer installer &lt;/span&gt;= mSystemServiceManager.startService(Installer.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In some cases after launching an app we need to access device identifiers,
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; therefore register the device identifier policy before the activity manager.&lt;/span&gt;
    traceBeginAndSlog(&quot;DeviceIdentifiersPolicyService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(DeviceIdentifiersPolicyService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Activity manager runs the show.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartActivityManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSystemServiceManager.startService(
            ActivityManagerService.Lifecycle.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;).getService();
    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);
    mActivityManagerService.setInstaller(installer);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Power manager needs to be started early because other services need it.
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Native daemons may be watching for it to be registered so it must be ready
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to handle incoming binder calls immediately (including being able to verify
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the permissions for those calls).&lt;/span&gt;
    traceBeginAndSlog(&quot;StartPowerManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mPowerManagerService &lt;/span&gt;= mSystemServiceManager.startService(PowerManagerService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Now that the power manager has been started, let the activity manager
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; initialize power management features.&lt;/span&gt;
    traceBeginAndSlog(&quot;InitPowerManagement&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService.initPowerManagement();
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Bring up recovery system in case a rescue party needs a reboot&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemProperties.getBoolean(&quot;config.disable_noncore&quot;, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
        traceBeginAndSlog(&lt;/span&gt;&quot;StartRecoverySystemService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        mSystemServiceManager.startService(RecoverySystemService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        traceEnd();
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Now that we have the bare essentials of the OS up and running, take
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; note that we just booted, which might send out a rescue party if
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we&apos;re stuck in a runtime restart loop.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        RescueParty.noteBoot(mSystemContext);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages LEDs and display backlight so we need it to bring up the display.&lt;/span&gt;
traceBeginAndSlog(&quot;StartLightsService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startService(LightsService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Display manager is needed to provide display metrics before package manager
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; starts up.&lt;/span&gt;
traceBeginAndSlog(&quot;StartDisplayManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mDisplayManagerService &lt;/span&gt;= mSystemServiceManager.startService(DisplayManagerService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We need the default display before we can initialize the package manager.&lt;/span&gt;
traceBeginAndSlog(&quot;WaitForDisplay&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Only run &quot;core&quot; apps if we&apos;re encrypting the device.&lt;/span&gt;
String cryptState = SystemProperties.get(&quot;vold.decrypt&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ENCRYPTING_STATE.equals(cryptState)) {
    Slog.w(TAG, &lt;/span&gt;&quot;Detected encryption in progress - only parsing core apps&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mOnlyCore &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ENCRYPTED_STATE.equals(cryptState)) {
    Slog.w(TAG, &lt;/span&gt;&quot;Device encrypted - only parsing core apps&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mOnlyCore &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start the package manager.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mRuntimeRestart) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_package_manager_init_start&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            (&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime());
}
traceBeginAndSlog(&lt;/span&gt;&quot;StartPackageManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mPackageManagerService &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; PackageManagerService.main(mSystemContext, installer,
        mFactoryTestMode &lt;/span&gt;!=&lt;span style=&quot;color: #000000;&quot;&gt; FactoryTest.FACTORY_TEST_OFF, mOnlyCore);
mFirstBoot &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mPackageManagerService.isFirstBoot();
mPackageManager &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSystemContext.getPackageManager();
traceEnd();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!mRuntimeRestart &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;isFirstBootOrUpgrade()) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_package_manager_init_ready&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            (&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime());
}
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages A/B OTA dexopting. This is a bootstrap service as we need it to rename
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; A/B artifacts after boot, before anything else might touch/need them.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Note: this isn&apos;t needed during decryption (we don&apos;t have /data anyways).&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mOnlyCore) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; disableOtaDexopt = SystemProperties.getBoolean(&quot;config.disable_otadexopt&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;disableOtaDexopt) {
        traceBeginAndSlog(&lt;/span&gt;&quot;StartOtaDexOptService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            OtaDexoptService.main(mSystemContext, mPackageManagerService);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Throwable e) {
            reportWtf(&lt;/span&gt;&quot;starting OtaDexOptService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, e);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;finally&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            traceEnd();
        }
    }
}

traceBeginAndSlog(&lt;/span&gt;&quot;StartUserManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startService(UserManagerService.LifeCycle.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize attribute cache used to cache resources from packages.&lt;/span&gt;
traceBeginAndSlog(&quot;InitAttributerCache&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
AttributeCache.init(mSystemContext);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Set up the Application instance for the system process and get started.&lt;/span&gt;
traceBeginAndSlog(&quot;SetSystemProcess&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mActivityManagerService.setSystemProcess();
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; DisplayManagerService needs to setup android.display scheduling related policies
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; since setSystemProcess() would have overridden policies due to setProcessGroup&lt;/span&gt;</code></pre><p><span style="color: #000000;">        mDisplayManagerService.setupSchedulerPolicies();</span></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages Overlay packages&lt;/span&gt;
    traceBeginAndSlog(&quot;StartOverlayManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; OverlayManagerService(mSystemContext, installer));
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The sensor service needs access to package manager service, app ops
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; service, and permissions service, therefore we start it after them.
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start sensor service in a separate thread. Completion should be checked
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; before using it.&lt;/span&gt;
    mSensorServiceStart = SystemServerInitThreadPool.get().submit(() -&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        BootTimingsTraceLog traceLog &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; BootTimingsTraceLog(
                SYSTEM_SERVER_TIMING_ASYNC_TAG, Trace.TRACE_TAG_SYSTEM_SERVER);
        traceLog.traceBegin(START_SENSOR_SERVICE);
        startSensorService();
        traceLog.traceEnd();
    }, START_SENSOR_SERVICE);
}


&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts some essential services that are not tangled up in the bootstrap process.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startCoreServices() {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Records errors and logs, for example wtf()&lt;/span&gt;
    traceBeginAndSlog(&quot;StartDropBoxManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(DropBoxManagerService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    traceBeginAndSlog(&lt;/span&gt;&quot;StartBatteryService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks the battery level.  Requires LightService.&lt;/span&gt;
    mSystemServiceManager.startService(BatteryService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks application usage stats.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartUsageService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(UsageStatsService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService.setUsageStatsManager(
            LocalServices.getService(UsageStatsManagerInternal.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks whether the updatable WebView is in a ready state and watches for update installs.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartWebViewUpdateService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mWebViewUpdateService &lt;/span&gt;= mSystemServiceManager.startService(WebViewUpdateService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();
}
&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;"> mSystemServiceManager是系统服务管理对象.在run()方法已经创建 mSystemServiceManager = new SystemServiceManager(mSystemContext);
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 进入mSystemServiceManager.startService() 分析下. 进入具体实现的方法

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;SystemServiceManager.java&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Creates and starts a system service. The class must be a subclass of
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; com.android.server.SystemService}.
 *
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; serviceClass A Java class that implements the SystemService interface.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The service instance, never null.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@throws&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; RuntimeException if the service fails to start.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
@SuppressWarnings(&lt;/span&gt;&quot;unchecked&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &amp;lt;T &lt;span style=&quot;color: #0000ff;&quot;&gt;extends&lt;/span&gt; SystemService&amp;gt; T startService(Class&amp;lt;T&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String name =&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass.getName();
        Slog.i(TAG, &lt;/span&gt;&quot;Starting &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name);
        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, &lt;/span&gt;&quot;StartService &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name);

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Create the service.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.isAssignableFrom(serviceClass)) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must extend &quot; + SystemService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.getName());
        }
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; T service;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            Constructor&lt;/span&gt;&amp;lt;T&amp;gt; constructor = serviceClass.getConstructor(Context.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            service &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; constructor.newInstance(mContext);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (InstantiationException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service could not be instantiated&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IllegalAccessException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must have a public constructor with a Context argument&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (NoSuchMethodException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must have a public constructor with a Context argument&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (InvocationTargetException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service constructor threw an exception&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        }

        startService(service);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; service;
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;finally&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);
    }
}

  &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts a service by class name.
 *
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The service instance.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
@SuppressWarnings(&lt;/span&gt;&quot;unchecked&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemService startService(String className) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; Class&amp;lt;SystemService&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        serviceClass &lt;/span&gt;= (Class&amp;lt;SystemService&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;)Class.forName(className);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ClassNotFoundException ex) {
        Slog.i(TAG, &lt;/span&gt;&quot;Starting &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; className);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; className
                &lt;/span&gt;+ &quot;: service class not found, usually indicates that the caller should &quot;
                + &quot;have called PackageManager.hasSystemFeature() to check whether the &quot;
                + &quot;feature is available on this device before trying to start the &quot;
                + &quot;services that implement it&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startService(serviceClass);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;通过反射器构造方法创建出服务类,然后返回SystemService.启动对应的服务.&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
  </article>
  
    
<div class="nexmoe-post-copyright">
<i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
<strong>本文作者：</strong>网记本<br>
<strong>本文链接：</strong><a href="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/" title="https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/" target="_blank" rel="noopener">https://freefuncode.github.io/2018/07/07/Android源码分析六SystemServer进程/</a><br>

  <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

</div>


  
  <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'f59edbb15c434fe50f63',
        clientSecret: '5ad8f05641605b384357bd325058c4cddd58b93b',
        id: window.location.pathname,
        repo: 'FreeFunCode.github.io',
        owner: 'FreeFunCode',
        admin: 'FreeFunCode'
    })
    gitalk.render('gitalk')
</script>
</section>
</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
 
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


 
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/app.js?v=1571545564604"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>


    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>



  





    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?3771b2566860fea0de20c35742671f53#&lt;ID&gt;';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

</body>

</html>
