<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  
  <title>Android源码分析（十二）ServiceManager服务分析 - 网记本</title>
  <meta charset="UTF-8">
  <meta name="description" content>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/img/favicon.png" type="image/png">
  <meta name="description" content="点击查看原文      一.启动过程分析 基于 binder 机制实现通信，添加服务，查询服务，获取服务。查询，获取服务时候需要检查权限，android是基于Linux底层，所以也很好的实现了linux多用户管理。   frameworks\native\cmds\servicemanager\servicemanager.rc service servicemanager /system/bin">
<meta name="keywords" content="安卓源码">
<meta property="og:type" content="article">
<meta property="og:title" content="Android源码分析（十二）ServiceManager服务分析">
<meta property="og:url" content="https://freefuncode.github.io/2018/07/22/Android源码分析十二ServiceManager服务分析/index.html">
<meta property="og:site_name" content="网记本">
<meta property="og:description" content="点击查看原文      一.启动过程分析 基于 binder 机制实现通信，添加服务，查询服务，获取服务。查询，获取服务时候需要检查权限，android是基于Linux底层，所以也很好的实现了linux多用户管理。   frameworks\native\cmds\servicemanager\servicemanager.rc service servicemanager /system/bin">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://common.cnblogs.com/images/copycode.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif">
<meta property="og:image" content="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722114236180-75099312.png">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722114323395-1692794298.png">
<meta property="og:updated_time" content="2019-09-06T13:20:05.811Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android源码分析（十二）ServiceManager服务分析">
<meta name="twitter:description" content="点击查看原文      一.启动过程分析 基于 binder 机制实现通信，添加服务，查询服务，获取服务。查询，获取服务时候需要检查权限，android是基于Linux底层，所以也很好的实现了linux多用户管理。   frameworks\native\cmds\servicemanager\servicemanager.rc service servicemanager /system/bin">
<meta name="twitter:image" content="https://common.cnblogs.com/images/copycode.gif">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css">
   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="/css/style.css?v=1571545564207">
</head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(https://i.loli.net/2019/01/13/5c3aec85a4343.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="网记本" class="mdui-btn mdui-btn-icon"><img src="/img/avatar.jpg"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="网记本">
            <img src="/img/avatar.jpg" alt="网记本">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>94</div>
        <div><span>标签</span>51</div>
        <div><span>分类</span>13</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的收藏">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的收藏
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">社交按钮</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://weibo.com/230689567" target="_blank" mdui-tooltip="{content: '微博'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-weibo"></i>
        </a><a class="mdui-ripple" href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" target="_blank" mdui-tooltip="{content: '掘金'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-appstore-fill"></i>
        </a><a class="mdui-ripple" href="https://www.cnblogs.com/bugzone/" target="_blank" mdui-tooltip="{content: '博客园'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-dribbble"></i>
        </a><a class="mdui-ripple" href="https://www.jianshu.com/u/ba21180e6aab" target="_blank" mdui-tooltip="{content: '简书'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-container"></i>
        </a><a class="mdui-ripple" href="https://github.com/freefuncode/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://www.zhihu.com/people/yimei-cheng-xu-yuan-28/activities" target="_blank" mdui-tooltip="{content: '知乎'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-zhihu"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/">Android</a>
          <span class="category-list-count">52</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/CSharp/">CSharp</a>
          <span class="category-list-count">14</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/GitHub/">GitHub</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/JAVA/">JAVA</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/PHP/">PHP</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/kotlin/">kotlin</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/前端/">前端</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/">后端</a>
          <span class="category-list-count">21</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/安卓源码/">安卓源码</a>
          <span class="category-list-count">15</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/开源框架/">开源框架</a>
          <span class="category-list-count">17</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/心情/">心情</a>
          <span class="category-list-count">10</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/知识点/">知识点</a>
          <span class="category-list-count">18</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/设计模式/">设计模式</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">标签云</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Activity/" style="font-size: 10px;">Activity</a> <a href="/tags/Android/" style="font-size: 12.5px;">Android</a> <a href="/tags/Android7-0/" style="font-size: 10px;">Android7.0</a> <a href="/tags/BroadcastReceiver/" style="font-size: 10px;">BroadcastReceiver</a> <a href="/tags/C-文件上传/" style="font-size: 10px;">C#文件上传</a> <a href="/tags/ContentProvider/" style="font-size: 10px;">ContentProvider</a> <a href="/tags/Excel操作/" style="font-size: 10px;">Excel操作</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/IIS/" style="font-size: 12.5px;">IIS</a> <a href="/tags/LNMP/" style="font-size: 10px;">LNMP</a> <a href="/tags/Linq/" style="font-size: 10px;">Linq</a> <a href="/tags/MAMP/" style="font-size: 10px;">MAMP</a> <a href="/tags/Service/" style="font-size: 10px;">Service</a> <a href="/tags/SqlServer/" style="font-size: 10px;">SqlServer</a> <a href="/tags/ViewPager/" style="font-size: 10px;">ViewPager</a> <a href="/tags/XMLHttpRequest/" style="font-size: 10px;">XMLHttpRequest</a> <a href="/tags/c/" style="font-size: 10px;">c#</a> <a href="/tags/coroutine协程/" style="font-size: 10px;">coroutine协程</a> <a href="/tags/easyui/" style="font-size: 12.5px;">easyui</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/kotlin/" style="font-size: 10px;">kotlin</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mono-for-Android/" style="font-size: 10px;">mono_for_Android</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/view绘制/" style="font-size: 10px;">view绘制</a> <a href="/tags/visualStudio/" style="font-size: 12.5px;">visualStudio</a> <a href="/tags/习惯/" style="font-size: 10px;">习惯</a> <a href="/tags/京东云擎/" style="font-size: 10px;">京东云擎</a> <a href="/tags/公众号/" style="font-size: 10px;">公众号</a> <a href="/tags/副业/" style="font-size: 10px;">副业</a> <a href="/tags/图片保存/" style="font-size: 10px;">图片保存</a> <a href="/tags/地图/" style="font-size: 12.5px;">地图</a> <a href="/tags/增量更新/" style="font-size: 10px;">增量更新</a> <a href="/tags/安卓源码/" style="font-size: 17.5px;">安卓源码</a> <a href="/tags/屏幕适配/" style="font-size: 10px;">屏幕适配</a> <a href="/tags/序列化/" style="font-size: 10px;">序列化</a> <a href="/tags/开源框架/" style="font-size: 20px;">开源框架</a> <a href="/tags/新浪SAE/" style="font-size: 10px;">新浪SAE</a> <a href="/tags/日期格式化/" style="font-size: 10px;">日期格式化</a> <a href="/tags/正则表达式/" style="font-size: 10px;">正则表达式</a> <a href="/tags/电影/" style="font-size: 15px;">电影</a> <a href="/tags/线程切换/" style="font-size: 10px;">线程切换</a> <a href="/tags/职业发展/" style="font-size: 10px;">职业发展</a> <a href="/tags/职业生涯/" style="font-size: 10px;">职业生涯</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/评论插件/" style="font-size: 10px;">评论插件</a> <a href="/tags/跳槽/" style="font-size: 12.5px;">跳槽</a> <a href="/tags/面试/" style="font-size: 12.5px;">面试</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2019 网记本
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    <div class="nexmoe-post-cover"> 
        
            <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg">
        
        <h1>Android源码分析（十二）ServiceManager服务分析</h1>
    </div>
  <div class="nexmoe-post-meta">
    <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月22日</a>
    <a><i class="nexmoefont icon-areachart"></i>6.2k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 38 分钟</a>
    
      <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
    
    
      <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
    
  </div>
  <article>
    <p><a href="https://www.cnblogs.com/bugzone/p/ServiceManager.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.启动过程分析</h2>
<div>基于 binder 机制实现通信，添加服务，查询服务，获取服务。查询，获取服务时候需要检查权限，android是基于Linux底层，所以也很好的实现了linux多用户管理。</div>
<div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">frameworks\native\cmds\servicemanager\servicemanager.rc
service servicemanager </span>/system/bin/<span style="color: #000000;">servicemanager
    </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> core animation
    user system
    group system readproc
    critical
    onrestart restart healthd
    onrestart restart zygote
    onrestart restart audioserver
    onrestart restart media
    onrestart restart surfaceflinger
    onrestart restart inputflinger
    onrestart restart drm
    onrestart restart cameraserver
    writepid </span>/dev/cpuset/system-background/tasks</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>从上面可知，如果ServiceManager服务异常退出的话，系统会重启。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">frameworks\native\cmds\servicemanager\service_manager.c
</span><span style="color: #0000ff;">int</span> main(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span>**<span style="color: #000000;"> argv)
{
    </span><span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs;
    union selinux_callback cb;
    </span><span style="color: #0000ff;">char</span> *<span style="color: #000000;">driver;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (argc &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    driver &lt;/span&gt;= argv[&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;];
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    driver &lt;/span&gt;= &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/binder&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

bs &lt;/span&gt;= binder_open(driver, &lt;span style=&quot;color: #800080;&quot;&gt;128&lt;/span&gt;*&lt;span style=&quot;color: #800080;&quot;&gt;1024&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;bs) {
#ifdef VENDORSERVICEMANAGER
    ALOGW(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;failed to open binder driver %s\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, driver);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        sleep(UINT_MAX);
    }
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;failed to open binder driver %s\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, driver);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#endif&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (binder_become_context_manager(bs)) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;cannot become context manager (%s)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, strerror(errno));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

cb.func_audit &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; audit_callback;
selinux_set_callback(SELINUX_CB_AUDIT, cb);
cb.func_log &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; selinux_log_callback;
selinux_set_callback(SELINUX_CB_LOG, cb);

#ifdef VENDORSERVICEMANAGER
sehandle &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; selinux_android_vendor_service_context_handle();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
sehandle &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; selinux_android_service_context_handle();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#endif&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
selinux_status_open(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (sehandle ==&lt;span style=&quot;color: #000000;&quot;&gt; NULL) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;SELinux: Failed to acquire sehandle. Aborting.\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    abort();
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (getcon(&amp;amp;service_manager_context) != &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;SELinux: Failed to acquire service_manager context. Aborting.\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    abort();
}


&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;loop 接受消息。并将binder解析完的消息返回给svcmgr_handler处理。&lt;/span&gt;</code></pre><p><span style="color: #000000;">    binder_loop(bs, svcmgr_handler);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>从这我们知道，ServiceManager是基于binder机制实现的。进入binder.c中了解下binder_open,binder_loop，然后binder将解析完的消息，返回给svcmag_handler处理</p>
<p>frameworks\native\cmds\servicemanager\binder.c</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c271bc75-156b-40e2-ae92-90551ddf233c')"><img id="code_img_closed_c271bc75-156b-40e2-ae92-90551ddf233c" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_c271bc75-156b-40e2-ae92-90551ddf233c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('c271bc75-156b-40e2-ae92-90551ddf233c',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_c271bc75-156b-40e2-ae92-90551ddf233c" class="cnblogs_code_hide">
<pre>    <span style="color: #0000ff;">struct</span> binder_state *binder_open(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> driver, size_t mapsize)
{
    </span><span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs;
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_version vers;

<pre><code>bs &lt;/span&gt;= malloc(&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;(*&lt;span style=&quot;color: #000000;&quot;&gt;bs));
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;bs) {
    errno &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; ENOMEM;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; NULL;
}

bs&lt;/span&gt;-&amp;gt;fd = open(driver, O_RDWR |&lt;span style=&quot;color: #000000;&quot;&gt; O_CLOEXEC);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (bs-&amp;gt;fd &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    fprintf(stderr,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder: cannot open %s (%s)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
            driver, strerror(errno));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; fail_open;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; ((ioctl(bs-&amp;gt;fd, BINDER_VERSION, &amp;amp;vers) == -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;) ||&lt;span style=&quot;color: #000000;&quot;&gt;
    (vers.protocol_version &lt;/span&gt;!=&lt;span style=&quot;color: #000000;&quot;&gt; BINDER_CURRENT_PROTOCOL_VERSION)) {
    fprintf(stderr,
            &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder: kernel driver version (%d) differs from user space version (%d)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
            vers.protocol_version, BINDER_CURRENT_PROTOCOL_VERSION);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; fail_open;
}

bs&lt;/span&gt;-&amp;gt;mapsize =&lt;span style=&quot;color: #000000;&quot;&gt; mapsize;
bs&lt;/span&gt;-&amp;gt;mapped = mmap(NULL, mapsize, PROT_READ, MAP_PRIVATE, bs-&amp;gt;fd, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (bs-&amp;gt;mapped ==&lt;span style=&quot;color: #000000;&quot;&gt; MAP_FAILED) {
    fprintf(stderr,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder: cannot map device (%s)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
            strerror(errno));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; fail_map;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; bs;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('5c06b747-4566-4459-8bff-9b4c249774c5')"><img id="code_img_closed_5c06b747-4566-4459-8bff-9b4c249774c5" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_5c06b747-4566-4459-8bff-9b4c249774c5" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('5c06b747-4566-4459-8bff-9b4c249774c5',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_5c06b747-4566-4459-8bff-9b4c249774c5" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">void</span> binder_loop(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs, binder_handler func)
{
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> res;
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_write_read bwr;
    uint32_t readbuf[</span><span style="color: #800080;">32</span><span style="color: #000000;">];

<pre><code>bwr.write_size &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
bwr.write_consumed &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
bwr.write_buffer &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

readbuf[&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;] =&lt;span style=&quot;color: #000000;&quot;&gt; BC_ENTER_LOOPER;
binder_write(bs, readbuf, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(uint32_t));

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (;;) {
    bwr.read_size &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(readbuf);
    bwr.read_consumed &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    bwr.read_buffer &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; (uintptr_t) readbuf;

    res &lt;/span&gt;= ioctl(bs-&amp;gt;fd, BINDER_WRITE_READ, &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;bwr);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (res &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder_loop: ioctl failed (%s)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, strerror(errno));
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;解析消息&lt;/span&gt;
    res = binder_parse(bs, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, (uintptr_t) readbuf, bwr.read_consumed, func);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (res == &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder_loop: unexpected reply?!\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (res &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder_loop: io error %d %s\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, res, strerror(errno));
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
}</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div>binder_parse 解析接受到的消息&nbsp;</div>
<div>binder_send_reply 接收到消息，并解析完消息后，binder将解析后的消息返回给ServiceManager</div>
<div>
<div class="cnblogs_code" onclick="cnblogs_code_show('4aebc7de-d31e-48f8-9dbc-8ae2582c5d95')"><img id="code_img_closed_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('4aebc7de-d31e-48f8-9dbc-8ae2582c5d95',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">void</span> binder_send_reply(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                       </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">reply,
                       binder_uintptr_t buffer_to_free,
                       </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> status)
{
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> {
        uint32_t cmd_free;
        binder_uintptr_t buffer;
        uint32_t cmd_reply;
        </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_transaction_data txn;
    } __attribute__((packed)) data;

<pre><code>data.cmd_free &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; BC_FREE_BUFFER;
data.buffer &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; buffer_to_free;
data.cmd_reply &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; BC_REPLY;
data.txn.target.ptr &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
data.txn.cookie &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
data.txn.code &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (status) {
    data.txn.flags &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; TF_STATUS_CODE;
    data.txn.data_size &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;(&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    data.txn.offsets_size &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    data.txn.data.ptr.buffer &lt;/span&gt;= (uintptr_t)&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;status;
    data.txn.data.ptr.offsets &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    data.txn.flags &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    data.txn.data_size &lt;/span&gt;= reply-&amp;gt;data - reply-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;data0;
    data.txn.offsets_size &lt;/span&gt;= ((&lt;span style=&quot;color: #0000ff;&quot;&gt;char&lt;/span&gt;*) reply-&amp;gt;offs) - ((&lt;span style=&quot;color: #0000ff;&quot;&gt;char&lt;/span&gt;*) reply-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;offs0);
    data.txn.data.ptr.buffer &lt;/span&gt;= (uintptr_t)reply-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;data0;
    data.txn.data.ptr.offsets &lt;/span&gt;= (uintptr_t)reply-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;offs0;
}
binder_write(bs, &lt;/span&gt;&amp;amp;data, &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(data));</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>继续回到serviceManager里分析binder解析返回回来的服务消息</p>
<p>frameworks\native\cmds\servicemanager\servicemanager.rc</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">int</span> svcmgr_handler(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                   </span><span style="color: #0000ff;">struct</span> binder_transaction_data *<span style="color: #000000;">txn,
                   </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">msg,
                   </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">reply)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *<span style="color: #000000;">si;
    uint16_t </span>*<span style="color: #000000;">s;
    size_t len;
    uint32_t handle;
    uint32_t strict_policy;
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> allow_isolated;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;ALOGI(&quot;target=%p code=%d pid=%d uid=%d\n&quot;,
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;      (void*) txn-&amp;gt;target.ptr, txn-&amp;gt;code, txn-&amp;gt;sender_pid, txn-&amp;gt;sender_euid);&lt;/span&gt;

&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (txn-&amp;gt;target.ptr !=&lt;span style=&quot;color: #000000;&quot;&gt; BINDER_SERVICE_MANAGER)
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (txn-&amp;gt;code ==&lt;span style=&quot;color: #000000;&quot;&gt; PING_TRANSACTION)
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Equivalent to Parcel::enforceInterface(), reading the RPC
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; header with the strict mode policy mask and the interface name.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Note that we ignore the strict_policy and don&apos;t propagate it
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; further (since we do no outbound RPCs anyway).&lt;/span&gt;
strict_policy =&lt;span style=&quot;color: #000000;&quot;&gt; bio_get_uint32(msg);
s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;len);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (s ==&lt;span style=&quot;color: #000000;&quot;&gt; NULL) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;检查是否是servicemanager服务&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; ((len != (&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;(svcmgr_id) / &lt;span style=&quot;color: #800080;&quot;&gt;2&lt;/span&gt;)) ||&lt;span style=&quot;color: #000000;&quot;&gt;
    memcmp(svcmgr_id, s, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(svcmgr_id))) {
    fprintf(stderr,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;invalid id %s\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, str8(s, len));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (sehandle &amp;amp;&amp;amp; selinux_status_updated() &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;struct&lt;/span&gt; selabel_handle *tmp_sehandle =&lt;span style=&quot;color: #000000;&quot;&gt; selinux_android_service_context_handle();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (tmp_sehandle) {
        selabel_close(sehandle);
        sehandle &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; tmp_sehandle;
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;switch&lt;/span&gt;(txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;code) {
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SVC_MGR_GET_SERVICE:
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;检查服务，do_find_service 查找服务。&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SVC_MGR_CHECK_SERVICE:
    s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;len);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (s ==&lt;span style=&quot;color: #000000;&quot;&gt; NULL) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    handle &lt;/span&gt;= do_find_service(s, len, txn-&amp;gt;sender_euid, txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_pid);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;handle)
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    bio_put_ref(reply, handle);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;添加服务 do_add_service 获取服务 在do_add_service会检查是否具有权限&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SVC_MGR_ADD_SERVICE:
    s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;len);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (s ==&lt;span style=&quot;color: #000000;&quot;&gt; NULL) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    handle &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; bio_get_ref(msg);
    allow_isolated &lt;/span&gt;= bio_get_uint32(msg) ? &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt; : &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (do_add_service(bs, s, len, handle, txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_euid,
        allow_isolated, txn&lt;/span&gt;-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_pid))
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;查询服务&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SVC_MGR_LIST_SERVICES: {
    uint32_t n &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; bio_get_uint32(msg);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!svc_can_list(txn-&amp;gt;sender_pid, txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_euid)) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;list_service() uid=%d - PERMISSION DENIED\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
                txn&lt;/span&gt;-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_euid);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    si &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; svclist;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; ((n-- &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;) &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; si)
        si &lt;/span&gt;= si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;next;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (si) {
        bio_put_string16(reply, si&lt;/span&gt;-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;name);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;default&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;unknown code %d\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;code);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

bio_put_uint32(reply, &lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>进入 do_find_service&nbsp; do_add_service了解下做了什么事。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('259cf340-561d-4ea7-9910-93cac3ea1148')"><img id="code_img_closed_259cf340-561d-4ea7-9910-93cac3ea1148" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_259cf340-561d-4ea7-9910-93cac3ea1148" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('259cf340-561d-4ea7-9910-93cac3ea1148',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_259cf340-561d-4ea7-9910-93cac3ea1148" class="cnblogs_code_hide">
<pre>uint32_t do_find_service(<span style="color: #0000ff;">const</span> uint16_t *<span style="color: #000000;">s, size_t len, uid_t uid, pid_t spid)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *si =<span style="color: #000000;"> find_svc(s, len);

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!si || !si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;handle) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;allow_isolated) {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If this service doesn&apos;t allow access from isolated processes,
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; then check the uid to see if it is isolated.&lt;/span&gt;
    uid_t appid = uid %&lt;span style=&quot;color: #000000;&quot;&gt; AID_USER;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (appid &amp;gt;= AID_ISOLATED_START &amp;amp;&amp;amp; appid &amp;lt;=&lt;span style=&quot;color: #000000;&quot;&gt; AID_ISOLATED_END) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;svc_can_find(s, len, spid, uid)) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;handle;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('786c6178-2ad5-466d-b516-d8e38fe7b404')"><img id="code_img_closed_786c6178-2ad5-466d-b516-d8e38fe7b404" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_786c6178-2ad5-466d-b516-d8e38fe7b404" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('786c6178-2ad5-466d-b516-d8e38fe7b404',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_786c6178-2ad5-466d-b516-d8e38fe7b404" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">int</span> do_add_service(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                   </span><span style="color: #0000ff;">const</span> uint16_t *<span style="color: #000000;">s, size_t len,
                   uint32_t handle, uid_t uid, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> allow_isolated,
                   pid_t spid)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *<span style="color: #000000;">si;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;ALOGI(&quot;add_service(&apos;%s&apos;,%x,%s) uid=%d\n&quot;, str8(s, len), handle,
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;        allow_isolated ? &quot;allow_isolated&quot; : &quot;!allow_isolated&quot;, uid);&lt;/span&gt;

&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!handle || (len == &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;) || (len &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;127&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;))
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;检查是否有权限&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;svc_can_register(s, len, spid, uid)) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;add_service(&apos;%s&apos;,%x) uid=%d - PERMISSION DENIED\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
         str8(s, len), handle, uid);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

si &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; find_svc(s, len);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (si) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;handle) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;add_service(&apos;%s&apos;,%x) uid=%d - ALREADY REGISTERED, OVERRIDE\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
             str8(s, len), handle, uid);
        svcinfo_death(bs, si);
    }
    si&lt;/span&gt;-&amp;gt;handle =&lt;span style=&quot;color: #000000;&quot;&gt; handle;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    si &lt;/span&gt;= malloc(&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;(*si) + (len + &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;) * &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(uint16_t));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;si) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;add_service(&apos;%s&apos;,%x) uid=%d - OUT OF MEMORY\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
             str8(s, len), handle, uid);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    si&lt;/span&gt;-&amp;gt;handle =&lt;span style=&quot;color: #000000;&quot;&gt; handle;
    si&lt;/span&gt;-&amp;gt;len =&lt;span style=&quot;color: #000000;&quot;&gt; len;
    memcpy(si&lt;/span&gt;-&amp;gt;name, s, (len + &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;) * &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(uint16_t));
    si&lt;/span&gt;-&amp;gt;name[len] = &lt;span style=&quot;color: #800000;&quot;&gt;&apos;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;\0&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&apos;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    si&lt;/span&gt;-&amp;gt;death.func = (&lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;*&lt;span style=&quot;color: #000000;&quot;&gt;) svcinfo_death;
    si&lt;/span&gt;-&amp;gt;death.ptr =&lt;span style=&quot;color: #000000;&quot;&gt; si;
    si&lt;/span&gt;-&amp;gt;allow_isolated =&lt;span style=&quot;color: #000000;&quot;&gt; allow_isolated;
    si&lt;/span&gt;-&amp;gt;next =&lt;span style=&quot;color: #000000;&quot;&gt; svclist;
    svclist &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; si;
}

binder_acquire(bs, handle);
binder_link_to_death(bs, handle, &lt;/span&gt;&amp;amp;si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;death);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<h2>二. ServiceManager如何管理服务</h2>
<p>&nbsp;从上面源码分析我们知道了ServiceManager利用binder通信机制来管理一系列服务。<br>&nbsp;上面源码的执行路径可以用下图所示：（注意，图中do_find_service7 应该是do_find_service.操作手误。）</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722114236180-75099312.png" alt></p>
<p>&nbsp;</p>
<p>　　代码分析抽象成逻辑分析，如下图所示：</p>
<p>　　　　　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722114323395-1692794298.png" alt></p>

</div>

</div>
</div>
  </article>
  
    
<div class="nexmoe-post-copyright">
<i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
<strong>本文作者：</strong>网记本<br>
<strong>本文链接：</strong><a href="https://freefuncode.github.io/2018/07/22/Android源码分析十二ServiceManager服务分析/" title="https://freefuncode.github.io/2018/07/22/Android源码分析十二ServiceManager服务分析/" target="_blank" rel="noopener">https://freefuncode.github.io/2018/07/22/Android源码分析十二ServiceManager服务分析/</a><br>

  <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

</div>


  
  <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'f59edbb15c434fe50f63',
        clientSecret: '5ad8f05641605b384357bd325058c4cddd58b93b',
        id: window.location.pathname,
        repo: 'FreeFunCode.github.io',
        owner: 'FreeFunCode',
        admin: 'FreeFunCode'
    })
    gitalk.render('gitalk')
</script>
</section>
</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
 
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


 
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/app.js?v=1571545564224"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>


    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>



  





    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?3771b2566860fea0de20c35742671f53#&lt;ID&gt;';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

</body>

</html>
