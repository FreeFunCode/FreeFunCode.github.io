<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  
  <title>分类：Android - 网记本</title>
  <meta charset="UTF-8">
  <meta name="description" content>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/img/favicon.png" type="image/png">
  <meta property="og:type" content="website">
<meta property="og:title" content="网记本">
<meta property="og:url" content="https://freefuncode.github.io/categories/Android/page/4/index.html">
<meta property="og:site_name" content="网记本">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="网记本">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css">
   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="/css/style.css?v=1571545567382">
</head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(https://i.loli.net/2019/01/13/5c3aec85a4343.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="网记本" class="mdui-btn mdui-btn-icon"><img src="/img/avatar.jpg"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="网记本">
            <img src="/img/avatar.jpg" alt="网记本">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>94</div>
        <div><span>标签</span>51</div>
        <div><span>分类</span>13</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的收藏">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的收藏
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">社交按钮</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://weibo.com/230689567" target="_blank" mdui-tooltip="{content: '微博'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-weibo"></i>
        </a><a class="mdui-ripple" href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" target="_blank" mdui-tooltip="{content: '掘金'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-appstore-fill"></i>
        </a><a class="mdui-ripple" href="https://www.cnblogs.com/bugzone/" target="_blank" mdui-tooltip="{content: '博客园'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-dribbble"></i>
        </a><a class="mdui-ripple" href="https://www.jianshu.com/u/ba21180e6aab" target="_blank" mdui-tooltip="{content: '简书'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-container"></i>
        </a><a class="mdui-ripple" href="https://github.com/freefuncode/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://www.zhihu.com/people/yimei-cheng-xu-yuan-28/activities" target="_blank" mdui-tooltip="{content: '知乎'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-zhihu"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/">Android</a>
          <span class="category-list-count">52</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/CSharp/">CSharp</a>
          <span class="category-list-count">14</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/GitHub/">GitHub</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/JAVA/">JAVA</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/PHP/">PHP</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/kotlin/">kotlin</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/前端/">前端</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/">后端</a>
          <span class="category-list-count">21</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/安卓源码/">安卓源码</a>
          <span class="category-list-count">15</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/开源框架/">开源框架</a>
          <span class="category-list-count">17</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/心情/">心情</a>
          <span class="category-list-count">10</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/知识点/">知识点</a>
          <span class="category-list-count">18</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/设计模式/">设计模式</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">标签云</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Activity/" style="font-size: 10px;">Activity</a> <a href="/tags/Android/" style="font-size: 12.5px;">Android</a> <a href="/tags/Android7-0/" style="font-size: 10px;">Android7.0</a> <a href="/tags/BroadcastReceiver/" style="font-size: 10px;">BroadcastReceiver</a> <a href="/tags/C-文件上传/" style="font-size: 10px;">C#文件上传</a> <a href="/tags/ContentProvider/" style="font-size: 10px;">ContentProvider</a> <a href="/tags/Excel操作/" style="font-size: 10px;">Excel操作</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/IIS/" style="font-size: 12.5px;">IIS</a> <a href="/tags/LNMP/" style="font-size: 10px;">LNMP</a> <a href="/tags/Linq/" style="font-size: 10px;">Linq</a> <a href="/tags/MAMP/" style="font-size: 10px;">MAMP</a> <a href="/tags/Service/" style="font-size: 10px;">Service</a> <a href="/tags/SqlServer/" style="font-size: 10px;">SqlServer</a> <a href="/tags/ViewPager/" style="font-size: 10px;">ViewPager</a> <a href="/tags/XMLHttpRequest/" style="font-size: 10px;">XMLHttpRequest</a> <a href="/tags/c/" style="font-size: 10px;">c#</a> <a href="/tags/coroutine协程/" style="font-size: 10px;">coroutine协程</a> <a href="/tags/easyui/" style="font-size: 12.5px;">easyui</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/kotlin/" style="font-size: 10px;">kotlin</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mono-for-Android/" style="font-size: 10px;">mono_for_Android</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/view绘制/" style="font-size: 10px;">view绘制</a> <a href="/tags/visualStudio/" style="font-size: 12.5px;">visualStudio</a> <a href="/tags/习惯/" style="font-size: 10px;">习惯</a> <a href="/tags/京东云擎/" style="font-size: 10px;">京东云擎</a> <a href="/tags/公众号/" style="font-size: 10px;">公众号</a> <a href="/tags/副业/" style="font-size: 10px;">副业</a> <a href="/tags/图片保存/" style="font-size: 10px;">图片保存</a> <a href="/tags/地图/" style="font-size: 12.5px;">地图</a> <a href="/tags/增量更新/" style="font-size: 10px;">增量更新</a> <a href="/tags/安卓源码/" style="font-size: 17.5px;">安卓源码</a> <a href="/tags/屏幕适配/" style="font-size: 10px;">屏幕适配</a> <a href="/tags/序列化/" style="font-size: 10px;">序列化</a> <a href="/tags/开源框架/" style="font-size: 20px;">开源框架</a> <a href="/tags/新浪SAE/" style="font-size: 10px;">新浪SAE</a> <a href="/tags/日期格式化/" style="font-size: 10px;">日期格式化</a> <a href="/tags/正则表达式/" style="font-size: 10px;">正则表达式</a> <a href="/tags/电影/" style="font-size: 15px;">电影</a> <a href="/tags/线程切换/" style="font-size: 10px;">线程切换</a> <a href="/tags/职业发展/" style="font-size: 10px;">职业发展</a> <a href="/tags/职业生涯/" style="font-size: 10px;">职业生涯</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/评论插件/" style="font-size: 10px;">评论插件</a> <a href="/tags/跳槽/" style="font-size: 12.5px;">跳槽</a> <a href="/tags/面试/" style="font-size: 12.5px;">面试</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2019 网记本
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <section class="nexmoe-posts" id="brand-waterfall">
    
    <div class="nexmoe-post">
        <a href="/2018/07/21/ViewPager相关使用/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="ViewPager相关使用">
                
                <h1>ViewPager相关使用</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月21日</a>
            <a><i class="nexmoefont icon-areachart"></i>893 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 4 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/知识点/">知识点</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/ViewPager/">ViewPager</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/viewpager.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.ViewPager+Fragment 预加载</h2>
<p>&nbsp;ViewPager的预加载，是指ViewPager的内部加载数据机制，它会默认至少预加载一个相邻的ViewPager内的Fragment页数据。<br>&nbsp;<br>&nbsp;如果设置 viewpager.setOffscreenPageLimit(0); 会发现没有效果。<br>&nbsp;可以查看ViewPager.java源码我们知道，ViewPager默认必须预加载一个相邻页面的数据。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ViewPager extends ViewGroup {
    ...
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> final <span style="color: #0000ff;">int</span> DEFAULT_OFFSCREEN_PAGES = <span style="color: #800080;">1</span><span style="color: #000000;">;
    ...
    </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
     * Set the number of pages that should be retained to either side of the
     * current page in the view hierarchy in an idle state. Pages beyond this
     * limit will be recreated from the adapter when needed.
     *
     * &lt;p&gt;This is offered as an optimization. If you know in advance the number
     * of pages you will need to support or have lazy-loading mechanisms in place
     * on your pages, tweaking this setting can have benefits in perceived smoothness
     * of paging animations and interaction. If you have a small number of pages (3-4)
     * that you can keep active all at once, less time will be spent in layout for
     * newly created view subtrees as the user pages back and forth.&lt;/p&gt;
     *
     * &lt;p&gt;You should keep this limit low, especially if your pages have complex layouts.
     * This setting defaults to 1.&lt;/p&gt;
     *
     * @param limit How many pages will be kept offscreen in an idle state.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setOffscreenPageLimit(<span style="color: #0000ff;">int</span><span style="color: #000000;"> limit) {
        </span><span style="color: #0000ff;">if</span> (limit &lt;<span style="color: #000000;"> DEFAULT_OFFSCREEN_PAGES) {
            Log.w(TAG, </span><span style="color: #800000;">"</span><span style="color: #800000;">Requested offscreen page limit </span><span style="color: #800000;">"</span> + limit + <span style="color: #800000;">"</span><span style="color: #800000;"> too small; defaulting to </span><span style="color: #800000;">"</span> +<span style="color: #000000;">
                    DEFAULT_OFFSCREEN_PAGES);
            limit </span>=<span style="color: #000000;"> DEFAULT_OFFSCREEN_PAGES;
        }
        </span><span style="color: #0000ff;">if</span> (limit !=<span style="color: #000000;"> mOffscreenPageLimit) {
            mOffscreenPageLimit </span>=<span style="color: #000000;"> limit;
            populate();
        }
    }
    ...
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div>&nbsp; &nbsp; 如果确实有时候非要相邻的Fragment页面需要实时显示的时候就要刷新数据，我们可以使用Fragment里的一个方法。<br>&nbsp; &nbsp; 重写 public void setUserVisibleHint(boolean isVisibleToUser) {...} 来处理请求刷新数据。</div>
<div>&nbsp; &nbsp; 当然也有很多其他方法来解决页面立即刷新问题，比如：利用EventBus监听事件刷新，或者FragmentManager来控制Fragment响应事件的触发更新等等。</div>
<div>&nbsp;</div>
<div>
<div>
<h2>二.FragmentStatePagerAdapter 和 FragmentPagerAdapter</h2>
<br>&nbsp;&nbsp;&nbsp;&nbsp; ViewPager 经常和 Fragment 一起使用，并且提供了专门的 FragmentPagerAdapter 和 FragmentStatePagerAdapter 类供 Fragment 中的 ViewPager 使用。</div>
<div>
<h4>&nbsp;1.FragmentStatePagerAdapter</h4>
Implementation of PagerAdapter that uses a Fragment to manage each page. This class also handles saving and restoring of fragment's state. <br>&nbsp;&nbsp;&nbsp; This version of the pager is more useful when there are a large number of pages, working more like a list view. <br>&nbsp;When pages are not visible to the user, their entire fragment may be destroyed, only keeping the saved state of that fragment.<br>&nbsp;This allows the pager to hold on to much less memory associated with each visited page as compared to FragmentPagerAdapter at the cost of potentially more overhead when switching between pages. <br>&nbsp;&nbsp;&nbsp; When using FragmentPagerAdapter the host ViewPager must have a valid ID set.<br>&nbsp;&nbsp;&nbsp; Subclasses only need to implement getItem(int) and getCount() to have a working adapter. </div>
<div>&nbsp;</div>
<div>&nbsp; &nbsp;&nbsp; 从FragmentStatePagerAdapter的Api可知。<strong>当ViewPager管理的页面有大量数据时候，也就是如果viewpager管理的页面是一个ListView时候，推荐使用FragmentStatePagerAdapter</strong>。这是因为FragmentStatePagerAdapter在页面不可见的时候，会销毁这个Fragment。所以FragmentStatePagerAdapter比FragmentPagerAdapter占用内存更小。<br>
<h4> 2.FragmentPagerAdapter</h4>
&nbsp;Implementation of PagerAdapter that represents each page as a Fragment that is persistently kept in the fragment manager as long as the user can return to the page. <br>&nbsp;This version of the pager is best for use when there are a handful of typically more static fragments to be paged through, such as a set of tabs. The fragment of each page the user visits will be kept in memory, <br>&nbsp;though its view hierarchy may be destroyed when not visible. This can result in using a significant amount of memory since fragment instances can hold on to an arbitrary amount of state. <br>&nbsp;For larger sets of pages, consider FragmentStatePagerAdapter. <br>&nbsp;When using FragmentPagerAdapter the host ViewPager must have a valid ID set.<br>&nbsp;Subclasses only need to implement getItem(int) and getCount() to have a working adapter. <br>&nbsp;<br>&nbsp;从FragmentPagerAdapter的Api也同样了解到，当页面有大量数据加载的时候推荐使用FragmentStatePagerAdapter，FragmentPagerAdapter 创建的 fragment 永远不会被销毁，一般用于<strong>只有少量固定的 fragment 时，可以选择 FragmentPagerAdapter</strong>。<br>&nbsp;<br><br>&nbsp;最后说一点，在内存优化上，<strong>RecyclerView要比ViewPager优秀</strong>些。推荐大家优先考虑使用RecyclerView 实现。</div>
</div>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/21/AIDL介绍以及简单使用/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="AIDL介绍以及简单使用">
                
                <h1>AIDL介绍以及简单使用</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月21日</a>
            <a><i class="nexmoefont icon-areachart"></i>3.6k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 20 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/知识点/">知识点</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/AIDL/">AIDL</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/aidl.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
    <div class="toc">
    <p class="toc-title">目录</p>
    <div class="toc-list">
        <ul>
        <li><a href="#一.-aidl-介绍.">一. AIDL 介绍.</a></li>
        <li><a href="#二.-aidl简单应用.">二. AIDL简单应用.</a><ul>
        <li><a href="#aidl_server端">Aidl_Server端</a></li>
        </ul></li>
        <li><a href="#section"></a><ul>
        <li><a href="#aidl_client端">Aidl_Client端</a></li>
        </ul></li>
        <li><a href="#三.注意事项">三.注意事项</a></li>
        </ul>
    </div>
</div>
<h2 id="一.-aidl-介绍.">一. AIDL 介绍.</h2>
<pre><code class="hljs"> AIDL（Android接口描述语言）是一个IDL语言，它可以生成一段代码，可以是一个在Android设备上运行的两个进程使用内部通信进程进行交互。</code></pre>
<p>如果你想在一个进程中（例如在一个Activity中）访问另一个进程中（例如service）某个对象的方法，你就可以使用AIDL来生成这样的代码来伪装传递各种参数。</p>
<p>稍微了解下几个常见的名词(IPC,匿名共享内存,Binder,Aidl,消息,广播,ContentProvider,Intent):<br>
<strong>IPC是一种概念，即进程间通信；其它几个都是Android里的概念；</strong><br>
<strong>匿名共享内存(Anonymous Shared Memory):其作用之一即通过Binder进程间通信机制来实现进程间的内存共享。 </strong><br>
<strong>Binder:Binder是对IPC的具体实行，是IPC的一种具体实现.其本质也是调用系统底层的共享内存实现.</strong><br>
<strong>AIDL:进程间的通信，速度快(系统底层直接是共享内存)，性能稳，效率高，一般进程间通信就用它. AIDL是Binder机制向外提供的接口，目的就是为了方便对Binder的使用；</strong><br>
<strong>消息(Messager)：Messenger本质也是AIDL，只是进行了封装，开发的时候不用再写.aidl文件,效率应该是和Aidl是一样的，与Aidl的区别在于Messager是线程安全的，而Aidl是非线程安全的，所以Aidl在使用的时候应该注意这个问题;</strong><br>
<strong>广播(BroadcastReceiver):只要注册了广播，都能收到，有点范围广，缺点速度慢必须在一定时间完成处理操作,同其他Android四大组件一样,都不能执行耗时操作;</strong><br>
<strong>ContentProvider:暴露app的数据访问接口，让其他应该访问app数据.同时也能通过ContentProvider来访问第三方的一些app数据(如通讯录,日历等暴露接口的应用);</strong><br>
<strong>Intent:Intent是最高层级的封装，实质是封装了对Binder的使用，当然Intent也常常在同一进程中调用，只是把两种方式封装在一起了.</strong><br>
<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180721125726338-2042877965.jpg"></p>
<h2 id="二.-aidl简单应用.">二. AIDL简单应用.</h2>
<pre><code class="hljs vbscript">编写两个app应用程序,一个实现Aidl传递的<span class="hljs-built_in">Server</span>端,一个实现Aidl的Client端:
aidl的<span class="hljs-built_in">Server</span>端,接收Client端传过来的两个<span class="hljs-built_in">int</span>值,定义一个加法计算的逻辑规则, 并返回 两个<span class="hljs-built_in">int</span>数之和, return num1 + num2;
aidl的Client端,从界面用户输入两个<span class="hljs-built_in">int</span>数,点击绑定<span class="hljs-built_in">Server</span>端服务,点击计算,调用<span class="hljs-built_in">Server</span>端加法逻辑,将返回结果 输入到用户界面展示,两数之和.</code></pre>
<h3 id="aidl_server端">Aidl_Server端</h3>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180721125835612-1721114769.jpg"></p>
<pre class="java"><code class="hljs"><span class="hljs-comment">// IImoocAIDL.aidl</span>
 <span class="hljs-keyword">package</span> com.example.administrator.aidl_server.service;

<p><span class="hljs-comment">// Declare any non-default types here with import statements</span></p>
<p><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IImoocAIDL</span> </span>{<br>     <span class="hljs-comment">//计算num1 + num2</span><br>        <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-keyword">int</span> num1,<span class="hljs-keyword">int</span> num2)</span></span>;<br>}</p></code></pre><p></p>
<p>编译后会生成</p>
<pre class="java"><code class="hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IImoocAIDL</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">android</span>.<span class="hljs-title">os</span>.<span class="hljs-title">IInterface</span> </span>{
    <span class="hljs-comment">/**
     * Local-side IPC implementation stub class.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Stub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">android</span>.<span class="hljs-title">os</span>.<span class="hljs-title">Binder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">com</span>.<span class="hljs-title">example</span>.<span class="hljs-title">administrator</span>.<span class="hljs-title">aidl_server</span>.<span class="hljs-title">service</span>.<span class="hljs-title">IImoocAIDL</span> </span>{
            ...
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">com</span>.<span class="hljs-title">example</span>.<span class="hljs-title">administrator</span>.<span class="hljs-title">aidl_server</span>.<span class="hljs-title">service</span>.<span class="hljs-title">IImoocAIDL</span> </span>{
            <span class="hljs-keyword">private</span> android.os.IBinder mRemote;

<pre><code>        Proxy(android.os.IBinder remote) {
            mRemote = remote;
        }

        &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; android.os.&lt;span class=&quot;hljs-function&quot;&gt;IBinder &lt;span class=&quot;hljs-title&quot;&gt;asBinder&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;{
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; mRemote;
        }

        &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; java.lang.&lt;span class=&quot;hljs-function&quot;&gt;String &lt;span class=&quot;hljs-title&quot;&gt;getInterfaceDescriptor&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;{
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; DESCRIPTOR;
        }

        &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; num1, &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; num2)&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;throws&lt;/span&gt; android.os.RemoteException &lt;/span&gt;{
            ...
        }

        ...
    }
        ...
}</code></pre><p>}</p></code></pre><p></p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180721125949447-88355980.jpg"></p>
<p>//om.example.administrator.aidl_server.IRemoteService</p>
<pre class="java"><code class="hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IRemoteService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Service</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TAG = <span class="hljs-string">"IRemoteService"</span>;
    <span class="hljs-comment">//客户端绑定service时会执行</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IBinder <span class="hljs-title">onBind</span><span class="hljs-params">(Intent intent)</span> </span>{
        <span class="hljs-keyword">return</span> iBinder;
    }

<pre><code>&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; IBinder iBinder = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; IImoocAIDL.Stub() {
    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; num1, &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; num2)&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;throws&lt;/span&gt; RemoteException &lt;/span&gt;{
        Log.e(TAG,&lt;span class=&quot;hljs-string&quot;&gt;&quot;收到了来自客户端的请求&quot;&lt;/span&gt; + num1 + &lt;span class=&quot;hljs-string&quot;&gt;&quot;+&quot;&lt;/span&gt; + num2 );
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; num1 + num2;
    }

};</code></pre><p>}</p></code></pre><p></p>
<p>//AndroidManifest.xml</p>
<pre class="xml"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-name">application</span>
    <span class="hljs-attr">...</span>
        &lt;<span class="hljs-attr">service</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">".IRemoteService"</span>
            <span class="hljs-attr">android:process</span>=<span class="hljs-string">":remote"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"true"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.example.administrator.aidl_server"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>
    ...
<span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span></code></pre>
<h2 id="section"></h2>
<h3 id="aidl_client端">Aidl_Client端</h3>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180721125848817-895261162.jpg"></p>
<pre class="java"><code class="hljs">com.example.administrator.aidl_client.MainActivity
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TAG = <span class="hljs-string">"MainActivity"</span>;
    <span class="hljs-keyword">private</span> EditText et_send_input,nub_1,nub_2;
    <span class="hljs-keyword">private</span> TextView tv_send;
    <span class="hljs-keyword">private</span> TextView tv_bind;
    <span class="hljs-keyword">private</span> IImoocAIDL iImoocAIDLService;

<pre><code>&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; ServiceConnection conn = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; ServiceConnection() {

    &lt;span class=&quot;hljs-comment&quot;&gt;//绑定服务，回调onBind()方法&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;onServiceConnected&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(ComponentName name, IBinder service)&lt;/span&gt; &lt;/span&gt;{
        iImoocAIDLService = IImoocAIDL.Stub.asInterface(service);
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;onServiceDisconnected&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(ComponentName name)&lt;/span&gt; &lt;/span&gt;{
        iImoocAIDLService = &lt;span class=&quot;hljs-keyword&quot;&gt;null&lt;/span&gt;;
    }
};


&lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(Bundle savedInstanceState)&lt;/span&gt; &lt;/span&gt;{
    &lt;span class=&quot;hljs-keyword&quot;&gt;super&lt;/span&gt;.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    bindService();

    et_send_input = findViewById(R.id.et_send_input);
    nub_1 = findViewById(R.id.nub_1);
    nub_2 = findViewById(R.id.nub_2);
    tv_send = findViewById(R.id.tv_send);
    tv_bind = findViewById(R.id.tv_bind);

    tv_send.setOnClickListener(&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; View.OnClickListener() {
        &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(View view)&lt;/span&gt; &lt;/span&gt;{
            &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; nub1 = Integer.parseInt(nub_1.getText().toString().trim());
                &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; nub2 = Integer.parseInt(nub_2.getText().toString().trim());

                &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; result = iImoocAIDLService.add(nub1,nub2);
                et_send_input.setText(result+&lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&lt;/span&gt;);
            }&lt;span class=&quot;hljs-keyword&quot;&gt;catch&lt;/span&gt; (Exception e){
                e.printStackTrace();
            }

        }
    });

    tv_bind.setOnClickListener(&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; View.OnClickListener() {
        &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;onClick&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(View view)&lt;/span&gt; &lt;/span&gt;{
            bindService();
            Log.e(TAG,&lt;span class=&quot;hljs-string&quot;&gt;&quot;bindService&quot;&lt;/span&gt;+iImoocAIDLService);
        }
    });
}

&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;bindService&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;{
    Intent intent = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; Intent();
    &lt;span class=&quot;hljs-comment&quot;&gt;//绑定服务端的service&lt;/span&gt;
    intent.setAction(&lt;span class=&quot;hljs-string&quot;&gt;&quot;com.example.administrator.aidl_server.IRemoteService&quot;&lt;/span&gt;);
    &lt;span class=&quot;hljs-comment&quot;&gt;//新版本（5.0后）必须显式intent启动 绑定服务&lt;/span&gt;
    intent.setComponent(&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; ComponentName(&lt;span class=&quot;hljs-string&quot;&gt;&quot;com.example.administrator.aidl_server&quot;&lt;/span&gt;,&lt;span class=&quot;hljs-string&quot;&gt;&quot;com.example.administrator.aidl_server.IRemoteService&quot;&lt;/span&gt;));
    &lt;span class=&quot;hljs-comment&quot;&gt;//绑定的时候服务端自动创建&lt;/span&gt;
    bindService(intent,conn, Context.BIND_AUTO_CREATE);
}

&lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;onDestroy&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;{
    &lt;span class=&quot;hljs-keyword&quot;&gt;super&lt;/span&gt;.onDestroy();
    unbindService(conn);
}</code></pre><p>}</p></code></pre><p></p>
<p>layout/activity_main.xml</p>
<pre class="xml"><code class="hljs"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span>

<pre><code>&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;LinearLayout&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:gravity&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;center&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;match_parent&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;EditText&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:id&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;@+id/nub_1&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:inputType&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;number&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;TextView&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:text&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;+&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;EditText&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:id&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;@+id/nub_2&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:inputType&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;number&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;TextView&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:text&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;=&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;EditText&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:id&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;@+id/et_send_input&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;wrap_content&quot;&lt;/span&gt;
        &lt;span class=&quot;hljs-attr&quot;&gt;android:inputType&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;number&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;LinearLayout&lt;/span&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;TextView&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:id&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;@+id/tv_bind&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;200dp&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;55dp&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_gravity&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;center&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_marginBottom&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;15dp&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:background&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;@color/colorAccent&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:gravity&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;center&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:text&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;bind&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;

&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;TextView&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:id&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;@+id/tv_send&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_width&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;200dp&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_height&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;55dp&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:layout_gravity&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;center&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:background&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;@color/colorAccent&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:gravity&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;center&quot;&lt;/span&gt;
    &lt;span class=&quot;hljs-attr&quot;&gt;android:text&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;计算&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;</code></pre><p><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span></p></code></pre><p></p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180721125924545-1098549099.jpg"></p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180721130234841-1703766935.jpg"></p>
<h2 id="三.注意事项">三.注意事项</h2>
<p>如果运行中报错:</p>
<h4 id="aidl-method-threw-java.lang.securityexception-exception.">aidl Method threw 'java.lang.SecurityException' exception.</h4>
<p>需要 确保客户端的aidl文件包名要与服务端的包名一样.也就是本项目中的IImoocAIDL.aidl文件包名一致.</p>
<hr>
<p>[1] 参考资料: https://blog.csdn.net/jinxinliu1/article/details/70174591</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/19/Android四大组件-五-第五大组件Fragment使用/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 四大组件 (五) 第五大组件 - Fragment 使用">
                
                <h1>Android 四大组件 (五) 第五大组件 - Fragment 使用</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月19日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.9k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 9 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/知识点/">知识点</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/Android/">Android</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/fragment.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p>&nbsp; &nbsp; Fragment 的存在必须依附于 Activity，并且与 Activity 一样，拥有自己的生命周期，同时处理用户的交互动作。同一个 Activity 可以有一个或多个 Fragment 作为界面内容，并且可以动态添加、删除 Fragment，灵活控制 UI 内容，也可以用来解决部分屏幕适配问题。</p>
<p>&nbsp; &nbsp; 另外，support v4 包中也提供了 Fragment，兼容 Android 3.0 之前的系统（当然，现在 3.0 之前的系统在市场上已经很少见了，可以不予考虑），使用兼容包需要注意两点：</p>
<p>&nbsp; &nbsp; FragmentActivity是为了兼容4.0以下版本的Fragment使用的。所以如果想兼容4.0以下Android版本使用Fragment的话，框架Activity需要继承FragmentActivity，该类在android.support.v4.app.FragmentActivity里的。它提供了操作fragment的一些方法，其功能跟4.0及以后的版本的Activity的功能一样。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.Activity 必须继承自 FragmentActivity；<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.使用 getSupportFragmentManager() 方法获取 FragmentManager 对象；</p>
<p>&nbsp;</p>
<h2>Fragment 生命周期介绍:</h2>
<p>　　onAttach(Context context):当Fragment和Activity发生关联时使用,在Fragment于窗口关联后立刻调用。从该方法开始，就可以通过Fragment.getActivity方法获取与Fragment关联的窗口对象，但因为Fragment的控件未初始化，所以不能够操作控件。</p>
<p>    　　onCreate(Bundle savedInstanceState)在调用完onAttach执行完之后立刻调用onCreate方法，可以在Bundle对象中获取一些在Activity中传过来的数据。通常会在该方法中读取保存的状态，获取或初始化一些数据。在该方法中不要进行耗时操作，不然窗口不会显示。</p>
<p>    　　onCreateView(LayoutInflater, ViewGroup, Bundle):创建该Fragment的视图,该方法是Fragment很重要的一个生命周期方法，因为会在该方法中创建在Fragment显示的View，其中inflater是用来装载布局文件的，container是&lt;fragment&gt;标签的父标签对应对象，　　savedInstanceState参数可以获取Fragment保存的状态，如果未保存那么就为null。</p>
<p>    　　onViewCreated(View view,Bundle savedInstanceState) Android在创建完Fragment中的View对象之后，会立刻回调该方法。其种view参数就是onCreateView中返回的view，而bundle对象用于一般用途。</p>
<p>    　　onActivityCreate(Bundle):当Activity的onCreate方法返回时调用,在Activity的onCreate方法执行完之后，Android系统会立刻调用该方法，表示窗口已经初始化完成，从这一个时候开始，就可以在Fragment中使用getActivity().findViewById(Id);来操控Activity中的view了。</p>
<p>    　　onStart()&nbsp;这个没啥可讲的，但有一个细节需要知道，当系统调用该方法的时候，fragment已经显示在ui上，但还不能进行互动，因为onResume方法还没执行完。</p>
<p><em id="__mceDel">    　　onResume()&nbsp;</em>该方法为fragment从创建到显示Android系统调用的最后一个生命周期方法，调用完该方法时候，fragment就可以与用户互动了。</p>
<p>    　　onPause() fragment由活跃状态变成非活跃状态执行的第一个回调方法，通常可以在这个方法中保存一些需要临时暂停的工作。如保存音乐播放进度，然后在onResume中恢复音乐播放进度。</p>
<p>    　　onStop() 当onStop返回的时候，fragment将从屏幕上消失。</p>
<p>    　　onDestoryView() 与onCreateView相对应，当该Fragment的视图被移除时调用, 该方法的调用意味着在 onCreateView 中创建的视图都将被移除。</p>
<p>    　　onDestroy() Android在Fragment不再使用时会调用该方法，要注意的是~这时Fragment还和Activity藕断丝连！并且可以获得Fragment对象，但无法对获得的Fragment进行任何操作。</p>
<p>    　　onDetach():与onAttach相对应，当Fragment与Activity关联被取消时调用.为Fragment生命周期中的最后一个方法，当该方法执行完后，Fragment与Activity不再有关联<br>    <br>    　　　　来自:https://blog.csdn.net/osle123/article/details/52756424</p>
<h2>Fragment 与 Activity 生命周期交互:</h2>
<p>一张图了解下:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180719091746040-653406302.png" alt></p>
<p>执行代码过程了解下:</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #800080;">1</span>. -- fragmentTransaction.addToBackStack(<span style="color: #800000;">"</span><span style="color: #800000;">blank</span><span style="color: #800000;">"</span>);<span style="color: #008000;">//</span><span style="color: #008000;">加入回退栈  按两次返回按键</span>

<p><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.912</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">MainActivity: onCreate<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.914</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">BlankFragment: onAttach<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.914</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">BlankFragment: onCreate<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.914</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">BlankFragment: onCreateView<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.918</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">BlankFragment: onActivityCreated<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.918</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">BlankFragment: onStart<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.918</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">MainActivity: onStart<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.921</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">MainActivity: onResume<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">15</span>:<span style="color: #800080;">50.921</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/? E/<span style="color: #000000;">BlankFragment: onResume<br></span><span style="color: #008000;">//</span><span style="color: #008000;">按返回键</span><br><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">16</span>:<span style="color: #800080;">39.838</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onPause<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">16</span>:<span style="color: #800080;">39.838</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onCreate<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">16</span>:<span style="color: #800080;">39.839</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onDestroyView<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">16</span>:<span style="color: #800080;">39.842</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onDestroy<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">16</span>:<span style="color: #800080;">39.842</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onDetach<br></span><span style="color: #008000;">//</span><span style="color: #008000;">按返回键</span><br><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">16</span>:<span style="color: #800080;">42.771</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onPause<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">16</span>:<span style="color: #800080;">43.157</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onStop<br></span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">16</span>:<span style="color: #800080;">43.158</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/MainActivity: onDestroy</p></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #800080;">2</span>. <span style="color: #008000;">//</span><span style="color: #008000;">---------------------------------------------------------------------------------</span><span style="color: #008000;">//</span>
<span style="color: #008000;">//</span><span style="color: #008000;">按物理home键</span>
<span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.215</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onCreate
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.216</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onAttach
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.216</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onCreate
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.217</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onCreateView
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.220</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onActivityCreated
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.221</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onStart
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.221</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onStart
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.223</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onResume
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">06.223</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onResume
</span><span style="color: #008000;">//</span><span style="color: #008000;">按home键</span>
<span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">10.213</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onPause
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">10.213</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onPause
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">10.538</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onSaveInstanceState
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">10.540</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onCreate
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">17</span>:<span style="color: #800080;">10.540</span> <span style="color: #800080;">17903</span>-<span style="color: #800080;">17903</span>/com.example.administrator.testapplication E/MainActivity: onStop</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #800080;">3</span>. <span style="color: #008000;">//</span><span style="color: #008000;">fragmentTransaction.addToBackStack("blank"); 注释该行代码运行
</span><span style="color: #008000;">//</span><span style="color: #008000;">-----------------------------------------------------------------------------</span><span style="color: #008000;">//
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.098</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onCreate
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.100</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onAttach
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.100</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onCreate
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.101</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onCreateView
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.105</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onActivityCreated
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.105</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onStart
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.105</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onStart
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.109</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onResume
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">12.109</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onResume
</span><span style="color: #008000;">//</span><span style="color: #008000;">按返回键</span>
<span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">16.642</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onPause
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">16.642</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onPause
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">17.020</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onCreate
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">17.020</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">MainActivity: onStop
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">17.022</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onDestroyView
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">17.023</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onDestroy
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">17.024</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/<span style="color: #000000;">BlankFragment: onDetach
</span><span style="color: #800080;">07</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">21</span>:<span style="color: #800080;">17.024</span> <span style="color: #800080;">18226</span>-<span style="color: #800080;">18226</span>/com.example.administrator.testapplication E/MainActivity: onDestroy</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<p>相关调用代码:</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>　　　　BlankFragment fragment = <span style="color: #0000ff;">new</span><span style="color: #000000;"> BlankFragment();

<pre><code>android.support.v4.app.FragmentManager fragmentManager;
android.support.v4.app.FragmentTransaction fragmentTransaction;

fragmentManager &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; getSupportFragmentManager();
fragmentTransaction &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; getSupportFragmentManager().beginTransaction();
fragmentTransaction.add(R.id.ll_fragment,fragment,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;blank&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
fragmentTransaction.addToBackStack(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;blank&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
fragmentTransaction.commit();&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/15/Android源码分析十一事件传递机制/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 源码分析（十一） 事件传递机制">
                
                <h1>Android 源码分析（十一） 事件传递机制</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月15日</a>
            <a><i class="nexmoefont icon-areachart"></i>5.8k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 35 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/touchEvent.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.介绍</h2>
<p>　　Android三种事件类型：ACTION_DOWN,ACTOIN_MOVE,ACTION_UP。<br>　　事件传递的三个阶段：<br>　　　　分发(Dispatch)<br>　　　　　　方法：public boolean <strong>dispatchTouchEvent</strong>(MotionEvent ev)<br>　　　　拦截(Intercept)<br>　　　　　　方法：public boolean <strong>onInterceptTouchEvent</strong>(MotionEvent ev)<br>　　　　消费(Consume)<br>　　　　　　方法：public boolean <strong>onTouchEvent</strong>(MotionEvent event)</p>
<h2>二.源码分析</h2>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">Activity.java   </span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Called to process touch screen events.  You can override this to
     * intercept all touch screen events before they are dispatched to the
     * window.  Be sure to call this implementation for touch screen events
     * that should be handled normally.
     *
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> ev The touch screen event.
     *
     * </span><span style="color: #808080;">@return</span><span style="color: #008000;"> boolean Return true if this event was consumed.
     </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> dispatchTouchEvent(MotionEvent ev) {
        </span><span style="color: #0000ff;">if</span> (ev.getAction() ==<span style="color: #000000;"> MotionEvent.ACTION_DOWN) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;">当此activity在栈顶时，用户对手机：触屏点击，按home，back，menu键都会触发此方法。
            </span><span style="color: #008000;">//</span><span style="color: #008000;">注：下拉statubar,旋转屏幕,锁屏，不会触发此方法.</span>
<span style="color: #000000;">            onUserInteraction();
        }
        </span><span style="color: #008000;">//</span><span style="color: #008000;">查看getWindow().对event做了什么分发？</span>
        <span style="color: #0000ff;">if</span><span style="color: #000000;"> (getWindow().superDispatchTouchEvent(ev)) {
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
        }
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> onTouchEvent(ev);
}

<p>Window.java 是一个抽象类。在Activity里attach()查看Window创建过程<br></p></span><span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> attach(…){<p></p>
<pre><code>attachBaseContext(context);

    mFragments.attachHost(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;parent&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;PhoneWindow 是 getWindow()的具体实现类。进去查看它的superDispatchTouchEvent()&lt;/span&gt;
    mWindow = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; PhoneWindow(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, window, activityConfigCallback);
    mWindow.setWindowControllerCallback(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mWindow.setCallback(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mWindow.setOnWindowDismissedCallback(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mWindow.getLayoutInflater().setPrivateFactory(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (info.softInputMode !=&lt;span style=&quot;color: #000000;&quot;&gt; WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) {
        mWindow.setSoftInputMode(info.softInputMode);
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (info.uiOptions != 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
        mWindow.setUiOptions(info.uiOptions);
    }
    mUiThread &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; Thread.currentThread();

    mMainThread &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; aThread;
...</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">PhoneWindow.java extends Window</span>
<span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> superDispatchTouchEvent(MotionEvent event) {
        </span><span style="color: #008000;">//</span><span style="color: #008000;">PhoneWindow Event 分发操作有在DecorView实现了，继续进去看看DecorView类。</span>
        <span style="color: #0000ff;">return</span><span style="color: #000000;"> mDecor.superDispatchTouchEvent(event);
    }

<p></p></span><span style="color: #008000;">//</span><span style="color: #008000;"> This is the top-level view of the window, containing the window decor.</span><br>    <span style="color: #0000ff;">private</span> DecorView mDecor;</pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">DecorView.java </span>
     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> superDispatchTouchEvent(MotionEvent event) {
         </span><span style="color: #008000;">//</span><span style="color: #008000;">DecorView就是activity的顶级view，
         </span><span style="color: #008000;">//</span><span style="color: #008000;">点击事件已经从activity传到View当中了，接下来要分析的就是顶级View把事件如何分发到各个子view中
         </span><span style="color: #008000;">//</span><span style="color: #008000;">DecorView extends FrameLayout</span>
        <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.dispatchTouchEvent(event);
    }

<pre><code> @Override
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; dispatchTouchEvent(MotionEvent ev) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; Window.Callback cb =&lt;span style=&quot;color: #000000;&quot;&gt; mWindow.getCallback();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; cb != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !mWindow.isDestroyed() &amp;amp;&amp;amp; mFeatureId &amp;lt; 0
            ? cb.dispatchTouchEvent(ev) : &lt;span style=&quot;color: #0000ff;&quot;&gt;super&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.dispatchTouchEvent(ev);
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">FrameLayout.java
    </span><span style="color: #008000;">//</span><span style="color: #008000;">FrameLayout extends ViewGroup 到 ViewGroup里看看</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FrameLayout <span style="color: #0000ff;">extends</span> ViewGroup {}</pre>
</div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ViewGroup.java</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> dispatchTouchEvent(MotionEvent ev) {
        </span><span style="color: #0000ff;">if</span> (mInputEventConsistencyVerifier != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            mInputEventConsistencyVerifier.onTouchEvent(ev, </span>1<span style="color: #000000;">);
        }

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If the event targets the accessibility focused view and this is it, start
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; normal event dispatch. Maybe a descendant is what will handle the click.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (ev.isTargetAccessibilityFocus() &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; isAccessibilityFocusedViewOrHost()) {
    ev.setTargetAccessibilityFocus(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; handled = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (onFilterTouchEventForSecurity(ev)) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; action =&lt;span style=&quot;color: #000000;&quot;&gt; ev.getAction();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; actionMasked = action &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_MASK;

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Handle an initial down.
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;当点击事件是MotionEvent.ACTION_DOWN时，及手指刚刚触碰屏幕第一个触发的事件&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_DOWN) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Throw away all previous state when starting a new touch gesture.
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The framework may have dropped the up or cancel event for the previous gesture
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; due to an app switch, ANR, or some other state change.&lt;/span&gt;</code></pre><p><span style="color: #000000;">                cancelAndClearTouchTargets(ev);<br>                resetTouchState();<br>            }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Check for interception.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;检查是否拦截&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; intercepted;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;判断是否父类是否拦截点击事件&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_DOWN
        &lt;/span&gt;|| mFirstTouchTarget != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; disallowIntercept = (mGroupFlags &amp;amp; FLAG_DISALLOW_INTERCEPT) != 0&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;disallowIntercept) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;调用拦截方法&lt;/span&gt;
        intercepted =&lt;span style=&quot;color: #000000;&quot;&gt; onInterceptTouchEvent(ev);
        ev.setAction(action); &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; restore action in case it was changed&lt;/span&gt;
    } &lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        intercepted &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; There are no touch targets and this action is not an initial down
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; so this view group continues to intercept touches.&lt;/span&gt;
    intercepted = &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If intercepted, start normal event dispatch. Also if there is already
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; a view that is handling the gesture, do normal event dispatch.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (intercepted || mFirstTouchTarget != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    ev.setTargetAccessibilityFocus(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Check for cancelation.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; canceled = resetCancelNextUpFlag(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)
        &lt;/span&gt;|| actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_CANCEL;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Update list of touch targets for pointer down, if needed.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; split = (mGroupFlags &amp;amp; FLAG_SPLIT_MOTION_EVENTS) != 0&lt;span style=&quot;color: #000000;&quot;&gt;;
TouchTarget newTouchTarget &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; alreadyDispatchedToNewTouchTarget = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;没有被取消并且没有被拦截,事件传递到子View &lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!canceled &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;intercepted) {

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If the event is targeting accessiiblity focus we give it to the
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; view that has accessibility focus and if it does not handle it
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we clear the flag and dispatch the event to all children as usual.
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We are looking up the accessibility focused host to avoid keeping
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; state since these events are very rare.&lt;/span&gt;
    View childWithAccessibilityFocus =&lt;span style=&quot;color: #000000;&quot;&gt; ev.isTargetAccessibilityFocus()
            &lt;/span&gt;? findChildWithAccessibilityFocus() : &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_DOWN
            &lt;/span&gt;|| (split &amp;amp;&amp;amp; actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_POINTER_DOWN)
            &lt;/span&gt;|| actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_HOVER_MOVE) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; actionIndex = ev.getActionIndex(); &lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; always 0 for down&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; idBitsToAssign = split ? 1 &amp;lt;&amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt; ev.getPointerId(actionIndex)
                : TouchTarget.ALL_POINTER_IDS;

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Clean up earlier touch targets for this pointer id in case they
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; have become out of sync.&lt;/span&gt;</code></pre><p><span style="color: #000000;">                    removePointersFromTouchTargets(idBitsToAssign);</span></p>
<pre><code>                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; childrenCount =&lt;span style=&quot;color: #000000;&quot;&gt; mChildrenCount;
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (newTouchTarget == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; childrenCount != 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;float&lt;/span&gt; x =&lt;span style=&quot;color: #000000;&quot;&gt; ev.getX(actionIndex);
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;float&lt;/span&gt; y =&lt;span style=&quot;color: #000000;&quot;&gt; ev.getY(actionIndex);
                    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Find a child that can receive the event.
                    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Scan children from front to back.&lt;/span&gt;
                    &lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; ArrayList&amp;lt;View&amp;gt; preorderedList =&lt;span style=&quot;color: #000000;&quot;&gt; buildTouchDispatchChildList();
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; customOrder = preorderedList == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;
                            &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; isChildrenDrawingOrderEnabled();
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; View[] children =&lt;span style=&quot;color: #000000;&quot;&gt; mChildren;
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; i = childrenCount - 1; i &amp;gt;= 0; i--&lt;span style=&quot;color: #000000;&quot;&gt;) {
                        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; childIndex =&lt;span style=&quot;color: #000000;&quot;&gt; getAndVerifyPreorderedIndex(
                                childrenCount, i, customOrder);
                        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; View child =&lt;span style=&quot;color: #000000;&quot;&gt; getAndVerifyPreorderedView(
                                preorderedList, children, childIndex);

                        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If there is a view that has accessibility focus we want it
                        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to get the event first and if not handled we will perform a
                        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; normal dispatch. We may do a double iteration but this is
                        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; safer given the timeframe.&lt;/span&gt;
                        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (childWithAccessibilityFocus != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (childWithAccessibilityFocus !=&lt;span style=&quot;color: #000000;&quot;&gt; child) {
                                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                            }
                            childWithAccessibilityFocus &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                            i &lt;/span&gt;= childrenCount - 1&lt;span style=&quot;color: #000000;&quot;&gt;;
                        }

                        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;canViewReceivePointerEvents(child)
                                &lt;/span&gt;|| !isTransformedTouchPointInView(x, y, child, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
                            ev.setTargetAccessibilityFocus(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
                            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                        }

                        newTouchTarget &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; getTouchTarget(child);
                        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (newTouchTarget != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Child is already receiving touch within its bounds.
                            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Give it the new pointer in addition to the ones it is handling.&lt;/span&gt;
                            newTouchTarget.pointerIdBits |=&lt;span style=&quot;color: #000000;&quot;&gt; idBitsToAssign;
                            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                        }

                        resetCancelNextUpFlag(child);
                        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (dispatchTransformedTouchEvent(ev, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, child, idBitsToAssign)) {
                            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Child wants to receive touch within its bounds.&lt;/span&gt;
                            mLastTouchDownTime =&lt;span style=&quot;color: #000000;&quot;&gt; ev.getDownTime();
                            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (preorderedList != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                                &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; childIndex points into presorted list, find original index&lt;/span&gt;
                                &lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; j = 0; j &amp;lt; childrenCount; j++&lt;span style=&quot;color: #000000;&quot;&gt;) {
                                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (children[childIndex] ==&lt;span style=&quot;color: #000000;&quot;&gt; mChildren[j]) {
                                        mLastTouchDownIndex &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; j;
                                        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                                    }
                                }
                            } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
                                mLastTouchDownIndex &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; childIndex;
                            }
                            mLastTouchDownX &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; ev.getX();
                            mLastTouchDownY &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; ev.getY();
                            newTouchTarget &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; addTouchTarget(child, idBitsToAssign);
                            alreadyDispatchedToNewTouchTarget &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                        }

                        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The accessibility focus didn&apos;t handle the event, so clear
                        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the flag and do a normal dispatch to all children.&lt;/span&gt;
                        ev.setTargetAccessibilityFocus(&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
                    }
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (preorderedList != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) preorderedList.clear();
                }

                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (newTouchTarget == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; mFirstTouchTarget != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Did not find a child to receive the event.
                    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Assign the pointer to the least recently added target.&lt;/span&gt;
                    newTouchTarget =&lt;span style=&quot;color: #000000;&quot;&gt; mFirstTouchTarget;
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; (newTouchTarget.next != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                        newTouchTarget &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; newTouchTarget.next;
                    }
                    newTouchTarget.pointerIdBits &lt;/span&gt;|=&lt;span style=&quot;color: #000000;&quot;&gt; idBitsToAssign;
                }
            }
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Dispatch to touch targets.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (mFirstTouchTarget == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; No touch targets so treat this as an ordinary view.&lt;/span&gt;
            handled = dispatchTransformedTouchEvent(ev, canceled, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
                    TouchTarget.ALL_POINTER_IDS);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Dispatch to touch targets, excluding the new touch target if we already
            &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; dispatched to it.  Cancel touch targets if necessary.&lt;/span&gt;
            TouchTarget predecessor = &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
            TouchTarget target &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mFirstTouchTarget;
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; (target != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; TouchTarget next =&lt;span style=&quot;color: #000000;&quot;&gt; target.next;
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (alreadyDispatchedToNewTouchTarget &amp;amp;&amp;amp; target ==&lt;span style=&quot;color: #000000;&quot;&gt; newTouchTarget) {
                    handled &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; cancelChild =&lt;span style=&quot;color: #000000;&quot;&gt; resetCancelNextUpFlag(target.child)
                            &lt;/span&gt;||&lt;span style=&quot;color: #000000;&quot;&gt; intercepted;
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (dispatchTransformedTouchEvent(ev, cancelChild,
                            target.child, target.pointerIdBits)) {
                        handled &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                    }
                    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (cancelChild) {
                        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (predecessor == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                            mFirstTouchTarget &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; next;
                        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
                            predecessor.next &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; next;
                        }
                        target.recycle();
                        target &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; next;
                        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
                    }
                }
                predecessor &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; target;
                target &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; next;
            }
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Update list of touch targets for pointer up or cancel, if needed.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (canceled
                &lt;/span&gt;|| actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_UP
                &lt;/span&gt;|| actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_HOVER_MOVE) {
            resetTouchState();
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (split &amp;amp;&amp;amp; actionMasked ==&lt;span style=&quot;color: #000000;&quot;&gt; MotionEvent.ACTION_POINTER_UP) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; actionIndex =&lt;span style=&quot;color: #000000;&quot;&gt; ev.getActionIndex();
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; idBitsToRemove = 1 &amp;lt;&amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt; ev.getPointerId(actionIndex);
            removePointersFromTouchTargets(idBitsToRemove);
        }
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!handled &amp;amp;&amp;amp; mInputEventConsistencyVerifier != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        mInputEventConsistencyVerifier.onUnhandledEvent(ev, &lt;/span&gt;1&lt;span style=&quot;color: #000000;&quot;&gt;);
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; handled;
}&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>ViewGroup 分发事件总结：&nbsp;</p>
<p>&nbsp;<strong>1.</strong> android的事件传递是先传递到父类，再到子类的。 <br><strong>&nbsp;2.</strong> ViewGroup中可以通过onInterceptTouchEvent方法对事件传递进行拦截，但是子View可以通过requestDisallowInterceptTouchEvent(boolean disallowIntercept)控制父类的拦截事件是否调用。 <br>&nbsp;<strong>3</strong>. 子View消耗掉点击事件后，父类onTouchEvent方法不会调用，子View不消耗点击事件，会传到父类onTouchEvent方法，父类onTouchEvent方法返回false，则最终传递到activity的onTouchEvent方法。 <br>&nbsp;<strong>4.</strong> ViewGroup一旦调用onInterceptTouchEvent方法拦截点击事件后，本次点击序列事件则都交于该ViewGroup处理，并且onInterceptTouchEvent将不再执行。<br>&nbsp;<strong>5.</strong> 当dispatchTouchEvent在进行事件分发的时候，只有前一个action返回true，才会触发下一个action.也就是说，子view 未消耗点击事件，dispatchTouchEvent返回false，这样mFirstTouchTarget =null，则后续action直接由ViewGroup执行，不传递给子View。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onInterceptTouchEvent(MotionEvent ev) {
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (ev.isFromSource(InputDevice.SOURCE_MOUSE)
                </span>&amp;&amp; ev.getAction() ==<span style="color: #000000;"> MotionEvent.ACTION_DOWN
                </span>&amp;&amp;<span style="color: #000000;"> ev.isButtonPressed(MotionEvent.BUTTON_PRIMARY)
                </span>&amp;&amp;<span style="color: #000000;"> isOnScrollbarThumb(ev.getX(), ev.getY())) {
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
        }
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;"> @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> requestDisallowInterceptTouchEvent(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> disallowIntercept) {

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (disallowIntercept == ((mGroupFlags &amp;amp; FLAG_DISALLOW_INTERCEPT) != 0&lt;span style=&quot;color: #000000;&quot;&gt;)) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We&apos;re already in this state, assume our ancestors are too&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (disallowIntercept) {
        mGroupFlags &lt;/span&gt;|=&lt;span style=&quot;color: #000000;&quot;&gt; FLAG_DISALLOW_INTERCEPT;
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        mGroupFlags &lt;/span&gt;&amp;amp;= ~&lt;span style=&quot;color: #000000;&quot;&gt;FLAG_DISALLOW_INTERCEPT;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Pass it up to our parent&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (mParent != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        mParent.requestDisallowInterceptTouchEvent(disallowIntercept);
    }
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h2>三.总结</h2>
<p>一张图介绍PhoneWindow,DecorView，Activity,ViewGroup,View 关系</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180715131417207-666045289.png" alt></p>
<p>在来一张图介绍下ViewGroup里的事件分发过程：（该图片来自https://www.jianshu.com/p/cf22ea3b09a5）</p>
<p>注：此图横着分析看，由上到下，由左到右。几个概念注意下 ：UserActivity(=Activiyt),ViewParent(=ViewGoup),ChildView(=View)。</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180715131456221-957174283.png" alt></p>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/14/Android8-0新特性介绍以及注意事项/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android8.0新特性介绍以及注意事项">
                
                <h1>Android8.0新特性介绍以及注意事项</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月14日</a>
            <a><i class="nexmoefont icon-areachart"></i>2.2k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 11 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/知识点/">知识点</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/Android/">Android</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/android8_new_features.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p>&nbsp; &nbsp; &nbsp; &nbsp; 2017年8月22日，谷歌正式发布了Android 8.0的正式版，其正式名称为：<strong>Android Oreo</strong>（奥利奥） 。在此之前 临时代号叫: <strong>Android O</strong>。对应Api level 为<strong>26</strong>。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; 2017年12月5日 , 谷歌正式发布了Android 8.1的正式版。对应的Api Level 为<strong>27</strong> 。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130336131-671377976.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Powerful 强大&nbsp; &nbsp; &nbsp; &nbsp;Secure 安全&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fast 流畅&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Smart&amp;seamiess&nbsp; 轻巧&amp;无缝</p>
<h1>Android 8.0 新特性:</h1>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.0版android系统主要聚焦点在电池续航能力,速度,安全.</p>
<h2>1.通知中心 -Notification Channel</h2>
<h3>&nbsp; &nbsp; &nbsp;1.1新特殊:</h3>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 用户在通知界面可以发现顶部的快捷键有了更充裕的空间，并且根据网络大数据的用户使用频繁度调整了这几个快捷键的顺序；并且长按推送消息可以看到一个开关，操作它可以开启和关闭这个该应用的未来所有通知。而如果向左滑动通知，则会出现两个开关，一个是设置该应用的具体通知规范，另一个可以设置让该应用的通知推迟一段时间推送。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 长按操作:<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130403972-1193902772.png" alt>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;向左滑动: &nbsp;&nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130422381-1707747781.png" alt><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130432545-721904404.png" alt></p>
<h3>&nbsp; &nbsp; &nbsp;1.2注意事项:</h3>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NotificationChannel是android8.0新增的特性，如果App的targetSDKVersion&gt;=26，没有设置channel通知渠道的话，就会导致通知无法展示。报错内容:<strong>&nbsp; Failed to post notification on channel “null” Target Api is 26</strong></p>
<h3>&nbsp; &nbsp; &nbsp;1.3 解决方案</h3>
<h4>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.3.1 临时方案</h4>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;临时兼容方案是设置targetSDKVersion低于26。</p>
<h4>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.3.2 最终方案</h4>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;创建通知渠道</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Step1:创建 NotificationChannel 对象，并设置应用内唯一的通知 ID。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Step2:配置通知渠道的属性，比如提示声音/震动等。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Step3:在 NotificationManager 中注册通知渠道对象。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130456453-97306205.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;扩展 了解:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;<a href="https://stackoverflow.com/questions/45711925/failed-to-post-notification-on-channel-null-target-api-is-26" target="_blank" rel="noopener">https://stackoverflow.com/questions/45711925/failed-to-post-notification-on-channel-null-target-api-is-26</a></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;<a href="https://www.jianshu.com/p/92afa56aee05" target="_blank" rel="noopener">https://www.jianshu.com/p/92afa56aee05</a></p>
<h2>2.PinnedShortcuts</h2>
<h3>&nbsp; &nbsp; &nbsp;2.1新特性</h3>
<p>&nbsp; &nbsp; &nbsp; &nbsp; 安卓创造出了PinnedShortcuts功能，类似苹果的3DTouch，长按一个软件后可以弹出子菜单，然后就可以通过这个方式快捷的使用该应用的部分功能。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; 自定义ShortCuts 是7.1牛轧糖(API Level 25)版本新增的.</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; Shortcuts是指在桌面长按app图标而出现的快捷方式，可以为你的app的关键功能添加更加快速的入口而不是先打开app。类似苹果的3D Touch。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; 点击快捷方式可以访问应用功能，而且这种快捷方式也可以被拖拽到桌面的单独位置，变成单独的左面快捷方式。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130520370-1116257844.png" alt><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130525067-1769221288.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如果删除” 支付宝”应用,再点击” 付款码”,会提示”未安装应用”,随后,系统自动删除掉”付款码”快捷方式.</p>
<h3>&nbsp; &nbsp; &nbsp;2.2注意事项</h3>
<p><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.</strong>最多创建4个特定的shortcuts：目前虽然说Static shortcuts 和Dynamic shortcuts之和最多为5个，但实际上只会显示4个。当我们尝试添加第六个shortcut时, 应用会抛出异常: Java.lang.IllegalArgumentException: Max number of dynamic shortcuts exceeded.</p>
<p><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.</strong>限制 Label 长度：其中shortcutShortLabel建议不超过 10 个字符，shortcutLongLabel 建议不超过 25 个字符。</p>
<p><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3.</strong>如何更好的删除(废弃)老的 Shortcut</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 这里主要考虑到删除老的 Shortcut，可能会影响已经固定的 Shortcut。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 对于静态 Shortcuts，直接删除配置文件中对应的 Shortcut 即可，系统桌面会将已固定的该 Shortcut 置灰，点击会提示 shortcutDisabledMessage。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 对于动态 Shortcuts 建议通过禁用的方式而不是直接删除的方式，因为已经删除的动态 Shortcut 如果被固定了依然是可用的，所以希望该入口不可用最好的方式是禁用。</p>
<h3>&nbsp; &nbsp; &nbsp;2.3 解决方案</h3>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130651974-2003571495.png" alt></p>
<h4>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.3.1静态快捷方式</h4>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130707338-635356109.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AndroidManifest.xml</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130733222-1243746562.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130741707-1997596608.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res/xml/shortcuts</p>
<h4>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.3.2动态快捷方式</h4>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130803753-1058198975.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130811151-987638283.png" alt></p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130841345-123303880.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ShortcutManager API可以帮助我们实现新建、更新、移除、禁用等快捷方式的操作.</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 扩展了解:&nbsp; &nbsp;<a href="https://www.jianshu.com/p/c10ea2bd5803" target="_blank" rel="noopener">https://www.jianshu.com/p/c10ea2bd5803</a></p>
<p>&nbsp;</p>
<h2>3.画中画</h2>
<h3>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3.1新特性</h3>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130900706-542659531.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130907952-164277144.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130916966-1253746177.png" alt></p>
<h3>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3.2 使用方法&nbsp;</h3>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130936884-710201620.png" alt></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;扩展了解:&nbsp;&nbsp;<a href="https://blog.csdn.net/ckwccc/article/details/79098602" target="_blank" rel="noopener">https://blog.csdn.net/ckwccc/article/details/79098602</a></p>
<h2>4.后台限制</h2>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Android 8.0将进一步优化后台程序，减少应用在没完全退出后占用系统的资源，并且减少电量的消耗。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714130956396-737551763.png" alt></p>
<p>&nbsp;&nbsp;</p>
<p><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 注意事项</strong>:&nbsp;使用常驻service时候需要注意权限问题.</p>
<p>&nbsp;</p>
<h2>5. 自动保存密码</h2>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 这个功能将会保存用户的部分帐号和密码，用于在网站或者应用中的快速登录，效率提升了不少 。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714131014555-1049141484.png" alt></p>
<p>&nbsp;</p>
<h2>6. 设置菜单</h2>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 在新的Android 8.0系统中，设置的界面有了大幅变化，主菜单的覆盖性变得更广，更多的功能将在子菜单中体现，并且在菜单界面中重新设计了很多图标。</p>
<p><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 注意</strong>: 各大厂商都做了优化,呈现的方式多少都有点不一致.</p>
<h2>7. 字体优化</h2>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Android 8.0系统中谷歌还增加了对系统字体的更多支持，开发者可以自行更改字体样式，让用户有了更多字体的选择。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Android 8.0 和 Android 支持库 26 允许您从提供程序应用请求字体，而无需将字体绑定到 APK 中或让 APK 下载字体。此功能可减小 APK 大小，提高应用安装成功率，使多个应用可以共享同一种字体。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;扩展了解:&nbsp;<a href="https://blog.csdn.net/IO_Field/article/details/78016411" target="_blank" rel="noopener">https://blog.csdn.net/IO_Field/article/details/78016411</a></p>
<h2>8. 表情符号</h2>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Android 8.0还带来了符合Unicode 10标准的表情符号，比原来新加超过60个表情符，这也是比较明显的改变之一。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180714131042984-1008393830.png" alt></p>
<p><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 注意</strong>: 表情符号在与ios表情符同步时候,可能表现不出来.</p>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/09/Android源码分析十Dalvik虚拟机创建过程/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 源码分析（十） Dalvik 虚拟机创建过程">
                
                <h1>Android 源码分析（十） Dalvik 虚拟机创建过程</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月09日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.8k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 9 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/dalvik.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一. 介绍Dalvik</h2>
<p>　　1.java的运行需要JVM,同样android中使用了java语言，也需要一个VM。针对手机处理器和内存等硬件资源不足而推出来的一款VM，为android运行提供环境，叫DVM。</p>
<p>　　2.Dalvik虚拟机允许多个instance的存在。实际上android中的每一个app都是运行在自己VM实例之中(沙盒)。每一个VM实例在linux中又是一个单独的进程，所以可以认为是同一个概念。运行在自己的DVM进程之中，不同的app不会相互干扰，且不会因为一个DVM的崩溃导致所有的app进程都崩溃。这点来说，<strong>Android dvm的进程和Linux的进程, 应用程序的进程 概念类似。</strong></p>
<p><strong>　　3.与<span style="color: #333300;"><strong><span style="font-family: Microsoft YaHei;">JVM的区别：</span></strong></span></strong></p>
<p><strong><span style="color: #333300;"><strong><span style="font-family: Microsoft YaHei;">　　　　</span></strong></span></strong><span style="color: #333300;"><span style="font-family: Microsoft YaHei;">1.基于架构的不同。JVM是基于栈的架构，而DVM是基于寄存器架构。</span></span></p>
<p><span style="color: #333300;"><span style="font-family: Microsoft YaHei;">　　　　2.jvm运行的是字节码文件，而dvm运行自己定义的dex文件格式。</span></span></p>
<p><span style="color: #333300;"><span style="font-family: Microsoft YaHei;">　　　　　　<span style="font-size: small;">JVM编译过程 java-&gt;class-&gt;jar</span><br><span style="font-size: small;">　　　　　　 DVM编译过程java-&gt;class-&gt;dex</span></span></span></p>
<p><span style="color: #333300;"><span style="font-family: Microsoft YaHei;"><span style="font-size: small;">　　　　总结dvm与jvm区别：</span></span></span><span style="color: #333300;"><span style="font-family: Microsoft YaHei;"><span style="font-size: small;">　　　　　</span></span></span></p>
<p>　　　　区别一：dvm执行的是.dex格式文件&nbsp; jvm执行的是.class文件&nbsp;&nbsp; android程序编译完之后生产.class文件，然后，dex工具会把.class文件处理成.dex文件，然后把资源文件和.dex文件等打包成.apk文件。apk就是android package的意思。 jvm执行的是.class文件。</p>
<p>&nbsp;</p>
<p>　　　　区别二:dvm是基于寄存器的虚拟机&nbsp; 而jvm执行是基于虚拟栈的虚拟机。寄存器存取速度比栈快的多，dvm可以根据硬件实现最大的优化，比较适合移动设备。</p>
<p>&nbsp;</p>
<p>　　　　区别三：.class文件存在很多的冗余信息，dex工具会去除冗余信息，并把所有的.class文件整合到.dex文件中。减少了I/O操作，提高了类的查找速度</p>
<p>　　　　</p>
<p>　　　　一张图了解dvm主要做的事：</p>
<p>　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180709210031356-2049035324.png" alt></p>
<p>　　　　参考：&nbsp;https://blog.csdn.net/u010355144/article/details/47682797</p>
<h2>二.Dalvik启动过程</h2>
<p>　　</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">AndroidRuntime.cpp</span>
<span style="color: #0000ff;">int</span> AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, <span style="color: #0000ff;">bool</span><span style="color: #000000;"> zygote)
{
    JavaVMInitArgs initArgs;
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> propBuf[PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> stackTraceFileBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xstacktracefile:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jniOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjniopts:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapstartsizeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xms</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapsizeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xmx</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapgrowthlimitOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:HeapGrowthLimit=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapminfreeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:HeapMinFree=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heapmaxfreeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:HeapMaxFree=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> usejitOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xusejit:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jitmaxsizeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitmaxsize:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jitinitialsizeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitinitialsize:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jitthresholdOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitthreshold:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> useJitProfilesOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitsaveprofilinginfo:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jitprithreadweightOptBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjitprithreadweight:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> jittransitionweightOptBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xjittransitionweight:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> gctypeOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xgc:</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> backgroundgcOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:BackgroundGC=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> heaptargetutilizationOptsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-XX:HeapTargetUtilization=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> cachePruneBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xzygote-max-boot-retry=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatXmsImageFlagsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xms</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatXmxImageFlagsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xmx</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatXmsFlagsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xms</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatXmxFlagsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-Xmx</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatCompilerFilterBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">--compiler-filter=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatImageCompilerFilterBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">--compiler-filter=</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatThreadsBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-j</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oatThreadsImageBuf[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">-j</span><span style="color: #800000;">"</span>)-<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> dex2oat_isa_variant_key[PROPERTY_KEY_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oat_isa_variant[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">--instruction-set-variant=</span><span style="color: #800000;">"</span>) -<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> dex2oat_isa_features_key[PROPERTY_KEY_MAX];
    </span><span style="color: #0000ff;">char</span> dex2oat_isa_features[<span style="color: #0000ff;">sizeof</span>(<span style="color: #800000;">"</span><span style="color: #800000;">--instruction-set-features=</span><span style="color: #800000;">"</span>) -<span style="color: #800080;">1</span> +<span style="color: #000000;"> PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> dex2oatFlagsBuf[PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> dex2oatImageFlagsBuf[PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> extraOptsBuf[PROPERTY_VALUE_MAX];
    </span><span style="color: #0000ff;">char</span><span style="color: #000000;"> voldDecryptBuf[PROPERTY_VALUE_MAX];
    ...

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Initialize the VM.
 *
 * The JavaVM* is essentially per-process, and the JNIEnv* is per-thread.
 * If this call succeeds, the VM is ready, and we can start issuing
 * JNI calls.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;amp;initArgs) &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;JNI_CreateJavaVM failed\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>}</p>
<p></p></span><span style="color: #0000ff;">void</span> AndroidRuntime::start(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>* className, <span style="color: #0000ff;">const</span> Vector&lt;String8&gt;&amp; options, <span style="color: #0000ff;">bool</span><span style="color: #000000;"> zygote)<br>{<p></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; start the virtual machine &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
JniInvocation jni_invocation;
jni_invocation.Init(NULL);
JNIEnv&lt;/span&gt;*&lt;span style=&quot;color: #000000;&quot;&gt; env;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (startVm(&amp;amp;mJavaVM, &amp;amp;env, zygote) != &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}
onVmCreated(env);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Register android functions.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (startReg(env) &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;Unable to register all android natives\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}</code></pre><p>}<br><br><span style="color: #339966;">　　　　　//Dalvik虚拟机在Zygote进程中的启动过程，这个启动过程主要就是完成了以下四个事情：</span><br><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; //1. 创建了一个Dalvik虚拟机实例；</span><br><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; //2. 加载了Java核心类及其JNI方法；</span><br><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; //3. 为主线程的设置了一个JNI环境；</span><br><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; //4. 注册了Android核心类的JNI方法。</span><br></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p><strong>Zygote 启动Dalvik作用：</strong></p>
<p>　　1. Zygote进程为Android系统准备好了一个Dalvik虚拟机实例，以后Zygote进程在创建Android应用程序进程的时候，就可以将它自身的Dalvik虚拟机实例复制到新创建Android应用程序进程中去，从而加快了Android应用程序进程的启动过程。</p>
<p><br>　　2.Java核心类和Android核心类（位于dex文件中），以及它们的JNI方法（位于so文件中），都是以内存映射的方式来读取的，因此，Zygote进程在创建Android应用程序进程的时候，除了可以将自身的Dalvik虚拟机实例复制到新创建的Android应用程序进程之外，还可以与新创建的Android应用程序进程共享Java核心类和Android核心类，以及它们的JNI方法，这样就可以节省内存消耗。</p>
<p><br>　　3.Zygote进程为了加快Android应用程序进程的启动过程，牺牲了自己的启动速度，因为它需要加载大量的Java核心类，以及注册大量的Android核心类JNI方法。Dalvik虚拟机在加载Java核心类的时候，还需要对它们进行验证以及优化，这些通常都是比较耗时的。又由于Zygote进程是由init进程启动的，也就是说Zygote进程在是开机的时候进行启动的，因此，Zygote进程的牺牲是比较大的。不过毕竟我们在玩手机的时候，很少会关机，也就是很少开机，因此，牺牲Zygote进程的启动速度是值得的，换来的是Android应用程序的快速启动。</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/08/Android源码分析九Init启动分析/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 源码分析（九） Init 启动分析">
                
                <h1>Android 源码分析（九） Init 启动分析</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月08日</a>
            <a><i class="nexmoefont icon-areachart"></i>6.6k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 40 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/init.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.前言:&nbsp;&nbsp;&nbsp;</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用</p>
<h3>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；</h3>
<p>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；</p>
<p>&nbsp;&nbsp;&nbsp; SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.</p>
<h2><br>二. init 进程分析</h2>
<p>&nbsp;linux的根进程,同样也是守护进程，usb连接电脑后，cmd窗口，输入：adb shell ps 命令，能看到手机系统中当前跑的所有进程，有一个init进程。<br>&nbsp;init进程主要任务：</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180708230407266-1488130940.png" alt></p>
<p>&nbsp;</p>
<p>源码：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">system/core/init/init.cpp

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;1.创建目录
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;2.将log重定向
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;3.初始化环境变量
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;4.得到硬件信息和版本
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;5.解析内核启动参数
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;6.导入默认环境变量
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;7.得到系统分区&lt;/span&gt;</code></pre><p><span style="color: #0000ff;">int</span> main(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span>**<span style="color: #000000;"> argv) {<br>    </span><span style="color: #0000ff;">if</span> (!strcmp(basename(argv[<span style="color: #800080;">0</span>]), <span style="color: #800000;">“</span><span style="color: #800000;">ueventd</span><span style="color: #800000;">“</span><span style="color: #000000;">)) {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> ueventd_main(argc, argv);<br>    }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!strcmp(basename(argv[&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;]), &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;watchdogd&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; watchdogd_main(argc, argv);
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (REBOOT_BOOTLOADER_ON_PANIC) {
    install_reboot_signal_handlers();
}

add_environment(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;PATH&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, _PATH_DEFPATH);

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;bool&lt;/span&gt; is_first_stage = (getenv(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_SECOND_STAGE&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;) ==&lt;span style=&quot;color: #000000;&quot;&gt; nullptr);

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (is_first_stage) {
    boot_clock::time_point start_time &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; boot_clock::now();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Clear the umask.&lt;/span&gt;
    umask(&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Get the basic filesystem setup we need put together in the initramdisk
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; on / and then we&apos;ll let the rc file figure out the rest.&lt;/span&gt;
    mount(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;tmpfs&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;tmpfs&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, MS_NOSUID, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;mode=0755&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mkdir(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/pts&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;0755&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mkdir(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/socket&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;0755&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mount(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;devpts&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/pts&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;devpts&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, NULL);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#define&lt;/span&gt; MAKE_STR(x) __STRING(x)&lt;span style=&quot;color: #000000;&quot;&gt;
    mount(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;proc&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/proc&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;proc&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;hidepid=2,gid=&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; MAKE_STR(AID_READPROC));
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Don&apos;t expose the raw commandline to unprivileged processes.&lt;/span&gt;
    chmod(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/proc/cmdline&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;0440&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    gid_t groups[] &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; { AID_READPROC };
    setgroups(arraysize(groups), groups);
    mount(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;sysfs&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/sys&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;sysfs&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, NULL);
    mount(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;selinuxfs&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/sys/fs/selinux&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;selinuxfs&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, NULL);
    mknod(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/kmsg&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, S_IFCHR | &lt;span style=&quot;color: #800080;&quot;&gt;0600&lt;/span&gt;, makedev(&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;11&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
    mknod(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/random&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, S_IFCHR | &lt;span style=&quot;color: #800080;&quot;&gt;0666&lt;/span&gt;, makedev(&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;8&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
    mknod(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/urandom&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, S_IFCHR | &lt;span style=&quot;color: #800080;&quot;&gt;0666&lt;/span&gt;, makedev(&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;9&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; talk to the outside world...&lt;/span&gt;</code></pre><p><span style="color: #000000;">        InitKernelLogging(argv);</span></p>
<pre><code>    LOG(INFO) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;init first stage started!&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;DoFirstStageMount()) {
        LOG(ERROR) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;Failed to mount required partitions early ...&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        panic();
    }

    SetInitAvbVersionInRecovery();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Set up SELinux, loading the SELinux policy.&lt;/span&gt;
    selinux_initialize(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We&apos;re in the kernel domain, so re-exec init to transition to the init domain now
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; that the SELinux policy has been loaded.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (restorecon(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;) == -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        PLOG(ERROR) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;restorecon failed&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        security_failure();
    }

    setenv(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_SECOND_STAGE&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;static&lt;/span&gt; constexpr uint32_t kNanosecondsPerMillisecond =&lt;span style=&quot;color: #000000;&quot;&gt; 1e6;
    uint64_t start_ms &lt;/span&gt;= start_time.time_since_epoch().count() /&lt;span style=&quot;color: #000000;&quot;&gt; kNanosecondsPerMillisecond;
    setenv(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_STARTED_AT&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, StringPrintf(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;%&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; PRIu64, start_ms).c_str(), &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;char&lt;/span&gt;* path = argv[&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;];
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;char&lt;/span&gt;* args[] =&lt;span style=&quot;color: #000000;&quot;&gt; { path, nullptr };
    execv(path, args);

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; execv() only returns if an error happened, in which case we
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; panic and never fall through this conditional.&lt;/span&gt;
    PLOG(ERROR) &amp;lt;&amp;lt; &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;execv(\&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; &amp;lt;&amp;lt; path &amp;lt;&amp;lt; &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;\&quot;) failed&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    security_failure();
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; At this point we&apos;re in the second stage of init.&lt;/span&gt;</code></pre><p><span style="color: #000000;">    InitKernelLogging(argv);<br>    LOG(INFO) </span>&lt;&lt; <span style="color: #800000;">“</span><span style="color: #800000;">init second stage started!</span><span style="color: #800000;">“</span><span style="color: #000000;">;</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Set up a session keyring that all processes will have access to. It
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; will hold things like FBE encryption keys. No process should override
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; its session keyring.&lt;/span&gt;
keyctl(KEYCTL_GET_KEYRING_ID, KEY_SPEC_SESSION_KEYRING, &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Indicate that booting is in progress to background fw loaders, etc.&lt;/span&gt;
close(open(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/.booting&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, O_WRONLY | O_CREAT | O_CLOEXEC, &lt;span style=&quot;color: #800080;&quot;&gt;0000&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));

property_init();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If arguments are passed both on the command line and in DT,
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; properties set in DT always have priority over the command-line ones.&lt;/span&gt;</code></pre><p><span style="color: #000000;">    process_kernel_dt();<br>    process_kernel_cmdline();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Propagate the kernel variables to internal variables
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; used by init as well as the current required properties.&lt;/span&gt;</code></pre><p><span style="color: #000000;">    export_kernel_boot_props();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Make the time that init started available for bootstat to log.&lt;/span&gt;
property_set(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;ro.boottime.init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, getenv(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_STARTED_AT&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
property_set(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;ro.boottime.init.selinux&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, getenv(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_SELINUX_TOOK&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Set libavb version for Framework-only OTA match in Treble build.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;const&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;char&lt;/span&gt;* avb_version = getenv(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_AVB_VERSION&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (avb_version) property_set(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;ro.boot.avb_version&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, avb_version);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Clean up our environment.&lt;/span&gt;
unsetenv(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_SECOND_STAGE&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
unsetenv(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_STARTED_AT&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
unsetenv(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_SELINUX_TOOK&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
unsetenv(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;INIT_AVB_VERSION&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Now set up SELinux for second stage.&lt;/span&gt;
selinux_initialize(&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
selinux_restore_context();

epoll_fd &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; epoll_create1(EPOLL_CLOEXEC);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (epoll_fd == -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    PLOG(ERROR) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;epoll_create1 failed&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    exit(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

signal_handler_init();

property_load_boot_defaults();
export_oem_lock_status();
start_property_service();
set_usb_controller();

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;const&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; BuiltinFunctionMap function_map;
Action::set_function_map(&lt;/span&gt;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;function_map);

Parser&lt;/span&gt;&amp;amp; parser =&lt;span style=&quot;color: #000000;&quot;&gt; Parser::GetInstance();
parser.AddSectionParser(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;service&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;,std::make_unique&amp;lt;ServiceParser&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;());
parser.AddSectionParser(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;on&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, std::make_unique&amp;lt;ActionParser&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;());
parser.AddSectionParser(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, std::make_unique&amp;lt;ImportParser&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;());
std::&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;string&lt;/span&gt; bootscript = GetProperty(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;ro.boot.init_rc&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (bootscript.empty()) {
    parser.ParseConfig(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/init.rc&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    parser.set_is_system_etc_init_loaded(
            parser.ParseConfig(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/system/etc/init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
    parser.set_is_vendor_etc_init_loaded(
            parser.ParseConfig(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/vendor/etc/init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
    parser.set_is_odm_etc_init_loaded(parser.ParseConfig(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/odm/etc/init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    parser.ParseConfig(bootscript);
    parser.set_is_system_etc_init_loaded(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    parser.set_is_vendor_etc_init_loaded(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    parser.set_is_odm_etc_init_loaded(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Turning this on and letting the INFO logging be discarded adds 0.2s to
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Nexus 9 boot time, so it&apos;s disabled by default.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) parser.DumpState();

ActionManager&lt;/span&gt;&amp;amp; am =&lt;span style=&quot;color: #000000;&quot;&gt; ActionManager::GetInstance();

am.QueueEventTrigger(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;early-init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...&lt;/span&gt;
am.QueueBuiltinAction(wait_for_coldboot_done_action, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;wait_for_coldboot_done&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; ... so that we can start queuing up actions that require stuff from /dev.&lt;/span&gt;
am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;mix_hwrng_into_linux_rng&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
am.QueueBuiltinAction(set_mmap_rnd_bits_action, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;set_mmap_rnd_bits&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
am.QueueBuiltinAction(set_kptr_restrict_action, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;set_kptr_restrict&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
am.QueueBuiltinAction(keychord_init_action, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;keychord_init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
am.QueueBuiltinAction(console_init_action, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;console_init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Trigger all the boot actions to get us started.&lt;/span&gt;
am.QueueEventTrigger(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; wasn&apos;t ready immediately after wait_for_coldboot_done&lt;/span&gt;
am.QueueBuiltinAction(mix_hwrng_into_linux_rng_action, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;mix_hwrng_into_linux_rng&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Don&apos;t mount filesystems or start core system services in charger mode.&lt;/span&gt;
std::&lt;span style=&quot;color: #0000ff;&quot;&gt;string&lt;/span&gt; bootmode = GetProperty(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;ro.bootmode&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (bootmode == &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;charger&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    am.QueueEventTrigger(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;charger&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    am.QueueEventTrigger(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;late-init&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Run all property triggers based on current state of the properties.&lt;/span&gt;
am.QueueBuiltinAction(queue_property_triggers_action, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;queue_property_triggers&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; By default, sleep until something happens.&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; epoll_timeout_ms = -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!(waiting_for_prop ||&lt;span style=&quot;color: #000000;&quot;&gt; ServiceManager::GetInstance().IsWaitingForExec())) {
        am.ExecuteOneCommand();
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!(waiting_for_prop ||&lt;span style=&quot;color: #000000;&quot;&gt; ServiceManager::GetInstance().IsWaitingForExec())) {
        restart_processes();

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If there&apos;s a process that needs restarting, wake up in time for that.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (process_needs_restart_at != &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            epoll_timeout_ms &lt;/span&gt;= (process_needs_restart_at - time(nullptr)) * &lt;span style=&quot;color: #800080;&quot;&gt;1000&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (epoll_timeout_ms &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;) epoll_timeout_ms = &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If there&apos;s more work to do, wake up again immediately.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (am.HasMoreCommands()) epoll_timeout_ms = &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    epoll_event ev;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; nr = TEMP_FAILURE_RETRY(epoll_wait(epoll_fd, &amp;amp;ev, &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, epoll_timeout_ms));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (nr == -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        PLOG(ERROR) &lt;/span&gt;&amp;lt;&amp;lt; &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;epoll_wait failed&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (nr == &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        ((&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; (*&lt;span style=&quot;color: #000000;&quot;&gt;)()) ev.data.ptr)();
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/07/Android源码分析八Launcher桌面启动App过程/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 源码分析（八） Launcher 桌面启动App过程">
                
                <h1>Android 源码分析（八） Launcher 桌面启动App过程</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月07日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.5k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 8 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/Launcher_app.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.<br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. Launcher 桌面启动App过程分析</h2>
<p>Launcher应用程序在启动过程中会通过PackageManagerService服务请求查询系统所有的已安装应用的包名，图标和应用名称等信息，然后填充到Launcher中的Adapter中.<br>这样点击某一项应用图标的时候就可以根据该图标的包名和启动Activity的类名初始化Intent对象，然后调用startActivity(Intent)启动相关的应用程序了。<br>其实android中应用进程可以通过许多方式启动，比如启动一个Activity，启动一个Service，启动一个ContentProvider或者是一个BroadcastReceiver，也就是说我们可以通过启动四大组件的方式启动应用进程，在应用进程没有启动的时候，如果我们通过启动这些组件，这时候系统会判断当前这些组件所需要的应用进程是否已经启动，若没有的话，则会启动应用进程。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">LauncherActivity.java</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> LauncherActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ListActivity {
    ......
    @Override
    </span><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onListItemClick(ListView l, View v, <span style="color: #0000ff;">int</span> position, <span style="color: #0000ff;">long</span><span style="color: #000000;"> id) {
        Intent intent </span>=<span style="color: #000000;"> intentForPosition(position);
        startActivity(intent);
    }
    ......

<pre><code>@Override
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startActivity(Intent intent) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;.startActivity(intent, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
}
......
 @Override
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startActivity(Intent intent, @Nullable Bundle options) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (options != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        startActivityForResult(intent, &lt;/span&gt;-1&lt;span style=&quot;color: #000000;&quot;&gt;, options);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Note we want to go through this call for compatibility with
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; applications that may have overridden the method.&lt;/span&gt;
        startActivityForResult(intent, -1&lt;span style=&quot;color: #000000;&quot;&gt;);
    }
}
......
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Adapter which shows the set of activities that can be performed for a given intent.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt; ActivityAdapter &lt;span style=&quot;color: #0000ff;&quot;&gt;extends&lt;/span&gt; BaseAdapter &lt;span style=&quot;color: #0000ff;&quot;&gt;implements&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Filterable {
    ......
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; View getView(&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; position, View convertView, ViewGroup parent) {
        View view;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (convertView == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            view &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mInflater.inflate(
                    com.android.internal.R.layout.activity_list_item_2, parent, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            view &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; convertView;
        }
        bindView(view, mActivitiesList.get(position));
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; view;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; bindView(View view, ListItem item) {
        TextView text &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; (TextView) view;
        text.setText(item.label);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (mShowIcons) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (item.icon == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
                item.icon &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mIconResizer.createIconThumbnail(item.resolveInfo.loadIcon(getPackageManager()));
            }
            text.setCompoundDrawablesWithIntrinsicBounds(item.icon, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        }
    }
    ......
}</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">activity_list.xml Launcher 桌面就是一个列表控件，来存放所有应用的图标和名称</span>
&lt;FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"<span style="color: #000000;">
    android:layout_width</span>="match_parent"<span style="color: #000000;">
    android:layout_height</span>="match_parent"
    &gt;

<pre><code>&amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt;ListView
    android:id&lt;/span&gt;=&quot;@android:id/list&quot;&lt;span style=&quot;color: #000000;&quot;&gt;
    android:layout_width&lt;/span&gt;=&quot;match_parent&quot;&lt;span style=&quot;color: #000000;&quot;&gt;
    android:layout_height&lt;/span&gt;=&quot;match_parent&quot;
    /&amp;gt;

&amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt;TextView
    android:id&lt;/span&gt;=&quot;@android:id/empty&quot;&lt;span style=&quot;color: #000000;&quot;&gt;
    android:layout_width&lt;/span&gt;=&quot;match_parent&quot;&lt;span style=&quot;color: #000000;&quot;&gt;
    android:layout_height&lt;/span&gt;=&quot;match_parent&quot;&lt;span style=&quot;color: #000000;&quot;&gt;
    android:gravity&lt;/span&gt;=&quot;center&quot;&lt;span style=&quot;color: #000000;&quot;&gt;
    android:text&lt;/span&gt;=&quot;@string/activity_list_empty&quot;&lt;span style=&quot;color: #000000;&quot;&gt;
    android:visibility&lt;/span&gt;=&quot;gone&quot;&lt;span style=&quot;color: #000000;&quot;&gt;
    android:textAppearance&lt;/span&gt;=&quot;?android:attr/textAppearanceMedium&quot;
    /&amp;gt;</code></pre><p>&lt;/FrameLayout&gt;</p></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">activity_list_item_2.xml 列表控件的子项，存放应用名称和应用logo。drawablePadding="14dip".</span>
&lt;TextView xmlns:android="http://schemas.android.com/apk/res/android"<span style="color: #000000;">
    android:layout_width</span>="match_parent"<span style="color: #000000;">
    android:layout_height</span>="wrap_content"<span style="color: #000000;">
    android:minHeight</span>="?attr/listPreferredItemHeight"<span style="color: #000000;">
    android:textAppearance</span>="?attr/textAppearanceListItemSmall"<span style="color: #000000;">
    android:gravity</span>="center_vertical"<span style="color: #000000;">
    android:drawablePadding</span>="14dip"<span style="color: #000000;">
    android:paddingStart</span>="?attr/listPreferredItemPaddingStart"<span style="color: #000000;">
    android:paddingEnd</span>="?attr/listPreferredItemPaddingEnd" /&gt;</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>后面就进入了Activity的启动流程了。</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/07/Android源码分析七Launcher桌面程序启动分析/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 源码分析（七） Launcher 桌面程序启动分析">
                
                <h1>Android 源码分析（七） Launcher 桌面程序启动分析</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月07日</a>
            <a><i class="nexmoefont icon-areachart"></i>4.4k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 26 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/Launcher.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;<strong>Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序</strong>.<strong>在Zygote进程里等待SystemService进程启动后，创建.</strong><br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. Launcher 桌面程序启动</h2>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Launcher程序就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序。</p>
<p>　　首先了解下，Zygote进程是如何启动一个应用的。</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180708235023116-19887742.png" alt></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteServer.java</span>
 <span style="color: #0000ff;">void</span> runSelectLoop(String abiList) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller {
        ArrayList</span>&lt;FileDescriptor&gt; fds = <span style="color: #0000ff;">new</span> ArrayList&lt;FileDescriptor&gt;<span style="color: #000000;">();
        ArrayList</span>&lt;ZygoteConnection&gt; peers = <span style="color: #0000ff;">new</span> ArrayList&lt;ZygoteConnection&gt;<span style="color: #000000;">();

<pre><code>    fds.add(mServerSocket.getFileDescriptor());
    peers.add(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        StructPollfd[] pollFds &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; StructPollfd[fds.size()];
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; pollFds.length; ++&lt;span style=&quot;color: #000000;&quot;&gt;i) {
            pollFds[i] &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; StructPollfd();
            pollFds[i].fd &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; fds.get(i);
            pollFds[i].events &lt;/span&gt;= (&lt;span style=&quot;color: #0000ff;&quot;&gt;short&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) POLLIN;
        }
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            Os.poll(pollFds, &lt;/span&gt;-1&lt;span style=&quot;color: #000000;&quot;&gt;);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ErrnoException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;poll failed&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        }
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; i = pollFds.length - 1; i &amp;gt;= 0; --&lt;span style=&quot;color: #000000;&quot;&gt;i) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; ((pollFds[i].revents &amp;amp; POLLIN) == 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;continue&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
            }
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (i == 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
                ZygoteConnection newPeer &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; acceptCommandPeer(abiList);
                peers.add(newPeer);
                fds.add(newPeer.getFileDesciptor());
            } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; done = peers.get(i).runOnce(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (done) {
                    peers.remove(i);
                    fds.remove(i);
                }
            }
        }
    }
}</code></pre><p>}<br><br>　　/**<br>&nbsp;&nbsp;&nbsp;&nbsp; * Waits for and accepts a single command connection. Throws<br>&nbsp;&nbsp;&nbsp;&nbsp; * RuntimeException on failure.<br>&nbsp;&nbsp;&nbsp;&nbsp; */<br>&nbsp;&nbsp;&nbsp; private ZygoteConnection acceptCommandPeer(String abiList) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return createNewConnection(mServerSocket.accept(), abiList);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (IOException ex) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new RuntimeException(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; “IOException during accept()”, ex);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;<br>&nbsp;protected ZygoteConnection createNewConnection(LocalSocket socket, String abiList)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throws IOException {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new ZygoteConnection(socket, abiList);<br>&nbsp;&nbsp;&nbsp; }<br></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('b4582d4a-5eee-42a1-a93e-5858a6f4d479')"><img id="code_img_closed_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('b4582d4a-5eee-42a1-a93e-5858a6f4d479',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_b4582d4a-5eee-42a1-a93e-5858a6f4d479" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteConnection.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Constructs instance from connected socket.
     *
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> socket non-null; connected socket
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> abiList non-null; a list of ABIs this zygote supports.
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IOException
     </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    ZygoteConnection(LocalSocket socket, String abiList) </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
        mSocket </span>=<span style="color: #000000;"> socket;
        </span><span style="color: #0000ff;">this</span>.abiList =<span style="color: #000000;"> abiList;

<pre><code>    mSocketOutStream
            &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; DataOutputStream(socket.getOutputStream());

    mSocketReader &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; BufferedReader(
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; InputStreamReader(socket.getInputStream()), 256&lt;span style=&quot;color: #000000;&quot;&gt;);

    mSocket.setSoTimeout(CONNECTION_TIMEOUT_MILLIS);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        peer &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSocket.getPeerCredentials();
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IOException ex) {
        Log.e(TAG, &lt;/span&gt;&quot;Cannot read peer credentials&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ex;
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Reads one start command from the command socket. If successful,
 * a child is forked and a {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Zygote.MethodAndArgsCaller}
 * exception is thrown in that child while in the parent process,
 * the method returns normally. On failure, the child is not
 * spawned and messages are printed to the log and stderr. Returns
 * a boolean status value indicating whether an end-of-file on the command
 * socket has been encountered.
 *
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; false if command socket should continue to be read from, or
 * true if an end-of-file has been encountered.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@throws&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Zygote.MethodAndArgsCaller trampoline to invoke main()
 * method in child process
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; runOnce(ZygoteServer zygoteServer) &lt;span style=&quot;color: #0000ff;&quot;&gt;throws&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Zygote.MethodAndArgsCaller {

    String args[];
    Arguments parsedArgs &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    FileDescriptor[] descriptors;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        args &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; readArgumentList();
        descriptors &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSocket.getAncillaryFileDescriptors();
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IOException ex) {
        Log.w(TAG, &lt;/span&gt;&quot;IOException on command socket &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; ex.getMessage());
        closeSocket();
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (args == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; EOF reached.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            closeSocket();<br>            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the stderr of the most recent request, if avail &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
PrintStream newStderr &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (descriptors != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; descriptors.length &amp;gt;= 3&lt;span style=&quot;color: #000000;&quot;&gt;) {
    newStderr &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; PrintStream(
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; FileOutputStream(descriptors[2&lt;span style=&quot;color: #000000;&quot;&gt;]));
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; pid = -1&lt;span style=&quot;color: #000000;&quot;&gt;;
FileDescriptor childPipeFd &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
FileDescriptor serverPipeFd &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    parsedArgs &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Arguments(args);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (parsedArgs.abiListQuery) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; handleAbiListQuery();
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (parsedArgs.preloadDefault) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; handlePreload();
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (parsedArgs.preloadPackage != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; handlePreloadPackage(parsedArgs.preloadPackage,
                parsedArgs.preloadPackageLibs, parsedArgs.preloadPackageCacheKey);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (parsedArgs.permittedCapabilities != 0 || parsedArgs.effectiveCapabilities != 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; ZygoteSecurityException(&quot;Client may not specify capabilities: &quot; +
                &quot;permitted=0x&quot; + Long.toHexString(parsedArgs.permittedCapabilities) +
                &quot;, effective=0x&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; Long.toHexString(parsedArgs.effectiveCapabilities));
    }

    applyUidSecurityPolicy(parsedArgs, peer);
    applyInvokeWithSecurityPolicy(parsedArgs, peer);

    applyDebuggerSystemProperty(parsedArgs);
    applyInvokeWithSystemProperty(parsedArgs);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;[][] rlimits = &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (parsedArgs.rlimits != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        rlimits &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; parsedArgs.rlimits.toArray(intArray2d);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;[] fdsToIgnore = &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (parsedArgs.invokeWith != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        FileDescriptor[] pipeFds &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; Os.pipe2(O_CLOEXEC);
        childPipeFd &lt;/span&gt;= pipeFds[1&lt;span style=&quot;color: #000000;&quot;&gt;];
        serverPipeFd &lt;/span&gt;= pipeFds[0&lt;span style=&quot;color: #000000;&quot;&gt;];
        Os.fcntlInt(childPipeFd, F_SETFD, &lt;/span&gt;0&lt;span style=&quot;color: #000000;&quot;&gt;);
        fdsToIgnore &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;[] { childPipeFd.getInt$(), serverPipeFd.getInt$() };
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
     * In order to avoid leaking descriptors to the Zygote child,
     * the native code must close the two Zygote socket descriptors
     * in the child process before it switches from Zygote-root to
     * the UID and privileges of the application being launched.
     *
     * In order to avoid &quot;bad file descriptor&quot; errors when the
     * two LocalSocket objects are closed, the Posix file
     * descriptors are released via a dup2() call which closes
     * the socket and substitutes an open descriptor to /dev/null.
     &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;

    &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; [] fdsToClose = { -1, -1&lt;span style=&quot;color: #000000;&quot;&gt; };

    FileDescriptor fd &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSocket.getFileDescriptor();

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (fd != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        fdsToClose[&lt;/span&gt;0] =&lt;span style=&quot;color: #000000;&quot;&gt; fd.getInt$();
    }

    fd &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; zygoteServer.getServerSocketFileDescriptor();

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (fd != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        fdsToClose[&lt;/span&gt;1] =&lt;span style=&quot;color: #000000;&quot;&gt; fd.getInt$();
    }

    fd &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

    pid &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,
            parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,
            parsedArgs.niceName, fdsToClose, fdsToIgnore, parsedArgs.instructionSet,
            parsedArgs.appDataDir);
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ErrnoException ex) {
    logAndPrintError(newStderr, &lt;/span&gt;&quot;Exception creating pipe&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IllegalArgumentException ex) {
    logAndPrintError(newStderr, &lt;/span&gt;&quot;Invalid zygote arguments&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ZygoteSecurityException ex) {
    logAndPrintError(newStderr,
            &lt;/span&gt;&quot;Zygote security policy prevents request: &quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (pid == 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; in child&lt;/span&gt;</code></pre><p><span style="color: #000000;">                zygoteServer.closeServerSocket();<br>                IoUtils.closeQuietly(serverPipeFd);<br>                serverPipeFd </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; should never get here, the child is expected to either
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; throw Zygote.MethodAndArgsCaller or exec().&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; in parent...pid of &amp;lt; 0 means failure&lt;/span&gt;</code></pre><p><span style="color: #000000;">                IoUtils.closeQuietly(childPipeFd);<br>                childPipeFd </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);<br>            }<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            IoUtils.closeQuietly(childPipeFd);<br>            IoUtils.closeQuietly(serverPipeFd);<br>        }<br>    }<br>    </span></p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('24047af0-fb9d-4495-955a-61ae30e0b7ac')"><img id="code_img_closed_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('24047af0-fb9d-4495-955a-61ae30e0b7ac',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_24047af0-fb9d-4495-955a-61ae30e0b7ac" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">Zygote.java</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> forkAndSpecialize(<span style="color: #0000ff;">int</span> uid, <span style="color: #0000ff;">int</span> gid, <span style="color: #0000ff;">int</span>[] gids, <span style="color: #0000ff;">int</span><span style="color: #000000;"> debugFlags,
          </span><span style="color: #0000ff;">int</span>[][] rlimits, <span style="color: #0000ff;">int</span> mountExternal, String seInfo, String niceName, <span style="color: #0000ff;">int</span><span style="color: #000000;">[] fdsToClose,
          </span><span style="color: #0000ff;">int</span><span style="color: #000000;">[] fdsToIgnore, String instructionSet, String appDataDir) {
        VM_HOOKS.preFork();
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Resets nice priority for zygote process.</span>
<span style="color: #000000;">        resetNicePriority();
        </span><span style="color: #0000ff;">int</span> pid =<span style="color: #000000;"> nativeForkAndSpecialize(
                  uid, gid, gids, debugFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,
                  fdsToIgnore, instructionSet, appDataDir);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Enable tracing as soon as possible for the child process.</span>
        <span style="color: #0000ff;">if</span> (pid == 0<span style="color: #000000;">) {
            Trace.setTracingEnabled(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);

<pre><code>        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Note that this event ends at the end of handleChildProc,&lt;/span&gt;
        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;PostFork&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    }
    VM_HOOKS.postForkCommon();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; pid;
}&lt;/span&gt;&lt;/pre&gt;</code></pre></span></pre></div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('585017ee-5c61-4dd0-b78d-a900abceb71c')"><img id="code_img_closed_585017ee-5c61-4dd0-b78d-a900abceb71c" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_585017ee-5c61-4dd0-b78d-a900abceb71c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('585017ee-5c61-4dd0-b78d-a900abceb71c',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_585017ee-5c61-4dd0-b78d-a900abceb71c" class="cnblogs_code_hide">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteConnection.java</span>
    <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Handles post-fork setup of child proc, closing sockets as appropriate,
     * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller
     * if successful or returning if failed.
     *
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> parsedArgs non-null; zygote args
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> descriptors null-ok; new file descriptors for stdio if available.
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> pipeFd null-ok; pipe for communication back to Zygote.
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> newStderr null-ok; stream to use for stderr until stdio
     * is reopened.
     *
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Zygote.MethodAndArgsCaller on success to
     * trampoline to code that invokes static main.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleChildProc(Arguments parsedArgs,
            FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)
            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller {
        </span><span style="color: #008000;">/**</span><span style="color: #008000;">
         * By the time we get here, the native code has closed the two actual Zygote
         * socket connections, and substituted /dev/null in their place.  The LocalSocket
         * objects still need to be closed properly.
         </span><span style="color: #008000;">*/</span><span style="color: #000000;">

<pre><code>closeSocket();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (descriptors != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        Os.dup2(descriptors[&lt;/span&gt;0&lt;span style=&quot;color: #000000;&quot;&gt;], STDIN_FILENO);
        Os.dup2(descriptors[&lt;/span&gt;1&lt;span style=&quot;color: #000000;&quot;&gt;], STDOUT_FILENO);
        Os.dup2(descriptors[&lt;/span&gt;2&lt;span style=&quot;color: #000000;&quot;&gt;], STDERR_FILENO);

        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (FileDescriptor fd: descriptors) {
            IoUtils.closeQuietly(fd);
        }
        newStderr &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; System.err;
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ErrnoException ex) {
        Log.e(TAG, &lt;/span&gt;&quot;Error reopening stdio&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (parsedArgs.niceName != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    Process.setArgV0(parsedArgs.niceName);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; End of the postFork event.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>        </span><span style="color: #0000ff;">if</span> (parsedArgs.invokeWith != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            WrapperInit.execApplication(parsedArgs.invokeWith,<br>                    parsedArgs.niceName, parsedArgs.targetSdkVersion,<br>                    VMRuntime.getCurrentInstructionSet(),<br>                    pipeFd, parsedArgs.remainingArgs);<br>        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br>            ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion,<br>                    parsedArgs.remainingArgs, </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;"> classLoader </span><span style="color: #008000;">*/</span><span style="color: #000000;">);<br>        }<br>    }</span></p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p>
<p>　　前一篇文章我们知道在SystemServer进程的启动过程中会调用其main静态方法，开始执行整个SystemServer的启动流程。在调用startOtherService方法中就会通过调用mActivityManagerService.systemReady()方法。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">SystemServer.java</span>
<span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> startOtherServices() {
    ......
         </span><span style="color: #008000;">//</span><span style="color: #008000;"> We now tell the activity manager it is okay to run third party
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> code.  It will call back into us once it has gotten to the state
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> where third party code can really run (but before it has actually
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> started launching the initial applications), for us to complete our
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> initialization.</span>
<span style="color: #000000;">        mActivityManagerService.systemReady()
    ......
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ActivityManagerService.java</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> systemReady(<span style="color: #0000ff;">final</span><span style="color: #000000;"> Runnable goingCallback, BootTimingsTraceLog traceLog) {
        ......
    startHomeActivityLocked(currentUserId, </span>"systemReady"<span style="color: #000000;">);
        ......

<p>}</p>
<p></p></span><span style="color: #0000ff;">boolean</span> startHomeActivityLocked(<span style="color: #0000ff;">int</span><span style="color: #000000;"> userId, String reason) {<br>        </span><span style="color: #0000ff;">if</span> (mFactoryTest ==<span style="color: #000000;"> FactoryTest.FACTORY_TEST_LOW_LEVEL<br>                </span>&amp;&amp; mTopAction == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> We are running in factory test mode, but unable to find<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> the factory test app, so just sit around displaying the<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> error message and don’t try to start anything.</span><br>            <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        }<br>        Intent intent </span>=<span style="color: #000000;"> getHomeIntent();<br>        ActivityInfo aInfo </span>=<span style="color: #000000;"> resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);<br>        </span><span style="color: #0000ff;">if</span> (aInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>            intent.setComponent(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> Don’t do this if the home app is currently being<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> instrumented.</span><br>            aInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ActivityInfo(aInfo);<br>            aInfo.applicationInfo </span>=<span style="color: #000000;"> getAppInfoForUser(aInfo.applicationInfo, userId);<br>            ProcessRecord app </span>=<span style="color: #000000;"> getProcessRecordLocked(aInfo.processName,<br>                    aInfo.applicationInfo.uid, </span><span style="color: #0000ff;">true</span><span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span> (app == <span style="color: #0000ff;">null</span> || app.instr == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>                intent.setFlags(intent.getFlags() </span>|<span style="color: #000000;"> Intent.FLAG_ACTIVITY_NEW_TASK);<br>                </span><span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> resolvedUserId =<span style="color: #000000;"> UserHandle.getUserId(aInfo.applicationInfo.uid);<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;"> For ANR debugging to verify if the user activity is the one that actually<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;"> launched.</span><br>                <span style="color: #0000ff;">final</span> String myReason = reason + “:” + userId + “:” +<span style="color: #000000;"> resolvedUserId;<br>                mActivityStarter.startHomeActivityLocked(intent, aInfo, myReason);<br>            }<br>        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br>            Slog.wtf(TAG, </span>“No home screen found for “ + intent, <span style="color: #0000ff;">new</span><span style="color: #000000;"> Throwable());<br>        }<p></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

 Intent getHomeIntent() {
    Intent intent &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; Intent(mTopAction, mTopData != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt; ? Uri.parse(mTopData) : &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    intent.setComponent(mTopComponent);
    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (mFactoryTest !=&lt;span style=&quot;color: #000000;&quot;&gt; FactoryTest.FACTORY_TEST_LOW_LEVEL) {
        intent.addCategory(Intent.CATEGORY_HOME);
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; intent;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ActivityStarter.java</span>
    <span style="color: #0000ff;">void</span><span style="color: #000000;"> startHomeActivityLocked(Intent intent, ActivityInfo aInfo, String reason) {
        mSupervisor.moveHomeStackTaskToTop(reason);
        mLastHomeActivityStartResult </span>= startActivityLocked(<span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">caller</span><span style="color: #008000;">*/</span><span style="color: #000000;">, intent,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">ephemeralIntent</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resolvedType</span><span style="color: #008000;">*/</span>, aInfo, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">rInfo</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">voiceSession</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">voiceInteractor</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resultTo</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">resultWho</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">requestCode</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">callingPid</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">callingUid</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">callingPackage</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">realCallingPid</span><span style="color: #008000;">*/</span>, 0 <span style="color: #008000;">/*</span><span style="color: #008000;">realCallingUid</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span>0 <span style="color: #008000;">/*</span><span style="color: #008000;">startFlags</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">options</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">false</span> <span style="color: #008000;">/*</span><span style="color: #008000;">ignoreTargetSecurity</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">false</span> <span style="color: #008000;">/*</span><span style="color: #008000;">componentSpecified</span><span style="color: #008000;">*/</span>, mLastHomeActivityStartRecord <span style="color: #008000;">/*</span><span style="color: #008000;">outActivity</span><span style="color: #008000;">*/</span><span style="color: #000000;">,
                </span><span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">container</span><span style="color: #008000;">*/</span>, <span style="color: #0000ff;">null</span> <span style="color: #008000;">/*</span><span style="color: #008000;">inTask</span><span style="color: #008000;">*/</span>, "startHomeActivity: " +<span style="color: #000000;"> reason);
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (mSupervisor.inResumeTopActivity) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> If we are in resume section already, home activity will be initialized, but not
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> resumed (to avoid recursive resume) and will stay that way until something pokes it
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> again. We need to schedule another resume.</span>
<span style="color: #000000;">            mSupervisor.scheduleResumeTopActivities();
        }
    }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp; 后面就进入了Activity的启动流程了。</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/07/Android源码分析六SystemServer进程/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 源码分析（六） SystemServer 进程">
                
                <h1>Android 源码分析（六） SystemServer 进程</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月07日</a>
            <a><i class="nexmoefont icon-areachart"></i>7.8k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 47 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>&nbsp;&nbsp;&nbsp; 一.前言:</h2>
<p>&nbsp;&nbsp;&nbsp; init进程 –&gt; Zygote进程 –&gt; SystemServer进程 –&gt; Launcher桌面程序 -&gt; 我们的App应用<br><br>&nbsp;&nbsp;&nbsp; init进程：linux的根进程，android系统是基于linux系统的，因此可以算作是整个android操作系统的第一个进程；<br><br>&nbsp;&nbsp;&nbsp; Zygote进程：android系统的根进程，主要作用：可以作用Zygote进程fork出SystemServer进程和各种应用进程；<br><br>&nbsp;&nbsp;&nbsp; <strong>SystemService进程：主要是在这个进程中启动系统的各项服务，比如ActivityManagerService，PackageManagerService，WindowManagerService服务等等；</strong><br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;Launcher桌面程序:就是我们平时看到的桌面程序，它其实也是一个android应用程序，只不过这个应用程序是系统默认第一个启动的应用程序.<br>&nbsp;&nbsp;&nbsp; </p>
<h2>&nbsp; 二. SystemService进程</h2>
<p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; ZygoteInit类的main方法调用了StartSystemService() 启动SystemService.<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SystemServer进程主要的作用是启动各种系统服务，比如ActivityManagerService，PackageManagerService，WindowManagerService等服务.</p>
<p>&nbsp;</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">ZygoteInit.java</span>
     <span style="color: #008000;">/**</span><span style="color: #008000;">
     * Prepare the arguments and fork for the system server process.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> startSystemServer(String abiList, String socketName, ZygoteServer zygoteServer)
            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> Zygote.MethodAndArgsCaller, RuntimeException {
        </span><span style="color: #0000ff;">long</span> capabilities =<span style="color: #000000;"> posixCapabilitiesAsBits(
            OsConstants.CAP_IPC_LOCK,
            OsConstants.CAP_KILL,
            OsConstants.CAP_NET_ADMIN,
            OsConstants.CAP_NET_BIND_SERVICE,
            OsConstants.CAP_NET_BROADCAST,
            OsConstants.CAP_NET_RAW,
            OsConstants.CAP_SYS_MODULE,
            OsConstants.CAP_SYS_NICE,
            OsConstants.CAP_SYS_PTRACE,
            OsConstants.CAP_SYS_TIME,
            OsConstants.CAP_SYS_TTY_CONFIG,
            OsConstants.CAP_WAKE_ALARM
        );
        </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Containers run without this capability, so avoid setting it in that case </span><span style="color: #008000;">*/</span>
        <span style="color: #0000ff;">if</span> (!SystemProperties.getBoolean(PROPERTY_RUNNING_IN_CONTAINER, <span style="color: #0000ff;">false</span><span style="color: #000000;">)) {
            capabilities </span>|=<span style="color: #000000;"> posixCapabilitiesAsBits(OsConstants.CAP_BLOCK_SUSPEND);
        }
        </span><span style="color: #008000;">/*</span><span style="color: #008000;"> Hardcoded command line to start the system server </span><span style="color: #008000;">*/</span><span style="color: #000000;">
        String args[] </span>=<span style="color: #000000;"> {
            </span>"--setuid=1000"<span style="color: #000000;">,
            </span>"--setgid=1000"<span style="color: #000000;">,
            </span>"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1032,3001,3002,3003,3006,3007,3009,3010"<span style="color: #000000;">,
            </span>"--capabilities=" + capabilities + "," +<span style="color: #000000;"> capabilities,
            </span>"--nice-name=system_server"<span style="color: #000000;">,
            </span>"--runtime-args"<span style="color: #000000;">,
            </span>"com.android.server.SystemServer"<span style="color: #000000;">,
        };
        ZygoteConnection.Arguments parsedArgs </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; pid;

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        parsedArgs &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ZygoteConnection.Arguments(args);
        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);
        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Request to fork the system server process &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
        pid &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; Zygote.forkSystemServer(
                parsedArgs.uid, parsedArgs.gid,
                parsedArgs.gids,
                parsedArgs.debugFlags,
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
                parsedArgs.permittedCapabilities,
                parsedArgs.effectiveCapabilities);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IllegalArgumentException ex) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; RuntimeException(ex);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; For child process &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (pid == 0&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (hasSecondZygote(abiList)) {
            waitForSecondaryZygote(socketName);
        }

        zygoteServer.closeServerSocket();
        handleSystemServerProcess(parsedArgs);
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp; 接上篇文章继续看看SystemServer在源码中做了什么.</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">SystemServer.java</span>

<pre><code>&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * The main entry point from zygote.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;static&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; main(String[] args) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemServer().run();
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; run() {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        traceBeginAndSlog(&lt;/span&gt;&quot;InitBeforeStartServices&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If a device&apos;s clock is before 1970 (before 0), a lot of
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; APIs crash dealing with negative numbers, notably
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; java.io.File#setLastModified, so instead we fake it and
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; hope that time from cell towers or NTP fixes it shortly.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (System.currentTimeMillis() &amp;lt;&lt;span style=&quot;color: #000000;&quot;&gt; EARLIEST_SUPPORTED_TIME) {
            Slog.w(TAG, &lt;/span&gt;&quot;System clock is before 1970; setting to 1970.&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
            SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);
        }

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;
        &lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Default the timezone property to GMT if not set.
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//</code></pre><p>            String timezoneProperty =  SystemProperties.get(“persist.sys.timezone”<span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span> (timezoneProperty == <span style="color: #0000ff;">null</span> ||<span style="color: #000000;"> timezoneProperty.isEmpty()) {<br>                Slog.w(TAG, </span>“Timezone not set; setting to GMT.”<span style="color: #000000;">);<br>                SystemProperties.set(</span>“persist.sys.timezone”, “GMT”<span style="color: #000000;">);<br>            }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If the system has &quot;persist.sys.language&quot; and friends set, replace them with
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; &quot;persist.sys.locale&quot;. Note that the default locale at this point is calculated
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; using the &quot;-Duser.locale&quot; command line flag. That flag is usually populated by
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; AndroidRuntime using the same set of system properties, but only the system_server
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; and system apps are allowed to set them.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; NOTE: Most changes made here will need an equivalent change to
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; core/jni/AndroidRuntime.cpp&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemProperties.get(&quot;persist.sys.language&quot;&lt;span style=&quot;color: #000000;&quot;&gt;).isEmpty()) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String languageTag =&lt;span style=&quot;color: #000000;&quot;&gt; Locale.getDefault().toLanguageTag();

    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.locale&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, languageTag);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.language&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.country&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    SystemProperties.set(&lt;/span&gt;&quot;persist.sys.localevar&quot;, &quot;&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The system server should never make non-oneway calls&lt;/span&gt;
Binder.setWarnOnBlocking(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Here we go!&lt;/span&gt;
Slog.i(TAG, &quot;Entered the Android system server!&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; uptimeMillis = (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime();
EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, uptimeMillis);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mRuntimeRestart) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_system_server_init&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, uptimeMillis);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In case the runtime switched since last boot (such as when
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the old runtime was removed in an OTA), set the system
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; property so that it is in sync. We can | xq oqi&apos;t do this in
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; libnativehelper&apos;s JniInvocation::Init code where we already
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; had to fallback to a different runtime because it is
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; running as root and we need to be the system user to set
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the property. &lt;/span&gt;&lt;span style=&quot;color: #008000; text-decoration: underline;&quot;&gt;http://b/11463182&lt;/span&gt;
SystemProperties.set(&quot;persist.sys.dalvik.vm.lib.2&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, VMRuntime.getRuntime().vmLibrary());

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Enable the sampling profiler.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (SamplingProfilerIntegration.isEnabled()) {
    SamplingProfilerIntegration.start();
    mProfilerSnapshotTimer &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Timer();
    mProfilerSnapshotTimer.schedule(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; TimerTask() {
            @Override
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; run() {
                SamplingProfilerIntegration.writeSnapshot(&lt;/span&gt;&quot;system_server&quot;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            }
        }, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Mmmmmm... more memory!&lt;/span&gt;</code></pre><p><span style="color: #000000;">            VMRuntime.getRuntime().clearGrowthLimit();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The system server has to run all of the time, so it needs to be
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; as efficient as possible with its memory usage.&lt;/span&gt;
VMRuntime.getRuntime().setTargetHeapUtilization(0.8f&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Some devices rely on runtime fingerprint generation, so make sure
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we&apos;ve defined it before booting further.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            Build.ensureFingerprintProperty();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Within the system server, it is an error to access Environment paths without
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; explicitly specifying a user.&lt;/span&gt;
Environment.setUserRequired(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Within the system server, any incoming Bundles should be defused
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to avoid throwing BadParcelableException.&lt;/span&gt;
BaseBundle.setShouldDefuse(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Ensure binder calls into the system always run at foreground priority.&lt;/span&gt;
BinderInternal.disableBackgroundScheduling(&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Increase the number of binder threads in system_server&lt;/span&gt;</code></pre><p><span style="color: #000000;">            BinderInternal.setMaxThreads(sMaxBinderThreads);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Prepare the main looper thread (this thread).&lt;/span&gt;</code></pre><p><span style="color: #000000;">            android.os.Process.setThreadPriority(<br>                android.os.Process.THREAD_PRIORITY_FOREGROUND);<br>            android.os.Process.setCanSelfBackground(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);<br>            Looper.prepareMainLooper();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize native services.&lt;/span&gt;
System.loadLibrary(&quot;android_servers&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Check whether we failed to shut down last time we tried.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; This call may not return.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            performPendingShutdown();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize the system context.&lt;/span&gt;</code></pre><p><span style="color: #000000;">            createSystemContext();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Create the system service manager.&lt;/span&gt;
mSystemServiceManager = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemServiceManager(mSystemContext);
mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);
LocalServices.addService(SystemServiceManager.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, mSystemServiceManager);
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Prepare the thread pool for init tasks that can be parallelized&lt;/span&gt;</code></pre><p><span style="color: #000000;">            SystemServerInitThreadPool.get();<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            traceEnd();  </span><span style="color: #008000;">//</span><span style="color: #008000;"> InitBeforeStartServices</span><br><span style="color: #000000;">        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start services. 启动各种需要的服务&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    traceBeginAndSlog(&lt;/span&gt;&quot;StartServices&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;启动系统Boot级服务 &lt;/span&gt;</code></pre><p><span style="color: #000000;">            startBootstrapServices();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">启动系统核心的服务 </span><br><span style="color: #000000;">            startCoreServices();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">启动非核心的服务 </span><br><span style="color: #000000;">            startOtherServices();<br>            SystemServerInitThreadPool.shutdown();<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable ex) {<br>            Slog.e(</span>“System”, “<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong>“<span style="color: #000000;">);<br>            Slog.e(</span>“System”, “<strong><strong>****</strong></strong> Failure starting system services”<span style="color: #000000;">, ex);<br>            </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> ex;<br>        } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br>            traceEnd();<br>        }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; For debug builds, log event loop stalls to dropbox for analysis.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (StrictMode.conditionallyEnableDebugLogging()) {
    Slog.i(TAG, &lt;/span&gt;&quot;Enabled StrictMode for system server main thread.&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
}
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!mRuntimeRestart &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;isFirstBootOrUpgrade()) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; uptimeMillis = (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime();
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_system_server_ready&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, uptimeMillis);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; MAX_UPTIME_MILLIS = 60 * 1000&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (uptimeMillis &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; MAX_UPTIME_MILLIS) {
        Slog.wtf(SYSTEM_SERVER_TIMING_TAG,
                &lt;/span&gt;&quot;SystemServer init took too long. uptimeMillis=&quot; +&lt;span style=&quot;color: #000000;&quot;&gt; uptimeMillis);
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Loop forever.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Looper.loop();<br>        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> RuntimeException(“Main thread loop unexpectedly exited”<span style="color: #000000;">);<br>    }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts the small tangle of critical services that are needed to get
 * the system off the ground.  These services have complex mutual dependencies
 * which is why we initialize them all in one place here.  Unless your service
 * is also entwined in these dependencies, it should be initialized in one of
 * the other functions.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startBootstrapServices() {
    Slog.i(TAG, &lt;/span&gt;&quot;Reading configuration...&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String TAG_SYSTEM_CONFIG = &quot;ReadingSystemConfig&quot;&lt;span style=&quot;color: #000000;&quot;&gt;;
    traceBeginAndSlog(TAG_SYSTEM_CONFIG);
    SystemServerInitThreadPool.get().submit(SystemConfig::getInstance, TAG_SYSTEM_CONFIG);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Wait for installd to finish starting up so that it has a chance to
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; create critical directories such as /data/user with the appropriate
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; permissions.  We need this to complete before we initialize other services.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartInstaller&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    Installer installer &lt;/span&gt;= mSystemServiceManager.startService(Installer.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; In some cases after launching an app we need to access device identifiers,
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; therefore register the device identifier policy before the activity manager.&lt;/span&gt;
    traceBeginAndSlog(&quot;DeviceIdentifiersPolicyService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(DeviceIdentifiersPolicyService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Activity manager runs the show.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartActivityManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSystemServiceManager.startService(
            ActivityManagerService.Lifecycle.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;).getService();
    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);
    mActivityManagerService.setInstaller(installer);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Power manager needs to be started early because other services need it.
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Native daemons may be watching for it to be registered so it must be ready
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; to handle incoming binder calls immediately (including being able to verify
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; the permissions for those calls).&lt;/span&gt;
    traceBeginAndSlog(&quot;StartPowerManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mPowerManagerService &lt;/span&gt;= mSystemServiceManager.startService(PowerManagerService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Now that the power manager has been started, let the activity manager
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; initialize power management features.&lt;/span&gt;
    traceBeginAndSlog(&quot;InitPowerManagement&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService.initPowerManagement();
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Bring up recovery system in case a rescue party needs a reboot&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemProperties.getBoolean(&quot;config.disable_noncore&quot;, &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)) {
        traceBeginAndSlog(&lt;/span&gt;&quot;StartRecoverySystemService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        mSystemServiceManager.startService(RecoverySystemService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        traceEnd();
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Now that we have the bare essentials of the OS up and running, take
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; note that we just booted, which might send out a rescue party if
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; we&apos;re stuck in a runtime restart loop.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        RescueParty.noteBoot(mSystemContext);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages LEDs and display backlight so we need it to bring up the display.&lt;/span&gt;
traceBeginAndSlog(&quot;StartLightsService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startService(LightsService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Display manager is needed to provide display metrics before package manager
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; starts up.&lt;/span&gt;
traceBeginAndSlog(&quot;StartDisplayManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mDisplayManagerService &lt;/span&gt;= mSystemServiceManager.startService(DisplayManagerService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; We need the default display before we can initialize the package manager.&lt;/span&gt;
traceBeginAndSlog(&quot;WaitForDisplay&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Only run &quot;core&quot; apps if we&apos;re encrypting the device.&lt;/span&gt;
String cryptState = SystemProperties.get(&quot;vold.decrypt&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ENCRYPTING_STATE.equals(cryptState)) {
    Slog.w(TAG, &lt;/span&gt;&quot;Detected encryption in progress - only parsing core apps&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mOnlyCore &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ENCRYPTED_STATE.equals(cryptState)) {
    Slog.w(TAG, &lt;/span&gt;&quot;Device encrypted - only parsing core apps&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mOnlyCore &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start the package manager.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mRuntimeRestart) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_package_manager_init_start&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            (&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime());
}
traceBeginAndSlog(&lt;/span&gt;&quot;StartPackageManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mPackageManagerService &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; PackageManagerService.main(mSystemContext, installer,
        mFactoryTestMode &lt;/span&gt;!=&lt;span style=&quot;color: #000000;&quot;&gt; FactoryTest.FACTORY_TEST_OFF, mOnlyCore);
mFirstBoot &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mPackageManagerService.isFirstBoot();
mPackageManager &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mSystemContext.getPackageManager();
traceEnd();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!mRuntimeRestart &amp;amp;&amp;amp; !&lt;span style=&quot;color: #000000;&quot;&gt;isFirstBootOrUpgrade()) {
    MetricsLogger.histogram(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &quot;boot_package_manager_init_ready&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            (&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) SystemClock.elapsedRealtime());
}
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages A/B OTA dexopting. This is a bootstrap service as we need it to rename
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; A/B artifacts after boot, before anything else might touch/need them.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Note: this isn&apos;t needed during decryption (we don&apos;t have /data anyways).&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;mOnlyCore) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;boolean&lt;/span&gt; disableOtaDexopt = SystemProperties.getBoolean(&quot;config.disable_otadexopt&quot;&lt;span style=&quot;color: #000000;&quot;&gt;,
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;disableOtaDexopt) {
        traceBeginAndSlog(&lt;/span&gt;&quot;StartOtaDexOptService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            OtaDexoptService.main(mSystemContext, mPackageManagerService);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Throwable e) {
            reportWtf(&lt;/span&gt;&quot;starting OtaDexOptService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, e);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;finally&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            traceEnd();
        }
    }
}

traceBeginAndSlog(&lt;/span&gt;&quot;StartUserManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mSystemServiceManager.startService(UserManagerService.LifeCycle.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Initialize attribute cache used to cache resources from packages.&lt;/span&gt;
traceBeginAndSlog(&quot;InitAttributerCache&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
AttributeCache.init(mSystemContext);
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Set up the Application instance for the system process and get started.&lt;/span&gt;
traceBeginAndSlog(&quot;SetSystemProcess&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
mActivityManagerService.setSystemProcess();
traceEnd();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; DisplayManagerService needs to setup android.display scheduling related policies
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; since setSystemProcess() would have overridden policies due to setProcessGroup&lt;/span&gt;</code></pre><p><span style="color: #000000;">        mDisplayManagerService.setupSchedulerPolicies();</span></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Manages Overlay packages&lt;/span&gt;
    traceBeginAndSlog(&quot;StartOverlayManagerService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; OverlayManagerService(mSystemContext, installer));
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The sensor service needs access to package manager service, app ops
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; service, and permissions service, therefore we start it after them.
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Start sensor service in a separate thread. Completion should be checked
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; before using it.&lt;/span&gt;
    mSensorServiceStart = SystemServerInitThreadPool.get().submit(() -&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        BootTimingsTraceLog traceLog &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; BootTimingsTraceLog(
                SYSTEM_SERVER_TIMING_ASYNC_TAG, Trace.TRACE_TAG_SYSTEM_SERVER);
        traceLog.traceBegin(START_SENSOR_SERVICE);
        startSensorService();
        traceLog.traceEnd();
    }, START_SENSOR_SERVICE);
}


&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts some essential services that are not tangled up in the bootstrap process.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startCoreServices() {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Records errors and logs, for example wtf()&lt;/span&gt;
    traceBeginAndSlog(&quot;StartDropBoxManager&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(DropBoxManagerService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    traceBeginAndSlog(&lt;/span&gt;&quot;StartBatteryService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks the battery level.  Requires LightService.&lt;/span&gt;
    mSystemServiceManager.startService(BatteryService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks application usage stats.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartUsageService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mSystemServiceManager.startService(UsageStatsService.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mActivityManagerService.setUsageStatsManager(
            LocalServices.getService(UsageStatsManagerInternal.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
    traceEnd();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Tracks whether the updatable WebView is in a ready state and watches for update installs.&lt;/span&gt;
    traceBeginAndSlog(&quot;StartWebViewUpdateService&quot;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mWebViewUpdateService &lt;/span&gt;= mSystemServiceManager.startService(WebViewUpdateService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    traceEnd();
}
&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></pre></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;"> mSystemServiceManager是系统服务管理对象.在run()方法已经创建 mSystemServiceManager = new SystemServiceManager(mSystemContext);
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 进入mSystemServiceManager.startService() 分析下. 进入具体实现的方法

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;SystemServiceManager.java&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Creates and starts a system service. The class must be a subclass of
 * {&lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@link&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; com.android.server.SystemService}.
 *
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@param&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; serviceClass A Java class that implements the SystemService interface.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The service instance, never null.
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@throws&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; RuntimeException if the service fails to start.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
@SuppressWarnings(&lt;/span&gt;&quot;unchecked&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &amp;lt;T &lt;span style=&quot;color: #0000ff;&quot;&gt;extends&lt;/span&gt; SystemService&amp;gt; T startService(Class&amp;lt;T&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; String name =&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass.getName();
        Slog.i(TAG, &lt;/span&gt;&quot;Starting &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name);
        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, &lt;/span&gt;&quot;StartService &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name);

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Create the service.&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!SystemService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.isAssignableFrom(serviceClass)) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must extend &quot; + SystemService.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.getName());
        }
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; T service;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            Constructor&lt;/span&gt;&amp;lt;T&amp;gt; constructor = serviceClass.getConstructor(Context.&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            service &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; constructor.newInstance(mContext);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (InstantiationException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service could not be instantiated&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (IllegalAccessException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must have a public constructor with a Context argument&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (NoSuchMethodException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service must have a public constructor with a Context argument&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (InvocationTargetException ex) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; name
                    &lt;/span&gt;+ &quot;: service constructor threw an exception&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
        }

        startService(service);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; service;
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;finally&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);
    }
}

  &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/**&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;
 * Starts a service by class name.
 *
 * &lt;/span&gt;&lt;span style=&quot;color: #808080;&quot;&gt;@return&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; The service instance.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
@SuppressWarnings(&lt;/span&gt;&quot;unchecked&quot;&lt;span style=&quot;color: #000000;&quot;&gt;)
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SystemService startService(String className) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;final&lt;/span&gt; Class&amp;lt;SystemService&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; serviceClass;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        serviceClass &lt;/span&gt;= (Class&amp;lt;SystemService&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;)Class.forName(className);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ClassNotFoundException ex) {
        Slog.i(TAG, &lt;/span&gt;&quot;Starting &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; className);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;throw&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;Failed to create service &quot; +&lt;span style=&quot;color: #000000;&quot;&gt; className
                &lt;/span&gt;+ &quot;: service class not found, usually indicates that the caller should &quot;
                + &quot;have called PackageManager.hasSystemFeature() to check whether the &quot;
                + &quot;feature is available on this device before trying to start the &quot;
                + &quot;services that implement it&quot;&lt;span style=&quot;color: #000000;&quot;&gt;, ex);
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startService(serviceClass);
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;通过反射器构造方法创建出服务类,然后返回SystemService.启动对应的服务.&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
</section>

    <nav class="nexmoe-page-nav">
      <a class="extend prev" rel="prev" href="/categories/Android/page/3/"><i class="nexmoefont icon-left"></i></a><a class="page-number" href="/categories/Android/">1</a><a class="page-number" href="/categories/Android/page/2/">2</a><a class="page-number" href="/categories/Android/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/categories/Android/page/5/">5</a><a class="page-number" href="/categories/Android/page/6/">6</a><a class="extend next" rel="next" href="/categories/Android/page/5/"><i class="nexmoefont icon-right"></i></a>
    </nav>
  
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
 
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


 
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/app.js?v=1571545567393"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>


    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>



  





    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?3771b2566860fea0de20c35742671f53#&lt;ID&gt;';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

</body>

</html>
