<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  
  <title>分类：Android - 网记本</title>
  <meta charset="UTF-8">
  <meta name="description" content>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/img/favicon.png" type="image/png">
  <meta property="og:type" content="website">
<meta property="og:title" content="网记本">
<meta property="og:url" content="https://freefuncode.github.io/categories/Android/page/3/index.html">
<meta property="og:site_name" content="网记本">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="网记本">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css">
   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="/css/style.css?v=1571545567369">
</head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(https://i.loli.net/2019/01/13/5c3aec85a4343.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="网记本" class="mdui-btn mdui-btn-icon"><img src="/img/avatar.jpg"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="网记本">
            <img src="/img/avatar.jpg" alt="网记本">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>94</div>
        <div><span>标签</span>51</div>
        <div><span>分类</span>13</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的收藏">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的收藏
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">社交按钮</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://weibo.com/230689567" target="_blank" mdui-tooltip="{content: '微博'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-weibo"></i>
        </a><a class="mdui-ripple" href="https://juejin.im/user/5ceb7d54f265da1b8466c2f5/posts" target="_blank" mdui-tooltip="{content: '掘金'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-appstore-fill"></i>
        </a><a class="mdui-ripple" href="https://www.cnblogs.com/bugzone/" target="_blank" mdui-tooltip="{content: '博客园'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-dribbble"></i>
        </a><a class="mdui-ripple" href="https://www.jianshu.com/u/ba21180e6aab" target="_blank" mdui-tooltip="{content: '简书'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-container"></i>
        </a><a class="mdui-ripple" href="https://github.com/freefuncode/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://www.zhihu.com/people/yimei-cheng-xu-yuan-28/activities" target="_blank" mdui-tooltip="{content: '知乎'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-zhihu"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/">Android</a>
          <span class="category-list-count">52</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/CSharp/">CSharp</a>
          <span class="category-list-count">14</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/GitHub/">GitHub</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/JAVA/">JAVA</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/PHP/">PHP</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/kotlin/">kotlin</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/前端/">前端</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/">后端</a>
          <span class="category-list-count">21</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/安卓源码/">安卓源码</a>
          <span class="category-list-count">15</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/开源框架/">开源框架</a>
          <span class="category-list-count">17</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/心情/">心情</a>
          <span class="category-list-count">10</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/知识点/">知识点</a>
          <span class="category-list-count">18</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/设计模式/">设计模式</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">标签云</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Activity/" style="font-size: 10px;">Activity</a> <a href="/tags/Android/" style="font-size: 12.5px;">Android</a> <a href="/tags/Android7-0/" style="font-size: 10px;">Android7.0</a> <a href="/tags/BroadcastReceiver/" style="font-size: 10px;">BroadcastReceiver</a> <a href="/tags/C-文件上传/" style="font-size: 10px;">C#文件上传</a> <a href="/tags/ContentProvider/" style="font-size: 10px;">ContentProvider</a> <a href="/tags/Excel操作/" style="font-size: 10px;">Excel操作</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/IIS/" style="font-size: 12.5px;">IIS</a> <a href="/tags/LNMP/" style="font-size: 10px;">LNMP</a> <a href="/tags/Linq/" style="font-size: 10px;">Linq</a> <a href="/tags/MAMP/" style="font-size: 10px;">MAMP</a> <a href="/tags/Service/" style="font-size: 10px;">Service</a> <a href="/tags/SqlServer/" style="font-size: 10px;">SqlServer</a> <a href="/tags/ViewPager/" style="font-size: 10px;">ViewPager</a> <a href="/tags/XMLHttpRequest/" style="font-size: 10px;">XMLHttpRequest</a> <a href="/tags/c/" style="font-size: 10px;">c#</a> <a href="/tags/coroutine协程/" style="font-size: 10px;">coroutine协程</a> <a href="/tags/easyui/" style="font-size: 12.5px;">easyui</a> <a href="/tags/fiddler/" style="font-size: 10px;">fiddler</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/kotlin/" style="font-size: 10px;">kotlin</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mono-for-Android/" style="font-size: 10px;">mono_for_Android</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/view绘制/" style="font-size: 10px;">view绘制</a> <a href="/tags/visualStudio/" style="font-size: 12.5px;">visualStudio</a> <a href="/tags/习惯/" style="font-size: 10px;">习惯</a> <a href="/tags/京东云擎/" style="font-size: 10px;">京东云擎</a> <a href="/tags/公众号/" style="font-size: 10px;">公众号</a> <a href="/tags/副业/" style="font-size: 10px;">副业</a> <a href="/tags/图片保存/" style="font-size: 10px;">图片保存</a> <a href="/tags/地图/" style="font-size: 12.5px;">地图</a> <a href="/tags/增量更新/" style="font-size: 10px;">增量更新</a> <a href="/tags/安卓源码/" style="font-size: 17.5px;">安卓源码</a> <a href="/tags/屏幕适配/" style="font-size: 10px;">屏幕适配</a> <a href="/tags/序列化/" style="font-size: 10px;">序列化</a> <a href="/tags/开源框架/" style="font-size: 20px;">开源框架</a> <a href="/tags/新浪SAE/" style="font-size: 10px;">新浪SAE</a> <a href="/tags/日期格式化/" style="font-size: 10px;">日期格式化</a> <a href="/tags/正则表达式/" style="font-size: 10px;">正则表达式</a> <a href="/tags/电影/" style="font-size: 15px;">电影</a> <a href="/tags/线程切换/" style="font-size: 10px;">线程切换</a> <a href="/tags/职业发展/" style="font-size: 10px;">职业发展</a> <a href="/tags/职业生涯/" style="font-size: 10px;">职业生涯</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/评论插件/" style="font-size: 10px;">评论插件</a> <a href="/tags/跳槽/" style="font-size: 12.5px;">跳槽</a> <a href="/tags/面试/" style="font-size: 12.5px;">面试</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">七月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2019 网记本
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <section class="nexmoe-posts" id="brand-waterfall">
    
    <div class="nexmoe-post">
        <a href="/2018/07/30/Android开源框架四Afinal-Android里的ORM-IOC聚合型框架/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 开源框架 ( 四 ) Afinal --- Android 里的 ORM IOC聚合型框架">
                
                <h1>Android 开源框架 ( 四 ) Afinal --- Android 里的 ORM IOC聚合型框架</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月30日</a>
            <a><i class="nexmoefont icon-areachart"></i>2.9k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 15 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/开源框架/">开源框架</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/开源框架/">开源框架</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/afinal.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p>Afinal&nbsp;是一个android的sqlite的 orm 和 ioc 框架.是一种聚合型框架, 大而全。所以不推荐使用,只做了解即可.应付手头临时项目.</p>
<p>推荐阅读,<a href="https://www.jianshu.com/p/f3227c7008d4" target="_blank">这么多开源框架，该用哪个好</a>？:</p>
<h2>一.引言</h2>
<p>　　Afinal是一个开源的android的orm和ioc应用开发框架.在android应用开发中，FinalActivity模块通过Afinal的ioc框架，诸如ui绑定，事件绑定，通过注解可以自动绑定。Afinal的orm框架，很轻松的就可以对android的sqlite数据库进行增删改查操作,Afinal内嵌了finalHttp等简单易用的工具，可以轻松的对http进行请求操作</p>
<h2>二.注解介绍</h2>
<p>　　说道注解首先接触最多的是@Override: 表示该方法是重写父类中的方法，编译的时候会检查该方法，如果这个方法不是父类中存在的将会报错.</p>
<p>　　java.lang.annotation 中包含所有定义自定义注解所需用到的原注解和接口。接口java.lang.annotation.Annotation 是所有注解继承的接口,并且是自动继承，不需要定义时指定，类似于所有类都自动继承Object。所以很多java.lang.annotation种的注册我们可以直接使用.</p>
<h3>　　注解三种保留方式: 　　</h3>
<p>　　@Retention: 定义注解的保留策略</p>
<p> 　　@Retention(RetentionPolicy.SOURCE)//注解仅存在于源码中，在class字节码文件中不包含<br>    　　@Retention(RetentionPolicy.CLASS)// 默认的保留策略，注解会在class字节码文件中存在，但运行时无法得<br>    　　@Retention(RetentionPolicy.RUNTIME)// 注解会在class字节码文件中存在，在运行时可以通过反射获取到</p>
<p>    　　1.SOURCE:只保留在源码中，不保留在class中，同时也不加载到虚拟机中. <br>    　　2.CLASS:保留在源码中，同时也保留到class中，但是不加载到虚拟机中.在程序编译时根据注解进行一些额外的操作，大名鼎鼎的<strong>ButterKnife</strong>运用的就是编译时注解,ButterKnife在我们编译时，就根据注解，自动生成了一些辅助类。 <br>    　　3.RUNING:保留到源码中，同时也保留到class中，最后加载到虚拟机中.在运行时环境下运用反射，动态获取对象、属性、方法等，一般的IOC框架就是这样，可能会牺牲一点效率。 <strong>EventBus</strong>是使用运行时注解，主要的作用是在运行的时候会去查找所有被注解的方法，然后再去解析注解。运行时注解会影响程序的性能，毕竟在运行的时候有一个查找的过程，所以运行时注解的作用一般是标记一个作用区。</p>
<h2>三.Afinal 介绍<em id="__mceDel"><br></em></h2>
<h3><em id="__mceDel">　　Afinal的四大模块：</em></h3>
<p>    　　　　FinalDB模块：android中的orm框架，一行代码就可以进行增删改查。支持一对多，多对一等查询。</p>
<p>    　　　　FinalActivity模块：android中的ioc框架，完全注解方式就可以进行UI绑定和事件绑定。无需findViewById和setClickListener等。</p>
<p>    　　　　FinalHttp模块：通过httpclient进行封装http数据请求，支持ajax方式加载。</p>
<p>    　　　　FinalBitmap模块：通过FinalBitmap，imageview加载bitmap的时候无需考虑bitmap加载过程中出现的oom和android容器快速滑动时候出现的图片错位等现象。FinalBitmap可以配置线程加载线程数量，缓存大小，缓存路径，加载显示动画等。FinalBitmap的内存管理使用lru算法，没有使用弱引用（android2.3以后google已经不建议使用弱引用，android2.3后强行回收软引用和弱引用，详情查看android官方文档），更好的管理bitmap内存。FinalBitmap可以自定义下载器，用来扩展其他协议显示网络图片，比如ftp等。同时可以自定义bitmap显示器，在imageview显示图片的时候播放动画等（默认是渐变动画显示）。</p>
<h2>&nbsp;四.Afinal 使用</h2>
<h4>&nbsp;　&nbsp; 1.引入jar包</h4>
<h4>    　　2.授权</h4>
<div class="cnblogs_code">
<pre>&lt;uses-permission android:name=<span style="color: #800000;">"</span><span style="color: #800000;">android.permission.INTERNET</span><span style="color: #800000;">"</span> /&gt;
&lt;uses-permission android:name=<span style="color: #800000;">"</span><span style="color: #800000;">android.permission.WRITE_EXTERNAL_STORAGE</span><span style="color: #800000;">"</span> /&gt;</pre>
</div>
<h4>　　3.FinalDB使用</h4>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>FinalDb db = FinalDb.create(<span style="color: #0000ff;">this</span><span style="color: #000000;">);
User user </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> User();
user.setEmail(</span><span style="color: #800000;">"1@</span><span style="color: #800000;">qq.com</span><span style="color: #800000;">"</span><span style="color: #000000;">);
user.setId(</span><span style="color: #800080;">1</span><span style="color: #000000;">);
user.setName(</span><span style="color: #800000;">"</span><span style="color: #800000;">oreo</span><span style="color: #800000;">"</span><span style="color: #000000;">); 
db.save(user);</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>　　查看下源码：（最后还是转成sql执行）</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> save(Object entity) {
        </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.checkTableExist(entity.getClass());
        </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.exeSqlInfo(SqlBuilder.buildInsertSql(entity));
    }</span></pre>
</div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> SqlInfo buildInsertSql(Object entity) {
        List</span>&lt;KeyValue&gt; keyValueList =<span style="color: #000000;"> getSaveKeyValueListByEntity(entity);
        StringBuffer strSQL </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> StringBuffer();
        SqlInfo sqlInfo </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;
        </span><span style="color: #0000ff;">if</span>(keyValueList != <span style="color: #0000ff;">null</span> &amp;&amp; keyValueList.size() &gt; <span style="color: #800080;">0</span><span style="color: #000000;">) {
            sqlInfo </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlInfo();
            strSQL.append(</span><span style="color: #800000;">"</span><span style="color: #800000;">INSERT INTO </span><span style="color: #800000;">"</span><span style="color: #000000;">);
            strSQL.append(TableInfo.</span><span style="color: #0000ff;">get</span><span style="color: #000000;">(entity.getClass()).getTableName());
            strSQL.append(</span><span style="color: #800000;">"</span><span style="color: #800000;"> (</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            Iterator var5 </span>=<span style="color: #000000;"> keyValueList.iterator();

<pre><code>        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(var5.hasNext()) {
            KeyValue kv &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; (KeyValue)var5.next();
            strSQL.append(kv.getKey()).append(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            sqlInfo.addValue(kv.getValue());
        }

        strSQL.deleteCharAt(strSQL.length() &lt;/span&gt;- &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        strSQL.append(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;) VALUES ( &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; length =&lt;span style=&quot;color: #000000;&quot;&gt; keyValueList.size();

        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt;(&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; i = &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;; i &amp;lt; length; ++&lt;span style=&quot;color: #000000;&quot;&gt;i) {
            strSQL.append(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;?,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        }

        strSQL.deleteCharAt(strSQL.length() &lt;/span&gt;- &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        strSQL.append(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;)&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        sqlInfo.setSql(strSQL.toString());
    }

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; sqlInfo;
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h2>　　4.FinalBitmap使用</h2>
<div class="cnblogs_code">
<pre><span style="color: #008000;">//</span><span style="color: #008000;"> 开始加载图片</span>
finalBitmap.display(iv_afinal,<span style="color: #800000;">"</span><span style="color: #800000;">https://images2018.cnblogs.com/blog/612293/201807/612293-20180722160006222-1427704878.jpg</span><span style="color: #800000;">"</span>);</pre>
</div>
<p>　　查看下源码:</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> doDisplay(View imageView, String uri, BitmapDisplayConfig displayConfig) {
        </span><span style="color: #0000ff;">if</span>(!<span style="color: #0000ff;">this</span><span style="color: #000000;">.mInit) {
            </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.init();
        }

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;(!TextUtils.isEmpty(uri) &amp;amp;&amp;amp; imageView != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;(displayConfig == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            displayConfig &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.mConfig.defaultDisplayConfig;
        }

        Bitmap bitmap &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;.mImageCache != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {&lt;br&gt;　　　　　　　　　　//优先缓存获取&lt;br&gt;                bitmap &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.mImageCache.getBitmapFromMemoryCache(uri);
        }

        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;(bitmap != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(imageView instanceof ImageView) {
                ((ImageView)imageView).setImageBitmap(bitmap);
            } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
                imageView.setBackgroundDrawable(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; BitmapDrawable(bitmap));
            }
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(checkImageTask(uri, imageView)) {&lt;br&gt;　　　　　　　　　//FinalBitmap模块 加载图片
            FinalBitmap.BitmapLoadAndDisplayTask task &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; FinalBitmap.BitmapLoadAndDisplayTask(imageView, displayConfig);
            FinalBitmap.AsyncDrawable asyncDrawable &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; FinalBitmap.AsyncDrawable(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;.mContext.getResources(), displayConfig.getLoadingBitmap(), task);
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(imageView instanceof ImageView) {
                ((ImageView)imageView).setImageDrawable(asyncDrawable);
            } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
                imageView.setBackgroundDrawable(asyncDrawable);
            }

            task.executeOnExecutor(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;.bitmapLoadAndDisplayExecutor, &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Object[]{uri});
        }

    }
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h2>　　5.FinalHttp下载文件</h2>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>FinalHttp finalHttp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FinalHttp();
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 请求网络资源的地址</span>
        String url = <span style="color: #800000;">""</span><span style="color: #000000;">;
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 存放视频文件到本地位置</span>
        String target = getFilesDir()+<span style="color: #800000;">"</span><span style="color: #800000;">/testAfinal.mp4</span><span style="color: #800000;">"</span><span style="color: #000000;">;

<pre><code>finalHttp.download(url, target, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; AjaxCallBack&amp;lt;File&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;() {
    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; onSuccess(File file) {
        tv_afinal_result.setText(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;下载文件成功&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        super.onSuccess(file);
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onFailure(Throwable t, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; errorNo, String strMsg) {
        tv_afinal_result.setText(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;下载文件失败&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        super.onFailure(t, errorNo, strMsg);
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; onStart() {
        tv_afinal_result.setText(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;开始下载&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        super.onStart();
    }
});&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h2>　　6.FinalHttp上传文件</h2>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>FinalHttp finalHttp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FinalHttp();
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 文件上传到服务器的位置</span>
        String url  = <span style="color: #800000;">""</span><span style="color: #000000;">;
        AjaxParams </span><span style="color: #0000ff;">params</span> = <span style="color: #0000ff;">new</span><span style="color: #000000;"> AjaxParams();
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 获取要上传的本地资源</span>
        <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            </span><span style="color: #0000ff;">params</span>.put(<span style="color: #800000;">"</span><span style="color: #800000;">File</span><span style="color: #800000;">"</span>,<span style="color: #0000ff;">new</span> File(getFilesDir()+<span style="color: #800000;">"</span><span style="color: #800000;">/testAfinal.mp4</span><span style="color: #800000;">"</span><span style="color: #000000;">));
        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (FileNotFoundException e) {
            e.printStackTrace();
        }

<pre><code>finalHttp.post(url, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;params&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; AjaxCallBack&amp;lt;Object&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;() {
    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; onStart() {
        tv_afinal_result.setText(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;开始上传&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        super.onStart();
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; onSuccess(Object o) {
        tv_afinal_result.setText(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;上传成功&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        super.onSuccess(o);
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onFailure(Throwable t, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; errorNo, String strMsg) {
        tv_afinal_result.setText(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;上传失败&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        super.onFailure(t, errorNo, strMsg);
    }
});&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/29/Android开源框架三基于OkHttp进一步封装的OkHttpUtils介绍/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 开源框架 ( 三 ) 基于OkHttp进一步封装的OkHttpUtils介绍">
                
                <h1>Android 开源框架 ( 三 ) 基于OkHttp进一步封装的OkHttpUtils介绍</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月29日</a>
            <a><i class="nexmoefont icon-areachart"></i>3.2k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 18 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/开源框架/">开源框架</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/开源框架/">开源框架</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/OkHttpUtils.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p>　　OkHttpUtils是 廖子尧 是基于OkHttp封装的框架库。里面也封装了很多其他实用的一些组件，这里只介绍下网络相关的使用。</p>
<p>　　里面的<strong>上传下载功能使用队列的概念</strong>做了进一步封装，但是因为我使用的是旧库，对于android6.0运行时权限判断和android7.0私有文件权限设置没有处理。</p>
<p>　　同上一篇随笔一样分析：<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/okhttp-utils.html" target="_blank">Android 开源框架 ( 二 ) 基于OkHttp进一步封装的okhttp-utils介绍</a> 介绍下基本使用，加深自己对OkHttp的理解。</p>
<h3>　　一.引入到自己项目后，先来对比下同上一篇介绍的okhttp-utils类库目录对比下：</h3>
<p>　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180729112723166-1670399309.png" alt></p>
<p>　　注意：途中下面红框标注部分的module:okhttputils-lib是本文介绍的OkHttpUtils类库，上面的module:okhttputils是<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/okhttp-utils.html" target="_blank">Android 开源框架 ( 二 ) 基于OkHttp进一步封装的okhttp-utils介绍</a>介绍的框架类库。　　</p>
<p>　　两个封装框架都有一个 <strong>OkHttpUtils 入口类。</strong></p>
<p>&nbsp;</p>
<h2><strong>　　二. OkHttpUtils基本使用</strong></h2>
<h3><strong>　　1</strong>.//get 请求数据</h3>
<div class="cnblogs_code">
<pre>OkHttpUtils.<span style="color: #0000ff;">get</span>(Urls.URL_METHOD)<span style="color: #008000;">//
</span>            .tag(<span style="color: #0000ff;">this</span>)<span style="color: #008000;">//
</span>            .headers(<span style="color: #800000;">"</span><span style="color: #800000;">header1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">headerValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>            .<span style="color: #0000ff;">params</span>(<span style="color: #800000;">"</span><span style="color: #800000;">param1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">paramValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>            .execute(<span style="color: #0000ff;">new</span> MethodCallBack&lt;&gt;(<span style="color: #0000ff;">this</span>, RequestInfo.<span style="color: #0000ff;">class</span>));</pre>
</div>
<h3>　　2.//post 请求数据</h3>
<div class="cnblogs_code">
<pre>OkHttpUtils.post(Urls.URL_METHOD)<span style="color: #008000;">//
</span>            .tag(<span style="color: #0000ff;">this</span>)<span style="color: #008000;">//
</span>            .headers(<span style="color: #800000;">"</span><span style="color: #800000;">header1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">headerValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>            .<span style="color: #0000ff;">params</span>(<span style="color: #800000;">"</span><span style="color: #800000;">param1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">paramValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>            .execute(<span style="color: #0000ff;">new</span> MethodCallBack&lt;&gt;(<span style="color: #0000ff;">this</span>, RequestInfo.<span style="color: #0000ff;">class</span>));    </pre>
</div>
<h3>　　3.//缓存请求</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>OkHttpUtils.<span style="color: #0000ff;">get</span>(Urls.URL_CACHE)<span style="color: #008000;">//
</span>        .tag(<span style="color: #0000ff;">this</span>)<span style="color: #008000;">//
</span>        .cacheMode(CacheMode.DEFAULT)<span style="color: #008000;">//
</span>        .cacheKey(<span style="color: #800000;">"</span><span style="color: #800000;">cache_default</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>        .cacheTime(<span style="color: #800080;">5000</span>)<span style="color: #008000;">//</span><span style="color: #008000;">对于默认的缓存模式,该时间无效,依靠的是服务端对304缓存的控制</span>
        .headers(<span style="color: #800000;">"</span><span style="color: #800000;">header1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">headerValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>        .<span style="color: #0000ff;">params</span>(<span style="color: #800000;">"</span><span style="color: #800000;">param1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">paramValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>        .execute(<span style="color: #0000ff;">new</span> CacheCallBack(<span style="color: #0000ff;">this</span>));    </pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">enum</span><span style="color: #000000;"> CacheMode {
            </span><span style="color: #008000;">/*</span><span style="color: #008000;">* 按照HTTP协议的默认缓存规则，例如有304响应头时缓存 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
            DEFAULT,

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;* 不使用缓存 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
    NO_CACHE,

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;* 请求网络失败后，读取缓存 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
    REQUEST_FAILED_READ_CACHE,

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;* 如果缓存不存在才请求网络，否则使用缓存 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
    IF_NONE_CACHE_REQUEST,

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;* 先使用缓存，不管是否存在，仍然请求网络 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
    FIRST_CACHE_THEN_REQUEST,
}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h3>　　4.//批量上传文件</h3>
<h4>　　　　4.1 方法一：　　</h4>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>OkHttpUtils.post(Urls.URL_FORM_UPLOAD)<span style="color: #008000;">//
</span>                .tag(<span style="color: #0000ff;">this</span>)<span style="color: #008000;">//
</span>                .headers(<span style="color: #800000;">"</span><span style="color: #800000;">header1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">headerValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>                .headers(<span style="color: #800000;">"</span><span style="color: #800000;">header2</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">headerValue2</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>                .<span style="color: #0000ff;">params</span>(<span style="color: #800000;">"</span><span style="color: #800000;">param1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">paramValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>                .<span style="color: #0000ff;">params</span>(<span style="color: #800000;">"</span><span style="color: #800000;">param2</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">paramValue2</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//</span>
<span style="color: #008000;">//</span><span style="color: #008000;">                .params("file1",new File("文件路径"))   </span><span style="color: #008000;">//</span><span style="color: #008000;">这种方式为一个key，对应一个文件
</span><span style="color: #008000;">//</span><span style="color: #008000;">                .params("file2",new File("文件路径"))
</span><span style="color: #008000;">//</span><span style="color: #008000;">                .params("file3",new File("文件路径"))</span>
                .addFileParams(<span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span>, files)           <span style="color: #008000;">//</span><span style="color: #008000;"> 这种方式为同一个key，上传多个文件</span>
                .execute(<span style="color: #0000ff;">new</span> ProgressUpCallBack&lt;&gt;(<span style="color: #0000ff;">this</span>, RequestInfo.<span style="color: #0000ff;">class</span>));</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h4>　　　　4.2 方式二：</h4>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; i &lt; images.size(); i++<span style="color: #000000;">) {
    </span><span style="color: #008000;">//</span><span style="color: #008000;">注册监听</span>
    MyUploadListener listener = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MyUploadListener();
    listener.setUserTag(gridView.getChildAt(i));
    </span><span style="color: #008000;">//</span><span style="color: #008000;">批量加入上传队列</span>
    UploadManager.getInstance(getContext()).addTask(Urls.URL_FORM_UPLOAD, <span style="color: #0000ff;">new</span> File(images.<span style="color: #0000ff;">get</span>(i).path), <span style="color: #800000;">"</span><span style="color: #800000;">imageFile</span><span style="color: #800000;">"</span><span style="color: #000000;">, listener);
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">/*</span><span style="color: #008000;">* 一旦该方法执行，意味着开始下载了 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">protected</span> UploadInfo doInBackground(Void... <span style="color: #0000ff;">params</span><span style="color: #000000;">) {
        </span><span style="color: #0000ff;">if</span> (isCancelled()) <span style="color: #0000ff;">return</span><span style="color: #000000;"> mUploadInfo;
        L.e(</span><span style="color: #800000;">"</span><span style="color: #800000;">doInBackground:</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> mUploadInfo.getResourcePath());
        mUploadInfo.setNetworkSpeed(</span><span style="color: #800080;">0</span><span style="color: #000000;">);
        mUploadInfo.setState(UploadManager.UPLOADING);
        postMessage(</span><span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">);

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;构建请求体,默认使用post请求上传&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Response response;<br>        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">本质还是调用OkHttpUtils的post方法上传</span><br>            PostRequest postRequest =<span style="color: #000000;"> OkHttpUtils.post(mUploadInfo.getUrl());<br>            File resource </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(mUploadInfo.getResourcePath());<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (TextUtils.isEmpty(mUploadInfo.getFileName())) {<br>                mUploadInfo.setFileName(resource.getName());<br>            }<br>            postRequest.</span><span style="color: #0000ff;">params</span><span style="color: #000000;">(mUploadInfo.getKey(), resource, mUploadInfo.getFileName());<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">接口对接，数据回调</span><br>            postRequest.setCallback(<span style="color: #0000ff;">new</span><span style="color: #000000;"> MergeListener());<br>            response </span>=<span style="color: #000000;"> postRequest.execute();<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br>            e.printStackTrace();<br>            mUploadInfo.setNetworkSpeed(</span><span style="color: #800080;">0</span><span style="color: #000000;">);<br>            mUploadInfo.setState(UploadManager.ERROR);<br>            postMessage(</span><span style="color: #0000ff;">null</span>, <span style="color: #800000;">“</span><span style="color: #800000;">网络异常</span><span style="color: #800000;">“</span><span style="color: #000000;">, e);<br>            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> mUploadInfo;<br>        }</span></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (response.isSuccessful()) {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;解析过程中抛出异常，一般为 json 格式错误，或者数据解析异常&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
            T t &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; (T) mUploadInfo.getListener().parseNetworkResponse(response);
            mUploadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            mUploadInfo.setState(UploadManager.FINISH); &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;上传成功&lt;/span&gt;
            postMessage(t, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mUploadInfo;
        } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Exception e) {
            e.printStackTrace();
            mUploadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            mUploadInfo.setState(UploadManager.ERROR);
            postMessage(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;解析数据对象出错&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, e);
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mUploadInfo;
        }
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        mUploadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        mUploadInfo.setState(UploadManager.ERROR);
        postMessage(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;数据返回失败&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mUploadInfo;
    }
}    &lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h3>　　5.//批量下载文件</h3>
<h4>　　　　5.1 方式一：</h4>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>OkHttpUtils.<span style="color: #0000ff;">get</span>(Urls.URL_DOWNLOAD)<span style="color: #008000;">//
</span>                .tag(<span style="color: #0000ff;">this</span>)<span style="color: #008000;">//
</span>                .headers(<span style="color: #800000;">"</span><span style="color: #800000;">header1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">headerValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>                .<span style="color: #0000ff;">params</span>(<span style="color: #800000;">"</span><span style="color: #800000;">param1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">paramValue1</span><span style="color: #800000;">"</span>)<span style="color: #008000;">//
</span>                .execute(<span style="color: #0000ff;">new</span> DownloadFileCallBack(Environment.getExternalStorageDirectory() + <span style="color: #800000;">"</span><span style="color: #800000;">/temp</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">OkHttpUtils.apk</span><span style="color: #800000;">"</span>));</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h4>　　　　5.2 方式二（DownloadManager）：</h4>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">　　　　if</span> (downloadManager.getTaskByUrl(apk.getUrl()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            Toast.makeText(getContext(), </span><span style="color: #800000;">"</span><span style="color: #800000;">任务已经在下载列表中</span><span style="color: #800000;">"</span><span style="color: #000000;">, Toast.LENGTH_SHORT).show();
        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
            downloadManager.addTask(apk.getUrl(), </span><span style="color: #0000ff;">null</span><span style="color: #000000;">);
            AppCacheUtils.getInstance(getContext()).put(apk.getUrl(), apk);
            download.setText(</span><span style="color: #800000;">"</span><span style="color: #800000;">已在队列</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            download.setEnabled(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
        }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">/*</span><span style="color: #008000;">* 一旦该方法执行，意味着开始下载了 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">protected</span> DownloadInfo doInBackground(Void... <span style="color: #0000ff;">params</span><span style="color: #000000;">) {
        </span><span style="color: #0000ff;">if</span> (isCancelled()) <span style="color: #0000ff;">return</span><span style="color: #000000;"> mDownloadInfo;
        L.e(</span><span style="color: #800000;">"</span><span style="color: #800000;">doInBackground:</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> mDownloadInfo.getFileName());
        mPreviousTime </span>=<span style="color: #000000;"> System.currentTimeMillis();
        mDownloadInfo.setNetworkSpeed(</span><span style="color: #800080;">0</span><span style="color: #000000;">);
        mDownloadInfo.setState(DownloadManager.DOWNLOADING);
        postMessage(</span><span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">);

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;构建下载文件路径，如果有设置，就用设置的，否者就自己创建&lt;/span&gt;
String url =&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo.getUrl();
String fileName &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo.getFileName();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (TextUtils.isEmpty(fileName)) {
    fileName &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; getUrlFileName(url);
    mDownloadInfo.setFileName(fileName);
}
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (TextUtils.isEmpty(mDownloadInfo.getTargetPath())) {
    File file &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; File(mDownloadInfo.getTargetFolder(), fileName);
    mDownloadInfo.setTargetPath(file.getAbsolutePath());
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;检查手机上文件的有效性&lt;/span&gt;
File file = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; File(mDownloadInfo.getTargetPath());
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; startPos;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (file.length() !=&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo.getDownloadLength()) {
    mDownloadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mDownloadInfo.setState(DownloadManager.ERROR);
    postMessage(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;断点文件异常，需要删除后重新下载&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;断点下载的情况&lt;/span&gt;
    startPos =&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo.getDownloadLength();
}
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;再次检查文件有效性，文件大小大于总文件大小&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (startPos &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo.getTotalLength()) {
    mDownloadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mDownloadInfo.setState(DownloadManager.ERROR);
    postMessage(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;断点文件异常，需要删除后重新下载&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo;
}
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (startPos == mDownloadInfo.getTotalLength() &amp;amp;&amp;amp; startPos &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    mDownloadInfo.setProgress(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;1.0f&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mDownloadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mDownloadInfo.setState(DownloadManager.FINISH);
    postMessage(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo;
}
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;设置断点写文件&lt;/span&gt;</code></pre><p><span style="color: #000000;">        ProgressRandomAccessFile randomAccessFile;<br>        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br>            randomAccessFile </span>= <span style="color: #0000ff;">new</span> ProgressRandomAccessFile(file, <span style="color: #800000;">“</span><span style="color: #800000;">rw</span><span style="color: #800000;">“</span><span style="color: #000000;">, startPos);<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (FileNotFoundException e) {<br>            e.printStackTrace();<br>            mDownloadInfo.setNetworkSpeed(</span><span style="color: #800080;">0</span><span style="color: #000000;">);<br>            mDownloadInfo.setState(DownloadManager.ERROR);<br>            postMessage(</span><span style="color: #800000;">“</span><span style="color: #800000;">没有找到已存在的断点文件</span><span style="color: #800000;">“</span><span style="color: #000000;">, e);<br>            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> mDownloadInfo;<br>        }<br>        L.e(</span><span style="color: #800000;">“</span><span style="color: #800000;">startPos:</span><span style="color: #800000;">“</span> + startPos + <span style="color: #800000;">“</span><span style="color: #800000;">  path:</span><span style="color: #800000;">“</span> +<span style="color: #000000;"> mDownloadInfo.getTargetPath());</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;构建请求体,默认使用get请求下载,设置断点头&lt;/span&gt;</code></pre><p><span style="color: #000000;">        Response response;<br>        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br>            response </span>= OkHttpUtils.<span style="color: #0000ff;">get</span>(url).headers(<span style="color: #800000;">“</span><span style="color: #800000;">RANGE</span><span style="color: #800000;">“</span>, <span style="color: #800000;">“</span><span style="color: #800000;">bytes=</span><span style="color: #800000;">“</span> + startPos + <span style="color: #800000;">“</span><span style="color: #800000;">-</span><span style="color: #800000;">“</span><span style="color: #000000;">).execute();<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br>            e.printStackTrace();<br>            mDownloadInfo.setNetworkSpeed(</span><span style="color: #800080;">0</span><span style="color: #000000;">);<br>            mDownloadInfo.setState(DownloadManager.ERROR);<br>            postMessage(</span><span style="color: #800000;">“</span><span style="color: #800000;">网络异常</span><span style="color: #800000;">“</span><span style="color: #000000;">, e);<br>            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> mDownloadInfo;<br>        }<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">获取流对象，准备进行读写文件</span><br>        <span style="color: #0000ff;">long</span> totalLength =<span style="color: #000000;"> response.body().contentLength();<br>        </span><span style="color: #0000ff;">if</span> (mDownloadInfo.getTotalLength() == <span style="color: #800080;">0</span><span style="color: #000000;">) {<br>            mDownloadInfo.setTotalLength(totalLength);<br>        }<br>        InputStream </span><span style="color: #0000ff;">is</span> =<span style="color: #000000;"> response.body().byteStream();<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">读写文件流</span><br>        <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br>            download(</span><span style="color: #0000ff;">is</span><span style="color: #000000;">, randomAccessFile);<br>        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br>            e.printStackTrace();<br>            mDownloadInfo.setNetworkSpeed(</span><span style="color: #800080;">0</span><span style="color: #000000;">);<br>            mDownloadInfo.setState(DownloadManager.ERROR);<br>            postMessage(</span><span style="color: #800000;">“</span><span style="color: #800000;">文件读写异常</span><span style="color: #800000;">“</span><span style="color: #000000;">, e);<br>            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> mDownloadInfo;<br>        }</span></p>
<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;循环结束走到这里，a.下载完成     b.暂停      c.判断是否下载出错&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (isCancelled()) {
        L.e(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;state: 暂停&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; +&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo.getState());
        mDownloadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (isPause) mDownloadInfo.setState(DownloadManager.PAUSE); &lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;暂停&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; mDownloadInfo.setState(DownloadManager.NONE);          &lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;停止&lt;/span&gt;
        postMessage(&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (file.length() == mDownloadInfo.getTotalLength() &amp;amp;&amp;amp; mDownloadInfo.getState() ==&lt;span style=&quot;color: #000000;&quot;&gt; DownloadManager.DOWNLOADING) {
        mDownloadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        mDownloadInfo.setState(DownloadManager.FINISH); &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;下载完成&lt;/span&gt;
        postMessage(&lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    } &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (file.length() !=&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo.getDownloadLength()) {
        mDownloadInfo.setNetworkSpeed(&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        mDownloadInfo.setState(DownloadManager.ERROR); &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;由于不明原因，文件保存有误&lt;/span&gt;
        postMessage(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;未知原因&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; mDownloadInfo;
}    &lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/29/Android开源框架二基于OkHttp进一步封装的okhttp-utils介绍/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 开源框架 ( 二 ) 基于OkHttp进一步封装的okhttp-utils介绍">
                
                <h1>Android 开源框架 ( 二 ) 基于OkHttp进一步封装的okhttp-utils介绍</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月29日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.7k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 10 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/开源框架/">开源框架</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/开源框架/">开源框架</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/okhttp-utils.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p>　　okhttp-utils是张鸿洋是基于OkHttp封装的框架库。实际工作中，使用的不多，对于小型项目的网络请求和文件传输可以考虑直接使用。否则还是基于主流的OkHttp+Retrift+RxJava框架。</p>
<p>　　对于OkHttp使用，可以自己根据自己项目需要，做一些封装。如果应付手头临时项目，可以借鉴GitHub上一些开源OkHttp封装库.只要去GitHub上搜索下OkHttp 会出来很多封装的框架。</p>
<p>　　分析okhttp-utils使用，只是用于自己学习了解。</p>
<h3>一.将okhttp-utils当做module引入项目中</h3>
<p>　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180729112047366-1984867735.png" alt></p>
<h3>二.okhttp-utils引入到项目中文件列表目录：</h3>
<p>　　　　　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180729112102229-1521363822.png" alt></p>
<h2>三.okhttp-utils 基本使用</h2>
<h3>　　1. //get 请求数据</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">OkHttpUtils
        .</span><span style="color: #0000ff;">get</span><span style="color: #000000;">()
        .url(url)
        .id(</span><span style="color: #800080;">100</span><span style="color: #000000;">)
        .build()
        .execute(</span><span style="color: #0000ff;">new</span> MyStringCallback());</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h3>　　2.//post 请求数据</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">OkHttpUtils
        .postString()
        .url(url)
        .mediaType(MediaType.parse(</span><span style="color: #800000;">"</span><span style="color: #800000;">application/json; charset=utf-8</span><span style="color: #800000;">"</span><span style="color: #000000;">))
        .content(</span><span style="color: #0000ff;">new</span> Gson().toJson(<span style="color: #0000ff;">new</span> User(<span style="color: #800000;">"</span><span style="color: #800000;">zhy</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">123</span><span style="color: #800000;">"</span><span style="color: #000000;">)))
        .build()
        .execute(</span><span style="color: #0000ff;">new</span> MyStringCallback());        </pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h3>　　3.//上传文件</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">OkHttpUtils
        .postFile()
        .url(url)
        .file(file)
        .build()
        .execute(</span><span style="color: #0000ff;">new</span> MyStringCallback());</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h3>　　4.//加载图片</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">OkHttpUtils
        .</span><span style="color: #0000ff;">get</span><span style="color: #000000;">()
        .url(url)
        .tag(</span><span style="color: #0000ff;">this</span><span style="color: #000000;">)
        .build()
        .connTimeOut(</span><span style="color: #800080;">20000</span><span style="color: #000000;">)
        .readTimeOut(</span><span style="color: #800080;">20000</span><span style="color: #000000;">)
        .writeTimeOut(</span><span style="color: #800080;">20000</span><span style="color: #000000;">)
        .execute(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BitmapCallback()
        {
            @Override
            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onError(Call call, Exception e, <span style="color: #0000ff;">int</span><span style="color: #000000;"> id)
            {
                mTv.setText(</span><span style="color: #800000;">"</span><span style="color: #800000;">onError:</span><span style="color: #800000;">"</span> +<span style="color: #000000;"> e.getMessage());
            }

<pre><code>    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onResponse(Bitmap bitmap, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
        Log.e(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;TAG&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;onResponse：complete&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        mImageView.setImageBitmap(bitmap);
    }
});    &lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h3>　　5.//上传单个文件</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>OkHttpUtils.post()<span style="color: #008000;">//
</span>        .addFile(<span style="color: #800000;">"</span><span style="color: #800000;">mFile</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">messenger_01.png</span><span style="color: #800000;">"</span><span style="color: #000000;">, file)
        .url(url)
        .</span><span style="color: #0000ff;">params</span>(<span style="color: #0000ff;">params</span>)<span style="color: #008000;">//</span><span style="color: #008000;">带表单数据</span>
<span style="color: #000000;">        .headers(headers)
        .build()
        .execute(</span><span style="color: #0000ff;">new</span> MyStringCallback());    </pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h3>　　6.//上传多个文件</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">OkHttpUtils.post()
        .addFile(</span><span style="color: #800000;">"</span><span style="color: #800000;">mFile</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">messenger_01.png</span><span style="color: #800000;">"</span><span style="color: #000000;">, file)
        .addFile(</span><span style="color: #800000;">"</span><span style="color: #800000;">mFile</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">test1.txt</span><span style="color: #800000;">"</span><span style="color: #000000;">, file2)
        .url(url)
        .</span><span style="color: #0000ff;">params</span>(<span style="color: #0000ff;">params</span>)<span style="color: #008000;">//</span><span style="color: #008000;">带表单数据</span>
<span style="color: #000000;">        .build()
        .execute(</span><span style="color: #0000ff;">new</span> MyStringCallback());    </pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h3>　　7.//下载文件</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">OkHttpUtils
        .</span><span style="color: #0000ff;">get</span><span style="color: #000000;">()
        .url(url)
        .build()
        .execute(</span><span style="color: #0000ff;">new</span> FileCallBack(Environment.getExternalStorageDirectory().getAbsolutePath(), <span style="color: #800000;">"</span><span style="color: #800000;">gson-2.2.1.jar</span><span style="color: #800000;">"</span><span style="color: #000000;">)
        {

<pre><code>    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onBefore(Request request, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; inProgress(&lt;span style=&quot;color: #0000ff;&quot;&gt;float&lt;/span&gt; progress, &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt; total, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;进度条显示&lt;/span&gt;
        mProgressBar.setProgress((&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;) (&lt;span style=&quot;color: #800080;&quot;&gt;100&lt;/span&gt; *&lt;span style=&quot;color: #000000;&quot;&gt; progress));
        Log.e(TAG, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;inProgress :&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; + (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;) (&lt;span style=&quot;color: #800080;&quot;&gt;100&lt;/span&gt; *&lt;span style=&quot;color: #000000;&quot;&gt; progress));
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onError(Call call, Exception e, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
        Log.e(TAG, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;onError :&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; +&lt;span style=&quot;color: #000000;&quot;&gt; e.getMessage());
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onResponse(File file, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
        Log.e(TAG, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;onResponse :&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; +&lt;span style=&quot;color: #000000;&quot;&gt; file.getAbsolutePath());
    }
});    &lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<h3>　　定义的公共回调方法：</h3>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MyStringCallback extends StringCallback
    {
        @Override
        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onBefore(Request request, <span style="color: #0000ff;">int</span><span style="color: #000000;"> id)
        {
        }

<pre><code>    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onAfter(&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onError(Call call, Exception e, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
        e.printStackTrace();
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; onResponse(String response, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
        Log.e(TAG, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;onResponse：complete&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        mTv.setText(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;onResponse:&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; +&lt;span style=&quot;color: #000000;&quot;&gt; response);

        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;switch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (id)
        {
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;100&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:
                Toast.makeText(MainActivity.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;http&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, Toast.LENGTH_SHORT).show();
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;101&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:
                Toast.makeText(MainActivity.&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;https&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, Toast.LENGTH_SHORT).show();
                &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
        }
    }

    @Override
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; inProgress(&lt;span style=&quot;color: #0000ff;&quot;&gt;float&lt;/span&gt; progress, &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt; total, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; id)
    {
        Log.e(TAG, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;inProgress:&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; +&lt;span style=&quot;color: #000000;&quot;&gt; progress);
        mProgressBar.setProgress((&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;) (&lt;span style=&quot;color: #800080;&quot;&gt;100&lt;/span&gt; *&lt;span style=&quot;color: #000000;&quot;&gt; progress));
    }
}        &lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/28/Android7-0下载APK后自动安装/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android7.0下载APK后自动安装">
                
                <h1>Android7.0下载APK后自动安装</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月28日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.5k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 7 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/知识点/">知识点</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/Android7-0/">Android7.0</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/strictMode.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p>&nbsp; &nbsp; &nbsp; &nbsp; 随着Android版本越来越高，Android对隐私的保护力度也越来越大。这些隐私权限的更改在为用户带来更加安全的操作系统的同时也为开发者带来了一些新的任务。如何让你的APP能够适应这些改变而不是崩溃，是每一位Android开发者必须要了解学习的。<br>        </p>
<h2>一.引言</h2>
<p>    　　Android 6.0引入了动态权限控制.<br>    　　Android 7.0 引入了私有目录被限制访问和StrictMode API ,在7.0上应用私有目录将被限制访问，这与iOS的沙盒机制类似,StrictMode API是指禁止向你的应用外公开 file:// URI。 如果一项包含文件 file:// URI类型 的 Intent 离开你的应用，则会报出异常。这项权限的变更将意味着你无法通过File API访问手机存储上的数据了，基于File API的一些文件浏览器等也将受到很大的影响.<br>    　　所以在7.0系统上,给其他应用传递 file:// URI 类型的Uri，可能会导致接受者无法访问该路径。 因此，在Android7.0中尝试传递 file:// URI 会触发 FileUriExposedException。解决办法就是可以通过使用<strong>FileProvider</strong>来解决这一问题.<br>        </p>
<h2>二. 两种实现自动下载安装方式</h2>
<p>　　两种下载方式入口:</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">　　/*</span><span style="color: #008000;">*
     * @param context
     * @param apkUrl      APK下载路径
     * @param fileName    APK下载自定义名称
     * @param webViewMode 是否是浏览器模式下载
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> install(Context context, String apkUrl, String fileName, boolean webViewMode) {
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (webViewMode) {
            downloadByWeb(context, apkUrl);
        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
            downloadBySelf(context, apkUrl, fileName);
        }
    }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h4>　　1. 通过手机内置浏览器来下载安装更新APP. 　　　　</h4>
<p>　　这种方式将下载和安装更新操作交给浏览器操作了,很简单,但是这种也是不受控的.有时候浏览器会推荐一系列的广告App伴随下载,不小心就会中招.</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">　　//</span><span style="color: #008000;">通过浏览器方式下载并安装</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> downloadByWeb(Context context, String apkPath) {
        Uri uri </span>=<span style="color: #000000;"> Uri.parse(apkPath);
        </span><span style="color: #008000;">//</span><span style="color: #008000;">String android.intent.action.VIEW 比较通用，会根据用户的数据类型打开相应的Activity。如:浏览器,电话,播放器,地图</span>
        Intent intent = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Intent(Intent.ACTION_VIEW, uri);
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        context.startActivity(intent);
    }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h4>　　2. 通过DownloadManager 下载APK,并提示安装</h4>
<h5>　　　　2.1 通过DownloadManager</h5>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">　　　　private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> downloadBySelf(Context context, String apkUrl, String fileName) {
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (TextUtils.isEmpty(apkUrl)) {
                    </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
                }
                </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                    Uri uri </span>=<span style="color: #000000;"> Uri.parse(apkUrl);
                    DownloadManager downloadManager </span>=<span style="color: #000000;"> (DownloadManager) context
                            .getSystemService(Context.DOWNLOAD_SERVICE);
                    DownloadManager.Request request </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadManager.Request(uri);
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">在通知栏中显示</span>
                    request.setVisibleInDownloadsUi(<span style="color: #0000ff;">true</span><span style="color: #000000;">);
                    request.setTitle(</span><span style="color: #800000;">"</span><span style="color: #800000;">应用更新</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                    request.setDescription(</span><span style="color: #800000;">"</span><span style="color: #800000;">本次更新描述</span><span style="color: #800000;">"</span><span style="color: #000000;">)
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">MIME_MapTable是所有文件的后缀名所对应的MIME类型的一个String数组  {".apk",    "application/vnd.android.package-archive"},</span>
                    request.setMimeType(<span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.android.package-archive</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 在通知栏通知下载中和下载完成
                    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 下载完成后该Notification才会被显示</span>
                    <span style="color: #0000ff;">if</span> (Build.VERSION.SDK_INT &gt;<span style="color: #000000;"> Build.VERSION_CODES.HONEYCOMB) {
                        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Android 3.0版本 以后才有该方法
                        </span><span style="color: #008000;">//</span><span style="color: #008000;">在下载过程中通知栏会一直显示该下载的Notification，在下载完成后该Notification会继续显示，直到用户点击该Notification或者消除该Notification</span>
<span style="color: #000000;">                        request.setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED);
                    }
                    String filePath </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;
                    </span><span style="color: #0000ff;">if</span> (Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)) {<span style="color: #008000;">//</span><span style="color: #008000;">外部存储卡</span>
                        filePath =<span style="color: #000000;"> Environment.getExternalStorageDirectory().getAbsolutePath();
                    } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                        Log.i(TAG, </span><span style="color: #800000;">"</span><span style="color: #800000;">没有SD卡</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                        </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
                    }
                    downloadUpdateApkFilePath </span>= filePath + File.separator + fileName + System.currentTimeMillis() + <span style="color: #800000;">"</span><span style="color: #800000;">.apk</span><span style="color: #800000;">"</span><span style="color: #000000;">;
                    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 若存在，则删除 (这里具体逻辑具体看,我这里是删除)</span>
<span style="color: #000000;">                    deleteFile(downloadUpdateApkFilePath);
                    Uri fileUri </span>= Uri.fromFile(<span style="color: #0000ff;">new</span><span style="color: #000000;"> File(downloadUpdateApkFilePath));
                    request.setDestinationUri(fileUri);
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">下载管理Id</span>
<span style="color: #000000;">                    downloadManager.enqueue(request);
                    DownloadReceiver mDownloaderReceiver </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadReceiver();
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">注册下载完成广播</span>
                    context.registerReceiver(mDownloaderReceiver, <span style="color: #0000ff;">new</span><span style="color: #000000;"> IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE));

<pre><code>} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;catch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (Exception e) {
    e.printStackTrace();
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;注意:如果文件下载失败则 使用浏览器下载
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; downloadByWeb(context, apkUrl);&lt;/span&gt;</code></pre><p><span style="color: #000000;">                }<br>            }</span></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h5>　　　　2.2 通过广播监控下载完成,调至提示用户安装操作.</h5>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>    　　　　<span style="color: #008000;">/*</span><span style="color: #008000;">*
             * 下载完成的广播
             </span><span style="color: #008000;">*/</span>
            <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> DownloadReceiver extends BroadcastReceiver {
                @Override
                </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onReceive(Context context, Intent intent) {
                    </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">TextUtils.isEmpty(downloadUpdateApkFilePath)) {
                        installNormal(context, downloadUpdateApkFilePath);
                    }
                }
            }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h5>　　　　2.3 提示用户安装或者更新</h5>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">　　　　/*</span><span style="color: #008000;">*
         * 提示安装
         * @param context 上下文
         * @param apkPath apk下载完成在手机中的路径
         </span><span style="color: #008000;">*/</span>
        <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> installNormal(Context context, String apkPath) {
            Intent intent </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Intent(Intent.ACTION_VIEW);
            </span><span style="color: #008000;">//</span><span style="color: #008000;">版本在7.0以上是不能直接通过uri访问的</span>
            <span style="color: #0000ff;">if</span> (Build.VERSION.SDK_INT &gt;<span style="color: #000000;"> Build.VERSION_CODES.N) {
                File file </span>= (<span style="color: #0000ff;">new</span><span style="color: #000000;"> File(apkPath));
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> 由于没有在Activity环境下启动Activity,设置下面的标签</span>
<span style="color: #000000;">                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                </span><span style="color: #008000;">//</span><span style="color: #008000;">参数1:上下文, 参数2:Provider主机地址 和配置文件中保持一致,参数3:共享的文件</span>
                Uri apkUri = FileProvider.getUriForFile(context, <span style="color: #800000;">"</span><span style="color: #800000;">com.xxxxx.fileprovider</span><span style="color: #800000;">"</span><span style="color: #000000;">, file);
                </span><span style="color: #008000;">//</span><span style="color: #008000;">添加这一句表示对目标应用临时授权该Uri所代表的文件</span>
<span style="color: #000000;">                intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
                intent.setDataAndType(apkUri, </span><span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.android.package-archive</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                intent.setDataAndType(Uri.fromFile(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> File(apkPath)),
                        </span><span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.android.package-archive</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            }
            context.startActivity(intent);
        }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h2>三. 补充</h2>
<p>　　MIME_MapTable是所有文件的后缀名所对应的MIME类型的一个String数组</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">　　　　　　　　//</span><span style="color: #008000;">{后缀名，MIME类型} </span>
            {<span style="color: #800000;">"</span><span style="color: #800000;">.3gp</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/3gpp</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.apk</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.android.package-archive</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.asf</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/x-ms-asf</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.avi</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/x-msvideo</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.bin</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/octet-stream</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.bmp</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">image/bmp</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.c</span><span style="color: #800000;">"</span>,  <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.class</span><span style="color: #800000;">"</span>,  <span style="color: #800000;">"</span><span style="color: #800000;">application/octet-stream</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.conf</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.cpp</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.doc</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/msword</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.docx</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.openxmlformats-officedocument.wordprocessingml.document</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.xls</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.ms-excel</span><span style="color: #800000;">"</span><span style="color: #000000;">},  
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.xlsx</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.openxmlformats-officedocument.spreadsheetml.sheet</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.exe</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/octet-stream</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.gif</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">image/gif</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.gtar</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">application/x-gtar</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.gz</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">application/x-gzip</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.h</span><span style="color: #800000;">"</span>,  <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.htm</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">text/html</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.html</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">text/html</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.jar</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/java-archive</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.java</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.jpeg</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">image/jpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.jpg</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">image/jpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.js</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">application/x-javascript</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.log</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.m3u</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/x-mpegurl</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.m4a</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/mp4a-latm</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.m4b</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/mp4a-latm</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.m4p</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/mp4a-latm</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.m4u</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/vnd.mpegurl</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.m4v</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/x-m4v</span><span style="color: #800000;">"</span><span style="color: #000000;">},  
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mov</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/quicktime</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mp2</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/x-mpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mp3</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/x-mpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mp4</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/mp4</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mpc</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.mpohun.certificate</span><span style="color: #800000;">"</span><span style="color: #000000;">},        
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mpe</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/mpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">},   
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mpeg</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">video/mpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">},   
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mpg</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">video/mpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">},   
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mpg4</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">video/mp4</span><span style="color: #800000;">"</span><span style="color: #000000;">},    
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.mpga</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">audio/mpeg</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.msg</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.ms-outlook</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.ogg</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/ogg</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.pdf</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/pdf</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.png</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">image/png</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.pps</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.ms-powerpoint</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.ppt</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.ms-powerpoint</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.pptx</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.openxmlformats-officedocument.presentationml.presentation</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.prop</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.rc</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.rmvb</span><span style="color: #800000;">"</span>,   <span style="color: #800000;">"</span><span style="color: #800000;">audio/x-pn-realaudio</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.rtf</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/rtf</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.sh</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.tar</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/x-tar</span><span style="color: #800000;">"</span><span style="color: #000000;">},    
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.tgz</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/x-compressed</span><span style="color: #800000;">"</span><span style="color: #000000;">},  
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.txt</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.wav</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/x-wav</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.wma</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/x-ms-wma</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.wmv</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">audio/x-ms-wmv</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.wps</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/vnd.ms-works</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.xml</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">text/plain</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.z</span><span style="color: #800000;">"</span>,  <span style="color: #800000;">"</span><span style="color: #800000;">application/x-compress</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">"</span><span style="color: #800000;">.zip</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">application/x-zip-compressed</span><span style="color: #800000;">"</span><span style="color: #000000;">}, 
            {</span><span style="color: #800000;">""</span>,        <span style="color: #800000;">"</span><span style="color: #800000;">*/*</span><span style="color: #800000;">"</span>} </pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/28/Android开源框架一OkHttp网络框架的基本使用/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android 开源框架 ( 一 ) OkHttp 网络框架的基本使用">
                
                <h1>Android 开源框架 ( 一 ) OkHttp 网络框架的基本使用</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月28日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.4k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 7 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/开源框架/">开源框架</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/开源框架/">开源框架</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/rxjava_get.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <p>&nbsp; &nbsp; &nbsp; &nbsp;<strong>HttpClient&nbsp; 和&nbsp;HttpURLConnection 以及 OkHttp</strong> :</p>
<p>　　在Android 2.2版本之前，HttpClient拥有较少的bug，因此使用它是最好的选择。 <br>&nbsp; &nbsp; &nbsp; &nbsp; 而在Android2.3版本及以后，HttpURLConnection则是最佳的选择。它的API简单，体积较小，因而非常适用于Android项目。压缩和缓存机制可以有效地减少网络访问的流量，在提升速度和省电方面也起到了较大的作用。对于新的应用程序应该更加偏向于使用HttpURLConnection，因为在以后的工作当中我们也会将更多的时间放在优化HttpURLConnection上面。</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; 其实现在嘛，两者都不用，就用Okhttp. HttpUrlConnection现在的底层实现就是通过Okhttp.</p>
<h2>一. HttpUrlConnect 介绍</h2>
<h4>　　1. 网络通信首先需要配置网络请求权限:</h4>
<div class="cnblogs_code">
<pre>&lt;uses-permission android:name=<span style="color: #800000;">"</span><span style="color: #800000;">android.permission.INTERNET</span><span style="color: #800000;">"</span> /&gt;</pre>
</div>
<h4>　　2.使用如下方式实现子线程里http请求通信:&nbsp;</h4>
<p>　　开启线程两种常用的实现方式:一种是继承Thread类.一种是实现Runnable接口.</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">new</span> Thread(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable() {

<pre><code>@Override
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; run() {
    ...
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;子线程方法异步执行&lt;/span&gt;</code></pre><p><span style="color: #000000;">                …<br>            }<br>        }).start();</span></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>　　如果在主线程(也就是我们常说的UI线程)中进行Http请求,会报如下错.(NetworkOnMainThreadException)</p>
<div class="cnblogs_code">
<pre>java.lang.RuntimeException: Unable to start activity ComponentInfo{com.android.okhttp.okhttp/<span style="color: #000000;">com.android.okhttp.okhttp.MainActivity}: android.os.NetworkOnMainThreadException
        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:</span><span style="color: #800080;">2855</span>)</pre>
</div>
<h4>　　3.使用HttpUrlConnect实现异步http get请求获取网络数据示例:</h4>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;"> 1. 得到访问地址的URL</span>
            URL url = <span style="color: #0000ff;">new</span><span style="color: #000000;"> URL(urlStr);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 2. 得到网络访问对象java.net.HttpURLConnection</span>
            HttpURLConnection connection =<span style="color: #000000;"> (HttpURLConnection) url.openConnection();
            </span><span style="color: #008000;">/*</span><span style="color: #008000;"> 3. 设置请求参数（过期时间，输入、输出流、访问方式），以流的形式进行连接 </span><span style="color: #008000;">*/</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> 设置是否向HttpURLConnection输出</span>
            connection.setDoOutput(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 设置是否从httpUrlConnection读入</span>
            connection.setDoInput(<span style="color: #0000ff;">true</span><span style="color: #000000;">);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 设置请求方式</span>
            connection.setRequestMethod(<span style="color: #800000;">"</span><span style="color: #800000;">GET</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 设置是否使用缓存</span>
            connection.setUseCaches(<span style="color: #0000ff;">true</span><span style="color: #000000;">);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 设置此 HttpURLConnection 实例是否应该自动执行 HTTP 重定向</span>
            connection.setInstanceFollowRedirects(<span style="color: #0000ff;">true</span><span style="color: #000000;">);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 设置超时时间</span>
            connection.setConnectTimeout(<span style="color: #800080;">3000</span><span style="color: #000000;">);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 连接</span>
<span style="color: #000000;">            connection.connect();
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 4. 得到响应状态码的返回值 responseCode</span>
            <span style="color: #0000ff;">int</span> code =<span style="color: #000000;"> connection.getResponseCode();
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 5. 如果返回值正常，数据在网络中是以流的形式得到服务端返回的数据</span>
            String msg = <span style="color: #800000;">""</span><span style="color: #000000;">;
            </span><span style="color: #0000ff;">if</span> (code == <span style="color: #800080;">200</span>) { <span style="color: #008000;">//</span><span style="color: #008000;"> 正常响应
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> 从流中读取响应信息</span>
                BufferedReader reader = <span style="color: #0000ff;">new</span><span style="color: #000000;"> BufferedReader(
                        </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> InputStreamReader(connection.getInputStream()));
                String line </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; 循环从流中读取&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; ((line = reader.readLine()) != &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    msg &lt;/span&gt;+= line + &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}
reader.close(); &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; 关闭流&lt;/span&gt;</code></pre><p><span style="color: #000000;">            }<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;"> 6. 断开连接，释放资源</span><br><span style="color: #000000;">            connection.disconnect();</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; 显示响应结果&lt;/span&gt;
Log.i(&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;getDataByHttpUrlConnect&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,msg);
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;组装消息&lt;/span&gt;
Message message = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; Message();
message.what &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; RESPONSE_OK;
message.obj &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; msg;
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;发送消息&lt;/span&gt;</code></pre><p><span style="color: #000000;">            handler.sendMessage(message);<br></span></p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h4>　　　　4.在子线程进行网络请求后,将返回的信息在主线程控件上刷新显示. 使用到Handler操作.</h4>
<pre><span>　　//定义一个Handler来接收子线程发送的消息并处理:</span></pre>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">            Handler handler </span>= <span style="color: #0000ff;">new</span> Handler(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Handler.Callback() {
                @Override
                </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> boolean handleMessage(Message message) {
                    </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (message.what){
                        </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> RESPONSE_OK:
                            </span><span style="color: #008000;">//</span><span style="color: #008000;">将返回的消息打印在界面TextView控件上显示</span>
<span style="color: #000000;">                            tv_response.setText(message.obj.toString());
                            </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
                    }
                    </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
                }
            });</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<h2>二. OkHttp 介绍</h2>
<p>　　<strong>Requests 和&nbsp;Responses</strong> 两个属性概念解释:</p>
<p>　　　　Requests（请求） 每一个HTTP请求中都应该包含一个URL，一个GET或POST方法以及Header或其他参数，当然还可以含特定内容类型的数据流。<br>                    　　　　　　　　注意下Content-Type:<br>                    　　　　　　　　　　RequestBody的数据格式都要指定Content-Type，常见的有三种：<br>                    　　　　　　　　　　application/x-www-form-urlencoded 数据是个普通表单<br>                    　　　　　　　　　　multipart/form-data 数据里有文件<br>                    　　　　　　　　　　application/json 数据是个json<br>                    <br>    　　　　Responses（响应） 响应则包含一个回复代码（200代表成功，404代表未找到等灯），Header和定制可选的body。</p>
<h4>　　1.项目中配置使用OkHttp　　</h4>
<p>　　首先gradle 引入类库(AndroidStudio显示最新的是3.11.0版本-2018年7月28日):</p>
<div class="cnblogs_code">
<pre>implementation <span style="color: #800000;">'</span><span style="color: #800000;">com.squareup.okhttp3:okhttp:3.11.0</span><span style="color: #800000;">'</span>    </pre>
</div>
<p> 　　或者下载jar包:<br>    　　　　OkHttp官网地址：http://square.github.io/okhttp/<br>    　　　　OkHttp GitHub地址：https://github.com/square/okhttp</p>
<h4>　　2. OkHttp get请求示例:</h4>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">　　　　　　//</span><span style="color: #008000;">new OkHttpClient</span>
            OkHttpClient okHttpClient = <span style="color: #0000ff;">new</span><span style="color: #000000;"> OkHttpClient();
                </span><span style="color: #008000;">//</span><span style="color: #008000;">封装Request请求信息,get方式,请求url</span>
                Request request = <span style="color: #0000ff;">new</span> Request.Builder().<span style="color: #0000ff;">get</span><span style="color: #000000;">().url(urlStr).build();
                </span><span style="color: #008000;">//</span><span style="color: #008000;">定义一个接受返回信息的Response</span>
                Response response = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
                </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">调用OkHttp内部真正的实现请求,并返回请求结果Response</span>
                    response =<span style="color: #000000;"> okHttpClient.newCall(request).execute();
                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;">(response.isSuccessful()){
                        </span><span style="color: #008000;">//</span><span style="color: #008000;">请求回来不能再子线程里进行界面Ui更新操作,通过Handler来通知主线程界面刷新</span>
                        Message message = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Message();
                        message.what </span>=<span style="color: #000000;"> RESPONSE_OK;
                        message.obj </span>=<span style="color: #000000;"> response.body().toString();
                        handler.sendMessage(message);
                    }
                } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
                    e.printStackTrace();
                }</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/22/Android进阶学习笔记整理/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android进阶学习笔记整理">
                
                <h1>Android进阶学习笔记整理</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月22日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.2k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 4 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/9350418.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <div>
<h2>一．android系统架构图及各层介绍</h2>
<p style="text-align: center;"><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722160006222-1427704878.jpg" alt></p>
<strong>1. 应用层</strong>：应用是用java语言编写的运行在虚拟机上的程序，比如通讯录，日历,电话，短信，浏览器等。</div>
<div><br><strong>2. 应用框架层</strong>：这一层是编写Google发布的核心应用时所使用的API框架，开发人员同样可以使用这些框架来开发自己的应用，这样便简化了程序开发的结构设计，但是必须要遵守其框架的开发原则。应用程序框架层包括活动管理器、窗口管理器、内容提供者、视图系统、包管理器、电话管理器、资源管理器、位置管理器、通知管理器和XMPP服务十个部分。</div>
<div><br><strong>3. 统运行库（C/C++库以及Android运行库）层</strong>：当使用Android应用框架时，Android系统会通过一些C/C++库来支持我们使用的各个组件，使其更好的为我们服务，比如其中的SQLite（关系数据库），Webkit，chromium（Web浏览器引擎），Dalivk,ART(Android Runtime)。</div>
<div><br><strong>4.Linux内核层</strong>：Android的核心系统服务基于Linux内核，如安全性、内存管理、进程管理、用户权限管理、网络协议栈和驱动模型等都依赖于该内核，比如Binder IPC(Internet Process Connection进程间通信)驱动，android的一个特殊驱动程序，具有单独的设备节点，提供进程间通信的功能。</div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; </div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; 若是从事Android应用开发，那应该研究Android的应用框架层和应用程序层；若是从事Android系统开发，那应该研究Android的系统库和Android运行时；若是从事Android驱动开发，那应该研究Android的Linux内核。找准定位，事倍功半。</div>
<div>
<h2>二. 随笔整理（导读）</h2>
<h3>Android 应用层：</h3>







</div>
<div><ol>
<li><a id="homepage1_HomePageDays_DaysList_ctl05_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/activity_lifecycle.html" target="_blank">Android 四大组件 (一) Activity 生命周期</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl02_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/android_service.html" target="_blank">Android 四大组件 (二) Service 使用</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/BroadcastReceiver.html" target="_blank">Android 四大组件 (三) BroadcastReceiver 介绍</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ContentProvider.html" target="_blank">Android 四大组件 (四) ContentProvider介绍</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl02_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/fragment.html" target="_blank">Android 四大组件 (五) 第五大组件 - Fragment 使用</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl04_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/android8_new_features.html" target="_blank">Android 8.0新特性介绍以及注意事项</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/aidl.html" target="_blank">AIDL介绍以及简单使用</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/viewpager.html" target="_blank">ViewPager 相关使用</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_3" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/Serializable_Parcelable.html" target="_blank">Serializable和Parcelable之序列化</a></li>





</ol></div>
<h3><br>Android 框架层：</h3>
<div><ol>
<li>&nbsp;<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/readTheFuckingSourceCode.html" target="_blank">Android 源码分析（一） 开篇介绍</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl04_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/startActivity.html" target="_blank">Android 源码分析（二） Activity 启动分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl04_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/startService.html" target="_blank">Android 源码分析（三） Service 启动分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_4" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/handler.html" target="_blank">Android 源码分析（四） Handler 异步消息机制</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_3" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/zygote.html" target="_blank">Android 源码分析（五） Zygote 进程</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_2" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank">Android 源码分析（六） SystemServer 进程</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/Launcher.html" target="_blank">Android 源码分析（七） Launcher 桌面程序启动分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/Launcher_app.html" target="_blank">Android 源码分析（八） Launcher 桌面启动App过程</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/init.html" target="_blank">Android 源码分析（九） Init 启动分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl05_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/dalvik.html" target="_blank">Android 源码分析（十） Dalvik 虚拟机创建过程</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl03_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/touchEvent.html" target="_blank">Android 源码分析（十一） 事件传递机制</a><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_2" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ServiceManager.html" target="_blank" rel="noopener">Android源码分析（十二）ServiceManager服务分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_2" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ServiceManager.html" target="_blank">Android源码分析（十二）ServiceManager服务分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ActivityManagerService.html" target="_blank">Android源码分析（十三）ActivityManagerService服务分析</a></li>
<li><a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/PackageManagerService.html" target="_blank">Android源码分析（十四）PackageManagerService服务分析</a></li>





</ol></div>
<h2>三.学习资料</h2>
<p>　　<strong>1.Android源码</strong>&nbsp;<a href="https://pan.baidu.com/s/15PNt1W4jjxZXM9o-qCC94A" target="_blank">https://pan.baidu.com/s/15PNt1W4jjxZXM9o-qCC94A</a> 密码：p3td</p>
<p>　　<strong>2.Android 6.0 离线API</strong> <a href="https://pan.baidu.com/s/17E01X32lHOrz0FN_QlXmwQ%20" target="_blank">https://pan.baidu.com/s/17E01X32lHOrz0FN_QlXmwQ </a>密码: styi</p>
<p>　　<strong>3.探索Android FrameWork底层开发视频</strong> <a href="https://pan.baidu.com/s/14BiZNm2C362afq3K-c3AJA" target="_blank">https://pan.baidu.com/s/14BiZNm2C362afq3K-c3AJA</a> 密码: i7yd</p>
<div>&nbsp; &nbsp; &nbsp; &nbsp;</div>
<div>&nbsp; &nbsp; &nbsp;&nbsp; 在学习过程中借鉴也翻阅了很多网上大牛的一些文章，加深自己的理解，如果文中未注明出处原文，还请原作者谅解，因为实在是找不到原文了。这里我推荐两个对Android 框架层研究比较透彻的两位大牛的bolg，他们帮助我加深了很多概念的理解。感谢他们。<br>　　《深入理解Android系列》丛书的作者： <a href="http://www.cnblogs.com/innost" target="_blank">http://www.cnblogs.com/innost</a><br>　　《Android系统源代码情景分析》作者：<a href="https://blog.csdn.net/Luoshengyang/" target="_blank">https://blog.csdn.net/Luoshengyang/</a></div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; 我的系列随笔只是作为一个自己的学习笔记，理解程度无法与两位大牛著作对比，但是可以作为读者或者自己初步探索Android源码和理解其实现原理的第一步。</div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; </div>
<div>&nbsp; &nbsp; &nbsp; &nbsp; 在工作中，会发现，其实很多东西，我们都会，但是就是讲不出来。学计算机出生，保持严谨性是必须的，有时候正因为时刻的严谨性，让我们不敢轻易对一些概念东西给出自己观点，怕说错，归根到底是对其实现原理理解不够透彻，让我们畏手畏脚的进行总结。“大胆假设，小心验证” 我想这句话可以作为我们学习技术的一个参考。</div>
<div>&nbsp;</div>
<div>&nbsp;</div>
<div><span style="text-decoration: underline;">附上android知识体系图</span>：</div>
<div style="text-align: center;">　　<img src="https://images2018.cnblogs.com/blog/612293/201808/612293-20180805222343312-808261016.jpg" alt></div>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/22/Android源码分析十四PackageManagerService服务分析/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android源码分析（十四）PackageManagerService服务分析">
                
                <h1>Android源码分析（十四）PackageManagerService服务分析</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月22日</a>
            <a><i class="nexmoefont icon-areachart"></i>2k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 11 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/PackageManagerService.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <div>
<h3>一. PackageManagerService启动过程分析</h3>
&nbsp;PackageManagerService(PMS)主要是管理应用的安装，卸载，更新，解析以及权限。</div>
<div>　　<br>如果想了解SystemService启动过程请看这篇文章：<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_2" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank">Android 源码分析（六） SystemServer 进程</a><br>如果想了解AMS服务分析请看这篇文章：<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/ActivityManagerService.html" target="_blank">Android源码分析（十三）ActivityManagerService服务分析</a></div>
<div>&nbsp;</div>
<div>同AMS一样，PMS也是由SystemServer启动的.</div>
<div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> final <span style="color: #0000ff;">class</span><span style="color: #000000;"> SystemServer {
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> PackageManagerService mPackageManagerService;
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> PackageManager mPackageManager;
    ...
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Start the package manager.
    </span><span style="color: #008000;">//</span><span style="color: #008000;">启动PMS服务</span>
    <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">mRuntimeRestart) {
        MetricsLogger.histogram(</span><span style="color: #0000ff;">null</span>, <span style="color: #800000;">"</span><span style="color: #800000;">boot_package_manager_init_start</span><span style="color: #800000;">"</span><span style="color: #000000;">,
                (</span><span style="color: #0000ff;">int</span><span style="color: #000000;">) SystemClock.elapsedRealtime());
    }
    traceBeginAndSlog(</span><span style="color: #800000;">"</span><span style="color: #800000;">StartPackageManagerService</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    mPackageManagerService </span>=<span style="color: #000000;"> PackageManagerService.main(mSystemContext, installer,
            mFactoryTestMode </span>!=<span style="color: #000000;"> FactoryTest.FACTORY_TEST_OFF, mOnlyCore);
    mFirstBoot </span>=<span style="color: #000000;"> mPackageManagerService.isFirstBoot();
    mPackageManager </span>=<span style="color: #000000;"> mSystemContext.getPackageManager();
    traceEnd();
    </span><span style="color: #0000ff;">if</span> (!mRuntimeRestart &amp;&amp; !<span style="color: #000000;">isFirstBootOrUpgrade()) {
        MetricsLogger.histogram(</span><span style="color: #0000ff;">null</span>, <span style="color: #800000;">"</span><span style="color: #800000;">boot_package_manager_init_ready</span><span style="color: #800000;">"</span><span style="color: #000000;">,
                (</span><span style="color: #0000ff;">int</span><span style="color: #000000;">) SystemClock.elapsedRealtime());
    }
    ...
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">PackageManagerService 初始化工作</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> PackageManagerService extends IPackageManager.Stub
        implements PackageSender {

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;static&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; PackageManagerService main(Context context, Installer installer,
        boolean factoryTest, boolean onlyCore) {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Self-check for initial settings.&lt;/span&gt;</code></pre><p><span style="color: #000000;">        PackageManagerServiceCompilerMapping.checkProperties();<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">构造一个PackageManagerService</span><br>        PackageManagerService m = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PackageManagerService(context, installer,<br>                factoryTest, onlyCore);<br>        m.enableSystemUserPackages();<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">添加到ServiceManager</span><br>        ServiceManager.addService(<span style="color: #800000;">“</span><span style="color: #800000;">package</span><span style="color: #800000;">“</span><span style="color: #000000;">, m);<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> m;<br>    }</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; PackageManagerService(Context context, Installer installer,
        boolean factoryTest, boolean onlyCore) {

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;installer apk的安装和卸载最终都是调用installd来实现的。&lt;/span&gt;
    mInstaller =&lt;span style=&quot;color: #000000;&quot;&gt; installer;
    mPackageDexOptimizer &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; PackageDexOptimizer(installer, mInstallLock, context,
            &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;*dexopt*&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    mDexManager &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; DexManager(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, mPackageDexOptimizer, installer, mInstallLock);
    mMoveCallbacks &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; MoveCallbacks(FgThread.&lt;span style=&quot;color: #0000ff;&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;().getLooper());

    synchronized (mInstallLock) {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; writer 
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;环境变量初始化&lt;/span&gt;</code></pre><p><span style="color: #000000;">        synchronized (mPackages) {<br>            File dataDir </span>=<span style="color: #000000;"> Environment.getDataDirectory();<br>            mAppInstallDir </span>= <span style="color: #0000ff;">new</span> File(dataDir, <span style="color: #800000;">“</span><span style="color: #800000;">app</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br>            mAppLib32InstallDir </span>= <span style="color: #0000ff;">new</span> File(dataDir, <span style="color: #800000;">“</span><span style="color: #800000;">app-lib</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br>            mAsecInternalPath </span>= <span style="color: #0000ff;">new</span> File(dataDir, <span style="color: #800000;">“</span><span style="color: #800000;">app-asec</span><span style="color: #800000;">“</span><span style="color: #000000;">).getPath();<br>            mDrmAppPrivateInstallDir </span>= <span style="color: #0000ff;">new</span> File(dataDir, <span style="color: #800000;">“</span><span style="color: #800000;">app-private</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br>            sUserManager </span>= <span style="color: #0000ff;">new</span> UserManagerService(context, <span style="color: #0000ff;">this</span><span style="color: #000000;">,<br>                    </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> UserDataPreparer(mInstaller, mInstallLock, mContext, mOnlyCore), mPackages);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;权限注册到 package manager，一个权限与几个组ID对应，当一个APK授予这个权限时，它同属于这几个组。
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;权限是一个复杂的过程
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Propagate permission configuration in to package manager.&lt;/span&gt;
ArrayMap&amp;lt;String, SystemConfig.PermissionEntry&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; permConfig
        &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; systemConfig.getPermissions();
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;遍历权限配置文件&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; i=&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;; i&amp;lt;permConfig.size(); i++&lt;span style=&quot;color: #000000;&quot;&gt;) {
    SystemConfig.PermissionEntry perm &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; permConfig.valueAt(i);
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;拿到权限&lt;/span&gt;
    BasePermission bp = mSettings.mPermissions.&lt;span style=&quot;color: #0000ff;&quot;&gt;get&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(perm.name);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (bp == &lt;span style=&quot;color: #0000ff;&quot;&gt;null&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        bp &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; BasePermission(perm.name, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;android&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, BasePermission.TYPE_BUILTIN);
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;写入权限&lt;/span&gt;</code></pre><p><span style="color: #000000;">                    mSettings.mPermissions.put(perm.name, bp);<br>                }<br>                </span><span style="color: #0000ff;">if</span> (perm.gids != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br>                    bp.setGids(perm.gids, perm.perUser);<br>                }<br>            }<br>        }</span></p>
<pre><code>final PackageHandler mHandler;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;class&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; PackageHandler extends Handler {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; doHandleMessage(Message msg) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;switch&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (msg.what) {

        }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; scanDirLI(File dir, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; parseFlags, &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt; scanFlags, &lt;span style=&quot;color: #0000ff;&quot;&gt;long&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; currentTime) {
    final File[] files &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; dir.listFiles();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (ArrayUtils.isEmpty(files)) {
        Log.d(TAG, &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;No files in app dir &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; +&lt;span style=&quot;color: #000000;&quot;&gt; dir);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    ParallelPackageParser parallelPackageParser &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ParallelPackageParser(
            mSeparateProcesses, mOnlyCore, mMetrics, mCacheDir,
            mParallelPackageParserCallback);

    parallelPackageParser.close();

}

File frameworkDir &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; File(Environment.getRootDirectory(), &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;framework&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Find base frameworks (resource packages without code).&lt;/span&gt;</code></pre><p><span style="color: #000000;">    scanDirTracedLI(frameworkDir, mDefParseFlags<br>            </span>|<span style="color: #000000;"> PackageParser.PARSE_IS_SYSTEM<br>            </span>|<span style="color: #000000;"> PackageParser.PARSE_IS_SYSTEM_DIR<br>            </span>|<span style="color: #000000;"> PackageParser.PARSE_IS_PRIVILEGED,<br>            scanFlags </span>| SCAN_NO_DEX, <span style="color: #800080;">0</span><span style="color: #000000;">);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Collected privileged system packages. 系统安装包&lt;/span&gt;
final File privilegedAppDir = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; File(Environment.getRootDirectory(), &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;priv-app&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
scanDirTracedLI(privilegedAppDir, mDefParseFlags
        &lt;/span&gt;|&lt;span style=&quot;color: #000000;&quot;&gt; PackageParser.PARSE_IS_SYSTEM
        &lt;/span&gt;|&lt;span style=&quot;color: #000000;&quot;&gt; PackageParser.PARSE_IS_SYSTEM_DIR
        &lt;/span&gt;| PackageParser.PARSE_IS_PRIVILEGED, scanFlags, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Collect ordinary system packages. 系统app安装包&lt;/span&gt;
final File systemAppDir = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; File(Environment.getRootDirectory(), &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;app&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
scanDirTracedLI(systemAppDir, mDefParseFlags
        &lt;/span&gt;|&lt;span style=&quot;color: #000000;&quot;&gt; PackageParser.PARSE_IS_SYSTEM
        &lt;/span&gt;| PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>　　PMS里面主要完成以下几件事。<br>&nbsp;　　1、通过installer与installd进行连接，进行安装卸载应用操作<br>&nbsp;　　2、创建PacakageHandler线程，处理外部应用的安装卸载请求<br>&nbsp;　　3、处理系统权限相关配置<br>&nbsp;　　4、扫描安装应用，并解析APK安装包信息</p>
<div>
<h3>二.总结</h3>

<p>&nbsp;一张图总结下PMS主要完成的工作，以及对上与PackageManager交互，向下与Installd的控制。<br>&nbsp;　　　　　　　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722145529724-1218830986.png" alt></p></div><p></p>
<div><br>如果想了解桌面Launcher应用启动app过程，请看这篇文章。<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/Launcher_app.html" target="_blank">Android 源码分析（八） Launcher 桌面启动App过程</a></div>
<div>最后补充一点，如果想要了解APK的编译过程，可以进一步去了解Android4.4之后使用的ART,可以与Dalivk对比了解。<br>给个Dalivk的启动过程介绍的文章：<a id="homepage1_HomePageDays_DaysList_ctl05_DayList_TitleUrl_0" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/dalvik.html" target="_blank">Android 源码分析（十） Dalvik 虚拟机创建过程</a></div>

</div>
<div>&nbsp;</div>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/22/Android源码分析十三ActivityManagerService服务分析/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android源码分析（十三）ActivityManagerService服务分析">
                
                <h1>Android源码分析（十三）ActivityManagerService服务分析</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月22日</a>
            <a><i class="nexmoefont icon-areachart"></i>2.2k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 13 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/ActivityManagerService.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h3>一.ActivityManagerService(AMS) 启动过程分析</h3>
<p>在SystemServer启动ActivityManagerService</p>
<p>如果想了解SystemServer启动过程可以看这篇文章：<a id="homepage1_HomePageDays_DaysList_ctl00_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/SystemServer.html" target="_blank">Android 源码分析（六） SystemServer 进程</a></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>frameworks\<span style="color: #0000ff;">base</span><span style="color: #000000;">\services\java\com\android\server\SystemServer.java
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Activity manager runs the show.</span>
        traceBeginAndSlog(<span style="color: #800000;">"</span><span style="color: #800000;">StartActivityManager</span><span style="color: #800000;">"</span><span style="color: #000000;">);
        mActivityManagerService </span>=<span style="color: #000000;"> mSystemServiceManager.startService(
                ActivityManagerService.Lifecycle.</span><span style="color: #0000ff;">class</span><span style="color: #000000;">).getService();
        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);
        mActivityManagerService.setInstaller(installer);
        </span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ActivityManagerService extends IActivityManager.Stub
        implements Watchdog.Monitor, BatteryStatsImpl.BatteryCallback {

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;* All system services &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
SystemServiceManager mSystemServiceManager;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;* Run all ActivityStacks through this &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;管理Activity&lt;/span&gt;</code></pre><p><span style="color: #000000;">    final ActivityStackSupervisor mStackSupervisor;</span></p>
<pre><code>final ActivityStarter mActivityStarter;

final TaskChangeNotificationController mTaskChangeNotificationController;

final InstrumentationReporter mInstrumentationReporter &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; InstrumentationReporter();

final ArrayList&lt;/span&gt;&amp;lt;ActiveInstrumentation&amp;gt; mActiveInstrumentation = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;();

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Whether we should use SCHED_FIFO for UI and RenderThreads.&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt; boolean mUseFifoUiScheduling = &lt;span style=&quot;color: #0000ff;&quot;&gt;false&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;Broadcast 广播 ，前台广播队列和后台广播队列&lt;/span&gt;</code></pre><p><span style="color: #000000;">    BroadcastQueue mFgBroadcastQueue;<br>    BroadcastQueue mBgBroadcastQueue;</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Convenient for easy iteration over the queues. Foreground is first
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; so that dispatch of foreground broadcasts gets precedence.&lt;/span&gt;
final BroadcastQueue[] mBroadcastQueues = &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; BroadcastQueue[&lt;span style=&quot;color: #800080;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;];

BroadcastStats mLastBroadcastStats;
BroadcastStats mCurBroadcastStats;

BroadcastQueue broadcastQueueForIntent(Intent intent) {
    final boolean isFg &lt;/span&gt;= (intent.getFlags() &amp;amp; Intent.FLAG_RECEIVER_FOREGROUND) != &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (DEBUG_BROADCAST_BACKGROUND) Slog.i(TAG_BROADCAST,
            &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;Broadcast intent &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; + intent + &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt; on &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;
            + (isFg ? &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;foreground&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt; : &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;background&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;) + &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt; queue&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; (isFg) ?&lt;span style=&quot;color: #000000;&quot;&gt; mFgBroadcastQueue : mBgBroadcastQueue;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;Activity 堆栈&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*
 * The last resumed activity. This is identical to the current resumed activity most
 * of the time but could be different when we&apos;re pausing one activity before we resume
 * another activity.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; ActivityRecord mLastResumedActivity;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*
 * If non-null, we are tracking the time the user spends in the currently focused app.
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;private&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; AppTimeTracker mCurAppTimeTracker;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;ANR ？ 最后个ANR状态，难道可以记录app发生ANR的？&lt;/span&gt;
&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*
 * Dump of the activity state at the time of the last ANR. Cleared after
 * {@link WindowManagerService#LAST_ANR_LIFETIME_DURATION_MSECS}
 &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
String mLastANRState;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;Service 和 Provider 管理&lt;/span&gt;</code></pre><p><span style="color: #000000;">    final ActiveServices mServices;<br>    final ProviderMap mProviderMap;</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;存放系统数据目录
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; TODO: Move creation of battery stats service outside of activity manager service.&lt;/span&gt;
File dataDir =&lt;span style=&quot;color: #000000;&quot;&gt; Environment.getDataDirectory();
File systemDir &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; File(dataDir, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;system&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
systemDir.mkdirs();
mBatteryStatsService &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; BatteryStatsService(systemDir, mHandler);

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;应用权限管理&lt;/span&gt;
mAppOpsService = mInjector.getAppOpsService(&lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; File(systemDir, &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;appops.xml&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;), mHandler);

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;AcitivityManager 添加进来&lt;/span&gt;
    ServiceManager.addService(Context.ACTIVITY_SERVICE, &lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
            ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);
            ServiceManager.addService(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;meminfo&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; MemBinder(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
            ServiceManager.addService(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;gfxinfo&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; GraphicsBinder(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
            ServiceManager.addService(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;dbinfo&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; DbBinder(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (MONITOR_CPU_USAGE) {
                ServiceManager.addService(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;cpuinfo&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; CpuBinder(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
            }
            ServiceManager.addService(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;permission&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; PermissionController(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));
            ServiceManager.addService(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;processinfo&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, &lt;span style=&quot;color: #0000ff;&quot;&gt;new&lt;/span&gt; ProcessInfoService(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;));

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;最后 使用Watchdog监控&lt;/span&gt;
Watchdog.getInstance().addMonitor(&lt;span style=&quot;color: #0000ff;&quot;&gt;this&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
Watchdog.getInstance().addThread(mHandler);</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;&nbsp; 从上面截取的一些代码片段，我们能了解到， AMS创建过程 涉及到Android 四大组件管理的初始化工作。并且ActivityManagerService extends IActivityManager.Stub，所以可知AcitivityManagerService与AcitivityManager之间通信也是使用binder机制。</p>
<p>&nbsp; &nbsp; 进ActivityManager 里面看看</p>
<div class="cnblogs_code">
<pre><span style="color: #008000;">//</span><span style="color: #008000;">与ActivityManagerService里的ServiceManager.addService(Context.ACTIVITY_SERVICE, this, true);对应。</span>
<span style="color: #000000;">@SystemService(Context.ACTIVITY_SERVICE)
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ActivityManager {
    ...
}</span></pre>
</div>
<p>&nbsp;</p>
<h3>二.ActivityManager和ActivityManagerService关系</h3>
<p>如果想了解Activity是如果通过ActivityManager调用ActivityManagerService的过程可以看下这篇文章.</p>
<p><a id="homepage1_HomePageDays_DaysList_ctl03_DayList_TitleUrl_1" class="postTitle2" href="https://www.cnblogs.com/bugzone/p/startActivity.html" target="_blank">Android 源码分析（二） Activity 启动分析</a></p>
<p>ActivityManager（frameworks/base/core/java/android/app/ActivityManager.java）</p>
<p>ActivityManager 是客户端用来管理系统中正在运行的所有Activity.</p>
<p>上层APP通过ActivityManager使用binder机制传递信息给AMS，由AMS去完成交互和调度工作后通过binder机制返回给ActivityManager，把结果在返回给上层app。</p>
<p>一张图了解ActivityManager和ActivityManagerService在整个Android系统通信过程中位置。</p>
<p><img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722132754102-1009841250.png" alt></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>参考：<br>[1]https://www.cnblogs.com/bastard/p/5770573.html</p>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/22/Android源码分析十二ServiceManager服务分析/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Android源码分析（十二）ServiceManager服务分析">
                
                <h1>Android源码分析（十二）ServiceManager服务分析</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月22日</a>
            <a><i class="nexmoefont icon-areachart"></i>6.2k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 38 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/安卓源码/">安卓源码</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/安卓源码/">安卓源码</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/ServiceManager.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <h2>一.启动过程分析</h2>
<div>基于 binder 机制实现通信，添加服务，查询服务，获取服务。查询，获取服务时候需要检查权限，android是基于Linux底层，所以也很好的实现了linux多用户管理。</div>
<div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">frameworks\native\cmds\servicemanager\servicemanager.rc
service servicemanager </span>/system/bin/<span style="color: #000000;">servicemanager
    </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> core animation
    user system
    group system readproc
    critical
    onrestart restart healthd
    onrestart restart zygote
    onrestart restart audioserver
    onrestart restart media
    onrestart restart surfaceflinger
    onrestart restart inputflinger
    onrestart restart drm
    onrestart restart cameraserver
    writepid </span>/dev/cpuset/system-background/tasks</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>从上面可知，如果ServiceManager服务异常退出的话，系统会重启。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #000000;">frameworks\native\cmds\servicemanager\service_manager.c
</span><span style="color: #0000ff;">int</span> main(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span>**<span style="color: #000000;"> argv)
{
    </span><span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs;
    union selinux_callback cb;
    </span><span style="color: #0000ff;">char</span> *<span style="color: #000000;">driver;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (argc &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    driver &lt;/span&gt;= argv[&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;];
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    driver &lt;/span&gt;= &lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;/dev/binder&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

bs &lt;/span&gt;= binder_open(driver, &lt;span style=&quot;color: #800080;&quot;&gt;128&lt;/span&gt;*&lt;span style=&quot;color: #800080;&quot;&gt;1024&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;bs) {
#ifdef VENDORSERVICEMANAGER
    ALOGW(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;failed to open binder driver %s\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, driver);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; (&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        sleep(UINT_MAX);
    }
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;failed to open binder driver %s\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, driver);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#endif&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (binder_become_context_manager(bs)) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;cannot become context manager (%s)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, strerror(errno));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

cb.func_audit &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; audit_callback;
selinux_set_callback(SELINUX_CB_AUDIT, cb);
cb.func_log &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; selinux_log_callback;
selinux_set_callback(SELINUX_CB_LOG, cb);

#ifdef VENDORSERVICEMANAGER
sehandle &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; selinux_android_vendor_service_context_handle();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
sehandle &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; selinux_android_service_context_handle();
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;#endif&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;
selinux_status_open(&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;true&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (sehandle ==&lt;span style=&quot;color: #000000;&quot;&gt; NULL) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;SELinux: Failed to acquire sehandle. Aborting.\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    abort();
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (getcon(&amp;amp;service_manager_context) != &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;SELinux: Failed to acquire service_manager context. Aborting.\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    abort();
}


&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;loop 接受消息。并将binder解析完的消息返回给svcmgr_handler处理。&lt;/span&gt;</code></pre><p><span style="color: #000000;">    binder_loop(bs, svcmgr_handler);</span></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>从这我们知道，ServiceManager是基于binder机制实现的。进入binder.c中了解下binder_open,binder_loop，然后binder将解析完的消息，返回给svcmag_handler处理</p>
<p>frameworks\native\cmds\servicemanager\binder.c</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c271bc75-156b-40e2-ae92-90551ddf233c')"><img id="code_img_closed_c271bc75-156b-40e2-ae92-90551ddf233c" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_c271bc75-156b-40e2-ae92-90551ddf233c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('c271bc75-156b-40e2-ae92-90551ddf233c',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_c271bc75-156b-40e2-ae92-90551ddf233c" class="cnblogs_code_hide">
<pre>    <span style="color: #0000ff;">struct</span> binder_state *binder_open(<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> driver, size_t mapsize)
{
    </span><span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs;
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_version vers;

<pre><code>bs &lt;/span&gt;= malloc(&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;(*&lt;span style=&quot;color: #000000;&quot;&gt;bs));
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;bs) {
    errno &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; ENOMEM;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; NULL;
}

bs&lt;/span&gt;-&amp;gt;fd = open(driver, O_RDWR |&lt;span style=&quot;color: #000000;&quot;&gt; O_CLOEXEC);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (bs-&amp;gt;fd &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    fprintf(stderr,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder: cannot open %s (%s)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
            driver, strerror(errno));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; fail_open;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; ((ioctl(bs-&amp;gt;fd, BINDER_VERSION, &amp;amp;vers) == -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;) ||&lt;span style=&quot;color: #000000;&quot;&gt;
    (vers.protocol_version &lt;/span&gt;!=&lt;span style=&quot;color: #000000;&quot;&gt; BINDER_CURRENT_PROTOCOL_VERSION)) {
    fprintf(stderr,
            &lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder: kernel driver version (%d) differs from user space version (%d)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
            vers.protocol_version, BINDER_CURRENT_PROTOCOL_VERSION);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; fail_open;
}

bs&lt;/span&gt;-&amp;gt;mapsize =&lt;span style=&quot;color: #000000;&quot;&gt; mapsize;
bs&lt;/span&gt;-&amp;gt;mapped = mmap(NULL, mapsize, PROT_READ, MAP_PRIVATE, bs-&amp;gt;fd, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (bs-&amp;gt;mapped ==&lt;span style=&quot;color: #000000;&quot;&gt; MAP_FAILED) {
    fprintf(stderr,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder: cannot map device (%s)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
            strerror(errno));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; fail_map;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; bs;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('5c06b747-4566-4459-8bff-9b4c249774c5')"><img id="code_img_closed_5c06b747-4566-4459-8bff-9b4c249774c5" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_5c06b747-4566-4459-8bff-9b4c249774c5" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('5c06b747-4566-4459-8bff-9b4c249774c5',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_5c06b747-4566-4459-8bff-9b4c249774c5" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">void</span> binder_loop(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs, binder_handler func)
{
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> res;
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_write_read bwr;
    uint32_t readbuf[</span><span style="color: #800080;">32</span><span style="color: #000000;">];

<pre><code>bwr.write_size &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
bwr.write_consumed &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
bwr.write_buffer &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

readbuf[&lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;] =&lt;span style=&quot;color: #000000;&quot;&gt; BC_ENTER_LOOPER;
binder_write(bs, readbuf, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(uint32_t));

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (;;) {
    bwr.read_size &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(readbuf);
    bwr.read_consumed &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    bwr.read_buffer &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; (uintptr_t) readbuf;

    res &lt;/span&gt;= ioctl(bs-&amp;gt;fd, BINDER_WRITE_READ, &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;bwr);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (res &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder_loop: ioctl failed (%s)\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, strerror(errno));
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;解析消息&lt;/span&gt;
    res = binder_parse(bs, &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, (uintptr_t) readbuf, bwr.read_consumed, func);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (res == &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder_loop: unexpected reply?!\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (res &amp;lt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;binder_loop: io error %d %s\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, res, strerror(errno));
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
}</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div>binder_parse 解析接受到的消息&nbsp;</div>
<div>binder_send_reply 接收到消息，并解析完消息后，binder将解析后的消息返回给ServiceManager</div>
<div>
<div class="cnblogs_code" onclick="cnblogs_code_show('4aebc7de-d31e-48f8-9dbc-8ae2582c5d95')"><img id="code_img_closed_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('4aebc7de-d31e-48f8-9dbc-8ae2582c5d95',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_4aebc7de-d31e-48f8-9dbc-8ae2582c5d95" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">void</span> binder_send_reply(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                       </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">reply,
                       binder_uintptr_t buffer_to_free,
                       </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> status)
{
    </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> {
        uint32_t cmd_free;
        binder_uintptr_t buffer;
        uint32_t cmd_reply;
        </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> binder_transaction_data txn;
    } __attribute__((packed)) data;

<pre><code>data.cmd_free &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; BC_FREE_BUFFER;
data.buffer &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; buffer_to_free;
data.cmd_reply &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; BC_REPLY;
data.txn.target.ptr &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
data.txn.cookie &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
data.txn.code &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (status) {
    data.txn.flags &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; TF_STATUS_CODE;
    data.txn.data_size &lt;/span&gt;= &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;(&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
    data.txn.offsets_size &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    data.txn.data.ptr.buffer &lt;/span&gt;= (uintptr_t)&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;status;
    data.txn.data.ptr.offsets &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    data.txn.flags &lt;/span&gt;= &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    data.txn.data_size &lt;/span&gt;= reply-&amp;gt;data - reply-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;data0;
    data.txn.offsets_size &lt;/span&gt;= ((&lt;span style=&quot;color: #0000ff;&quot;&gt;char&lt;/span&gt;*) reply-&amp;gt;offs) - ((&lt;span style=&quot;color: #0000ff;&quot;&gt;char&lt;/span&gt;*) reply-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;offs0);
    data.txn.data.ptr.buffer &lt;/span&gt;= (uintptr_t)reply-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;data0;
    data.txn.data.ptr.offsets &lt;/span&gt;= (uintptr_t)reply-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;offs0;
}
binder_write(bs, &lt;/span&gt;&amp;amp;data, &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(data));</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>继续回到serviceManager里分析binder解析返回回来的服务消息</p>
<p>frameworks\native\cmds\servicemanager\servicemanager.rc</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">int</span> svcmgr_handler(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                   </span><span style="color: #0000ff;">struct</span> binder_transaction_data *<span style="color: #000000;">txn,
                   </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">msg,
                   </span><span style="color: #0000ff;">struct</span> binder_io *<span style="color: #000000;">reply)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *<span style="color: #000000;">si;
    uint16_t </span>*<span style="color: #000000;">s;
    size_t len;
    uint32_t handle;
    uint32_t strict_policy;
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> allow_isolated;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;ALOGI(&quot;target=%p code=%d pid=%d uid=%d\n&quot;,
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;      (void*) txn-&amp;gt;target.ptr, txn-&amp;gt;code, txn-&amp;gt;sender_pid, txn-&amp;gt;sender_euid);&lt;/span&gt;

&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (txn-&amp;gt;target.ptr !=&lt;span style=&quot;color: #000000;&quot;&gt; BINDER_SERVICE_MANAGER)
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (txn-&amp;gt;code ==&lt;span style=&quot;color: #000000;&quot;&gt; PING_TRANSACTION)
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Equivalent to Parcel::enforceInterface(), reading the RPC
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; header with the strict mode policy mask and the interface name.
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; Note that we ignore the strict_policy and don&apos;t propagate it
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; further (since we do no outbound RPCs anyway).&lt;/span&gt;
strict_policy =&lt;span style=&quot;color: #000000;&quot;&gt; bio_get_uint32(msg);
s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;len);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (s ==&lt;span style=&quot;color: #000000;&quot;&gt; NULL) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;检查是否是servicemanager服务&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; ((len != (&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;(svcmgr_id) / &lt;span style=&quot;color: #800080;&quot;&gt;2&lt;/span&gt;)) ||&lt;span style=&quot;color: #000000;&quot;&gt;
    memcmp(svcmgr_id, s, &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(svcmgr_id))) {
    fprintf(stderr,&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;invalid id %s\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;, str8(s, len));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (sehandle &amp;amp;&amp;amp; selinux_status_updated() &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;struct&lt;/span&gt; selabel_handle *tmp_sehandle =&lt;span style=&quot;color: #000000;&quot;&gt; selinux_android_service_context_handle();
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (tmp_sehandle) {
        selabel_close(sehandle);
        sehandle &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; tmp_sehandle;
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;switch&lt;/span&gt;(txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;code) {
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SVC_MGR_GET_SERVICE:
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;检查服务，do_find_service 查找服务。&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SVC_MGR_CHECK_SERVICE:
    s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;len);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (s ==&lt;span style=&quot;color: #000000;&quot;&gt; NULL) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    handle &lt;/span&gt;= do_find_service(s, len, txn-&amp;gt;sender_euid, txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_pid);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;handle)
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    bio_put_ref(reply, handle);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;添加服务 do_add_service 获取服务 在do_add_service会检查是否具有权限&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SVC_MGR_ADD_SERVICE:
    s &lt;/span&gt;= bio_get_string16(msg, &amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt;len);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (s ==&lt;span style=&quot;color: #000000;&quot;&gt; NULL) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    handle &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; bio_get_ref(msg);
    allow_isolated &lt;/span&gt;= bio_get_uint32(msg) ? &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt; : &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (do_add_service(bs, s, len, handle, txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_euid,
        allow_isolated, txn&lt;/span&gt;-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_pid))
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;break&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;查询服务&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;case&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; SVC_MGR_LIST_SERVICES: {
    uint32_t n &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; bio_get_uint32(msg);

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!svc_can_list(txn-&amp;gt;sender_pid, txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_euid)) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;list_service() uid=%d - PERMISSION DENIED\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
                txn&lt;/span&gt;-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;sender_euid);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    si &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; svclist;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;while&lt;/span&gt; ((n-- &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;) &amp;amp;&amp;amp;&lt;span style=&quot;color: #000000;&quot;&gt; si)
        si &lt;/span&gt;= si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;next;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (si) {
        bio_put_string16(reply, si&lt;/span&gt;-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;name);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;default&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;unknown code %d\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;, txn-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;code);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

bio_put_uint32(reply, &lt;/span&gt;&lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>}</p></span></pre><p></p>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></div>
<p>进入 do_find_service&nbsp; do_add_service了解下做了什么事。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('259cf340-561d-4ea7-9910-93cac3ea1148')"><img id="code_img_closed_259cf340-561d-4ea7-9910-93cac3ea1148" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_259cf340-561d-4ea7-9910-93cac3ea1148" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('259cf340-561d-4ea7-9910-93cac3ea1148',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_259cf340-561d-4ea7-9910-93cac3ea1148" class="cnblogs_code_hide">
<pre>uint32_t do_find_service(<span style="color: #0000ff;">const</span> uint16_t *<span style="color: #000000;">s, size_t len, uid_t uid, pid_t spid)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *si =<span style="color: #000000;"> find_svc(s, len);

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!si || !si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;handle) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;allow_isolated) {
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; If this service doesn&apos;t allow access from isolated processes,
    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; then check the uid to see if it is isolated.&lt;/span&gt;
    uid_t appid = uid %&lt;span style=&quot;color: #000000;&quot;&gt; AID_USER;
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (appid &amp;gt;= AID_ISOLATED_START &amp;amp;&amp;amp; appid &amp;lt;=&lt;span style=&quot;color: #000000;&quot;&gt; AID_ISOLATED_END) {
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;svc_can_find(s, len, spid, uid)) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;handle;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('786c6178-2ad5-466d-b516-d8e38fe7b404')"><img id="code_img_closed_786c6178-2ad5-466d-b516-d8e38fe7b404" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt><img id="code_img_opened_786c6178-2ad5-466d-b516-d8e38fe7b404" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('786c6178-2ad5-466d-b516-d8e38fe7b404',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt>
<div id="cnblogs_code_open_786c6178-2ad5-466d-b516-d8e38fe7b404" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">int</span> do_add_service(<span style="color: #0000ff;">struct</span> binder_state *<span style="color: #000000;">bs,
                   </span><span style="color: #0000ff;">const</span> uint16_t *<span style="color: #000000;">s, size_t len,
                   uint32_t handle, uid_t uid, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> allow_isolated,
                   pid_t spid)
{
    </span><span style="color: #0000ff;">struct</span> svcinfo *<span style="color: #000000;">si;

<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;ALOGI(&quot;add_service(&apos;%s&apos;,%x,%s) uid=%d\n&quot;, str8(s, len), handle,
&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;        allow_isolated ? &quot;allow_isolated&quot; : &quot;!allow_isolated&quot;, uid);&lt;/span&gt;

&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!handle || (len == &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;) || (len &amp;gt; &lt;span style=&quot;color: #800080;&quot;&gt;127&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;))
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;

&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;//&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;检查是否有权限&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;svc_can_register(s, len, spid, uid)) {
    ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;add_service(&apos;%s&apos;,%x) uid=%d - PERMISSION DENIED\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
         str8(s, len), handle, uid);
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
}

si &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; find_svc(s, len);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; (si) {
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;handle) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;add_service(&apos;%s&apos;,%x) uid=%d - ALREADY REGISTERED, OVERRIDE\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
             str8(s, len), handle, uid);
        svcinfo_death(bs, si);
    }
    si&lt;/span&gt;-&amp;gt;handle =&lt;span style=&quot;color: #000000;&quot;&gt; handle;
} &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
    si &lt;/span&gt;= malloc(&lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;(*si) + (len + &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;) * &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(uint16_t));
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; (!&lt;span style=&quot;color: #000000;&quot;&gt;si) {
        ALOGE(&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;add_service(&apos;%s&apos;,%x) uid=%d - OUT OF MEMORY\n&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;,
             str8(s, len), handle, uid);
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; -&lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    }
    si&lt;/span&gt;-&amp;gt;handle =&lt;span style=&quot;color: #000000;&quot;&gt; handle;
    si&lt;/span&gt;-&amp;gt;len =&lt;span style=&quot;color: #000000;&quot;&gt; len;
    memcpy(si&lt;/span&gt;-&amp;gt;name, s, (len + &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;) * &lt;span style=&quot;color: #0000ff;&quot;&gt;sizeof&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(uint16_t));
    si&lt;/span&gt;-&amp;gt;name[len] = &lt;span style=&quot;color: #800000;&quot;&gt;&apos;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;\0&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&apos;&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;
    si&lt;/span&gt;-&amp;gt;death.func = (&lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt;*&lt;span style=&quot;color: #000000;&quot;&gt;) svcinfo_death;
    si&lt;/span&gt;-&amp;gt;death.ptr =&lt;span style=&quot;color: #000000;&quot;&gt; si;
    si&lt;/span&gt;-&amp;gt;allow_isolated =&lt;span style=&quot;color: #000000;&quot;&gt; allow_isolated;
    si&lt;/span&gt;-&amp;gt;next =&lt;span style=&quot;color: #000000;&quot;&gt; svclist;
    svclist &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; si;
}

binder_acquire(bs, handle);
binder_link_to_death(bs, handle, &lt;/span&gt;&amp;amp;si-&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt;death);
&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;;</code></pre><p>}</p></span></pre><p></p>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<h2>二. ServiceManager如何管理服务</h2>
<p>&nbsp;从上面源码分析我们知道了ServiceManager利用binder通信机制来管理一系列服务。<br>&nbsp;上面源码的执行路径可以用下图所示：（注意，图中do_find_service7 应该是do_find_service.操作手误。）</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722114236180-75099312.png" alt></p>
<p>&nbsp;</p>
<p>　　代码分析抽象成逻辑分析，如下图所示：</p>
<p>　　　　　　　　<img src="https://images2018.cnblogs.com/blog/612293/201807/612293-20180722114323395-1692794298.png" alt></p>

</div>

</div>
</div>
            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2018/07/22/Serializable和Parcelable之序列化/">
            <div class="nexmoe-post-cover mdui-ripple"> 
                
                    <img src="https://i.loli.net/2019/01/13/5c3aec85a4343.jpg" alt="Serializable和Parcelable之序列化">
                
                <h1>Serializable和Parcelable之序列化</h1>
            </div>
        </a>
        <div class="nexmoe-post-meta">
            <a><i class="nexmoefont icon-calendar-fill"></i>2018年07月22日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.8k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 8 分钟</a>
            
                <a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/">Android</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/Android/知识点/">知识点</a>
            
            
                <a class="nexmoefont icon-tag-fill -link" href="/tags/序列化/">序列化</a>
            
        </div>
        <article>
            
            <p><a href="https://www.cnblogs.com/bugzone/p/Serializable_Parcelable.html" target="_blank" rel="noopener">点击查看原文</a></p>
<div id="cnblogs_post_body" class="blogpost-body ">
    <div>序列化，表示将一个对象转换成可存储或可传输的状态。序列化后的对象可以在网络上进行传输，也可以存储到本地。
<h3>&nbsp;一.Serializable和Parcelable介绍</h3>
&nbsp;Android中Intent如果要传递类对象，可以通过两种方式实现。<br>&nbsp;&nbsp;方式一：Serializable，要传递的类实现Serializable接口传递对象，<br>&nbsp;&nbsp;方式二：Parcelable，要传递的类实现Parcelable接口传递对象。<br>&nbsp;&nbsp;<br>&nbsp;Serializable（Java自带）： <br>&nbsp;&nbsp;Serializable是序列化的意思，表示将一个对象转换成可存储或可传输的状态。序列化后的对象可以在网络上进行传输，也可以存储到本地。只需要实现Serializable接口就可以，是由系统来完成序列化和反序列化操作。<br>&nbsp;Parcelable（android 专用）： <br>&nbsp;&nbsp;除了Serializable之外，使用Parcelable也可以实现相同的效果， <br>&nbsp;&nbsp;不过不同于将对象进行序列化，Parcelable方式的实现原理是将一个完整的对象进行分解， <br>&nbsp;&nbsp;而分解后的每一部分都是Intent所支持的数据类型，这样也就实现传递对象的功能了。 &nbsp;
<h3>&nbsp;二.Serializable和Parcelable对比&nbsp;</h3>

<p>&nbsp;1.在使用内存的时候，Parcelable比Serializable性能高，所以推荐使用Parcelable。<br>&nbsp;2.Serializable在序列化的时候会产生大量的临时变量，从而引起频繁的GC。<br>&nbsp;3.Parcelable无法将数据进行持久化,因此在将数据保存在磁盘的时候,仍然需要使用后者,因为前者无法很好的将数据进行持久化.(原因是在不同的Android版本当中,Parcelable可能会不同,因此数据的持久化方面仍然是使用Serializable)<br>&nbsp;4.Parcelable 不仅仅需要声明,还需要实现内部的相应方法.writeToParcel;重写describeContents方法,默认值为0;Public static final Parcelable.Creator&lt;T&gt;CREATOR = new CREATOR&lt;T&gt;(){…}<br>&nbsp;5.Parcelable是以Ibinder作为信息载体的.在内存上的开销比较小,因此在内存之间进行数据传递的时候,Android推荐使用Parcelable,既然是内存方面比价有优势,那么自然就要优先选择.<br>&nbsp;6.在读写数据的时候,Parcelable是在内存中直接进行读写,而Serializable是通过使用IO流的形式将数据读写入在硬盘上.&nbsp;</p></div><p></p>
<div>
<h3>&nbsp;三.序列化 运用场景</h3>

</div>
<div>&nbsp;注意：不想对部分关键字进行序列化,可以使用transient关键字来修饰以及static修饰.<br>&nbsp;1.永久的保存对象数据(将对象数据保存在文件当中,或者是磁盘中<br>&nbsp;2.通过序列化操作将对象数据在网络上进行传输(由于网络传输是以字节流的方式对数据进行传输的.因此序列化的目的是将对象数据转换成字节流的形式)<br>&nbsp;3.将对象数据在进程之间进行传递(Activity之间传递对象数据时,需要在当前的Activity中对对象数据进行序列化操作.在另一个Activity中需要进行反序列化操作讲数据取出)<br>&nbsp;4.Java平台允许我们在内存中创建可复用的Java对象，但一般情况下，只有当JVM处于运行时，这些对象才可能存在，即，这些对象的生命周期不会比JVM的生命周期更长（即每个对象都在JVM中）但在现实应用中，就可能要停止JVM运行，但有要保存某些指定的对象，并在将来重新读取被保存的对象。这是Java对象序列化就能够实现该功能。（可选择入数据库、或文件的形式保存）<br>&nbsp;5.序列化对象的时候只是针对变量进行序列化,不针对方法进行序列化.<br>&nbsp;6.在Intent之间,基本的数据类型直接进行相关传递即可,但是一旦数据类型比较复杂的时候,就需要进行序列化操作了.&nbsp;
<h3>&nbsp;四.总结：</h3>

<p>&nbsp;&nbsp;Java应用程序中有Serializable来实现序列化操作,Android中有Parcelable来实现序列化操作,相关的性能也作出了比较,因此<strong>在Android中除了对数据持久化的时候需要使用到Serializable来实现序列化操作,其他的时候我们仍然需要使用Parcelable来实现序列化操作</strong>,因为在Android中效率并不是最重要的,而是内存,通过比较Parcelable在效率和内存上都要优秀与Serializable.<br>&nbsp;<br>&nbsp;<br>&nbsp;附上Parcelable.java源码 主要describeContents(),writeToParcel(Parcel dest, @WriteFlags int flags),interface Creator&lt;T&gt;{}</p></div><p></p>
<div>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Parcelable {

<pre><code>    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*
     * Describe the kinds of special objects contained in this Parcelable
     * instance&apos;s marshaled representation. For example, if the object will
     * include a file descriptor in the output of {@link #writeToParcel(Parcel, int)},
     * the return value of this method must include the
     * {@link #CONTENTS_FILE_DESCRIPTOR} bit.
     *  
     * @return a bitmask indicating the set of special object types marshaled
     * by this Parcelable object instance.
     &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; @ContentsFlags &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; describeContents();

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*
     * Flatten this object in to a Parcel.
     * 
     * @param dest The Parcel in which the object should be written.
     * @param flags Additional flags about how the object should be written.
     * May be 0 or {@link #PARCELABLE_WRITE_RETURN_VALUE}.
     &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;void&lt;/span&gt; writeToParcel(Parcel dest, @WriteFlags &lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; flags);

    &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*
     * Interface that must be implemented and provided as a public CREATOR
     * field that generates instances of your Parcelable class from a Parcel.
     &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
    &lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;interface&lt;/span&gt; Creator&amp;lt;T&amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; {
        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*
         * Create a new instance of the Parcelable class, instantiating it
         * from the given Parcel whose data had previously been written by
         * {@link Parcelable#writeToParcel Parcelable.writeToParcel()}.
         * 
         * @param source The Parcel to read the object&apos;s data from.
         * @return Returns a new instance of the Parcelable class.
         &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; T createFromParcel(Parcel source);

        &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;/*&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*
         * Create a new array of the Parcelable class.
         * 
         * @param size Size of the array.
         * @return Returns an array of the Parcelable class, with every entry
         * initialized to null.
         &lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;*/&lt;/span&gt;
        &lt;span style=&quot;color: #0000ff;&quot;&gt;public&lt;/span&gt; T[] newArray(&lt;span style=&quot;color: #0000ff;&quot;&gt;int&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; size);
    }


}&lt;/span&gt;&lt;/pre&gt;</code></pre><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码" target="_blank" rel="noopener"><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div></span></pre></div>
<p>[1]&nbsp;序列化Serializable和Parcelable的理解和区别 https://blog.csdn.net/Double2hao/article/details/70145747</p>
<p>[2] Android中Serializable和Parcelable序列化对象详解 https://www.cnblogs.com/yezhennan/p/5527506.html</p>
</div>
</div>

            
        </article>
    </div>
    
</section>

    <nav class="nexmoe-page-nav">
      <a class="extend prev" rel="prev" href="/categories/Android/page/2/"><i class="nexmoefont icon-left"></i></a><a class="page-number" href="/categories/Android/">1</a><a class="page-number" href="/categories/Android/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/categories/Android/page/4/">4</a><a class="page-number" href="/categories/Android/page/5/">5</a><a class="page-number" href="/categories/Android/page/6/">6</a><a class="extend next" rel="next" href="/categories/Android/page/4/"><i class="nexmoefont icon-right"></i></a>
    </nav>
  
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
 
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


 
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/app.js?v=1571545567380"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>


    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>



  





    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?3771b2566860fea0de20c35742671f53#&lt;ID&gt;';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

</body>

</html>
